<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Miscellaneous Features</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-16 23:44:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 1880--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmch26.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse135.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse135.html#tailclmse135.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse136.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch25.html#clmse136.html" >Наверх</a><tt>&#x003E;</tt></div><h3 class="sectionHead"><span class="titlemark">25.12   </span> <a 
href="clm.html#QQ2-166-2659" id="x166-261600025.12">Miscellaneous
Features</a></h3>
<!--l. 1883--><p class="noindent" >The Loop Facility provides the <tt><a 
href="clmli7.html#x196-3479641r641">named</a></tt> construct to name a loop so that the
Common Lisp special operator <tt><a 
href="clmli7.html#x196-3479799r799">return-from</a></tt> can be used.
<!--l. 1886--><p class="indent" >   The loop keywords <tt><a 
href="clmli7.html#x196-3479477r477">initially</a></tt> and <tt><a 
href="clmli7.html#x196-3479398r398">finally</a></tt> designate loop constructs
that cause expressions to be evaluated before and after the loop body,
respectively.
<!--l. 1890--><p class="indent" >   The code for any <tt><a 
href="clmli7.html#x196-3479477r477">initially</a></tt> clauses is collected into one <tt><a 
href="clmli7.html#x196-3479745r745">progn</a></tt> in the order in
which the clauses appeared in the loop. The collected code is executed once in the
loop prologue after any implicit variable initializations.
<!--l. 1895--><p class="indent" >   The code for any <tt><a 
href="clmli7.html#x196-3479398r398">finally</a></tt> clauses is collected into one <tt><a 
href="clmli7.html#x196-3479745r745">progn</a></tt> in the order in
which the clauses appeared in the loop. The collected code is executed once in the
loop epilogue before any implicit values are returned from the accumulation
clauses. Explicit returns in the loop body, however, will exit the loop without
executing the epilogue code.
<!--l. 1902--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">25.12.1   </span> <a 
href="clmli1.html#QQ2-166-2660" id="x166-261700025.12.1">Data Types</a></h4>
<!--l. 1905--><p class="noindent" >Many loop constructs take a <i>type-spec</i> argument that allows you to specify certain
data types for loop variables. While it is not necessary to specify a data type for
any variable, by doing so you ensure that the variable has a correctly typed initial
value. The type declaration is made available to the compiler for more eﬃcient
<tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt> expansion. In some implementations, ﬁxnum and ﬂoat declarations
are especially useful; the compiler notices them and emits more eﬃcient
code.
<!--l. 1918--><p class="indent" >   The <i>type-spec</i> argument has the following syntax: <div class="tabbing">
<i>type-spec</i> ::= <tt>of-type</tt> <i>d-type-spec</i>
   <br>           <i>d-type-spec</i> ::= <i>type-speciﬁer</i> | <tt>(<i>d-type-spec</i> . <i>d-type-spec</i>)</tt><br>
<!--l. 1922--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 1922--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-261800025.12.1" id="x166-261800025.12.1"></a></span>
   A <i>type-speciﬁer</i> in this syntax can be any Common Lisp type speciﬁer. The
<i>d-type-spec</i> argument is used for destructuring, as described in section <a 
href="#x166-262100025.12.2">25.12.2<!--tex4ht:ref: LOOP-DESTRUCTURING-SECTION --></a>. If
the <i>d-type-spec</i> argument consists solely of the types <tt>fixnum</tt>, <tt><a 
href="clmli7.html#x196-3479411r411">float</a></tt>, <tt><a 
href="clmli7.html#x196-3479935r935">t</a></tt>, or <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>, the
<tt>of-type</tt> keyword is optional. The <tt>of-type</tt> construct is optional in these cases to
provide backward compatibility; thus the following two expressions are the
same:
<div class="lisp">
<!--l. 1931--><p class="indent" >   <div class="tabbing">
;;; This expression uses the old syntax for type speciﬁers.
   <br>                                                      (loop for i ﬁxnum upfrom 3 ...)<br>
<br>                  ;;; This expression uses the new syntax for type speciﬁers.<br>
(loop for i of-type ﬁxnum upfrom 3 ...)<br>
<!--l. 1937--><p class="noindent" ></div>
<!--l. 1937--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-261900025.12.1" id="x166-261900025.12.1"></a></span>
<!--l. 1937--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-262000025.12.1" id="x166-262000025.12.1"></a></span>
</div>
<!--l. 1939--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">25.12.2   </span> <a 
href="clmli1.html#QQ2-166-2664" id="x166-262100025.12.2">Destructuring</a></h4>
<!--l. 1942--><p class="noindent" >Destructuring allows you to bind a set of variables to a corresponding set of values
anywhere that you can normally bind a value to a single variable. During <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt>
expansion, each variable in the variable list is matched with the values in
the values list. If there are more variables in the variable list than there
are values in the values list, the remaining variables are given a value of
<tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>. If there are more values than variables listed, the extra values are
discarded.
<!--l. 1951--><p class="indent" >   Suppose you want to assign values from a list to the variables <tt>a</tt>, <tt>b</tt>, and <tt>c</tt>. You
could use one <tt><a 
href="clmli7.html#x196-3479421r421">for</a></tt> clause to bind the variable <tt>numlist</tt> to the <i>car</i> of the speciﬁed
expression, and then you could use another <tt><a 
href="clmli7.html#x196-3479421r421">for</a></tt> clause to bind the variables <tt>a</tt>, <tt>b</tt>,
                                                                          

                                                                          
and <tt>c</tt> sequentially. <div class="lisp"><div class="tabbing">
;;; Collect values by using FOR constructs.
   <br>                            (loop for numlist in &#x2019;((1 2 4.0) (5 6 8.3) (8 9 10.4))<br>
      for a integer = (ﬁrst numlist)<br>
      and for b integer = (second numlist)<br>
      and for c ﬂoat = (third numlist)<br>                collect (list c b a))<br>
   <span class="math"> ⇒</span> ((4.0 2 1) (8.3 6 5) (10.4 9 8))<br>
<!--l. 1964--><p class="noindent" ></div>
<!--l. 1964--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-262200025.12.2" id="x166-262200025.12.2"></a></span>
<!--l. 1964--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-262300025.12.2" id="x166-262300025.12.2"></a></span>
</div>
<!--l. 1965--><p class="indent" >   Destructuring makes this process easier by allowing the variables to be bound
in parallel in each loop iteration. You can declare data types by using a
list of <i>type-spec</i> arguments. If all the types are the same, you can use a
shorthand destructuring syntax, as the second example following illustrates.
<div class="lisp"><div class="tabbing">
;;; Destructuring simpliﬁes the process.
   <br>                                         (loop for (a b c) (integer integer ﬂoat) in<br>
      &#x2019;((1 2 4.0) (5 6 8.3) (8 9 10.4))<br>
      collect (list c b a)))<br>              <span class="math"> ⇒</span> ((4.0 2 1) (8.3 6 5) (10.4 9 8))<br>
<br>                   ;;; If all the types are the same, this way is even simpler.<br>
(loop for (a b c) ﬂoat in<br>         &#x2019;((1.0 2.0 4.0) (5.0 6.0 8.3) (8.0 9.0 10.4))<br>
      collect (list c b a))<br>     <span class="math"> ⇒</span> ((4.0 2.0 1.0) (8.3 6.0 5.0) (10.4 9.0 8.0))<br>
<!--l. 1982--><p class="noindent" ></div>
<!--l. 1982--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-262400025.12.2" id="x166-262400025.12.2"></a></span>
                                                                          

                                                                          
<!--l. 1982--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-262500025.12.2" id="x166-262500025.12.2"></a></span>
</div>
<!--l. 1985--><p class="indent" >   If you use destructuring to declare or initialize a number of groups of variables
into types, you can use the loop keyword <tt><a 
href="clmli7.html#x196-3479085r85">and</a></tt> to simplify the process further.
<div class="lisp"><div class="tabbing">
;;; Initialize and declare variables in parallel
   <br>                                                      ;;; by using the AND construct.<br>
(loop with (a b) ﬂoat = &#x2019;(1.0 2.0)<br>               and (c d) integer = &#x2019;(3 4)<br>
      and (e f)<br>                                  return (list a b c d e f))<br>
   <span class="math"> ⇒</span> (1.0 2.0 3 4 NIL NIL)<br>
<!--l. 1996--><p class="noindent" ></div>
<!--l. 1996--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-262600025.12.2" id="x166-262600025.12.2"></a></span>
<!--l. 1996--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-262700025.12.2" id="x166-262700025.12.2"></a></span>
</div>
<!--l. 1998--><p class="indent" >   A data type speciﬁer for a destructuring pattern is a tree of type speciﬁers
with the same shape as the tree of variables, with the following exceptions:
      <ul class="itemize1">
      <li class="itemize">When aligning the trees, an atom in the type speciﬁer tree that matches
      a cons in the variable tree declares the same type for each variable.
      </li>
      <li class="itemize">A cons in the type speciﬁer tree that matches an atom in the variable
      tree is a non-atomic type specifer.
      </li></ul>
<div class="lisp">
<!--l. 2013--><p class="indent" >   <div class="tabbing">
;;; Declare X and Y to be of type VECTOR and FIXNUM, respectively.
   <br>                      (loop for (x y) of-type (vector ﬁxnum) in my-list do ...)<br>
                                                                          

                                                                          
<!--l. 2016--><p class="noindent" ></div>
<!--l. 2016--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-262800025.12.2" id="x166-262800025.12.2"></a></span>
<!--l. 2016--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-262900025.12.2" id="x166-262900025.12.2"></a></span>
</div>
<!--l. 2020--><p class="indent" >   If <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt> is used in a destructuring list, no variable is provided for its place.
<div class="lisp"><div class="tabbing">
(loop for (a nil b) = &#x2019;(1 2 3)
   <br>                                                               do (return (list a b)))<br>
   <span class="math"> ⇒</span> (1 3)<br>
<!--l. 2026--><p class="noindent" ></div>
<!--l. 2026--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263000025.12.2" id="x166-263000025.12.2"></a></span>
<!--l. 2026--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263100025.12.2" id="x166-263100025.12.2"></a></span>
</div>
<!--l. 2028--><p class="indent" >   Note that nonstandard lists can specify destructuring. <div class="lisp"><div class="tabbing">
(loop for (x . y) = &#x2019;(1 . 2)
   <br>                                  do (return y))<br>                               <span class="math"> ⇒</span> 2<br>
<br>                                                  (loop for ((a . b) (c . d))<br>
          of-type ((ﬂoat . ﬂoat) (integer . integer))<br>
          in &#x2019;(((1.2 . 2.4) (3 . 4)) ((3.4 . 4.6) (5 . 6)))<br>
      collect (list a b c d))<br>                <span class="math"> ⇒</span> ((1.2 2.4 3 4) (3.4 4.6 5 6))<br>
<!--l. 2039--><p class="noindent" ></div>
<!--l. 2039--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263200025.12.2" id="x166-263200025.12.2"></a></span>
                                                                          

                                                                          
<!--l. 2039--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263300025.12.2" id="x166-263300025.12.2"></a></span>
</div>
<!--l. 2041--><p class="indent" >   [It is worth noting that the destructuring facility of <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt> predates, and diﬀers
in some details from, that of <tt><a 
href="clmli7.html#x196-3479332r332">destructuring-bind</a></tt>, an extension that has been
provided by many implementors of Common Lisp.—GLS]
<div class="defmacheader">
<!--l. 2047--><p class="indent" >   <div class="tabbing">
 <i>[Выражение цикла]</i><b> initially </b> <a 
 id="dx166-2633001"></a><a 
 id="x166-2633002r829"></a> {expr}*
   <br>
<!--l. 2047--><p class="noindent" ></div>
<!--l. 2047--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263400025.12.2" id="x166-263400025.12.2"></a></span>
</div>
<div class="defmacheader">
<!--l. 2047--><p class="indent" >   <div class="tabbing">
 <i>[Выражение цикла]</i><b> ﬁnally </b> <a 
 id="dx166-2634001"></a><a 
 id="x166-2634002r830"></a> [<span class="math">do!|doing!]{expr}∗</span>
   <br>
<!--l. 2048--><p class="noindent" ></div>
<!--l. 2048--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263500025.12.2" id="x166-263500025.12.2"></a></span>
</div>
<div class="defmacheader">
<!--l. 2048--><p class="indent" >   <div class="tabbing">
 <i>[Выражение цикла]</i><b> ﬁnally </b> <a 
 id="dx166-2635001"></a><a 
 id="x166-2635002r831"></a> <span class="math"> return!expr</span>
   <br>
<!--l. 2050--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 2050--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263600025.12.2" id="x166-263600025.12.2"></a></span>
</div>
<!--l. 2051--><p class="indent" >   The <tt><a 
href="clmli7.html#x196-3479477r477">initially</a></tt> construct causes the speciﬁed expression to be evaluated in
the loop prologue, which precedes all loop code except for initial settings speciﬁed
by constructs <tt><a 
href="clmli7.html#x196-3479997r997">with</a></tt>, <tt><a 
href="clmli7.html#x196-3479421r421">for</a></tt>, or <tt><a 
href="clmli7.html#x196-3479110r110">as</a></tt>. The <tt><a 
href="clmli7.html#x196-3479398r398">finally</a></tt> construct causes the speciﬁed
expression to be evaluated in the loop epilogue after normal iteration
terminates.
<!--l. 2058--><p class="indent" >   The <i>expr</i> argument can be any non-atomic Common Lisp form.
<!--l. 2060--><p class="indent" >   Clauses such as <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt>, <tt><a 
href="clmli7.html#x196-3479084r84">always</a></tt>, <tt><a 
href="clmli7.html#x196-3479646r646">never</a></tt>, and <tt><a 
href="clmli7.html#x196-3479944r944">thereis</a></tt> can bypass the <tt><a 
href="clmli7.html#x196-3479398r398">finally</a></tt>
clause.
<!--l. 2063--><p class="indent" >   The Common Lisp macro <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> (or the <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> loop construct) can be
used after <tt><a 
href="clmli7.html#x196-3479398r398">finally</a></tt> to return values from a loop. The evaluation of the
<tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> form inside the <tt><a 
href="clmli7.html#x196-3479398r398">finally</a></tt> clause takes precedence over returning the
accumulation from clauses speciﬁed by such keywords as <tt><a 
href="clmli7.html#x196-3479239r239">collect</a></tt>, <tt><a 
href="clmli7.html#x196-3479644r644">nconc</a></tt>,
<tt><a 
href="clmli7.html#x196-3479086r86">append</a></tt>, <tt><a 
href="clmli7.html#x196-3479923r923">sum</a></tt>, <tt><a 
href="clmli7.html#x196-3479292r292">count</a></tt>, <tt><a 
href="clmli7.html#x196-3479606r606">maximize</a></tt>, and <tt><a 
href="clmli7.html#x196-3479617r617">minimize</a></tt>; the accumulation values
for these pre-empted clauses are not returned by the loop if <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> is
used.
<!--l. 2072--><p class="indent" >   The constructs <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>, <tt><a 
href="clmli7.html#x196-3479477r477">initially</a></tt>, and <tt><a 
href="clmli7.html#x196-3479398r398">finally</a></tt> are the only loop keywords that
take an arbitrary number of (non-atomic) forms and group them as if by using an
implicit <tt><a 
href="clmli7.html#x196-3479745r745">progn</a></tt>.
<!--l. 2078--><p class="indent" >   Examples: <div class="lisp"><div class="tabbing">
;;; This example parses a simple printed string representation
   <br>                  ;;; from BUFFER (which is itself a string) and returns the<br>
;;; index of the closing double-quote character.<br>
<br>                         (loop initially (unless (char= (char buﬀer 0) #\&#x0022;)<br>
                  (loop-ﬁnish))<br>
      for i ﬁxnum from 1 below (string-length buﬀer)<br>
      when (char= (char buﬀer i) #\&#x0022;)<br>                         return i)<br>
<br>                          ;;; The FINALLY clause prints the last value of I.<br>
;;; The collected value is returned.<br>         <br>            (loop for i from 1 to 10<br>
      when (&#x003E; i 5)<br>                                              collect i<br>
      ﬁnally (print i))                                       ;Prints 1 line<br>
11<br>                                                        <span class="math"> ⇒</span> (6 7 8 9 10)<br>
<br>                             ;;; Return both the count of collected numbers<br>
;;; as well as the numbers themselves.<br>                                      <br>
                                                                          

                                                                          
(loop for i from 1 to 10<br>                                      when (&#x003E; i 5)<br>
        collect i into number-list<br>         and count i into number-count<br>
      ﬁnally (return (values number-count number-list)))<br>
   <span class="math"> ⇒</span> 5 and (6 7 8 9 10)<br>
<!--l. 2109--><p class="noindent" ></div>
<!--l. 2109--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263700025.12.2" id="x166-263700025.12.2"></a></span>
<!--l. 2109--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263800025.12.2" id="x166-263800025.12.2"></a></span>
</div>
<div class="defmacheader">
<!--l. 2113--><p class="indent" >   <div class="tabbing">
 <i>[Выражение цикла]</i><b> named </b> <a 
 id="dx166-2638001"></a><a 
 id="x166-2638002r832"></a> name
   <br>
<!--l. 2114--><p class="noindent" ></div>
<!--l. 2114--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-263900025.12.2" id="x166-263900025.12.2"></a></span>
</div>
<!--l. 2115--><p class="indent" >   The <tt><a 
href="clmli7.html#x196-3479641r641">named</a></tt> construct allows you to assign a name to a <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt> construct so that
you can use the Common Lisp special operator <tt><a 
href="clmli7.html#x196-3479799r799">return-from</a></tt> to exit the named
loop.
<!--l. 2119--><p class="indent" >   Only one name may be assigned per loop; the speciﬁed name becomes the
name of the implicit block for the loop.
<!--l. 2122--><p class="indent" >   If used, the <tt><a 
href="clmli7.html#x196-3479641r641">named</a></tt> construct must be the ﬁrst clause in the loop expression,
coming right after the word <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt>.
<!--l. 2126--><p class="indent" >   Example: <div class="lisp"><div class="tabbing">
;;; Just name and return.
   <br>                                                                        (loop named max<br>
      for i from 1 to 10<br>                                      do (print i)<br>
      do (return-from max &#x2019;done))                           ;Prints 1 line<br>
1<br>                                                              <span class="math"> ⇒</span> DONE<br>
                                                                          

                                                                          
<!--l. 2135--><p class="noindent" ></div>
<!--l. 2135--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-264000025.12.2" id="x166-264000025.12.2"></a></span>
<!--l. 2135--><p class="noindent" ><span class="paragraphHead"><a 
href="#x166-264100025.12.2" id="x166-264100025.12.2"></a></span>
</div>
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
<!--l. 7--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmch26.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse135.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse135.html#tailclmse135.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse136.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch25.html#clmse136.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse136.html"></a>   </div> </div> 
</body></html> 
