<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Pretty Printing Dispatch Tables</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-16 00:55:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 937--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmch27.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse140.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse140.html#tailclmse140.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse141.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch26.html#clmse141.html" >Наверх</a><tt>&#x003E;</tt></div><h3 class="sectionHead"><span class="titlemark">26.6   </span> <a 
href="clm.html#QQ2-172-2527" id="x172-250400026.6">Pretty Printing
Dispatch Tables</a></h3>
<!--l. 939--><p class="noindent" >When <tt><a 
href="clmse111.html#x138-1845002r642">*print-pretty*</a></tt> is not <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>, the pprint dispatch table in the variable
<tt>*print-pprint-dispatch*</tt> controls how objects are printed. The information in
this table takes precedence over all other mechanisms for specifying how to print
objects. In particular, it overrides user-deﬁned <tt><a 
href="clmse143.html#x175-2661004r907">print-object</a></tt> methods and print
functions for structures. However, if there is no speciﬁcation for how to pretty
print a particular kind of object, it is then printed using the standard mechanisms
as if <tt><a 
href="clmse111.html#x138-1845002r642">*print-pretty*</a></tt> were <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>.
<!--l. 947--><p class="indent" >   A pprint dispatch table is a mapping from keys to pairs of values. The keys are
type speciﬁers. The values are functions and numerical priorities. Basic insertion
and retrieval is done based on the keys with the equality of keys being tested by
<tt><a 
href="clmse33.html#x44-405002r46">equal</a></tt>. The function to use when pretty printing an object is chosen by ﬁnding the
highest priority function in <tt>*print-pprint-dispatch*</tt> that is associated with a
type speciﬁer that matches the object.
<div class="defun">
<!--l. 955--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx172-2504001"></a><a 
 id="x172-2504002r841"></a><b> copy-pprint-dispatch</b>  &#x0026;optional  <i>table</i>
</div>
<!--l. 957--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-250500026.6" id="x172-250500026.6"></a></span>
   A copy is made of <i>table</i>, which defaults to the current pprint dispatch table. If
<i>table</i> is <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>, a copy is returned of the initial value of <tt>*print-pprint-dispatch*</tt>.
</div>
<div class="defun">
<!--l. 963--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx172-2505001"></a><a 
 id="x172-2505002r842"></a><b> pprint-dispatch</b>  <i>object</i> &#x0026;optional  <i>table</i>
</div>
<!--l. 965--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-250600026.6" id="x172-250600026.6"></a></span>
   This retrieves the highest priority function from a pprint table that is
associated with a type speciﬁer in the table that matches <i>object</i>. The
function is chosen by ﬁnding all the type speciﬁers in <i>table</i> that match the
object and selecting the highest priority function associated with any of
these type speciﬁers. If there is more than one highest priority function,
                                                                          

                                                                          
an arbitrary choice is made. If no type speciﬁers match the object, a
function is returned that prints object with <tt><a 
href="clmse111.html#x138-1845002r642">*print-pretty*</a></tt> bound to
<tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>.
<!--l. 975--><p class="indent" >   As a second return value, <tt><a 
href="#x172-2505002r842">pprint-dispatch</a></tt> returns a ﬂag that is <tt><a 
href="clmse31.html#x42-313002r19">t</a></tt> if a
matching type speciﬁer was found in <i>table</i> and <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> if not.
<i>
<!--l. 978--><p class="indent" >   Table</i> (which defaults to <tt>*print-pprint-dispatch*</tt>) must be a pprint
dispatch table. <i>Table</i> can be <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>, in which case retrieval is done in the initial
value of <tt>*print-pprint-dispatch*</tt>.
<!--l. 982--><p class="indent" >   When <tt><a 
href="clmse111.html#x138-1845002r642">*print-pretty*</a></tt> is <tt><a 
href="clmse31.html#x42-313002r19">t</a></tt>, <tt>(write object :stream s)</tt> is equivalent to
<tt>(funcall (pprint-dispatch object) s object)</tt>.
</div>
<div class="defun">
<!--l. 986--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx172-2506001"></a><a 
 id="x172-2506002r843"></a><b> set-pprint-dispatch</b>  <i>type</i> <i>function</i> &#x0026;optional  <i>priority</i> <i>table</i>
</div>
<!--l. 988--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-250700026.6" id="x172-250700026.6"></a></span>
   This puts an entry into a pprint dispatch table and returns <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>. The type must
be a valid type speciﬁer and is the key of the entry. The ﬁrst action of
<tt><a 
href="#x172-2506002r843">set-pprint-dispatch</a></tt> is to remove any pre-existing entry associated with <i>type</i>.
This guarantees that there will never be two entries associated with the same type
speciﬁer in a given pprint dispatch table. Equality of type speciﬁers is tested by
<tt><a 
href="clmse33.html#x44-405002r46">equal</a></tt>.
<!--l. 997--><p class="indent" >   Two values are associated with each type speciﬁer in a pprint dispatch table: a
function and a priority. The <i>function</i> must accept two arguments: the stream to
send output to and the object to be printed. The <i>function</i> should pretty print the
object on the stream. The function can assume that object satisﬁes <i>type</i>. The
<i>function</i> should obey <tt>*print-readably*</tt>. Any values returned by the <i>function</i> are
ignored.
<!--l. 1005--><p class="indent" >   The <i>priority</i> (which defaults to 0) must be a non-complex number. This
number is used as a priority to resolve conﬂicts when an object matches more
than one entry. An error is signaled if priority fails to be a non-complex
number.
<!--l. 1010--><p class="indent" >   The <i>table</i> (which defaults to the value of <tt>*print-pprint-dispatch*</tt>)
must be a pprint dispatch table. The speciﬁed entry is placed in this
table.
<!--l. 1013--><p class="indent" >   It is permissible for <i>function</i> to be <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>. In this situation, there will be no <i>type</i>
                                                                          

                                                                          
entry in <i>table</i> after <tt><a 
href="#x172-2506002r843">set-pprint-dispatch</a></tt> is evaluated.
<!--l. 1017--><p class="indent" >   To facilitate the use of pprint dispatch tables for controlling the
pretty printing of Lisp code, the <i>type-speciﬁer</i> argument of the function
<tt><a 
href="#x172-2506002r843">set-pprint-dispatch</a></tt> is allowed to contain the form <tt>(cons</tt> car-type cdr-type<tt>)</tt>.
This form indicates that the corresponding object must be a cons whose
<i>car</i> satisﬁes the type speciﬁer <i>car-type</i> and whose <i>cdr</i> satisﬁes the type
speciﬁer <i>cdr-type</i>. The <i>cdr-type</i> can be omitted, in which case it defaults to
<tt><a 
href="clmse31.html#x42-313002r19">t</a></tt>.
</div>
<!--l. 1027--><p class="indent" >   The initial value of <tt>*print-pprint-dispatch*</tt> is implementation-dependent.
However, the initial entries all use a special class of priorities that are less than
every priority that can be speciﬁed using <tt><a 
href="#x172-2506002r843">set-pprint-dispatch</a></tt>. This guarantees
that pretty printing functions speciﬁed by users will override everything in the
initial value of <tt>*print-pprint-dispatch*</tt>.
<!--l. 1034--><p class="indent" >   Consider the following examples. The ﬁrst form restores <tt>*print-pprint-dispatch*</tt>
to its initial value. The next two forms then specify a special way of pretty
printing ratios. Note that the more speciﬁc type speciﬁer has to be associated
with a higher priority. <div class="lisp"><div class="tabbing">
(setq *print-pprint-dispatch*
   <br>                               (copy-pprint-dispatch nil))<br>                         <br>
(defun div-print (s r colon? atsign?)<br>       (declare (ignore colon? atsign?))<br>
  (format s &#x0022;(/ ~D ~D)&#x0022; (numerator (abs r)) (denominator r)))<br>
<br>                   (set-pprint-dispatch &#x2019;ratio (formatter &#x0022;#.~/div-print/&#x0022;))<br>
<br>                         (set-pprint-dispatch &#x2019;(and ratio (satisﬁes minusp))<br>
  (formatter &#x0022;#.(- ~/div-print/)&#x0022;)<br>                    5)<br>                  <br>
(pprint &#x2019;(1/3 -2/3)) prints: (#.(/ 1 3) #.(- (/ 2 3)))<br>
<!--l. 1053--><p class="noindent" ></div>
<!--l. 1053--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-250800026.6" id="x172-250800026.6"></a></span>
<!--l. 1053--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-250900026.6" id="x172-250900026.6"></a></span>
</div>
                                                                          

                                                                          
<!--l. 1055--><p class="indent" >   The following two forms illustrate the speciﬁcation of pretty printing
functions for particular types of Lisp code. The ﬁrst form illustrates how
to specify the traditional method for printing quoted objects using “<tt>&#x2019;</tt>”
syntax. Note the care taken to ensure that data lists that happen to begin
with <tt><a 
href="clmse35.html#x47-426002r51">quote</a></tt> will be printed readably. The second form speciﬁes that lists
beginning with the symbol <tt>my-let</tt> should print the same way that lists
beginning with <tt><a 
href="clmse39.html#x51-590002r79">let</a></tt> print when the initial pprint dispatch table is in eﬀect.
<div class="lisp"><div class="tabbing">
(set-pprint-dispatch &#x2019;(cons (member quote))
   <br>   #&#x2019;(lambda (s list)<br>       (if (and (consp (cdr list)) (null (cddr list)))<br>
          (funcall (formatter &#x0022;&#x2019;~W&#x0022;) s (cadr list))<br>
          (pprint-ﬁll s list)))))<br>                                           <br>
(set-pprint-dispatch &#x2019;(cons (member my-let))<br>    (pprint-dispatch &#x2019;(let) nil))<br>
<br>
<!--l. 1071--><p class="noindent" ></div>
<!--l. 1071--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251000026.6" id="x172-251000026.6"></a></span>
<!--l. 1071--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251100026.6" id="x172-251100026.6"></a></span>
</div>
<!--l. 1073--><p class="indent" >   The next example speciﬁes a default method for printing lists that do
not correspond to function calls. Note that, as shown in the deﬁnition of
<tt><a 
href="clmse138.html#x169-2461006r839">pprint-tabular</a></tt> above, <tt><a 
href="clmse138.html#x169-2461004r838">pprint-linear</a></tt>, <tt><a 
href="clmse138.html#x169-2461002r837">pprint-fill</a></tt>, and <tt><a 
href="clmse138.html#x169-2461006r839">pprint-tabular</a></tt> are
deﬁned with optional colon and atsign arguments so that they can be used as
pprint dispatch functions as well as <tt>~/.../</tt> functions. <div class="lisp"><div class="tabbing">
(set-pprint-dispatch
   <br>        &#x2019;(cons (not (and symbol (satisﬁes fboundp))))<br>        #&#x2019;pprint-ﬁll<br>
  -5)<br>
<!--l. 1083--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 1083--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251200026.6" id="x172-251200026.6"></a></span>
<!--l. 1083--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251300026.6" id="x172-251300026.6"></a></span>
</div>
<!--l. 1084--><p class="indent" >   With a line length of 9, <tt>(pprint &#x2019;(0 b c d e f g h i j k))</tt> prints:
<div class="lisp"><div class="tabbing">
(0 b c d
   <br>                                                                                      e f g h<br>
 i j k)<br>
<!--l. 1089--><p class="noindent" ></div>
<!--l. 1089--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251400026.6" id="x172-251400026.6"></a></span>
<!--l. 1089--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251500026.6" id="x172-251500026.6"></a></span>
</div>
<!--l. 1091--><p class="indent" >   This ﬁnal example shows how to deﬁne a pretty printing function for a user
deﬁned data structure. <div class="lisp"><div class="tabbing">
(defstruct family mom kids)
   <br>                                                                                               <br>
(set-pprint-dispatch &#x2019;family<br>                                #&#x2019;(lambda (s f)<br>
      (format s &#x0022;~@&#x003C;#&#x003C;~;~W and ~2I~_~/pprint-ﬁll/~;&#x003E;~:&#x003E;&#x0022;<br>
              (family-mom f) (family-kids f))))<br>
<!--l. 1101--><p class="noindent" ></div>
<!--l. 1101--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251600026.6" id="x172-251600026.6"></a></span>
                                                                          

                                                                          
<!--l. 1101--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251700026.6" id="x172-251700026.6"></a></span>
</div>
<!--l. 1103--><p class="indent" >   The pretty printing function for the structure <tt>family</tt> speciﬁes how to adjust
the layout of the output so that it can ﬁt aesthetically into a variety of line
widths. In addition, it obeys the printer control variables <tt>*print-level*</tt>,
<tt>*print-length*</tt>, <tt>*print-lines*</tt>, <tt><a 
href="clmse111.html#x138-1846003r643">*print-circle*</a></tt>, <tt>*print-shared*</tt>, and
<tt><a 
href="clmse111.html#x138-1844002r641">*print-escape*</a></tt>, and can tolerate several diﬀerent kinds of malformity in the
data structure. The output below shows what is printed out with a right margin
of 25, <tt><a 
href="clmse111.html#x138-1845002r642">*print-pretty*</a></tt> <tt><a 
href="clmse31.html#x42-313002r19">t</a></tt>, <tt><a 
href="clmse111.html#x138-1844002r641">*print-escape*</a></tt> <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>, and a malformed <tt>kids</tt> list.
<div class="lisp"><div class="tabbing">
(write (list &#x2019;principal-family
   <br>                                                    (make-family :mom &#x0022;Lucy&#x0022;<br>
                          :kids &#x2019;(&#x0022;Mark&#x0022; &#x0022;Bob&#x0022; . &#x0022;Dan&#x0022;)))<br>
       :right-margin 25 :pretty T :escape nil :miser-width nil)<br>             <br>
(PRINCIPAL-FAMILY<br>                                       #&#x003C;Lucy and<br>
     Mark Bob . Dan&#x003E;)<br>
<!--l. 1120--><p class="noindent" ></div>
<!--l. 1120--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251800026.6" id="x172-251800026.6"></a></span>
<!--l. 1120--><p class="noindent" ><span class="paragraphHead"><a 
href="#x172-251900026.6" id="x172-251900026.6"></a></span>
</div>
<!--l. 1122--><p class="indent" >   Note that a pretty printing function for a structure is diﬀerent from the
structure&#x2019;s print function. While print functions are permanently associated with
a structure, pretty printing functions are stored in pprint dispatch tables and can
be rapidly changed to reﬂect diﬀerent printing needs. If there is no pretty printing
function for a structure in the current print dispatch table, the print function (if
any) is used instead.
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
<!--l. 19--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmch27.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse140.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse140.html#tailclmse140.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse141.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch26.html#clmse141.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse141.html"></a>   </div> </div> 
</body></html> 
