<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>How to Use Defstruct Как использовать defstruct</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-19 00:40:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 278--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse100.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse98.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse98.html#tailclmse98.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse99.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch19.html#clmse99.html" >Вверх</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">19.2   </span> <a 
 id="x123-22700019.2"></a>How to Use Defstruct Как использовать defstruct</h3>
<!--l. 280--><p class="noindent" >All structures are deﬁned through the <a 
href="#x123-227002r580">defstruct</a> construct. A call to <a 
href="#x123-227002r580">defstruct</a>
deﬁnes a new data type whose instances have named slots.
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> defstruct </b><a 
 id="dx123-227001"></a><a 
 id="x123-227002r580"></a> name-and-options [doc-string]  {slot-description}+
</td></tr></table>
<!--l. 286--><p class="indent" >
</div>
<!--l. 286--><p class="noindent" ><span class="paragraphHead"><a 
 id="x123-22800019.2"></a></span>
   <div class=new>X3J13 voted in June 1988 <a 
 id="dx123-228001"></a>to allow a <a 
href="#x123-227002r580">defstruct</a> deﬁnition to have no
<i>slot-description</i> at all; in other words, the occurrence of {<i><i>slot-description</i></i>}+ in
the preceding header line would be replaced by  {<i><i>slot-description</i></i>}* .
<!--l. 295--><p class="indent" >   Such structure deﬁnitions are particularly useful if the :include option is used,
perhaps with other options; for example, one can have two structures that are
exactly alike except that they print diﬀerently (having diﬀerent :print-function
options).
<!--l. 300--><p class="indent" >   Implementors are encouraged to permit this simple extension as soon as
convenient. Users, however, may wish to maximize portability of their code by
avoiding the use of this extension unless and until it is adopted as part of the
ANSI standard.
</div>
<!--l. 306--><p class="indent" >   This deﬁnes a record-structure data type. A general call to <a 
href="#x123-227002r580">defstruct</a> looks like
the following example. <div class=lisp><div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defstruct (<i>name</i> <i>option-1</i> <i>option-2</i> ... <i>option-m</i>)
</td></tr></table>
<!--l. 309--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">           <i>doc-string</i></td></tr></table>
<!--l. 310--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">           <i>slot-description-1</i></td></tr></table>
<!--l. 311--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">           <i>slot-description-2</i></td></tr></table>
<!--l. 312--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">           ...</td></tr></table>
<!--l. 313--><p class="indent" >                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">           <i>slot-description-n</i>)</td></tr></table>
<!--l. 314--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 315--><p class="indent" >
</div>
</div>
<!--l. 316--><p class="noindent" >The <i>name</i> must be a symbol; it becomes the name of a new data type consisting of
all instances of the structure. The function <a 
href="clmse32.html#x43-76002r20">typep</a> will accept and use this
name as appropriate. The <i>name</i> is returned as the value of the <i>defstruct</i>
form.
<!--l. 322--><p class="indent" >   Usually no options are needed at all. If no options are speciﬁed, then one may
write simply <i>name</i> instead of (<i>name</i>) after the word <a 
href="#x123-227002r580">defstruct</a>. The syntax of
options and the options provided are discussed in section <a 
href="clmse102.html#x126-23100019.5">19.5<!--tex4ht:ref: DEFSTRUCT-OPTIONS --></a>.
<!--l. 327--><p class="indent" >   If the optional documentation string <i>doc-string</i> is present, then it is
attached to the <i>name</i> as a documentation string of type structure; see
<a 
href="clmse146.html#x179-417017r889">documentation</a>.
<!--l. 331--><p class="indent" >   Each <i>slot-description-j</i> is of the form <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(<i>slot-name</i> <i>default-init</i>
</td></tr></table>
<!--l. 333--><p class="indent" >                               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">     <i>slot-option-name-1</i> <i>slot-option-value-1</i></td></tr></table>
<!--l. 334--><p class="indent" >                               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">     <i>slot-option-name-2</i> <i>slot-option-value-2</i></td></tr></table>
<!--l. 335--><p class="indent" >                                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">     ...</td></tr></table>
<!--l. 336--><p class="indent" >                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">     <i>slot-option-name-k<span class="math"><sub>j</sub></span></i> <i>slot-option-value-k<span class="math"><sub>j</sub></span></i>)</td></tr></table>
<!--l. 338--><p class="indent" >
</div>
</div>
<!--l. 339--><p class="noindent" >Each <i>slot-name</i> must be a symbol; an access function is deﬁned for each slot. If no
options and no <i>default-init</i> are speciﬁed, then one may write simply <i>slot-name</i>
instead of (<i>slot-name</i>) as the slot description.
                                                                          

                                                                          
<div class=obsolete>
<!--l. 345--><p class="indent" >   The <i>default-init</i> is a form that is evaluated <i>each time</i> a structure is to be
constructed; the value is used as the initial value of the slot.
</div>
<div class=newer>
<!--l. 351--><p class="indent" >   X3J13 voted in October 1988 <a 
 id="dx123-228002"></a>to clarify that a <i>default-init</i> form is evaluated
only if the corresponding argument is not supplied to the constructor function.
The preceding sentence should therefore read as follows:
<!--l. 356--><p class="indent" >   The <i>default-init</i> is a form that is evaluated <i>each time</i> its value is to be used as
the initial value of the slot.
</div> If no <i>default-init</i> is speciﬁed, then the initial contents of the slot are undeﬁned
and implementation-dependent. The available slot-options are described in
section <a 
href="clmse101.html#x125-23000019.4">19.4<!--tex4ht:ref: Defstruct-Slot-Options --></a>.
<div class=incompatibility>
<!--l. 366--><p class="noindent" ><b>Compatibility note:</b> Slot-options are not currently provided in Lisp Machine Lisp, but
this is an upward-compatible extension.
</div>
<div class=new>
<!--l. 373--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx123-228003"></a>to specify that it is an error for two slots
to have the same name; more precisely, no two slots may have names
for whose print names <a 
href="clmse96.html#x119-223002r557">string=</a> would be true. Under this interpretation
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defstruct lotsa-slots slot slot)
</td></tr></table>
<!--l. 381--><p class="indent" >
</div>
</div>
<!--l. 382--><p class="noindent" >obviously is incorrect but the following one is also in error, even assuming that
the symbols coin:slot and blot:slot really are distinct (non-<a 
href="clmse33.html#x44-78004r45">eql</a>) symbols:
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defstruct no-dice coin:slot blot:slot)
</td></tr></table>
<!--l. 387--><p class="indent" >
                                                                          

                                                                          
</div>
</div>
<!--l. 388--><p class="noindent" >To illustrate another case, the ﬁrst <a 
href="#x123-227002r580">defstruct</a> form below is correct, but the second
one is in error. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defstruct one-slot slot)
</td></tr></table>
<!--l. 391--><p class="indent" >                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defstruct (two-slots (:include one-slot)) slot)</td></tr></table>
<!--l. 393--><p class="indent" >
</div>
</div>
<div class=rationale>
<!--l. 396--><p class="noindent" ><b>Rationale:</b> Print names are the criterion for slot-names being the same, rather
than the symbols themselves, because <a 
href="#x123-227002r580">defstruct</a> constructs names of accessor
functions from the print names and interns the resulting new names in the current
package.
</div>
<!--l. 405--><p class="indent" >   X3J13 recommended that expanding a <a 
href="#x123-227002r580">defstruct</a> form violating this restriction
should signal an error and noted, with an eye to the Common Lisp Object
System <a 
 id="dx123-228004"></a>, that the restriction applies only to the operation of the <a 
href="#x123-227002r580">defstruct</a>
macro as such and not to the structure-class or structures deﬁned with
<a 
href="clmse146.html#x179-413022r877">defclass</a>.
</div>
<div class=newer>
<!--l. 415--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx123-228005"></a>to clarify that, while deﬁning forms normally
appear at top level, it is meaningful to place them in non-top-level contexts;
<a 
href="#x123-227002r580">defstruct</a> must treat slot <i>default-init</i> forms and any initialization forms within the
                                                                          

                                                                          
speciﬁcation of a by-position constructor function as occurring within the
enclosing lexical environment, not within the global environment.
</div>
<!--l. 426--><p class="indent" >   <a 
href="#x123-227002r580">defstruct</a> not only deﬁnes an access function for each slot, but also arranges for
<a 
href="clmse36.html#x48-90002r64">setf</a> to work properly on such access functions, deﬁnes a predicate named
<i>name</i>-p, deﬁnes a constructor function named make-<i>name</i>, and deﬁnes a
copier function named copy-<i>name</i>. All names of automatically created
functions are interned in whatever package is current at the time the
<a 
href="#x123-227002r580">defstruct</a> form is processed (see <a 
href="clmse60.html#x76-168002r141">*package*</a>). Also, all such functions may
be declared inline at the discretion of the implementation to improve
eﬃciency; if you do not want some function declared inline, follow the
<a 
href="#x123-227002r580">defstruct</a> form with a notinline declaration to override any automatic inline
declaration.
<div class=newer>
<!--l. 441--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx123-228006"></a>to specify that the results of redeﬁning a
<a 
href="#x123-227002r580">defstruct</a> structure (that is, evaluating more than one <a 
href="#x123-227002r580">defstruct</a> structure for the
same name) are undeﬁned.
<!--l. 446--><p class="indent" >   The problem is that if instances have been created under the old deﬁnition and
then remain accessible after the new deﬁnition has been evaluated, the accessors
and other functions for the new deﬁnition may be incompatible with the old
instances. Conversely, functions associated with the old deﬁnition may have been
declared inline and compiled into code that remains accessible after the new
deﬁnition has been evaluated; such code may be incompatible with the new
instances.
<!--l. 454--><p class="indent" >   In practice this restriction aﬀects the development and debugging process
rather than production runs of fully developed code. The <a 
href="#x123-227002r580">defstruct</a> feature is
intended to provide “the most eﬃcient” structure class. CLOS classes
deﬁned by <a 
href="clmse146.html#x179-413022r877">defclass</a> allow much more ﬂexible structures to be deﬁned and
redeﬁned.
<!--l. 461--><p class="indent" >   Programming environments are allowed and encouraged to permit <a 
href="#x123-227002r580">defstruct</a>
redeﬁnition, perhaps with warning messages about possible interactions with
other parts of the programming environment or memory state. It is beyond the
scope of the Common Lisp language standard to deﬁne those interactions except
to note that they are not portable.
</div>
</div>
                                                                          

                                                                          
   <!--l. 470--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse100.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse98.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse98.html#tailclmse98.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse99.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch19.html#clmse99.html" >Вверх</a><tt>&#x003E;</tt></p></div>
<!--l. 470--><p class="indent" >   <a 
 id="tailclmse99.html"></a>  
</body></html> 
