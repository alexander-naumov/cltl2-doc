<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Compiler Macros</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-16 00:55:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 1662--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse49.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse47.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse47.html#tailclmse47.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse48.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse48.html" >Наверх</a><tt>&#x003E;</tt></div><h3 class="sectionHead"><span class="titlemark">8.4   </span> <a 
href="clm.html#QQ2-61-811" id="x61-8030008.4">Compiler
Macros</a></h3>
<!--l. 1664--><p class="noindent" >X3J13 voted in June 1989 <a 
 id="dx61-803001"></a>to add a facility for deﬁning <i>compiler macros</i> that take
eﬀect only when compiling code, not when interpreting it.
<!--l. 1668--><p class="indent" >   The purpose of this facility is to permit selective source-code transformations
only when the compiler is processing the code. When the compiler is about to
compile a non-atomic form, it ﬁrst calls <tt>compiler-macroexpand-1</tt> repeatedly
until there is no more expansion (there might not be any to begin with). Then it
continues its remaining processing, which may include calling <tt><a 
href="clmse46.html#x59-798004r126">macroexpand-1</a></tt> and
so on.
<!--l. 1675--><p class="indent" >   The compiler is required to expand compiler macros. It is unspeciﬁed whether
the interpreter does so. The intention is that only the compiler will do so, but the
range of possible “compiled-only” implementation strategies precludes any ﬁrm
speciﬁcation.
<div class="defmac">
<div class="defmacheader">
<!--l. 1682--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i><b> deﬁne-compiler-macro </b><a 
 id="dx61-803002"></a><a 
 id="x61-803003r129"></a> name lambda-list
   <br>                                               {declaration | doc-string}* {form}*<br>
<!--l. 1684--><p class="noindent" ></div>
<!--l. 1684--><p class="noindent" ><span class="paragraphHead"><a 
href="#x61-8040008.4" id="x61-8040008.4"></a></span>
</div>
<!--l. 1685--><p class="indent" >   This is just like <tt><a 
href="clmse45.html#x58-756002r124">defmacro</a></tt> except the deﬁnition is not stored in the symbol
function cell of <i>name</i> and is not seen by <tt><a 
href="clmse46.html#x59-798004r126">macroexpand-1</a></tt>. It is, however, seen by
<tt>compiler-macroexpand-1</tt>. As with <tt><a 
href="clmse45.html#x58-756002r124">defmacro</a></tt>, the <i>lambda-list</i> may include
<tt>&#x0026;environment</tt> and <tt>&#x0026;whole</tt> and may include destructuring. The deﬁnition is
global. (There is no provision for deﬁning local compiler macros in the way that
<tt><a 
href="clmse39.html#x51-601002r84">macrolet</a></tt> deﬁnes local macros.)
                                                                          

                                                                          
<!--l. 1693--><p class="indent" >   A top-level call to <tt><a 
href="#x61-803003r129">define-compiler-macro</a></tt> in a ﬁle being compiled by
<tt><a 
href="clmse120.html#x149-2180004r737">compile-file</a></tt> has an eﬀect on the compilation environment similar to
that of a call to <tt><a 
href="clmse45.html#x58-756002r124">defmacro</a></tt>, except it is noticed as a compiler macro (see
section <a 
href="clmse120.html#x149-217700024.1">24.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
<!--l. 1698--><p class="indent" >   Note that compiler macro deﬁnitions do not appear in information returned by
<tt><a 
href="clmse49.html#x62-810002r134">function-information</a></tt>; they are global, and their interaction with other lexical
and global deﬁnitions can be reconstructed by <tt><a 
href="#x61-804003r130">compiler-macro-function</a></tt>. It is
up to code-walking programs to decide whether to invoke compiler macro
expansion.
<div class="newer">
<!--l. 1706--><p class="indent" >   X3J13 voted in March 1988 <a 
 id="dx61-804001"></a>to specify that the body of the expander function
deﬁned by <tt><a 
href="clmse45.html#x58-756002r124">defmacro</a></tt> is implicitly enclosed in a <tt><a 
href="clmse41.html#x53-640002r93">block</a></tt> construct whose name is the
same as the <i>name</i> of the deﬁned macro; presumably this applies also to
<tt><a 
href="#x61-803003r129">define-compiler-macro</a></tt>. Therefore <tt><a 
href="clmse41.html#x53-643002r94">return-from</a></tt> may be used to exit from the
function.
</div>
</div>
<div class="defun">
<!--l. 1716--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx61-804002"></a><a 
 id="x61-804003r130"></a><b> compiler-macro-function</b>  <i>name</i> &#x0026;optional  <i>env</i>
</div>
<!--l. 1718--><p class="noindent" ><span class="paragraphHead"><a 
href="#x61-8050008.4" id="x61-8050008.4"></a></span>
   The <i>name</i> must be a symbol. If it has been deﬁned as a compiler macro, then
<tt><a 
href="#x61-804003r130">compiler-macro-function</a></tt> returns the macro expansion function; otherwise it
returns <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>. The lexical environment <i>env</i> may override any global deﬁnition for
<i>name</i> by deﬁning a local function or local macro (such as by <tt><a 
href="clmse39.html#x51-599002r82">flet</a></tt>, <tt><a 
href="clmse39.html#x51-600002r83">labels</a></tt>, or
<tt><a 
href="clmse39.html#x51-601002r84">macrolet</a></tt>) in which case <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> is returned.
<tt>
<!--l. 1727--><p class="indent" >   <a 
href="clmse36.html#x48-474002r64">setf</a></tt> may be used with <tt><a 
href="#x61-804003r130">compiler-macro-function</a></tt> to install a function as the
expansion function for the compiler macro <i>name</i>, in the same manner as for
<tt><a 
href="clmse45.html#x58-753002r123">macro-function</a></tt>. Storing the value <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> removes any existing compiler macro
deﬁnition. As with <tt><a 
href="clmse45.html#x58-753002r123">macro-function</a></tt>, a non-<tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> stored value must be a function of
two arguments, the entire macro call and the environment. The second
argument to <tt><a 
href="#x61-804003r130">compiler-macro-function</a></tt> must be omitted when it is used with
<tt><a 
href="clmse36.html#x48-474002r64">setf</a></tt>.
</div>
<div class="defun">
                                                                          

                                                                          
<!--l. 1736--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx61-805001"></a><a 
 id="x61-805002r131"></a><b> compiler-macroexpand</b>  <i>form</i> &#x0026;optional  <i>env</i><br 
class="newline" /><i>[Function]</i><a 
 id="dx61-805003"></a><a 
 id="x61-805004r132"></a><b> compiler-macroexpand-1</b>  <i>form</i> &#x0026;optional  <i>env</i>
</div>
<!--l. 1739--><p class="noindent" ><span class="paragraphHead"><a 
href="#x61-8060008.4" id="x61-8060008.4"></a></span>
   These are just like <tt><a 
href="clmse46.html#x59-798002r125">macroexpand</a></tt> and <tt><a 
href="clmse46.html#x59-798004r126">macroexpand-1</a></tt> except that the expander
function is obtained as if by a call to <tt><a 
href="#x61-804003r130">compiler-macro-function</a></tt> on the <i>car</i> of the
<i>form</i> rather than by a call to <tt><a 
href="clmse45.html#x58-753002r123">macro-function</a></tt>. Note that <tt><a 
href="#x61-805002r131">compiler-macroexpand</a></tt>
performs repeated expansion but <tt>compiler-macroexpand-1</tt> performs
at most one expansion. Two values are returned, the expansion (or the
original <i>form</i>) and a value that is true if any expansion occurred and <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt>
otherwise.
<!--l. 1749--><p class="indent" >   There are three cases where no expansion happens:
      <ul class="itemize1">
      <li class="itemize">There is no compiler macro deﬁnition for the <i>car</i> of <i>form</i>.
      </li>
      <li class="itemize">There is such a deﬁnition but there is also a <tt>notinline</tt> declaration,
      either globally or in the lexical environment <i>env</i>.
      </li>
      <li class="itemize">A global compiler macro deﬁnition is shadowed by a local function or
      macro deﬁnition (such as by <tt><a 
href="clmse39.html#x51-599002r82">flet</a></tt>, <tt><a 
href="clmse39.html#x51-600002r83">labels</a></tt>, or <tt><a 
href="clmse39.html#x51-601002r84">macrolet</a></tt>).</li></ul>
<!--l. 1758--><p class="noindent" >Note that if there is no expansion, the original <i>form</i> is returned as the ﬁrst value, and
<tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> as the second value.
<!--l. 1761--><p class="indent" >   Any macro expansion performed by the function <tt><a 
href="#x61-805002r131">compiler-macroexpand</a></tt> or by
the function <tt>compiler-macroexpand-1</tt> is carried out by calling the function that
is the value of <tt><a 
href="clmse46.html#x59-799002r127">*macroexpand-hook*</a></tt>.
<!--l. 1765--><p class="indent" >   A compiler macro may decline to provide any expansion merely by returning
the original form. This is useful when using the facility to put “compiler
optimizers” on various function names. For example, here is a compiler macro that
“optimizes” (one would hope) the zero-argument and one-argument cases of a
function called <tt>plus</tt>: <div class="lisp"><div class="tabbing">
(deﬁne-compiler-macro plus (&#x0026;whole form &#x0026;rest args)
                                                                          

                                                                          
   <br>                                                                      (case (length args)<br>
    (0 0)<br>                                                   (1 (car args))<br>
    (t form)))<br>
<!--l. 1777--><p class="noindent" ></div>
<!--l. 1777--><p class="noindent" ><span class="paragraphHead"><a 
href="#x61-8070008.4" id="x61-8070008.4"></a></span>
<!--l. 1777--><p class="noindent" ><span class="paragraphHead"><a 
href="#x61-8080008.4" id="x61-8080008.4"></a></span>
</div>
</div>
                                                                          

                                                                          
<!--l. 1780--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse49.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse47.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse47.html#tailclmse47.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse48.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse48.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse48.html"></a>  </div> </div> 
</body></html> 
