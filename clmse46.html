<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Macro Deﬁnition Определение макроса</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-09 00:03:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 104--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse47.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#tailclmch8.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse46.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse46.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">8.1   </span> <a 
 id="x59-1570008.1"></a>Macro Deﬁnition Определение макроса</h3>
<!--l. 106--><p class="noindent" >The function <a 
href="#x59-157005r136">macro-function</a> determines whether a given symbol is the name of a
macro. The <a 
href="#x59-157007r137">defmacro</a> construct provides a convenient way to deﬁne new
macros.
<!--l. 110--><p class="indent" >   Функция <a 
href="#x59-157005r136">macro-function</a> определяет, является ли данный символ именем
макроса. Конструкция <a 
href="#x59-157007r137">defmacro</a> предоставляет удобный способ определить
новый макрос.
<div class=obsolete>
<div class=defun>
<!--l. 115--><p class="noindent" ><i>[Function]</i><a 
 id="dx59-157001"></a><a 
 id="x59-157002r135"></a><b> macro-function</b>  <i>symbol</i>
<!--l. 117--><p class="noindent" >The argument must be a symbol. If the symbol has a global function deﬁnition
that is a macro deﬁnition, then the expansion function (a function of
two arguments, the macro-call form and an environment) is returned. If
the symbol has no global function deﬁnition, or has a deﬁnition as an
ordinary function or as a special form but not as a macro, then <a 
href="clmse31.html#x42-77002r19">nil</a> is
returned. The function <a 
href="clmse47.html#x60-159002r138">macroexpand</a> is the best way to invoke the expansion
function.
<!--l. 127--><p class="indent" >   It is possible for <i>both</i> <a 
href="#x59-157005r136">macro-function</a> and <a 
href="clmse35.html#x47-89019r60">special-form-p</a> to be true of a
symbol. This is possible because an implementation is permitted to implement
any macro also as a special form for speed. On the other hand, the macro
                                                                          

                                                                          
deﬁnition must be available for use by programs that understand only the
standard special forms listed in table <a 
href="clmse28.html#x38-620011">5.1<!--tex4ht:ref: SPECIAL-FORM-TABLE --></a>.
<!--l. 134--><p class="indent" >   <a 
href="#x59-157005r136">macro-function</a> cannot be used to determine whether a symbol names a locally
deﬁned macro established by <a 
href="clmse39.html#x51-114010r95">macrolet</a>; <a 
href="#x59-157005r136">macro-function</a> can examine only global
deﬁnitions.
<!--l. 139--><p class="indent" >   <a 
href="clmse36.html#x48-93002r66">setf</a> may be used with <a 
href="#x59-157005r136">macro-function</a> to install a macro as a symbol&#x2019;s global
function deﬁnition: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(setf (macro-function <i>symbol</i>) <i>fn</i>)
</td></tr></table>
<!--l. 143--><p class="indent" >
</div>
</div>
<!--l. 144--><p class="noindent" >The value installed must be a function that accepts two arguments, an entire macro
call and an environment, and computes the expansion for that call. Performing
this operation causes the symbol to have <i>only</i> that macro deﬁnition as its global
function deﬁnition; any previous deﬁnition, whether as a macro or as a
function, is lost. It is an error to attempt to redeﬁne the name of a special
form.
</div>
</div>
<div class=newer>
<!--l. 155--><p class="indent" >   X3J13 voted in March 1988 <a 
 id="dx59-157003"></a>to add an optional environment argument to
<a 
href="#x59-157005r136">macro-function</a>.
<div class=defun>
<!--l. 158--><p class="noindent" ><i>[Function]</i><a 
 id="dx59-157004"></a><a 
 id="x59-157005r136"></a><b> macro-function</b>  <i>symbol</i> &#x0026;optional  <i>env</i>
<!--l. 160--><p class="noindent" >The ﬁrst argument must be a symbol. If the symbol has a function deﬁnition that
is a macro deﬁnition, whether a local one established in the environment <i>env</i> by
<a 
href="clmse39.html#x51-114010r95">macrolet</a> or a global one established as if by <a 
href="#x59-157007r137">defmacro</a>, then the expansion
function (a function of two arguments, the macro-call form and an environment)
is returned. If the symbol has no function deﬁnition, or has a deﬁnition as an
ordinary function or as a special form but not as a macro, then <a 
href="clmse31.html#x42-77002r19">nil</a> is returned.
The function <a 
href="clmse47.html#x60-159002r138">macroexpand</a> or <a 
href="clmse47.html#x60-159004r139">macroexpand-1</a> is the best way to invoke the
expansion function.
<!--l. 173--><p class="indent" >   Первый аргумент должен быть символом. Если символ содержит
определение функции, то есть определение макроса, локально созданное в
окружении <i>env</i> с помощью <a 
href="clmse39.html#x51-114010r95">macrolet</a> или глобально созданное с помощью
                                                                          

                                                                          
<a 
href="#x59-157007r137">defmacro</a>, тогда возвращается функция раскрытия (функция двух
аргументов, первый форма макровызова и второй — окружение). Если
символ не содержит определение функции, или это определение обычной
функции или это специальная форма, но не макрос, тогда возвращается <a 
href="clmse31.html#x42-77002r19">nil</a>.
Наилучший способ вызвать функцию раскрытия использовать <a 
href="clmse47.html#x60-159002r138">macroexpand</a>
или <a 
href="clmse47.html#x60-159004r139">macroexpand-1</a>.
<!--l. 183--><p class="indent" >   It is possible for <i>both</i> <a 
href="#x59-157005r136">macro-function</a> and <a 
href="clmse35.html#x47-89019r60">special-form-p</a> to be true of a
symbol. This is possible because an implementation is permitted to implement
any macro also as a special form for speed. On the other hand, the macro
deﬁnition must be available for use by programs that understand only the
standard special forms listed in table <a 
href="clmse28.html#x38-620011">5.1<!--tex4ht:ref: SPECIAL-FORM-TABLE --></a>.
<!--l. 190--><p class="indent" >   Возможно такое, что и <a 
href="#x59-157005r136">macro-function</a>, и <a 
href="clmse35.html#x47-89019r60">special-form-p</a> обе возвращают
истину для одного заданного символа. Так происходит, потому что
реализация может для увеличения производительности реализовывать любой
макрос, как специальную форму. С другой стороны, определения макросов
должны быть доступны для использования программами, которые
понимают только стандартные специальные формы, перечисленные в
таблице <a 
href="clmse28.html#x38-620011">5.1<!--tex4ht:ref: SPECIAL-FORM-TABLE --></a>.
<!--l. 198--><p class="indent" >   <a 
href="clmse36.html#x48-93002r66">setf</a> may be used with <a 
href="#x59-157005r136">macro-function</a> to install a macro as a symbol&#x2019;s global
function deﬁnition: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(setf (macro-function <i>symbol</i>) <i>fn</i>)
</td></tr></table>
<!--l. 202--><p class="indent" >
</div>
</div>
<!--l. 203--><p class="noindent" >The value installed must be a function that accepts two arguments, an entire macro
call and an environment, and computes the expansion for that call. Performing
this operation causes the symbol to have <i>only</i> that macro deﬁnition as its global
function deﬁnition; any previous deﬁnition, whether as a macro or as a
function, is lost. One cannot use <a 
href="clmse36.html#x48-93002r66">setf</a> to establish a local macro deﬁnition; it
is an error to supply a second argument to <a 
href="#x59-157005r136">macro-function</a> when using
it with <a 
href="clmse36.html#x48-93002r66">setf</a>. It is an error to attempt to redeﬁne the name of a special
form.
<!--l. 213--><p class="indent" >   See also <a 
href="clmse49.html#x62-163003r143">compiler-macro-function</a>.
<!--l. 215--><p class="indent" >   <a 
href="clmse36.html#x48-93002r66">setf</a> может быть использована с <a 
href="#x59-157005r136">macro-function</a> для установки в символ
глобального определения макроса: <div class=lisp> <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(setf (macro-function <i>symbol</i>) <i>fn</i>)
</td></tr></table>
<!--l. 219--><p class="indent" >
</div>
</div>
<!--l. 220--><p class="noindent" >Устанавливаемое значение должно быть функцией, которая принимает два
аргументы, список макровызова и окружение, и вычислять раскрытие этого
макровызова. Выполнение этой операции указывает на то, что символ будет
содержать <i>только</i> это определение макроса в качестве определения
глобальной функции. Предыдущее определение функции или макроса
утрачивается. С помощью <a 
href="clmse36.html#x48-93002r66">setf</a> невозможно установить локальное определение
макроса. При использовании <a 
href="clmse36.html#x48-93002r66">setf</a> указание второго параметра (окружение)
является ошибкой. Переопределение специальной формы также является
ошибкой.
<!--l. 229--><p class="indent" >   Смотрите также <a 
href="clmse49.html#x62-163003r143">compiler-macro-function</a>.
</div>
</div>
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Macro]</i><b> defmacro </b><a 
 id="dx59-157006"></a><a 
 id="x59-157007r137"></a> name lambda-list  [[ {declaration}*  | doc-string]]  { form}*
</td></tr></table>
<!--l. 235--><p class="indent" >
</div>
<!--l. 235--><p class="noindent" ><span class="paragraphHead"><a 
 id="x59-1580008.1"></a></span>
   <a 
href="#x59-157007r137">defmacro</a> is a macro-deﬁning macro that arranges to decompose the
macro-call form in an elegant and useful way. <a 
href="#x59-157007r137">defmacro</a> has essentially the
same syntax as <a 
href="clmse30.html#x40-69002r13">defun</a>: <i>name</i> is the symbol whose macro deﬁnition we are
creating, <i>lambda-list</i> is similar in form to a lambda-list, and the <i>form</i>s
constitute the body of the expander function. The <a 
href="#x59-157007r137">defmacro</a> construct
arranges to install this expander function, as the global macro deﬁnition of
<i>name</i>.
                                                                          

                                                                          
<!--l. 245--><p class="indent" >   <a 
href="#x59-157007r137">defmacro</a> является макросом определяющим макросы, которые
преобразуют формы макровызовов. <a 
href="#x59-157007r137">defmacro</a> имеет почти такой же
синтаксис, как и <a 
href="clmse30.html#x40-69002r13">defun</a>: <i>name</i> является символом, для которого создается
макрос, <i>lambda-list</i> похож на список параметров лямбда-выражения и <i>form</i>
содержит тело функции раскрытия. Конструкция <i>defmacro</i> устанавливает
функцию раскрытия, как глобальное определение макроса для символа
<i>name</i>. FIXME
<div class=obsolete>
<!--l. 256--><p class="indent" >   The expander function is eﬀectively deﬁned in the <i>global</i> environment; lexically
scoped entities established outside the <a 
href="#x59-157007r137">defmacro</a> form that would ordinarily
be lexically apparent are not visible within the body of the expansion
function.
</div>
<div class=newer>
<!--l. 264--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx59-158001"></a>to clarify that, while deﬁning forms normally
appear at top level, it is meaningful to place them in non-top-level contexts.
Furthermore, <a 
href="#x59-157007r137">defmacro</a> should deﬁne the expander function within the enclosing
lexical environment, not within the global environment.
</div>
<div class=newer>
<!--l. 273--><p class="indent" >   X3J13 voted in March 1988 <a 
 id="dx59-158002"></a>to specify that the body of the expander function
deﬁned by <a 
href="#x59-157007r137">defmacro</a> is implicitly enclosed in a <a 
href="clmse41.html#x53-124002r103">block</a> construct whose name is the
same as the <i>name</i> of the deﬁned macro. Therefore <a 
href="clmse41.html#x53-125002r104">return-from</a> may be used to
exit from the function.
</div>
<!--l. 280--><p class="indent" >   The <i>name</i> is returned as the value of the <a 
href="#x59-157007r137">defmacro</a> form.
<!--l. 283--><p class="indent" >   Форма <a 
href="#x59-157007r137">defmacro</a> возвращает в качестве значение <i>name</i>.
<!--l. 285--><p class="indent" >   If we view the macro call as a list containing a function name and some
argument forms, in eﬀect the expander function and the list of (unevaluated)
argument forms is given to <a 
href="clmse37.html#x49-101002r77">apply</a>. The parameter speciﬁers are processed
as for any lambda-expression, using the macro-call argument forms as
the arguments. Then the body forms are evaluated as an implicit <a 
href="clmse38.html#x50-102002r80">progn</a>,
and the value of the last form is returned as the expansion of the macro
call.
<!--l. 295--><p class="indent" >   Если мы рассмотрим макровызов, как список содержащий имя
функции и некоторые формы аргументов, то механизм заключается в
передаче в функцию <a 
href="clmse37.html#x49-101002r77">apply</a> этой функции и списка ее (невычисленных)
аргументов. Спецификаторы параметров обратываются также, как и для
                                                                          

                                                                          
любого лямбда-выражения. В качестве параметров используются
формы аргументов макровызова. Затем вычисляются формы тела, как
неявный <a 
href="clmse38.html#x50-102002r80">progn</a>. Значение последней формы возвращается, как раскрытие
макровызова.
<!--l. 303--><p class="indent" >   If the optional documentation string <i>doc-string</i> is present (if not followed by a
declaration, it may be present only if at least one <i>form</i> is also speciﬁed, as it
is otherwise taken to be a <i>form</i>), then it is attached to the <i>name</i> as a
documentation string of type <a 
href="clmse35.html#x47-88006r54">function</a>; see <a 
href="clmse151.html#x184-441017r932">documentation</a>.
<!--l. 309--><p class="indent" >   Если указана необязательная строка документации <i>doc-string</i>,
тогда она присоединяется к символу <i>name</i>, как строка документации
типа <a 
href="clmse35.html#x47-88006r54">function</a>. Смотрите <a 
href="clmse151.html#x184-441017r932">documentation</a>. Если в определении макроса
представлена только строка документации, и после нее нет ни одной
формы, ни деклараций, ни просто для тела, то данная строка сама
становиться формой, и тело считается состоящим из одной формы — этой
строки.
<div class=obsolete>
<!--l. 317--><p class="indent" >   Like the lambda-list in a <a 
href="clmse30.html#x40-69002r13">defun</a>, a <a 
href="#x59-157007r137">defmacro</a> <i>lambda-list</i> may contain the
lambda-list keywords &#x0026;optional, &#x0026;rest, &#x0026;key, &#x0026;allow-other-keys, and &#x0026;aux. For
&#x0026;optional and &#x0026;key parameters, initialization forms and supplied-p parameters
may be speciﬁed, just as for <a 
href="clmse30.html#x40-69002r13">defun</a>. Three additional markers are allowed in
<a 
href="#x59-157007r137">defmacro</a> variable lists only.
</div> <div class=new> These three markers are now allowed in other constructs as well.
<!--l. 328--><p class="indent" >   Следующие три маркера доступны в определении лямбда-списка.
</div> <div class=indentdesc>
      <ul><li><b>
&#x0026;body </b></li>This  is  identical  in  function  to  &#x0026;rest,  but  it  informs  certain
      output-formatting and editing functions that the remainder of the form
      is treated as a body and should be indented accordingly. (Only one of
      &#x0026;body or &#x0026;rest may be used.)
      <!--l. 337--><p class="noindent" >Данный  маркер  эквивалентен  &#x0026;rest  маркеру,  но  дополнительно
      сообщает для функций вывода-форматирования и редактирования,
      что   оставшаяся   часть   формы   рассматривается   как   тело   и
      должна быть правильно отформатирована. (Можно использовать
      исключительно один маркер или &#x0026;body, или &#x0026;rest)
      <li><b>
&#x0026;whole </b></li>This is followed by a single variable that is bound to the entire
                                                                          

                                                                          
      macro-call form; this is the value that the macro deﬁnition function
      receives  as  its  single  argument.  &#x0026;whole  and  the  following  variable
      should appear ﬁrst in the lambda-list, before any other parameter or
      lambda-list keyword.
      <!--l. 349--><p class="noindent" >За данным маркером указывается одна переменная, которая будет
      связана  со  всей  формой  макровызова.  Это  значение,  которое
      получает функция определения макроса в качестве своего первого
      аргумента. &#x0026;whole и следующая переменная должны указываться
      на первой позиции в лямбда-списке, перед другими параметрами
      или маркерами.
      <li><b>
&#x0026;environment </b></li>This  is  followed  by  a  single  variable  that  is  bound  to
      an  environment  representing  the  lexical  environment  in  which  the
      macro  call  is  to  be  interpreted.  This  environment  may  not  be
      the  complete  lexical  environment;  it  should  be  used  only  with  the
      function  <a 
href="clmse47.html#x60-159002r138">macroexpand</a>  for  the  sake  of  any  local  macro  deﬁnitions
      that the <a 
href="clmse39.html#x51-114010r95">macrolet</a> construct may have established within that lexical
      environment. This is useful primarily in the rare cases where a macro
      deﬁnition must explicitly expand any macros in a subform of the macro
      call before computing its own expansion.
      <!--l. 366--><p class="noindent" >За данным маркером указывается одна переменния, которая будет
      связана  с  окружением,  отображаюим  лексическое  окружение,  в
      котором произошел макровызов. Это окружение может не быть
      полным  лексическим  окружением.  Оно  должно  использоваться
      только                 с                 функцией                 <a 
href="clmse47.html#x60-159002r138">macroexpand</a>
      ради  любых  локальных  определений  макросов,  которые  могли
      быть установлены с помощью <a 
href="clmse39.html#x51-114010r95">macrolet</a> конструкции внутри этого
      лексического окружения. Этот функционал полезен крайне редко,
      когда определение макроса должно явно раскрыть другие макросы
      в процессе своего раскрытия.</ul>
</div>
<!--l. 375--><p class="noindent" >See <a 
href="clmse29.html#x39-67006r11">lambda-list-keywords</a>.
<!--l. 377--><p class="indent" >   Смотрите <a 
href="clmse29.html#x39-67006r11">lambda-list-keywords</a>.
<div class=new>
<i>
<!--l. 380--><p class="indent" >   Notice of correction.</i> In the ﬁrst edition, the symbol &#x0026;environment at the left
                                                                          

                                                                          
margin above was inadvertently omitted.
</div>
<div class=newer>
<!--l. 386--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx59-158003"></a>to specify that macro environment objects
received with the &#x0026;environment argument of a macro function have only dynamic
extent. The consequences are undeﬁned if such objects are referred to outside the
dynamic extent of that particular invocation of the macro function. This allows
implementations to use somewhat more eﬃcient techniques for representing
environment objects.
</div>
<div class=newer>
<!--l. 397--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx59-158004"></a>to clarify the permitted uses of &#x0026;body, &#x0026;whole,
and &#x0026;environment:
      <ul class="itemize1">
      <li class="itemize">&#x0026;body may appear at any level of a <a 
href="#x59-157007r137">defmacro</a> lambda-list.
      </li>
      <li class="itemize">&#x0026;whole may appear at any level of a <a 
href="#x59-157007r137">defmacro</a> lambda-list. At inner
      levels a &#x0026;whole variable is bound to that part of the argument that
      matches the sub-lambda-list in which &#x0026;whole appears. No matter where
      &#x0026;whole is used, other parameters or lambda-list keywords may follow
      it.
      </li>
      <li class="itemize">&#x0026;environment may occur only at the outermost level of a <a 
href="#x59-157007r137">defmacro</a>
      lambda-list, and it may occur at most once, but it may occur anywhere
      within that lambda-list, even before an occurrence of &#x0026;whole.</li></ul>
</div>
<!--l. 411--><p class="indent" >   <a 
href="#x59-157007r137">defmacro</a>, unlike any other Common Lisp construct that has a lambda-list as
part of its syntax, provides an additional facility known as <i>destructuring</i>. <div class=newer> See
<a 
href="clmse48.html#x61-160003r141">destructuring-bind</a>, which provides the destructuring facility separately.
</div> Anywhere in the lambda-list where a parameter name may appear, and where
ordinary lambda-list syntax (as described in section <a 
href="clmse29.html#x39-670005.2.2">5.2.2<!--tex4ht:ref: LAMBDA-EXPRESSIONS-SECTION --></a>) does not otherwise
allow a list, a lambda-list may appear in place of the parameter name. When
this is done, then the argument form that would match the parameter
is treated as a (possibly dotted) list, to be used as an argument forms
list for satisfying the parameters in the embedded lambda-list. As an
                                                                          

                                                                          
example, one could write the macro deﬁnition for <a 
href="clmse42.html#x54-134002r111">dolist</a> in this manner: <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform &#x0026;optional resultform)
</td></tr></table>
<!--l. 428--><p class="indent" >                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  &#x0026;rest body)</td></tr></table>
<!--l. 429--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 431--><p class="indent" >
</div>
</div>
<!--l. 432--><p class="noindent" >More examples of embedded lambda-lists in <a 
href="#x59-157007r137">defmacro</a> are shown below.
<!--l. 434--><p class="indent" >   <a 
href="#x59-157007r137">defmacro</a>, в отличие от любых других конструкций Common
Lisp&#x2019;а, имеющих лямбда-списки в своем синтаксисе, предоставляет
дополнительную функциональность известную как <i>деструктуризация</i>. <div class=newer>
Смотрите <a 
href="clmse48.html#x61-160003r141">destructuring-bind</a>, которая отдельно предоставляет эту
функциональность.
</div> В любом месте, где могло бы стоять имя параметра, и где по синтаксису не
ожидается использование списка (как описано в разделе <a 
href="clmse29.html#x39-670005.2.2">5.2.2<!--tex4ht:ref: LAMBDA-EXPRESSIONS-SECTION --></a>), можно
использовать еще один встроенный лямбда-список. Когда использован такой
прием, при передаче форм аргументов для встроенного лямбда-списка,
необходимо обернуть эти формы в отдельный список. В качестве
примера, определение макроса для <a 
href="clmse42.html#x54-134002r111">dolist</a> можно записать в таком стиле: <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform &#x0026;optional resultform)
</td></tr></table>
<!--l. 449--><p class="indent" >                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  &#x0026;rest body)</td></tr></table>
<!--l. 450--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 452--><p class="indent" >
</div>
</div>
<!--l. 453--><p class="noindent" >Ниже будет больше примеров использования встраиваемых лямбда-списков в
<a 
href="#x59-157007r137">defmacro</a>.
<!--l. 456--><p class="indent" >   Another destructuring rule is that <a 
href="#x59-157007r137">defmacro</a> allows any lambda-list (whether
top-level or embedded) to be dotted, ending in a parameter name. This situation
                                                                          

                                                                          
is treated exactly as if the parameter name that ends the list had appeared
preceded by &#x0026;rest. For example, the deﬁnition skeleton for <a 
href="clmse42.html#x54-134002r111">dolist</a> shown above
could instead have been written <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform &#x0026;optional resultform)
</td></tr></table>
<!--l. 463--><p class="indent" >                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  . body)</td></tr></table>
<!--l. 464--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 466--><p class="indent" >
</div>
</div>
<!--l. 468--><p class="indent" >   Следующим правилом деструктуризации является то, что <a 
href="#x59-157007r137">defmacro</a>
позволяет любому лямбда-списку (верхнего уровня или встроенному) быть
dotted, заканчивающимся именем параметра. Такая ситуация обрабатывается
так, как будто имя параметра в конце списка, стоит после неявного маркера
&#x0026;rest. Например, уже показанное определение <a 
href="clmse42.html#x54-134002r111">dolist</a> может быть записано
так: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform &#x0026;optional resultform)
</td></tr></table>
<!--l. 474--><p class="indent" >                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  . body)</td></tr></table>
<!--l. 475--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 477--><p class="indent" >
</div>
</div>
<!--l. 480--><p class="indent" >   If the compiler encounters a <a 
href="#x59-157007r137">defmacro</a>, the new macro is added to the
compilation environment, and a compiled form of the expansion function is also
added to the output ﬁle so that the new macro will be operative at run time. If
this is not the desired eﬀect, the <a 
href="#x59-157007r137">defmacro</a> form can be wrapped in an <a 
href="clmse30.html#x40-74003r18">eval-when</a>
construct.
<!--l. 487--><p class="indent" >   Если компилятор встречает <a 
href="#x59-157007r137">defmacro</a>, он добавляет новый макрос в
окружение компиляции, и также функция раскрытия добавляется в
выходной файл. Таким образом новый марокс будет более быстрым во время
выполнения. Если необходимо избежать такого механизма, можно
использовать <a 
href="#x59-157007r137">defmacro</a> внутри конструкции <a 
href="clmse30.html#x40-74003r18">eval-when</a>.
                                                                          

                                                                          
<!--l. 493--><p class="indent" >   It is permissible to use <a 
href="#x59-157007r137">defmacro</a> to redeﬁne a macro (for example, to install a
corrected version of an incorrect deﬁnition), or to redeﬁne a function as a macro.
It is an error to attempt to redeﬁne the name of a special form (see table <a 
href="clmse28.html#x38-620011">5.1<!--tex4ht:ref: SPECIAL-FORM-TABLE --></a>) as a
macro. See <a 
href="clmse39.html#x51-114010r95">macrolet</a>, which establishes macro deﬁnitions over a restricted lexical
scope.
<!--l. 502--><p class="indent" >   <a 
href="#x59-157007r137">defmacro</a> может также использоваться для переопределения макроса
(например, для установки корректной версии определения вместо
некорректной), или для переопределения функции в макрос. Переопределение
специальной формы (смотрите таблицу <a 
href="clmse28.html#x38-620011">5.1<!--tex4ht:ref: SPECIAL-FORM-TABLE --></a>) недопускается. Смотрите
<a 
href="clmse39.html#x51-114010r95">macrolet</a>, которая устанавливает определение макроса в замкнутом
лексическом области видимости.
<div class=newer>
<!--l. 511--><p class="indent" >   See also <a 
href="clmse49.html#x62-162003r142">deﬁne-compiler-macro</a>.
</div>
<!--l. 514--><p class="indent" >   Suppose, for the sake of example, that it were desirable to implement a
conditional construct analogous to the Fortran arithmetic IF statement. (This of
course requires a certain stretching of the imagination and suspension of
disbelief.) The construct should accept four forms: a <i>test-value</i>, a <i>neg-form</i>, a
<i>zero-form</i>, and a <i>pos-form</i>. One of the last three forms is chosen to be executed
according to whether the value of the <i>test-form</i> is positive, negative, or zero.
Using <a 
href="#x59-157007r137">defmacro</a>, a deﬁnition for such a construct might look like this: <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro arithmetic-if (test neg-form zero-form pos-form)
</td></tr></table>
<!--l. 526--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 527--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(let ((,var ,test))</td></tr></table>
<!--l. 528--><p class="indent" >                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (cond ((&#x003C; ,var 0) ,neg-form)</td></tr></table>
<!--l. 529--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             ((= ,var 0) ,zero-form)</td></tr></table>
<!--l. 530--><p class="indent" >                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (t ,pos-form)))))</td></tr></table>
<!--l. 532--><p class="indent" >
</div>
</div>
<!--l. 533--><p class="noindent" >Note the use of the backquote facility in this deﬁnition (see section <a 
href="clmse115.html#x142-27500022.1.3">22.1.3<!--tex4ht:ref: MACRO-CHARACTERS-SECTION --></a>). Also note
the use of <a 
href="clmse56.html#x71-179008r168">gensym</a> to generate a new variable name. This is necessary to avoid
conﬂict with any variables that might be referred to in <i>neg-form</i>, <i>zero-form</i>, or
<i>pos-form</i>.
                                                                          

                                                                          
<!--l. 539--><p class="indent" >   Допустим, для примера, что необходимо реализовать условную
конструкцию аналогичную Fortran&#x2019;овскому арифметичскому выражению
IF. (Это конечно требует определенного расширения воображения
и приостановки неверия.) Конструкция должна принимать четыре
формы: <i>test-value</i>, <i>neg-form</i>, <i>zero-form</i> и <i>pos-form</i>. В зависимости от того,
является ли <i>test-form</i> отрицительным, нулем или положительным
числом, для выполнения будет выбрана одна из трех последних форм. С
использованием <a 
href="#x59-157007r137">defmacro</a>, определение этой конструкции может выглядеть
так: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro arithmetic-if (test neg-form zero-form pos-form)
</td></tr></table>
<!--l. 552--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 553--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(let ((,var ,test))</td></tr></table>
<!--l. 554--><p class="indent" >                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (cond ((&#x003C; ,var 0) ,neg-form)</td></tr></table>
<!--l. 555--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             ((= ,var 0) ,zero-form)</td></tr></table>
<!--l. 556--><p class="indent" >                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (t ,pos-form)))))</td></tr></table>
<!--l. 558--><p class="indent" >
</div>
</div>
<!--l. 559--><p class="noindent" >Необходимо отметить, что в данном определении используется функциональность
обратной кавычки (смотрите раздел <a 
href="clmse115.html#x142-27500022.1.3">22.1.3<!--tex4ht:ref: MACRO-CHARACTERS-SECTION --></a>). Также необходимо заметить, что
используется <a 
href="clmse56.html#x71-179008r168">gensym</a> для создания нового имени переменной. Это необходимо
для избежания конфликтов с другими переменными, которые могут
использоваться в формах <i>neg-form</i>, <i>zero-form</i> или <i>pos-form</i>.
<!--l. 566--><p class="indent" >   If the form is executed by the interpreter, it will cause the function deﬁnition
of the symbol arithmetic-if to be a macro associated with which is a two-argument
expansion function roughly equivalent to <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(lambda (calling-form environment)
</td></tr></table>
<!--l. 571--><p class="indent" >                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (declare (ignore environment))</td></tr></table>
<!--l. 572--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 573--><p class="indent" >                                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (list &#x2019;let</td></tr></table>
<!--l. 574--><p class="indent" >                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">          (list (list &#x2019;var (cadr calling-form)))</td></tr></table>
<!--l. 575--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">          (list &#x2019;cond</td></tr></table>
                                                                          

                                                                          
<!--l. 576--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list (list &#x2019;&#x003C; var &#x2019;0) (caddr calling-form))</td></tr></table>
<!--l. 577--><p class="indent" >              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list (list &#x2019;= var &#x2019;0) (cadddr calling-form))</td></tr></table>
<!--l. 578--><p class="indent" >                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list &#x2019;t (ﬁfth calling-form))))))</td></tr></table>
<!--l. 580--><p class="indent" >
</div>
</div>
<!--l. 581--><p class="noindent" >The lambda-expression is produced by the <a 
href="#x59-157007r137">defmacro</a> declaration. The calls to
<a 
href="clmse87.html#x107-225038r493">list</a> are the (hypothetical) result of the backquote (‘) macro character
and its associated commas. The precise macro expansion function may
depend on the implementation, for example providing some degree of
explicit error checking on the number of argument forms in the macro
call.
<!--l. 588--><p class="indent" >   Если форма выполняется интерпретатором, то определение функции для
символа arithmetic-if будет является макросом, с которым ассоциирована
функция двух аргументом эквивалентная данной <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(lambda (calling-form environment)
</td></tr></table>
<!--l. 592--><p class="indent" >                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (declare (ignore environment))</td></tr></table>
<!--l. 593--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 594--><p class="indent" >                                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (list &#x2019;let</td></tr></table>
<!--l. 595--><p class="indent" >                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">          (list (list &#x2019;var (cadr calling-form)))</td></tr></table>
<!--l. 596--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">          (list &#x2019;cond</td></tr></table>
<!--l. 597--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list (list &#x2019;&#x003C; var &#x2019;0) (caddr calling-form))</td></tr></table>
<!--l. 598--><p class="indent" >              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list (list &#x2019;= var &#x2019;0) (cadddr calling-form))</td></tr></table>
<!--l. 599--><p class="indent" >                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list &#x2019;t (ﬁfth calling-form))))))</td></tr></table>
<!--l. 601--><p class="indent" >
</div>
</div>
<!--l. 602--><p class="noindent" >Лямбда-выражение является результатом выполнения декларации <a 
href="#x59-157007r137">defmacro</a>.
Вызов <a 
href="clmse87.html#x107-225038r493">list</a> является (гипотетически) результатом макросимвола обратной
кавычки (‘) и связанной с нии запятой. Конкретная функция раскрытия
макроса может зависеть от реализации, например, она также может
содержать проверку на корректность входных аргументов в макровызове.
<!--l. 608--><p class="indent" >   Now, if <a 
href="clmse110.html#x135-261002r620">eval</a> encounters <div class=lisp> <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(arithmetic-if (- x 4.0)
</td></tr></table>
<!--l. 610--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               (- x)</td></tr></table>
<!--l. 611--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               (error &#x0022;Strange zero&#x0022;)</td></tr></table>
<!--l. 612--><p class="indent" >                                                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               x)</td></tr></table>
<!--l. 614--><p class="indent" >
</div>
</div>
<!--l. 615--><p class="noindent" >this will be expanded into something like <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((g407 (- x 4.0)))
</td></tr></table>
<!--l. 617--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (cond ((&#x003C; g407 0) (- x))</td></tr></table>
<!--l. 618--><p class="indent" >                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        ((= g407 0) (error &#x0022;Strange zero&#x0022;))</td></tr></table>
<!--l. 619--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (t x)))</td></tr></table>
<!--l. 621--><p class="indent" >
</div>
</div>
<!--l. 622--><p class="noindent" >and <a 
href="clmse110.html#x135-261002r620">eval</a> tries again on this new form. (It should be clear now that the backquote
facility is very useful in writing macros, since the form to be returned is normally
a complex list structure, typically consisting of a mostly constant template with a
few evaluated forms here and there. The backquote template provides a “picture”
of the resulting code, with places to be ﬁlled in indicated by preceding
commas.)
<!--l. 630--><p class="indent" >   Теперь, если <a 
href="clmse110.html#x135-261002r620">eval</a> встретит <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(arithmetic-if (- x 4.0)
</td></tr></table>
<!--l. 632--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               (- x)</td></tr></table>
<!--l. 633--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               (error &#x0022;Strange zero&#x0022;)</td></tr></table>
<!--l. 634--><p class="indent" >                                                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               x)</td></tr></table>
<!--l. 636--><p class="indent" >
</div>
</div>
<!--l. 637--><p class="noindent" >то раскроет эту форму в <div class=lisp> <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((g407 (- x 4.0)))
</td></tr></table>
<!--l. 639--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (cond ((&#x003C; g407 0) (- x))</td></tr></table>
<!--l. 640--><p class="indent" >                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        ((= g407 0) (error &#x0022;Strange zero&#x0022;))</td></tr></table>
<!--l. 641--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (t x)))</td></tr></table>
<!--l. 643--><p class="indent" >
</div>
</div>
<!--l. 644--><p class="noindent" >и <a 
href="clmse110.html#x135-261002r620">eval</a> выполнит полученную форму. (Сейчас должно быть понятно, что
функциональность обратной кавычки очень полезна для написания
макросов. Она используется для построения шаблона, возвращаемой
формы, с константными частями и частями для выполнения. Шаблон
представляет собой «картину» кода, с местами для заполнения выделенными
запятыми.)
<!--l. 650--><p class="indent" >   To expand on this example, stretching credibility to its limit, we might allow
the <i>pos-form</i> and <i>zero-form</i> to be omitted, allowing their values to default to <a 
href="clmse31.html#x42-77002r19">nil</a>,
in much the same way that the <i>else</i> form of a Common Lisp <a 
href="clmse141.html#x172-364002r878">if</a> construct may be
omitted: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro arithmetic-if (test neg-form
</td></tr></table>
<!--l. 656--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                         &#x0026;optional zero-form pos-form)</td></tr></table>
<!--l. 657--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 658--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(let ((,var ,test))</td></tr></table>
<!--l. 659--><p class="indent" >                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (cond ((&#x003C; ,var 0) ,neg-form)</td></tr></table>
<!--l. 660--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             ((= ,var 0) ,zero-form)</td></tr></table>
<!--l. 661--><p class="indent" >                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (t ,pos-form)))))</td></tr></table>
<!--l. 663--><p class="indent" >
</div>
</div>
<!--l. 664--><p class="noindent" >Then one could write <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(arithmetic-if (- x 4.0) (print x))
</td></tr></table>
<!--l. 667--><p class="indent" >
                                                                          

                                                                          
</div>
</div>
<!--l. 668--><p class="noindent" >which would be expanded into something like <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((g408 (- x 4.0)))
</td></tr></table>
<!--l. 670--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (cond ((&#x003C; g408 0) (print x))</td></tr></table>
<!--l. 671--><p class="indent" >                                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        ((= g408 0) nil)</td></tr></table>
<!--l. 672--><p class="indent" >                                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (t nil)))</td></tr></table>
<!--l. 674--><p class="indent" >
</div>
</div>
<!--l. 675--><p class="noindent" >The resulting code is correct but rather silly-looking. One might rewrite the macro
deﬁnition to produce better code when <i>pos-form</i> and possibly <i>zero-form</i> are
omitted, or one might simply rely on the Common Lisp implementation to provide
a compiler smart enough to improve the code itself.
<!--l. 681--><p class="indent" >   Для улучшения примера мы можем сделать так, чтобы <i>pos-form</i> и
<i>zero-form</i> могли быть заменены на <a 
href="clmse31.html#x42-77002r19">nil</a> в результате разкрытия макроса.
Таким же образом действует и <a 
href="clmse141.html#x172-364002r878">if</a> опусткая векту <i>else</i> в случае истинности
условия. <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro arithmetic-if (test neg-form
</td></tr></table>
<!--l. 686--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                         &#x0026;optional zero-form pos-form)</td></tr></table>
<!--l. 687--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 688--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(let ((,var ,test))</td></tr></table>
<!--l. 689--><p class="indent" >                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (cond ((&#x003C; ,var 0) ,neg-form)</td></tr></table>
<!--l. 690--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             ((= ,var 0) ,zero-form)</td></tr></table>
<!--l. 691--><p class="indent" >                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (t ,pos-form)))))</td></tr></table>
<!--l. 693--><p class="indent" >
</div>
</div>
<!--l. 694--><p class="noindent" >Тогда можно записать <div class=lisp> <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(arithmetic-if (- x 4.0) (print x))
</td></tr></table>
<!--l. 697--><p class="indent" >
</div>
</div>
<!--l. 698--><p class="noindent" >и это раскроется в что-то вроде <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((g408 (- x 4.0)))
</td></tr></table>
<!--l. 700--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (cond ((&#x003C; g408 0) (print x))</td></tr></table>
<!--l. 701--><p class="indent" >                                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        ((= g408 0) nil)</td></tr></table>
<!--l. 702--><p class="indent" >                                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (t nil)))</td></tr></table>
<!--l. 704--><p class="indent" >
</div>
</div>
<!--l. 705--><p class="noindent" >Результирующий код корректен, но некрасиво выглядит. Можно переписать
определение макроса для генерации лучшего кода, когда <i>pos-form</i> и
<i>zero-form</i> могут быть вообще опущены. Или же можно положиться на
реализацию Common Lisp&#x2019;а, которая возможно соптимизирует этот
код.
<!--l. 711--><p class="indent" >   Destructuring is a very powerful facility that allows the <a 
href="#x59-157007r137">defmacro</a> lambda-list
to express the structure of a complicated macro-call syntax. If no lambda-list
keywords appear, then the <a 
href="#x59-157007r137">defmacro</a> lambda-list is simply a list, nested to some
extent, containing parameter names at the leaves. The macro-call form must
have the same list structure. For example, consider this macro deﬁnition: <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro halibut ((mouth eye1 eye2)
</td></tr></table>
<!--l. 719--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   ((ﬁn1 length1) (ﬁn2 length2))</td></tr></table>
<!--l. 720--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   tail)</td></tr></table>
<!--l. 721--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 723--><p class="indent" >
</div>
</div>
<!--l. 724--><p class="noindent" >Now consider this macro call: <div class=lisp> <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 726--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 727--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 729--><p class="indent" >
</div>
</div>
<!--l. 730--><p class="noindent" >This would cause the expansion function to receive the following values for its
parameters:
<div class="flushleft" 
>
<!--l. 732--><p class="noindent" >
 <!--tex4ht:inline--><div class="tabular"><table width="100%"><tr><td align="left" >Parameter</td><td align="left" >Value              </td></tr><tr><td align="left" >mouth </td> <td align="left" >m</td>
</tr><tr><td align="left" >eye1        </td><td align="left" >(car eyes)         </td>
</tr><tr><td align="left" >eye2        </td><td align="left" >(cdr eyes)         </td>
</tr><tr><td align="left" >ﬁn1         </td><td align="left" >f1                   </td>
</tr><tr><td align="left" >length1    </td><td align="left" >(count-scales f1)</td>
</tr><tr><td align="left" >ﬁn2         </td><td align="left" >f2                   </td>
</tr><tr><td align="left" >length2    </td><td align="left" >(count-scales f2)</td>
</tr><tr><td align="left" >tail         </td><td align="left" >my-favorite-tail </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr><td align="left" > </td></tr></table></div></div>
<!--l. 748--><p class="noindent" >The following macro call would be in error because there would be no argument form
to match the parameter length1: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 751--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1) (f2 (count-scales f2)))</td></tr></table>
<!--l. 752--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 754--><p class="indent" >
</div>
</div>
<!--l. 755--><p class="noindent" >The following macro call would be in error because a symbol appears in the call
where the structure of the lambda-list requires a list. <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut my-favorite-head
</td></tr></table>
                                                                          

                                                                          
<!--l. 758--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 759--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 761--><p class="indent" >
</div>
</div>
<!--l. 762--><p class="noindent" >The fact that the value of the variable my-favorite-head might happen to be a list is
irrelevant here. It is the macro call itself whose structure must match that of the
<a 
href="#x59-157007r137">defmacro</a> lambda-list.
<!--l. 766--><p class="indent" >   The use of lambda-list keywords adds even greater ﬂexibility. For example,
suppose it is convenient within the expansion function for halibut to be able to
refer to the list whose components are called mouth, eye1, and eye2 as head. One
may write this: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro halibut ((&#x0026;whole head mouth eye1 eye2)
</td></tr></table>
<!--l. 772--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   ((ﬁn1 length1) (ﬁn2 length2))</td></tr></table>
<!--l. 773--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   tail)</td></tr></table>
<!--l. 775--><p class="indent" >
</div>
</div>
<!--l. 776--><p class="noindent" >Now consider the same valid macro call as before: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 778--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 779--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 781--><p class="indent" >
</div>
</div>
<!--l. 782--><p class="noindent" >This would cause the expansion function to receive the same values for its parameters
and also a value for the parameter head:
<div class="flushleft" 
>
<!--l. 784--><p class="noindent" >
 <!--tex4ht:inline--><div class="tabular"><table width="100%"><tr><td align="left" >Parameter</td><td align="left" >Value                         </td></tr><tr><td align="left" >head </td> <td align="left" >(m (car eyes) (cdr eyes))</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr><td align="left" > </td></tr></table>
</div></div>
                                                                          

                                                                          
<!--l. 794--><p class="indent" >   Деструктуризация является очень мощной функциональностью, которая
позволяет лямбда-списку в <a 
href="#x59-157007r137">defmacro</a> выразить сложную структуру
макровызова. Если не использовались ключевые символы лямбда-списка, то
он представляет собой просто список с некоторой степенью вложенности и
параметрами в качестве листьев. Структура макровызова должна иметь
такую же структуру списка. Например, рассмотрим следующее определение
макроса: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro halibut ((mouth eye1 eye2)
</td></tr></table>
<!--l. 801--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   ((ﬁn1 length1) (ﬁn2 length2))</td></tr></table>
<!--l. 802--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   tail)</td></tr></table>
<!--l. 803--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 805--><p class="indent" >
</div>
</div>
<!--l. 806--><p class="noindent" >Теперь давайте рассмотрим макровызов: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 808--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 809--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 811--><p class="indent" >
</div>
</div>
<!--l. 812--><p class="noindent" >Все это приведет к тому, что функция раскрытия получит следующие значения
для ее параметров:
<div class="flushleft" 
>
<!--l. 814--><p class="noindent" >
 <!--tex4ht:inline--><div class="tabular"><table width="100%"><tr><td align="left" >Parameter</td><td align="left" >Value              </td></tr><tr><td align="left" >mouth </td> <td align="left" >m</td>
</tr><tr><td align="left" >eye1        </td><td align="left" >(car eyes)         </td>
</tr><tr><td align="left" >eye2        </td><td align="left" >(cdr eyes)         </td>
</tr><tr><td align="left" >ﬁn1         </td><td align="left" >f1                   </td>
</tr><tr><td align="left" >length1    </td><td align="left" >(count-scales f1)</td>
</tr><tr><td align="left" >ﬁn2         </td><td align="left" >f2                   </td>
</tr><tr><td align="left" >length2    </td><td align="left" >(count-scales f2)</td>
</tr><tr><td align="left" >tail         </td><td align="left" >my-favorite-tail </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr><td align="left" > </td></tr></table></div></div>
                                                                          

                                                                          
<!--l. 830--><p class="noindent" >Следующий макровызов ошибочный, так как аргумента для параметра length1
не представлено: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 833--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1) (f2 (count-scales f2)))</td></tr></table>
<!--l. 834--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 836--><p class="indent" >
</div>
</div>
<!--l. 837--><p class="noindent" >Следующий макровызов также ошибочный, так как на месте предполагаемого
списка указан символ. <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut my-favorite-head
</td></tr></table>
<!--l. 840--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 841--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 843--><p class="indent" >
</div>
</div>
<!--l. 844--><p class="noindent" >Тот факт, что значение переменной my-favorite-head может быть списком, не
имеет здесь значения. В макровызове структура должна совпадать с
лямбда-списком в определении.
<!--l. 848--><p class="indent" >   Использование ключевых символов лябмда-списка предоставляет еще
большую гибкость. Например, предположим, что удобно будет в функции
раскрытия обращаться к элементам списка, называемым cdmouth, eye1, and
eye2, как к head. Можно записать так: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro halibut ((&#x0026;whole head mouth eye1 eye2)
</td></tr></table>
<!--l. 855--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   ((ﬁn1 length1) (ﬁn2 length2))</td></tr></table>
<!--l. 856--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   tail)</td></tr></table>
<!--l. 858--><p class="indent" >
                                                                          

                                                                          
</div>
</div>
<!--l. 859--><p class="noindent" >Теперь рссмотрим такой же, как раньше, корректный макровызов: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 861--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 862--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 864--><p class="indent" >
</div>
</div>
<!--l. 865--><p class="noindent" >Это приведет к тому, что функции раскрытия получит те же значения для своих
параметров, а также значение для параметра head:
<div class="flushleft" 
>
<!--l. 867--><p class="noindent" >
 <!--tex4ht:inline--><div class="tabular"><table width="100%"><tr><td align="left" >Parameter</td><td align="left" >Value                         </td></tr><tr><td align="left" >head </td> <td align="left" >(m (car eyes) (cdr eyes))</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr><td align="left" > </td></tr></table>
</div></div>
<!--l. 877--><p class="indent" >   The stipulation that an embedded lambda-list is permitted only where
ordinary lambda-list syntax would permit a parameter name but not
a list is made to prevent ambiguity. For example, one may not write <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional (a b &#x0026;rest c) &#x0026;rest z)
</td></tr></table>
<!--l. 883--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 885--><p class="indent" >
</div>
</div>
<!--l. 886--><p class="noindent" >because ordinary lambda-list syntax does permit a list following &#x0026;optional; the list (a
b &#x0026;rest c) would be interpreted as describing an optional parameter named a
whose default value is that of the form b, with a supplied-p parameter named
&#x0026;rest (not legal), and an extraneous symbol c in the list (also not legal). An
almost correct way to express this is <div class=lisp> <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional ((a b &#x0026;rest c)) &#x0026;rest z)
</td></tr></table>
<!--l. 893--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 895--><p class="indent" >
</div>
</div>
<!--l. 896--><p class="noindent" >The extra set of parentheses removes the ambiguity. However, the deﬁnition is now
incorrect because a macro call such as (loser (car pool)) would not provide any
argument form for the lambda-list (a b &#x0026;rest c), and so the default value against
which to match the lambda-list would be <a 
href="clmse31.html#x42-77002r19">nil</a> because no explicit default value was
speciﬁed. This is in error because <a 
href="clmse31.html#x42-77002r19">nil</a> is an empty list; it does not have forms to
satisfy the parameters a and b. The fully correct deﬁnition would be either <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional ((a b &#x0026;rest c) &#x2019;(nil nil)) &#x0026;rest z)
</td></tr></table>
<!--l. 904--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 906--><p class="indent" >
</div>
</div>
<!--l. 907--><p class="noindent" >or <div class=lisp>  <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional ((&#x0026;optional a b &#x0026;rest c)) &#x0026;rest z)
</td></tr></table>
<!--l. 909--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 911--><p class="indent" >
</div>
</div>
<!--l. 912--><p class="noindent" >These diﬀer slightly: the ﬁrst requires that if the macro call speciﬁes a explicitly then
it must also specify b explicitly, whereas the second does not have this
requirement. For example, <div class=lisp> <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(loser (car pool) ((+ x 1)))
</td></tr></table>
<!--l. 917--><p class="indent" >
</div>
</div>
<!--l. 918--><p class="noindent" >would be a valid call for the second deﬁnition but not for the ﬁrst.
<!--l. 920--><p class="indent" >   Существует условие для деструктуризации, встроенный лямбда-список
разрешен только на позиции, где синтаксис лямбда-списка предусматривает
имя параметра, но не список. Это защищает от двусмысленности. Например,
нельзя записать <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional (a b &#x0026;rest c) &#x0026;rest z)
</td></tr></table>
<!--l. 924--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 926--><p class="indent" >
</div>
</div>
<!--l. 927--><p class="noindent" >потому что синтаксис лямбда-списка не позволяет использовать списки
после &#x0026;optional. Список (a b &#x0026;rest c) был бы интерпретирован как
необязательный параметр a, у которого значение по умолчанию b, и
supplied-p параметр с некорректным именем &#x0026;rest, и дополнительным
символом c, также некорректным. Было бы правильнее выразить это так: <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional ((a b &#x0026;rest c)) &#x0026;rest z)
</td></tr></table>
<!--l. 933--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 935--><p class="indent" >
</div>
</div>
<!--l. 936--><p class="noindent" >Дополнительные круглые скобки устраняют двусмысленность. Однако, такой
макровызов, как (loser (car pool)) не предоставляет никакой формы
аргумента для лямбда-списка (a b &#x0026;rest c), значит значение по умолчанию
для него будет <a 
href="clmse31.html#x42-77002r19">nil</a>. А так как <a 
href="clmse31.html#x42-77002r19">nil</a> является пустым списком, то этот
макровызов ошибочен. Полностью корректное определение выглядит так: <div class=lisp>
<div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional ((a b &#x0026;rest c) &#x2019;(nil nil)) &#x0026;rest z)
</td></tr></table>
<!--l. 942--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 944--><p class="indent" >
</div>
</div>
<!--l. 945--><p class="noindent" >или так <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional ((&#x0026;optional a b &#x0026;rest c)) &#x0026;rest z)
</td></tr></table>
<!--l. 947--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 949--><p class="indent" >
</div>
</div>
<!--l. 950--><p class="noindent" >Они слегка отличаются: первое определение требует, что если макровызов явно
указывает a, тогда он должен указать явно и b, тогда как второе определение
не содержит такого требования. Например, <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(loser (car pool) ((+ x 1)))
</td></tr></table>
<!--l. 955--><p class="indent" >
</div>
</div>
<!--l. 956--><p class="noindent" >будет корректным макровызовом для второго определения, но не для
первого.
</div>
                                                                          

                                                                          
   <!--l. 959--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse47.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#tailclmch8.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse46.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 959--><p class="indent" >   <a 
 id="tailclmse46.html"></a>  
</body></html> 
