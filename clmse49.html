<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Compiler Macros</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-02-22 01:55:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 709--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse50.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse48.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse48.html#tailclmse48.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse49.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse49.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">8.4   </span> <a 
 id="x62-1010008.4"></a>Compiler Macros</h3>
<!--l. 711--><p class="noindent" >X3J13 voted in June 1989 ⟨<b>?</b>⟩ to add a facility for deﬁning compiler macros that
take eﬀect only when compiling code, not when interpreting it.
<!--l. 715--><p class="indent" >   The purpose of this facility is to permit selective source-code transformations
only when the compiler is processing the code. When the compiler is about to
compile a non-atomic form, it ﬁrst calls <i>compiler-macroexpand-1</i> repeatedly until
there is no more expansion (there might not be any to begin with). Then it
continues its remaining processing, which may include calling <i>macroexpand-1</i> and
so on.
<!--l. 722--><p class="indent" >   The compiler is required to expand compiler macros. It is unspeciﬁed whether
the interpreter does so. The intention is that only the compiler will do so, but the
range of possible “compiled-only” implementation strategies precludes any ﬁrm
speciﬁcation.
<div class=defmac>
<!--l. 729--><p class="noindent" ><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Macro]</i><b> deﬁne-compiler-macro </b> <a 
 id="dx62-101001"></a><a 
 id="x62-101002r140"></a>   name lambda-list  {<i>declaration|doc − string</i>}∗  {<i>form</i>}∗
</td></tr></table>
<!--l. 731--><p class="indent" >
</div>
   This is just like <a 
href="clmse46.html#x59-98006r135">defmacro</a> except the deﬁnition is not stored in the symbol
function cell of name and is not seen by <i>macroexpand-1</i>. It is, however, seen by
<i>compiler-macroexpand-1</i>. As with <a 
href="clmse46.html#x59-98006r135">defmacro</a>, the lambda-list may include
<i>&#x0026;environment</i> and <i>&#x0026;whole</i> and may include destructuring. The deﬁnition is
global. (There is no provision for deﬁning local compiler macros in the way that
macrolet deﬁnes local macros.)
   A top-level call to <a 
href="#x62-101002r140">deﬁne-compiler-macro</a> in a ﬁle being compiled by
<a 
href="clmse127.html#x157-224006r797">compile-ﬁle</a> has an eﬀect on the compilation environment similar to that of a call
to <a 
href="clmse46.html#x59-98006r135">defmacro</a>, except it is noticed as a compiler macro (see section <a 
href="clmse127.html#x157-22400025.1">25.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
                                                                          

                                                                          
   Note that compiler macro deﬁnitions do not appear in information returned by
<a 
href="clmse50.html#x63-102004r145">function-information</a>; they are global, and their interaction with other lexical and
global deﬁnitions can be reconstructed by <a 
href="#x62-101004r141">compiler-macro-function</a>. It is up
to code-walking programs to decide whether to invoke compiler macro
expansion.
<div class=newer>
   X3J13 voted in March 1988 ⟨<b>?</b>⟩ to specify that the body of the expander
function deﬁned by <a 
href="clmse46.html#x59-98006r135">defmacro</a> is implicitly enclosed in a <a 
href="clmse41.html#x53-85002r101">block</a> construct whose
name is the same as the name of the deﬁned macro; presumably this applies also
to <a 
href="#x62-101002r140">deﬁne-compiler-macro</a>. Therefore <a 
href="clmse41.html#x53-85004r102">return-from</a> may be used to exit from the
function.
</div>
</div>
<div class=defun>
<!--l. 763--><p class="noindent" > <i>[Function]</i>   <b>compiler-macro-function</b> <a 
 id="dx62-101003"></a><a 
 id="x62-101004r141"></a>   <i>name</i>  <b>&#x0026;optional</b>  <i>env</i>
<!--l. 765--><p class="noindent" >The name must be a symbol. If it has been deﬁned as a compiler macro, then
<a 
href="#x62-101004r141">compiler-macro-function</a> returns the macro expansion function; otherwise it
returns <a 
href="clmse31.html#x42-70002r19">nil</a>. The lexical environment env may override any global deﬁnition for
name by deﬁning a local function or local macro (such as by ﬂet, <a 
href="clmse39.html#x51-83022r93">labels</a>, or
macrolet) in which case <a 
href="clmse31.html#x42-70002r19">nil</a> is returned.
<!--l. 774--><p class="indent" >   <a 
href="clmse36.html#x48-80002r66">setf</a> may be used with <a 
href="#x62-101004r141">compiler-macro-function</a> to install a function as the
expansion function for the compiler macro name, in the same manner as for
<a 
href="clmse46.html#x59-98004r134">macro-function</a>. Storing the value <a 
href="clmse31.html#x42-70002r19">nil</a> removes any existing compiler macro
deﬁnition. As with <a 
href="clmse46.html#x59-98004r134">macro-function</a>, a non-<a 
href="clmse31.html#x42-70002r19">nil</a> stored value must be a function of
two arguments, the entire macro call and the environment. The second
argument to <a 
href="#x62-101004r141">compiler-macro-function</a> must be omitted when it is used with
<a 
href="clmse36.html#x48-80002r66">setf</a>.
</div>
<div class=defun>
<!--l. 783--><p class="noindent" > <i>[Function]</i>   <b>compiler-macroexpand</b> <a 
 id="dx62-101005"></a><a 
 id="x62-101006r142"></a>   <i>form</i>  <b>&#x0026;optional</b>  <i>env</i><br 
class="newline" /><i>[Function]</i>   <b>compiler-macroexpand-1</b> <a 
 id="dx62-101007"></a><a 
 id="x62-101008r143"></a>   <i>form</i>  <b>&#x0026;optional</b>  <i>env</i>
<!--l. 786--><p class="noindent" >These are just like <a 
href="clmse47.html#x60-99002r136">macroexpand</a> and <i>macroexpand-1</i> except that the
expander function is obtained as if by a call to <a 
href="#x62-101004r141">compiler-macro-function</a> on
the car of the form rather than by a call to <a 
href="clmse46.html#x59-98004r134">macro-function</a>. Note that
<a 
href="#x62-101006r142">compiler-macroexpand</a> performs repeated expansion but <i>compiler-macroexpand-1</i>
performs at most one expansion. Two values are returned, the expansion (or the
original form) and a value that is true if any expansion occurred and <a 
href="clmse31.html#x42-70002r19">nil</a>
otherwise.
                                                                          

                                                                          
<!--l. 796--><p class="indent" >   There are three cases where no expansion happens:
      <ul class="itemize1">
      <li class="itemize">There is no compiler macro deﬁnition for the car of form.
      </li>
      <li class="itemize">There is such a deﬁnition but there is also a notinline declaration, either
      globally or in the lexical environment env.
      </li>
      <li class="itemize">A global compiler macro deﬁnition is shadowed by a local function or
      macro deﬁnition (such as by ﬂet, <a 
href="clmse39.html#x51-83022r93">labels</a>, or macrolet).</li></ul>
<!--l. 805--><p class="noindent" >Note that if there is no expansion, the original form is returned as the ﬁrst value, and
<a 
href="clmse31.html#x42-70002r19">nil</a> as the second value.
<!--l. 808--><p class="indent" >   Any macro expansion performed by the function <a 
href="#x62-101006r142">compiler-macroexpand</a> or by
the function <i>compiler-macroexpand-1</i> is carried out by calling the function that is
the value of <i>*macroexpand-hook*</i>.
<!--l. 812--><p class="indent" >   A compiler macro may decline to provide any expansion merely by returning
the original form. This is useful when using the facility to put “compiler
optimizers” on various function names. For example, here is a compiler macro that
“optimizes” (one would hope) the zero-argument and one-argument cases of a
function called plus: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(deﬁne-compiler-macro plus (&#x0026;whole form &#x0026;rest args)
</td></tr></table>
<!--l. 819--><p class="indent" >                                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (case (length args)</td></tr></table>
<!--l. 820--><p class="indent" >                                                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (0 0)</td></tr></table>
<!--l. 821--><p class="indent" >                                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (1 (car args))</td></tr></table>
<!--l. 822--><p class="indent" >                                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (t form)))</td></tr></table>
<!--l. 824--><p class="indent" >
</div>
</div>
</div>
</div>
<div class=newer>
                                                                          

                                                                          
   <!--l. 830--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse50.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse48.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse48.html#tailclmse48.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse49.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse49.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 830--><p class="indent" >   <a 
 id="tailclmse49.html"></a>  
</body></html> 
