<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Compiler Macros</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-02-26 02:27:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 709--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse50.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse48.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse48.html#tailclmse48.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse49.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse49.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">8.4   </span> <a 
 id="x62-1010008.4"></a>Compiler Macros</h3>
<!--l. 711--><p class="noindent" >X3J13 voted in June 1989 <a 
 id="dx62-101001"></a>to add a facility for deﬁning <i>compiler macros</i> that take
eﬀect only when compiling code, not when interpreting it.
<!--l. 715--><p class="indent" >   The purpose of this facility is to permit selective source-code transformations
only when the compiler is processing the code. When the compiler is about to
compile a non-atomic form, it ﬁrst calls compiler-macroexpand-1 repeatedly until
there is no more expansion (there might not be any to begin with). Then it
continues its remaining processing, which may include calling macroexpand-1 and
so on.
<!--l. 722--><p class="indent" >   The compiler is required to expand compiler macros. It is unspeciﬁed whether
the interpreter does so. The intention is that only the compiler will do so, but the
range of possible “compiled-only” implementation strategies precludes any ﬁrm
speciﬁcation.
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  <i>[Macro]</i> <b> deﬁne-compiler-macro </b> <a 
 id="dx62-101002"></a><a 
 id="x62-101003r142"></a>  name lambda-list
</td></tr></table>
<!--l. 730--><p class="indent" >                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> {declaration | doc-string }*  { form }* </td></tr></table>
<!--l. 731--><p class="indent" >
</div>
   This is just like <a 
href="clmse46.html#x59-98007r137">defmacro</a> except the deﬁnition is not stored in the symbol
function cell of <i>name</i> and is not seen by macroexpand-1. It is, however, seen by
compiler-macroexpand-1. As with <a 
href="clmse46.html#x59-98007r137">defmacro</a>, the <i>lambda-list</i> may include
&#x0026;environment and &#x0026;whole and may include destructuring. The deﬁnition is
global. (There is no provision for deﬁning local compiler macros in the way that
<a 
href="clmse39.html#x51-83034r95">macrolet</a> deﬁnes local macros.)
   A top-level call to <a 
href="#x62-101003r142">deﬁne-compiler-macro</a> in a ﬁle being compiled by
<a 
href="clmse127.html#x157-224011r799">compile-ﬁle</a> has an eﬀect on the compilation environment similar to that of a call
                                                                          

                                                                          
to <a 
href="clmse46.html#x59-98007r137">defmacro</a>, except it is noticed as a compiler macro (see section <a 
href="clmse127.html#x157-22400025.1">25.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
   Note that compiler macro deﬁnitions do not appear in information returned by
<a 
href="clmse50.html#x63-102008r147">function-information</a>; they are global, and their interaction with other lexical and
global deﬁnitions can be reconstructed by <a 
href="#x62-101006r143">compiler-macro-function</a>. It is up
to code-walking programs to decide whether to invoke compiler macro
expansion.
<div class=newer>
   X3J13 voted in March 1988 <a 
 id="dx62-101004"></a>to specify that the body of the expander function
deﬁned by <a 
href="clmse46.html#x59-98007r137">defmacro</a> is implicitly enclosed in a <a 
href="clmse41.html#x53-85002r103">block</a> construct whose name is the
same as the <i>name</i> of the deﬁned macro; presumably this applies also to
<a 
href="#x62-101003r142">deﬁne-compiler-macro</a>. Therefore <a 
href="clmse41.html#x53-85004r104">return-from</a> may be used to exit from the
function.
</div>
</div>
<div class=defun>
<!--l. 763--><p class="noindent" ><i>[Function]</i><a 
 id="dx62-101005"></a><a 
 id="x62-101006r143"></a><b> compiler-macro-function</b>  <i>name</i> &#x0026;optional  <i>env</i>
<!--l. 765--><p class="noindent" >The <i>name</i> must be a symbol. If it has been deﬁned as a compiler macro, then
<a 
href="#x62-101006r143">compiler-macro-function</a> returns the macro expansion function; otherwise it
returns <a 
href="clmse31.html#x42-70002r19">nil</a>. The lexical environment <i>env</i> may override any global deﬁnition for
<i>name</i> by deﬁning a local function or local macro (such as by <a 
href="clmse39.html#x51-83030r93">ﬂet</a>, <a 
href="clmse39.html#x51-83032r94">labels</a>, or
<a 
href="clmse39.html#x51-83034r95">macrolet</a>) in which case <a 
href="clmse31.html#x42-70002r19">nil</a> is returned.
<!--l. 774--><p class="indent" >   <a 
href="clmse36.html#x48-80002r66">setf</a> may be used with <a 
href="#x62-101006r143">compiler-macro-function</a> to install a function as the
expansion function for the compiler macro <i>name</i>, in the same manner as for
<a 
href="clmse46.html#x59-98005r136">macro-function</a>. Storing the value <a 
href="clmse31.html#x42-70002r19">nil</a> removes any existing compiler macro
deﬁnition. As with <a 
href="clmse46.html#x59-98005r136">macro-function</a>, a non-<a 
href="clmse31.html#x42-70002r19">nil</a> stored value must be a function of
two arguments, the entire macro call and the environment. The second
argument to <a 
href="#x62-101006r143">compiler-macro-function</a> must be omitted when it is used with
<a 
href="clmse36.html#x48-80002r66">setf</a>.
</div>
<div class=defun>
<!--l. 783--><p class="noindent" ><i>[Function]</i><a 
 id="dx62-101007"></a><a 
 id="x62-101008r144"></a><b> compiler-macroexpand</b>  <i>form</i> &#x0026;optional  <i>env</i><br 
class="newline" /><i>[Function]</i><a 
 id="dx62-101009"></a><a 
 id="x62-101010r145"></a><b> compiler-macroexpand-1</b>  <i>form</i> &#x0026;optional  <i>env</i>
<!--l. 786--><p class="noindent" >These are just like <a 
href="clmse47.html#x60-99002r138">macroexpand</a> and macroexpand-1 except that the
expander function is obtained as if by a call to <a 
href="#x62-101006r143">compiler-macro-function</a> on
the <i>car</i> of the <i>form</i> rather than by a call to <a 
href="clmse46.html#x59-98005r136">macro-function</a>. Note that
<a 
href="#x62-101008r144">compiler-macroexpand</a> performs repeated expansion but compiler-macroexpand-1
performs at most one expansion. Two values are returned, the expansion (or the
original <i>form</i>) and a value that is true if any expansion occurred and <a 
href="clmse31.html#x42-70002r19">nil</a>
                                                                          

                                                                          
otherwise.
<!--l. 796--><p class="indent" >   There are three cases where no expansion happens:
      <ul class="itemize1">
      <li class="itemize">There is no compiler macro deﬁnition for the <i>car</i> of <i>form</i>.
      </li>
      <li class="itemize">There is such a deﬁnition but there is also a notinline declaration, either
      globally or in the lexical environment <i>env</i>.
      </li>
      <li class="itemize">A global compiler macro deﬁnition is shadowed by a local function or
      macro deﬁnition (such as by <a 
href="clmse39.html#x51-83030r93">ﬂet</a>, <a 
href="clmse39.html#x51-83032r94">labels</a>, or <a 
href="clmse39.html#x51-83034r95">macrolet</a>).</li></ul>
<!--l. 805--><p class="noindent" >Note that if there is no expansion, the original <i>form</i> is returned as the ﬁrst value, and
<a 
href="clmse31.html#x42-70002r19">nil</a> as the second value.
<!--l. 808--><p class="indent" >   Any macro expansion performed by the function <a 
href="#x62-101008r144">compiler-macroexpand</a> or by
the function compiler-macroexpand-1 is carried out by calling the function that is
the value of *macroexpand-hook*.
<!--l. 812--><p class="indent" >   A compiler macro may decline to provide any expansion merely by returning
the original form. This is useful when using the facility to put “compiler
optimizers” on various function names. For example, here is a compiler macro that
“optimizes” (one would hope) the zero-argument and one-argument cases of a
function called plus: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(deﬁne-compiler-macro plus (&#x0026;whole form &#x0026;rest args)
</td></tr></table>
<!--l. 819--><p class="indent" >                                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (case (length args)</td></tr></table>
<!--l. 820--><p class="indent" >                                                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (0 0)</td></tr></table>
<!--l. 821--><p class="indent" >                                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (1 (car args))</td></tr></table>
<!--l. 822--><p class="indent" >                                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (t form)))</td></tr></table>
<!--l. 824--><p class="indent" >
</div>
</div>
</div>
</div>
<div class=newer>
                                                                          

                                                                          
   <!--l. 830--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse50.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse48.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse48.html#tailclmse48.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse49.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse49.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 830--><p class="indent" >   <a 
 id="tailclmse49.html"></a>  
</body></html> 
