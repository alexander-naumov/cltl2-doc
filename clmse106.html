<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Создание новых потоков</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-30 23:01:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 828--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse107.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse105.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse105.html#tailclmse105.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse106.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch21.html#clmse106.html" >Вверх</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">21.2   </span> <a 
href="clm.html#QQ2-132-269" id="x132-24000021.2">Создание новых потоков</a></h3>
<!--l. 830--><p class="noindent" >Пожалуй самые важные конструкции для создания новых потоков это то,
которые открывают файлы. Смотрите <tt><a 
href="clmse113.html#x141-276011r698">with-open-file</a></tt> и <tt><a 
href="clmse113.html#x141-276002r697">open</a></tt>. Следующие
функции создают потоки без ссылок на файловую систему.
<div class=defun>
<!--l. 834--><p class="noindent" ><i>[Функция]</i><a 
 id="dx132-240001"></a><a 
 id="x132-240002r585"></a><b> make-synonym-stream</b>  <i>symbol</i>
<!--l. 836--><p class="noindent" ><tt><a 
href="#x132-240002r585">make-synonym-stream</a></tt> создаёт и возвращает поток-синоним. Любые операции
на новом потоке будут проделаны на потоке, являющемся значением
динамической переменной с именем <i>symbol</i>. Если значение этой переменной
изменится или будет пересвязано, то поток-синоним будет воздействовать на
новый установленный поток.
</div>
<div class=defun>
<!--l. 844--><p class="noindent" ><i>[Функция]</i><a 
 id="dx132-240003"></a><a 
 id="x132-240004r586"></a><b> make-broadcast-stream</b>  &#x0026;rest  <i>streams</i>
<!--l. 846--><p class="noindent" >Эта функция возвращает поток, который работает только для записи. Любая
выходная информация, посланная в этот поток, будет отослана в все
указанные потоки <i>streams</i>. Множество операций, которые могут быть
выполнены на новом потоке, является пересечением множеств операций
для указанных потоков. Результаты, возвращаемые операциями над
новым потоком, являются результатами возвращёнными операциями на
последнем потоке из списка <i>streams</i>. Результаты полученные в ходе
выполнения функции над всеми, кроме последнего, потоками игнорируются.
Если не было передано ни одного потока в аргументе <i>streams</i>, тогда
результат является «кусочком клоаки». Вся выводимая информация будет
игнорироваться.
</div>
<div class=defun>
<!--l. 861--><p class="noindent" ><i>[Функция]</i><a 
 id="dx132-240005"></a><a 
 id="x132-240006r587"></a><b> make-concatenated-stream</b>  &#x0026;rest  <i>streams</i>
<!--l. 863--><p class="noindent" >Данная функция возвращает поток, который работает только для чтения.
Входная информация берётся из первого потоки из списка <i>streams</i> пока
указатель не достигнет конца-файла end-of-ﬁle, затем данный поток
                                                                          

                                                                          
откладывается, и входная информация берётся из следующего, и так
далее. Если список потоков <i>stream</i> был пуст, то возвращается поток без
содержимого. Любая попытка чтения будет возвращать конец-файла
end-of-ﬁle.
</div>
<div class=defun>
<!--l. 872--><p class="noindent" ><i>[Функция]</i><a 
 id="dx132-240007"></a><a 
 id="x132-240008r588"></a><b> make-two-way-stream</b>  <i>input-stream</i> <i>output-stream</i>
<!--l. 874--><p class="noindent" >Данная функция возвращает поток для чтения и записи, который входную
информацию получает из <i>input-stream</i> и посылает выходную информацию в
<i>output-stream</i>.
</div>
<div class=defun>
<!--l. 879--><p class="noindent" ><i>[Функция]</i><a 
 id="dx132-240009"></a><a 
 id="x132-240010r589"></a><b> make-echo-stream</b>  <i>input-stream</i> <i>output-stream</i>
<!--l. 881--><p class="noindent" >Данная функция возвращает поток для чтения и записи, который
получает входную информацию из <i>input-stream</i> и отсылает выходную в
<i>output-stream</i>. В дополнение, входная информация посылается в <i>output-stream</i>
(эхо).
</div>
<div class=defun>
<!--l. 887--><p class="noindent" ><i>[Функция]</i><a 
 id="dx132-240011"></a><a 
 id="x132-240012r590"></a><b> make-string-input-stream</b>  <i>string</i> &#x0026;optional  <i>start</i> <i>end</i>
<!--l. 889--><p class="noindent" >Данная функция возвращает поток для чтения. Данный поток
последовательно будет сохранять строковые символы в подстроке в строке
<i>string</i> ограниченной с помощью <i>start</i> и <i>end</i>. После того, как будет достигнут
последний символ, поток вернёт конец-файла.
</div>
<div class=defun>
<!--l. 896--><p class="noindent" ><i>[Функция]</i><a 
 id="dx132-240013"></a><a 
 id="x132-240014r591"></a><b> make-string-output-stream</b>  &#x0026;key  <i>:element-type</i>
<!--l. 898--><p class="noindent" >Данная функция возвращает поток для записи, который будет аккумулировать
всю полученную информацию в строку, которая может быть получена с
помощью функции <tt><a 
href="#x132-240016r592">get-output-stream-string</a></tt>.
<!--l. 903--><p class="indent" >   Аргумент <tt>:element-type</tt> указывает, какие символы могут приниматься
потоком. Если аргумент <tt>:element-type</tt> опущен, созданный поток должен
принимать все символы.
<!--l. 907--><p class="indent" >   Результатом <tt><a 
href="#x132-240014r591">make-string-output-stream</a></tt> всегда является поток типа
<tt>string-stream</tt>.
</div>
<div class=defun>
                                                                          

                                                                          
<!--l. 911--><p class="noindent" ><i>[Функция]</i><a 
 id="dx132-240015"></a><a 
 id="x132-240016r592"></a><b> get-output-stream-string</b>  <i>string-output-stream</i>
<!--l. 913--><p class="noindent" >Данная функция возвращает строку, для потока, возвращённого функцией
<tt><a 
href="#x132-240014r591">make-string-output-stream</a></tt>, которая содержит все записанную в
данный поток информацию. После этого поток сбрасывается. Таким
образом каждый вызов <tt><a 
href="#x132-240016r592">get-output-stream-string</a></tt> возвращает только те
символы, которые были записаны с момента предыдущего вызова этой
функции (или создания потока, если предыдущего вызова ещё не
было).
</div>
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> with-open-stream </b><a 
 id="dx132-240017"></a><a 
 id="x132-240018r593"></a> (var stream)  {declaration}*  { form}*
</td></tr></table>
<!--l. 924--><p class="indent" >
</div>
<!--l. 924--><p class="noindent" ><span class="paragraphHead"><a 
href="#x132-24100021.2" id="x132-24100021.2"></a></span>
   Форма <i>stream</i> вычисляется и должна вернуть поток. Переменная <i>var</i>
связывается с этим потоком, и затем выполняются формы тела как неявный
<tt><a 
href="clmse37.html#x49-95002r71">progn</a></tt>. Результатом выполнения <tt><a 
href="#x132-240018r593">with-open-stream</a></tt> является значение
последней формы. Поток автоматически закрывается при выходе из формы
<tt><a 
href="#x132-240018r593">with-open-stream</a></tt>, вне зависимости от типа выхода. Смотрите <tt><a 
href="clmse107.html#x133-244013r601">close</a></tt>. Поток
следует рассматривать, как имеющий динамическую продолжительность
видимости.
</div>
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> with-input-from-string </b><a 
 id="dx132-241001"></a><a 
 id="x132-241002r594"></a> (var string  {keyword value}* )
</td></tr></table>
<!--l. 937--><p class="indent" >                                                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> {declaration}*  { form}* </td></tr></table>
<!--l. 938--><p class="indent" >
                                                                          

                                                                          
</div>
<!--l. 938--><p class="noindent" ><span class="paragraphHead"><a 
href="#x132-24200021.2" id="x132-24200021.2"></a></span>
   Тело выполняется как неявный <tt><a 
href="clmse37.html#x49-95002r71">progn</a></tt> с переменной <i>var</i> связанной с
потоком символов для чтения, который последовательно предоставляет
символы из значения формы <i>string</i>. <tt><a 
href="#x132-241002r594">with-input-from-string</a></tt> возвращает
результат выполнения последней формы <i>form</i> тела.
<!--l. 944--><p class="indent" >   В параметрах могут использоваться следующие имена:
      <div class="quotation">
<div class=flushdesc>
      <!--l. 947--><p class="noindent" >
     <ul><li><b>
<tt>:index</tt> </b></li>Форма  после  <tt>:index</tt> должна  быть  <i>местом</i>,  в  которое
     можно  осуществить  запись  с  помощью  <tt><a 
href="clmse35.html#x47-89002r64">setf</a></tt>.  Если  форма
     <tt><a 
href="#x132-241002r594">with-input-from-string</a></tt> завершается  нормально,  то  <i>место</i>
     будет содержать позицию первого не прочитанного символа
     из строки <i>string</i> (или длину строки, если все символы были
     прочитаны). <i>Место</i> не изменяется в процессе чтения, а только
     во время выхода.
     <li><b>
<tt>:start</tt> </b></li><tt>:start</tt> принимает  аргумент,  указывающий  позицию  с
     которой  необходимо  начинать  чтение  символов  из  строки
     <i>string</i>.
     <li><b>
<tt>:end</tt> </b></li>The <tt>:end</tt> keyword takes an argument indicating, in the manner
     usual for sequence functions, the end of a substring of <i>string</i> to
     be used. <tt>:end</tt> принимает аргумент, указывающий на позицию
     на которой необходимо завершить чтение символов из строки
     <i>string</i>
     </ul>
</div>
      </div>
                                                                          

                                                                          
<!--l. 969--><p class="indent" >   The <tt>:start</tt> and <tt>:index</tt> keywords may both specify the same variable, which
is a pointer within the string to be advanced, perhaps repeatedly by some
containing loop.
<!--l. 973--><p class="indent" >   Вот простой пример использования <tt><a 
href="#x132-241002r594">with-input-from-string</a></tt>: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(with-input-from-string (s &#x0022;Animal Crackers&#x0022; :index j :start 6)
</td></tr></table>
<!--l. 975--><p class="indent" >                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (read s)) <span class="math"> ⇒</span> crackers</td></tr></table>
<!--l. 977--><p class="indent" >
</div>
</div>
<!--l. 978--><p class="noindent" >В качестве побочного эффекта переменная <tt>j</tt> будет установлена в <tt>15</tt>.
<tt>
<!--l. 980--><p class="indent" >   :start</tt> и <tt>:index</tt> могут оба содержать одну переменную, указывающую
позицию в строке, возможно, внутри цикла.
</div>
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> with-output-to-string </b><a 
 id="dx132-242001"></a><a 
 id="x132-242002r595"></a> (var [string [<span class="math">: element − type!type]])</span>
</td></tr></table>
<!--l. 986--><p class="indent" >                                                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> {declaration}*  { form}* </td></tr></table>
<!--l. 987--><p class="indent" >
</div>
<!--l. 987--><p class="noindent" ><span class="paragraphHead"><a 
href="#x132-24300021.2" id="x132-24300021.2"></a></span>
   Можно указать <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt> вместо строки <i>string</i> и использовать аргумент
<tt>:element-type</tt> для указания, какие символы должны приниматься
созданным потоком. Если аргумент <i>string</i> не указан или он <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt> и не
указан <tt>:element-type</tt>, то созданный поток должен принимать все
символы.
</div>
                                                                          

                                                                          
   <!--l. 994--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse107.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse105.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse105.html#tailclmse105.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse106.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch21.html#clmse106.html" >Вверх</a><tt>&#x003E;</tt></p></div>
<!--l. 994--><p class="indent" >   <a 
 id="tailclmse106.html"></a>  
</body></html> 
