<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Динамические нелокальные выходы</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-13 16:31:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 7259--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmch8.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse43.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse43.html#tailclmse43.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse44.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch7.html#clmse44.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">7.10   </span> <a 
 id="x56-1390007.10"></a>Динамические нелокальные выходы</h3>
<a 
 id="dx56-139001"></a>
<a 
 id="dx56-139002"></a>
<a 
 id="dx56-139003"></a>
<a 
 id="dx56-139004"></a>
<!--l. 7266--><p class="noindent" >Common Lisp предоставляет функциональноссть для выхода из сложного
процесса в нелокальном, динамических ограниченном стиле. Для этих целей
есть два вида специальных форм, называемых <i>catch</i> и <i>throw</i>. Форма catch
выполняет некоторые подформы так, что если форма throw выполняется в
ходе этих вычислений, в данной точке вычисления прерываются и форма
catch немедленно возвращает значение указанное в throw. В отличие от <a 
href="clmse41.html#x53-113002r87">block</a>
и <a 
href="clmse139.html#x170-346002r845">return</a> (раздел <a 
href="clmse41.html#x53-1130007.7">7.7<!--tex4ht:ref: BLOCK-RETURN-SECTION --></a>), которые позволяют выйти из тела <a 
href="clmse41.html#x53-113002r87">block</a> из любой точки
лексически, находящейся внутри тела, catch/throw механизм работает, даже
если форма throw по тексту не находится внутри тела формы catch.
Throw может использовать только в течение (продолжительности
времени) выполнения тела catch. Можно провести аналогию между ними,
как между динамически связываемыми переменными и лексически
связываемыми.
<div class=defspec>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Special form]</i><b> catch </b><a 
 id="dx56-139005"></a><a 
 id="x56-139006r114"></a> tag  { form}*
</td></tr></table>
<!--l. 7282--><p class="indent" >
</div>
<!--l. 7282--><p class="noindent" ><span class="paragraphHead"><a 
 id="x56-1400007.10"></a></span>
                                                                          

                                                                          
   Специальная форма <a 
href="#x56-139006r114">catch</a> служит мишенью для передачи управления с
помощью <a 
href="#x56-141002r116">throw</a>. Первой выполняется форма <i>tag</i> для создания объекта
для имени catch. Он может быть любым Lisp&#x2019;овым объектом. Затем
устанавливается ловушка с тегом, в качестве которого используется этот
объект. Формы <i>form</i> выполняются как неявный <a 
href="clmse38.html#x50-96002r71">progn</a>, и возвращается
результат последней формы. Однако если во время вычислений будет
выполнена форма <a 
href="#x56-141002r116">throw</a> с тегом, который равен <a 
href="clmse33.html#x44-78002r44">eq</a> тегу catch, то управление
немедленно прерывается и возвращается результат указанный в форме throw.
Ловушка, устанавливаемая с помощью <a 
href="#x56-139006r114">catch</a>, упраздняется перед тем, как
будет возвращен результат.
<!--l. 7297--><p class="indent" >   Тег используется для соотнесения throws и catches. (catch &#x2019;foo <i>form</i>) будет
перехватывать (throw &#x2019;foo <i>form</i>), но не будет (throw &#x2019;bar <i>form</i>). Если <a 
href="#x56-141002r116">throw</a>
выполнен без соотвествующего <a 
href="#x56-139006r114">catch</a>, готового его обработать, то это
является ошибкой.
<!--l. 7302--><p class="indent" >   Теги catch сравниваются с использованием <a 
href="clmse33.html#x44-78002r44">eq</a>, а не <a 
href="clmse33.html#x44-78004r45">eql</a>. Таким
образом числа и строковые символы не могут использоваться в качестве
тегов.
</div>
<a 
 id="dx56-140001"></a>
<a 
 id="dx56-140002"></a>
<div class=defspec>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Special form]</i><b> unwind-protect </b><a 
 id="dx56-140003"></a><a 
 id="x56-140004r115"></a> protected-form  {cleanup-form}*
</td></tr></table>
<!--l. 7311--><p class="indent" >
</div>
<!--l. 7311--><p class="noindent" ><span class="paragraphHead"><a 
 id="x56-1410007.10"></a></span>
   Иногда необходимо выполнить форму и быть уверенным, что некоторые
побочные эффекты выполняются после ее завершения. Например:
<div class=lisp><div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(progn (start-motor)
</td></tr></table>
<!--l. 7316--><p class="indent" >                                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (drill-hole)</td></tr></table>
<!--l. 7317--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (stop-motor))</td></tr></table>
<!--l. 7319--><p class="indent" >
</div>
</div>
<!--l. 7320--><p class="noindent" >Функциональность нелокальных выходов в Common Lisp создает ситуацию, в
которой однако данный код может не сработать правильно. Если drill-hole
может бросить исключение в ловушку, находяющуюся выше данного <a 
href="clmse38.html#x50-96002r71">progn</a>,
то (stop-motor) никогда не выполниться. Более удобный пример с
открытием/закрытием файлов: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(prog2 (open-a-ﬁle)
</td></tr></table>
<!--l. 7326--><p class="indent" >                                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (process-ﬁle)</td></tr></table>
<!--l. 7327--><p class="indent" >                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (close-the-ﬁle))</td></tr></table>
<!--l. 7329--><p class="indent" >
</div>
</div>
<!--l. 7330--><p class="noindent" >где закрытие файла может не произойти, по причине ошибки в функции
process-ﬁle.
<!--l. 7333--><p class="indent" >   Для того, чтобы вышеприведенный код работал корректно, можно
переписать его с использованием <a 
href="#x56-140004r115">unwind-protect</a>: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">;; Stop the motor no matter what (even if it failed to start).
</td></tr></table>
<!--l. 7336--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 7337--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(unwind-protect</td></tr></table>
<!--l. 7338--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (progn (start-motor)</td></tr></table>
<!--l. 7339--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         (drill-hole))</td></tr></table>
<!--l. 7340--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (stop-motor))</td></tr></table>
<!--l. 7342--><p class="indent" >
</div>
</div>
                                                                          

                                                                          
<!--l. 7343--><p class="noindent" >Если drill-hole бросит исключение, которое попытается выйти из блока
<a 
href="#x56-140004r115">unwind-protect</a>, то (stop-motor) будет обязательно выполнена.
<!--l. 7346--><p class="indent" >   Этот пример допускает то, что вызов stop-motor корректен, даже если
мотор еще не был запущен. Помните, что ошибка или прерывание может
осуществить выход перед тем, как будет проведена инициализация. Любой
код по восстановлению состояния должен правильно работать вне
зависимости от того, где произошла ошибка. Например, следующий код
неправильный: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(unwind-protect
</td></tr></table>
<!--l. 7353--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (progn (incf *access-count*)</td></tr></table>
<!--l. 7354--><p class="indent" >                                               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         (perform-access))</td></tr></table>
<!--l. 7355--><p class="indent" >                                                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (decf *access-count*))</td></tr></table>
<!--l. 7357--><p class="indent" >
</div>
</div>
<!--l. 7358--><p class="noindent" >Если выход случиться перед тем, как выполниться операция <a 
href="clmse66.html#x83-181014r192">incf</a>, то выполнение
<a 
href="clmse66.html#x83-181016r193">decf</a> приведет к некорректному значению в *access-count*. Правильно будет
записать этот код так: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((old-count *access-count*))
</td></tr></table>
<!--l. 7362--><p class="indent" >                                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (unwind-protect</td></tr></table>
<!--l. 7363--><p class="indent" >                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (progn (incf *access-count*)</td></tr></table>
<!--l. 7364--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">           (perform-access))</td></tr></table>
<!--l. 7365--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (setq *access-count* old-count)))</td></tr></table>
<!--l. 7367--><p class="indent" >
</div>
</div>
<!--l. 7369--><p class="indent" >   Как правило, <a 
href="#x56-140004r115">unwind-protect</a> гарантирует выполнение форм <i>cleanup-form</i>
перед выходом, как в случае нормального выхода, так и в случае генерации
исключения. (Если, однако, выход случился в ходе выполнения форм
<i>cleanup-form</i>, никакого специального действия не предпринимается. Формы
<i>cleanup-form</i> не защищаются. Для этого необходимо использовать
                                                                          

                                                                          
дополнительные конструкции <a 
href="#x56-140004r115">unwind-protect</a>.) <a 
href="#x56-140004r115">unwind-protect</a> возвращает
результат выполнения защищенной формы <i>protected-form</i> и игнорирует все
результаты выполнения форм чистки <i>cleanup-form</i>.
<!--l. 7380--><p class="indent" >   Следует подчеркнуть, что <a 
href="#x56-140004r115">unwind-protect</a> защищает против <i>всех</i> попыток
выйти из защищенной формы, включая не только «динамический выход» с
помощью <a 
href="#x56-141002r116">throw</a>, но и также «лексический выход» с помощью <a 
href="clmse42.html#x54-128002r104">go</a> и
<a 
href="clmse41.html#x53-114002r88">return-from</a>. Рассмотрим следующую ситуацию: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(tagbody
</td></tr></table>
<!--l. 7385--><p class="indent" >                                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((x 3))</td></tr></table>
<!--l. 7386--><p class="indent" >                                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (unwind-protect</td></tr></table>
<!--l. 7387--><p class="indent" >                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (if (numberp x) (go out))</td></tr></table>
<!--l. 7388--><p class="indent" >                                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (print x)))</td></tr></table>
<!--l. 7389--><p class="indent" >                                                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> out</td></tr></table>
<!--l. 7390--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 7392--><p class="indent" >
</div>
</div>
<!--l. 7393--><p class="noindent" >Когда выполнится <a 
href="clmse42.html#x54-128002r104">go</a>, то сначала выполнится <a 
href="clmse114.html#x141-263010r675">print</a>, а затем перенос управления
на тег out будет завершен.
</div>
<div class=defspec>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Special form]</i><b> throw </b><a 
 id="dx56-141001"></a><a 
 id="x56-141002r116"></a> tag result
</td></tr></table>
<!--l. 7399--><p class="indent" >
</div>
<!--l. 7399--><p class="noindent" ><span class="paragraphHead"><a 
 id="x56-1420007.10"></a></span>
                                                                          

                                                                          
   Специальная форма <a 
href="#x56-141002r116">throw</a> переносит управление к соотвествующей
конструкции <a 
href="#x56-139006r114">catch</a>. Сначала выполняется <i>tag</i> для вычисления объекта,
называемого тег throw. Затем вычисляется форма результата <i>result</i>, и этот
результат сохраняется (если форма <i>result</i> возвращает несколько значений, то
<i>все</i> значения сохраняются). Управление выходит и самого последнего
установленного catch, тег которого совпадает с тегом throw. Сохраненные
результаты возвращаются, как значения конструкции <a 
href="#x56-139006r114">catch</a>. Теги catch и
throw совпадают, только если они равны <a 
href="clmse33.html#x44-78002r44">eq</a>.
<!--l. 7411--><p class="indent" >   В процессе, связывания динамических переменных упраздняются
до точки catch, и выполнятся все формы очистки в конструкциях
unwind-protect. Форма <i>result</i> вычисляется перед началом процесса
раскручивания, и ее значение возвращается из блока catch.
<!--l. 7416--><p class="indent" >   Если внешний блок catch с совпадающим тегом не найден, раскрутка стека
не происходит и сигнализируется ошибка. Когда ошибка сигнализируется,
ловушки и динамические связывания переменных являются теми, которые
были в точке throw.
</div>
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
   <!--l. 1246--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmch8.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse43.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse43.html#tailclmse43.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch7.html#clmse44.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 1246--><p class="indent" >   <a 
 id="tailclmse44.html"></a>  
</body></html> 
