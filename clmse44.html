<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Определение макроса</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-11 09:24:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 1230--><p class="noindent" > <div id="main_container"> <div id="content"> <!--l. 1230--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse45.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#tailclmch8.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse44.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse44.html" >Вверх</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">8.1   </span> <a 
href="clm.html#QQ2-57-151" id="x57-1430008.1">Определение макроса</a></h3>
<!--l. 1232--><p class="noindent" >Функция <tt><a 
href="#x57-143002r117">macro-function</a></tt> определяет, является ли данный символ именем
макроса. Конструкция <tt><a 
href="#x57-143004r118">defmacro</a></tt> предоставляет удобный способ определить
новый макрос.
<div class=defun>
<!--l. 1236--><p class="noindent" ><i>[Функция]</i><a 
 id="dx57-143001"></a><a 
 id="x57-143002r117"></a><b> macro-function</b>  <i>symbol</i> &#x0026;optional  <i>env</i>
<!--l. 1238--><p class="noindent" >Первый аргумент должен быть символом. Если символ содержит
определение функции, то есть определение макроса, локально созданное в
окружении <i>env</i> с помощью <tt><a 
href="clmse38.html#x50-102006r79">macrolet</a></tt> или глобально созданное с помощью
<tt><a 
href="#x57-143004r118">defmacro</a></tt>, тогда возвращается функция раскрытия (функция двух
аргументов, первый форма макровызова и второй — окружение). Если
символ не содержит определение функции, или это определение обычной
функции или это специальная форма, но не макрос, тогда возвращается <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt>.
Наилучший способ вызвать функцию раскрытия использовать <tt><a 
href="clmse45.html#x58-145002r119">macroexpand</a></tt>
или <tt><a 
href="clmse45.html#x58-145004r120">macroexpand-1</a></tt>.
<!--l. 1249--><p class="indent" >   Возможно такое, что и <tt><a 
href="#x57-143002r117">macro-function</a></tt>, и <tt><a 
href="clmse34.html#x46-85015r58">special-operator-p</a></tt> обе
возвращают истину для одного заданного символа. Так происходит, потому
что реализация может для увеличения производительности реализовывать
любой макрос, как специальную форму. С другой стороны, определения
макросов должны быть доступны для использования программами, которые
понимают только стандартные специальные формы, перечисленные в
таблице <a 
href="clmse27.html#x37-590011">5.1<!--tex4ht:ref: SPECIAL-FORM-TABLE --></a>.
                                                                          

                                                                          
<tt>
<!--l. 1257--><p class="indent" >   <a 
href="clmse35.html#x47-89002r64">setf</a></tt> может быть использована с <tt><a 
href="#x57-143002r117">macro-function</a></tt> для установки в символ
глобального определения макроса: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(setf (macro-function <i>symbol</i>) <i>fn</i>)
</td></tr></table>
<!--l. 1261--><p class="indent" >
</div>
</div>
<!--l. 1262--><p class="noindent" >Устанавливаемое значение должно быть функцией, которая принимает два
аргументы, список макровызова и окружение, и вычислять раскрытие этого
макровызова. Выполнение этой операции указывает на то, что символ будет
содержать <i>только</i> это определение макроса в качестве определения
глобальной функции. Предыдущее определение функции или макроса
утрачивается. С помощью <tt><a 
href="clmse35.html#x47-89002r64">setf</a></tt> невозможно установить локальное
определение макроса. При использовании <tt><a 
href="clmse35.html#x47-89002r64">setf</a></tt> указание второго параметра
(окружение) является ошибкой. Переопределение специальной формы также
является ошибкой.
<!--l. 1271--><p class="indent" >   Смотрите также <tt>compiler-macro-function</tt>.
</div>
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> defmacro </b><a 
 id="dx57-143003"></a><a 
 id="x57-143004r118"></a> name lambda-list  [[ {declaration}*  | doc-string]]  { form}*
</td></tr></table>
<!--l. 1276--><p class="indent" >
</div>
<!--l. 1276--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-1440008.1" id="x57-1440008.1"></a></span>
   <tt><a 
href="#x57-143004r118">defmacro</a></tt> является макросом определяющим макросы, которые
преобразуют формы макровызовов. <tt><a 
href="#x57-143004r118">defmacro</a></tt> имеет почти такой же
синтаксис, как и <tt><a 
href="clmse29.html#x39-66002r13">defun</a></tt>: <i>name</i> является символом, для которого создаётся
макрос, <i>lambda-list</i> похож на список параметров лямбда-выражения и <i>form</i>
                                                                          

                                                                          
содержит тело функции раскрытия. Конструкция <i>defmacro</i> устанавливает
функцию раскрытия, как глобальное определение макроса для символа
<i>name</i>. FIXME
<!--l. 1287--><p class="indent" >   Форма <tt><a 
href="#x57-143004r118">defmacro</a></tt> возвращает в качестве значение <i>name</i>.
<!--l. 1289--><p class="indent" >   Если мы рассмотрим макровызов, как список содержащий имя
функции и некоторые формы аргументов, то механизм заключается в
передаче в функцию <tt><a 
href="clmse36.html#x48-94002r68">apply</a></tt> этой функции и списка её (невычисленных)
аргументов. Спецификаторы параметров обрабатываются также, как и для
любого лямбда-выражения. В качестве параметров используются
формы аргументов макровызова. Затем вычисляются формы тела, как
неявный <tt><a 
href="clmse37.html#x49-95002r71">progn</a></tt>. Значение последней формы возвращается, как раскрытие
макровызова.
<!--l. 1297--><p class="indent" >   Если указана необязательная строка документации <i>doc-string</i>, тогда
она присоединяется к символу <i>name</i>, как строка документации типа
<tt><a 
href="clmse34.html#x46-84002r52">function</a></tt>. Смотрите <tt><a 
href="clmse140.html#x172-404017r847">documentation</a></tt>. Если в определении макроса
представлена только строка документации, и после неё нет ни одной
формы, ни деклараций, ни просто для тела, то данная строка сама
становиться формой, и тело считается состоящим из одной формы — этой
строки.
<!--l. 1304--><p class="indent" >   Следующие три дополнительных маркера доступны в определении
лямбда-списка. <div class=indentdesc>
      <ul><li><b>
<tt>&#x0026;body</tt> </b></li>
      <!--l. 1308--><p class="noindent" >Данный  маркер  эквивалентен  <tt>&#x0026;rest</tt> маркеру,  но  дополнительно
      сообщает для функций вывода-форматирования и редактирования,
      что   оставшаяся   часть   формы   рассматривается   как   тело   и
      должна быть правильно отформатирована. (Можно использовать
      исключительно один маркер или <tt>&#x0026;body</tt>, или <tt>&#x0026;rest</tt>)
      <li><b>
<tt>&#x0026;whole</tt> </b></li>За  данным  маркером  указывается  одна  переменная,  которая
      будет связана со всей формой макровызова. Это значение, которое
      получает функция определения макроса в качестве своего первого
      аргумента. <tt>&#x0026;whole</tt> и следующая переменная должны указываться
      на первой позиции в лямбда-списке, перед другими параметрами
      или маркерами.
      <li><b>
                                                                          

                                                                          
<tt>&#x0026;environment</tt> </b></li>
      <!--l. 1322--><p class="noindent" >За данным маркером указывается одна переменная, которая будет
      связана с окружением, отображающим лексическое окружение, в
      котором произошёл макровызов. Это окружение может не быть
      полным  лексическим  окружением.  Оно  должно  использоваться
      только                 с                 функцией                 <tt><a 
href="clmse45.html#x58-145002r119">macroexpand</a></tt>
      ради  любых  локальных  определений  макросов,  которые  могли
      быть установлены с помощью <tt><a 
href="clmse38.html#x50-102006r79">macrolet</a></tt> конструкции внутри этого
      лексического окружения. Этот функционал полезен крайне редко,
      когда определение макроса должно явно раскрыть другие макросы
      в процессе своего раскрытия.</ul>
</div>
<!--l. 1332--><p class="indent" >   Смотрите <tt><a 
href="clmse28.html#x38-64008r11">lambda-list-keywords</a></tt>.
<tt>
<!--l. 1334--><p class="indent" >   <a 
href="#x57-143004r118">defmacro</a></tt>, в отличие от любых других конструкций Common
Lisp&#x2019;а, имеющих лямбда-списки в своём синтаксисе, предоставляет
дополнительную функциональность известную как <i>деструктуризация</i>. <div class=newer>
Смотрите <tt><a 
href="clmse46.html#x59-146002r122">destructuring-bind</a></tt>, которая отдельно предоставляет эту
функциональность.
</div> В любом месте, где могло бы стоять имя параметра, и где по синтаксису не
ожидается использование списка (как описано в разделе <a 
href="clmse28.html#x38-640005.2.2">5.2.2<!--tex4ht:ref: LAMBDA-EXPRESSIONS-SECTION --></a>), можно
использовать ещё один встроенный лямбда-список. Когда использован такой
приём, при передаче форм аргументов для встроенного лямбда-списка,
необходимо обернуть эти формы в отдельный список. В качестве
примера, определение макроса для <tt><a 
href="clmse41.html#x53-121002r93">dolist</a></tt> можно записать в таком стиле:
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform <tt>&#x0026;optional</tt> resultform)
</td></tr></table>
<!--l. 1349--><p class="indent" >                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  &#x0026;rest body)</td></tr></table>
<!--l. 1350--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1352--><p class="indent" >
</div>
</div>
<!--l. 1353--><p class="noindent" >Ниже будет больше примеров использования встраиваемых лямбда-списков в
<tt><a 
href="#x57-143004r118">defmacro</a></tt>.
                                                                          

                                                                          
<!--l. 1356--><p class="indent" >   Следующим правилом деструктуризации является то, что <tt><a 
href="#x57-143004r118">defmacro</a></tt>
позволяет любому лямбда-списку (верхнего уровня или встроенному) быть
dotted, заканчивающимся именем параметра. Такая ситуация обрабатывается
так, как будто имя параметра в конце списка, стоит после неявного маркера
<tt>&#x0026;rest</tt>. Например, уже показанное определение <tt><a 
href="clmse41.html#x53-121002r93">dolist</a></tt> может быть записано
так: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform &#x0026;optional resultform)
</td></tr></table>
<!--l. 1362--><p class="indent" >                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  . body)</td></tr></table>
<!--l. 1363--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1365--><p class="indent" >
</div>
</div>
<!--l. 1367--><p class="indent" >   Если компилятор встречает <tt><a 
href="#x57-143004r118">defmacro</a></tt>, он добавляет новый макрос в
окружение компиляции, и также функция раскрытия добавляется в
выходной файл. Таким образом новый макрос будет более быстрым во время
выполнения. Если необходимо избежать такого механизма, можно
использовать <tt><a 
href="#x57-143004r118">defmacro</a></tt> внутри конструкции <tt><a 
href="clmse29.html#x39-70002r17">eval-when</a></tt>.
<tt>
<!--l. 1373--><p class="indent" >   <a 
href="#x57-143004r118">defmacro</a></tt> может также использоваться для переопределения макроса
(например, для установки корректной версии определения вместо
некорректной), или для переопределения функции в макрос. Переопределение
специальной формы (смотрите таблицу <a 
href="clmse27.html#x37-590011">5.1<!--tex4ht:ref: SPECIAL-FORM-TABLE --></a>) не допускается. Смотрите
<tt><a 
href="clmse38.html#x50-102006r79">macrolet</a></tt>, которая устанавливает определение макроса в замкнутом
лексическом области видимости.
<!--l. 1381--><p class="indent" >   Допустим, для примера, что необходимо реализовать условную
конструкцию аналогичную Fortran&#x2019;овскому арифметическому выражению
IF. (Это конечно требует определённого расширения воображения
и приостановки неверия.) Конструкция должна принимать четыре
формы: <i>test-value</i>, <i>neg-form</i>, <i>zero-form</i> и <i>pos-form</i>. В зависимости от того,
является ли <i>test-form</i> отрицательным, нулём или положительным
числом, для выполнения будет выбрана одна из трёх последних форм. С
использованием <tt><a 
href="#x57-143004r118">defmacro</a></tt>, определение этой конструкции может выглядеть
так: <div class=lisp><div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro arithmetic-if (test neg-form zero-form pos-form)
</td></tr></table>
<!--l. 1394--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 1395--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(let ((,var ,test))</td></tr></table>
<!--l. 1396--><p class="indent" >                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (cond ((&#x003C; ,var 0) ,neg-form)</td></tr></table>
<!--l. 1397--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             ((= ,var 0) ,zero-form)</td></tr></table>
<!--l. 1398--><p class="indent" >                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (t ,pos-form)))))</td></tr></table>
<!--l. 1400--><p class="indent" >
</div>
</div>
<!--l. 1401--><p class="noindent" >Необходимо отметить, что в данном определении используется функциональность
обратной кавычки (смотрите раздел <a 
href="clmse108.html#x135-24900022.1.3">22.1.3<!--tex4ht:ref: MACRO-CHARACTERS-SECTION --></a>). Также необходимо заметить, что
используется <tt><a 
href="clmse52.html#x67-159006r136">gensym</a></tt> для создания нового имени переменной. Это необходимо
для избежания конфликтов с другими переменными, которые могут
использоваться в формах <i>neg-form</i>, <i>zero-form</i> или <i>pos-form</i>.
<!--l. 1408--><p class="indent" >   Если форма выполняется интерпретатором, то определение функции для
символа <tt>arithmetic-if</tt> будет является макросом, с которым ассоциирована
функция двух аргументом эквивалентная данной <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(lambda (calling-form environment)
</td></tr></table>
<!--l. 1412--><p class="indent" >                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (declare (ignore environment))</td></tr></table>
<!--l. 1413--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 1414--><p class="indent" >                                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (list &#x2019;let</td></tr></table>
<!--l. 1415--><p class="indent" >                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">          (list (list &#x2019;var (cadr calling-form)))</td></tr></table>
<!--l. 1416--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">          (list &#x2019;cond</td></tr></table>
<!--l. 1417--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list (list &#x2019;&#x003C; var &#x2019;0) (caddr calling-form))</td></tr></table>
<!--l. 1418--><p class="indent" >              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list (list &#x2019;= var &#x2019;0) (cadddr calling-form))</td></tr></table>
<!--l. 1419--><p class="indent" >                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list &#x2019;t (ﬁfth calling-form))))))</td></tr></table>
<!--l. 1421--><p class="indent" >
</div>
</div>
<!--l. 1422--><p class="noindent" >Лямбда-выражение является результатом выполнения декларации <tt><a 
href="#x57-143004r118">defmacro</a></tt>.
Вызов <tt><a 
href="clmse80.html#x100-201034r441">list</a></tt> является (гипотетически) результатом макросимвола
обратной кавычки (<tt>‘</tt>) и связанной с ним запятой. Конкретная функция
раскрытия макроса может зависеть от реализации, например, она также
                                                                          

                                                                          
может содержать проверку на корректность входных аргументов в
макровызове.
<!--l. 1428--><p class="indent" >   Теперь, если <tt><a 
href="clmse103.html#x128-236002r562">eval</a></tt> встретит <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(arithmetic-if (- x 4.0)
</td></tr></table>
<!--l. 1430--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               (- x)</td></tr></table>
<!--l. 1431--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               (error &#x0022;Strange zero&#x0022;)</td></tr></table>
<!--l. 1432--><p class="indent" >                                                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               x)</td></tr></table>
<!--l. 1434--><p class="indent" >
</div>
</div>
<!--l. 1435--><p class="noindent" >то раскроет эту форму в <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((g407 (- x 4.0)))
</td></tr></table>
<!--l. 1437--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (cond ((&#x003C; g407 0) (- x))</td></tr></table>
<!--l. 1438--><p class="indent" >                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        ((= g407 0) (error &#x0022;Strange zero&#x0022;))</td></tr></table>
<!--l. 1439--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (t x)))</td></tr></table>
<!--l. 1441--><p class="indent" >
</div>
</div>
<!--l. 1442--><p class="noindent" >и <tt> <a 
href="clmse103.html#x128-236002r562">eval</a></tt> выполнит полученную форму. (Сейчас должно быть понятно, что
функциональность обратной кавычки очень полезна для написания
макросов. Она используется для построения шаблона, возвращаемой
формы, с константными частями и частями для выполнения. Шаблон
представляет собой «картину» кода, с местами для заполнения выделенными
запятыми.)
<!--l. 1448--><p class="indent" >   Для улучшения примера мы можем сделать так, чтобы <i>pos-form</i> и
<i>zero-form</i> могли быть заменены на <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt> в результате раскрытия макроса.
Таким же образом действует и <tt><a 
href="clmse130.html#x160-327002r793">if</a></tt> опуская ветку <i>else</i> в случае истинности
условия. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro arithmetic-if (test neg-form
</td></tr></table>
                                                                          

                                                                          
<!--l. 1453--><p class="indent" >              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                         <tt>&#x0026;optional</tt> zero-form pos-form)</td></tr></table>
<!--l. 1454--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 1455--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(let ((,var ,test))</td></tr></table>
<!--l. 1456--><p class="indent" >                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (cond ((&#x003C; ,var 0) ,neg-form)</td></tr></table>
<!--l. 1457--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             ((= ,var 0) ,zero-form)</td></tr></table>
<!--l. 1458--><p class="indent" >                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (t ,pos-form)))))</td></tr></table>
<!--l. 1460--><p class="indent" >
</div>
</div>
<!--l. 1461--><p class="noindent" >Тогда можно записать <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(arithmetic-if (- x 4.0) (print x))
</td></tr></table>
<!--l. 1464--><p class="indent" >
</div>
</div>
<!--l. 1465--><p class="noindent" >и это раскроется в что-то вроде <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((g408 (- x 4.0)))
</td></tr></table>
<!--l. 1467--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (cond ((&#x003C; g408 0) (print x))</td></tr></table>
<!--l. 1468--><p class="indent" >                                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        ((= g408 0) nil)</td></tr></table>
<!--l. 1469--><p class="indent" >                                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (t nil)))</td></tr></table>
<!--l. 1471--><p class="indent" >
</div>
</div>
<!--l. 1472--><p class="noindent" >Результирующий код корректен, но некрасиво выглядит. Можно переписать
определение макроса для генерации лучшего кода, когда <i>pos-form</i> и
<i>zero-form</i> могут быть вообще опущены. Или же можно положиться на
реализацию Common Lisp&#x2019;а, которая возможно оптимизирует этот
код.
<!--l. 1478--><p class="indent" >   Деструктуризация является очень мощной функциональностью, которая
позволяет лямбда-списку в <tt><a 
href="#x57-143004r118">defmacro</a></tt> выразить сложную структуру
макровызова. Если не использовались ключевые символы лямбда-списка, то
он представляет собой просто список с некоторой степенью вложенности и
                                                                          

                                                                          
параметрами в качестве листьев. Структура макровызова должна иметь
такую же структуру списка. Например, рассмотрим следующее определение
макроса: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro halibut ((mouth eye1 eye2)
</td></tr></table>
<!--l. 1485--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   ((ﬁn1 length1) (ﬁn2 length2))</td></tr></table>
<!--l. 1486--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   tail)</td></tr></table>
<!--l. 1487--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1489--><p class="indent" >
</div>
</div>
<!--l. 1490--><p class="noindent" >Теперь давайте рассмотрим макровызов: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 1492--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 1493--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 1495--><p class="indent" >
</div>
</div>
<!--l. 1496--><p class="noindent" >Все это приведёт к тому, что функция раскрытия получит следующие значения
для её параметров:
<div class="flushleft" 
>
<!--l. 1498--><p class="noindent" >
 <!--tex4ht:inline--><div class="tabular"><table width="100%"><tr><td align="left" >Parameter</td><td align="left" >Value              </td></tr><tr><td align="left" >mouth </td> <td align="left" >m</td>
</tr><tr><td align="left" >eye1        </td><td align="left" >(car eyes)         </td>
</tr><tr><td align="left" >eye2        </td><td align="left" >(cdr eyes)         </td>
</tr><tr><td align="left" >ﬁn1         </td><td align="left" >f1                   </td>
</tr><tr><td align="left" >length1    </td><td align="left" >(count-scales f1)</td>
</tr><tr><td align="left" >ﬁn2         </td><td align="left" >f2                   </td>
</tr><tr><td align="left" >length2    </td><td align="left" >(count-scales f2)</td>
</tr><tr><td align="left" >tail         </td><td align="left" >my-favorite-tail </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr><td align="left" > </td></tr></table></div></div>
<!--l. 1514--><p class="noindent" >Следующий макровызов ошибочный, так как аргумента для параметра <tt>length1</tt>
не представлено: <div class=lisp><div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 1517--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1) (f2 (count-scales f2)))</td></tr></table>
<!--l. 1518--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 1520--><p class="indent" >
</div>
</div>
<!--l. 1521--><p class="noindent" >Следующий макровызов также ошибочный, так как на месте предполагаемого
списка указан символ. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut my-favorite-head
</td></tr></table>
<!--l. 1524--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 1525--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 1527--><p class="indent" >
</div>
</div>
<!--l. 1528--><p class="noindent" >Тот факт, что значение переменной <tt>my-favorite-head</tt> может быть списком, не
имеет здесь значения. В макровызове структура должна совпадать с
лямбда-списком в определении.
<!--l. 1532--><p class="indent" >   Использование ключевых символов лямбда-списка предоставляет ещё
большую гибкость. Например, предположим, что удобно будет в функции
раскрытия обращаться к элементам списка, называемым cdmouth, <tt>eye1</tt>, and
<tt>eye2</tt>, как к <tt>head</tt>. Можно записать так: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro halibut ((<tt>&#x0026;whole</tt> head mouth eye1 eye2)
</td></tr></table>
<!--l. 1539--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   ((ﬁn1 length1) (ﬁn2 length2))</td></tr></table>
<!--l. 1540--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   tail)</td></tr></table>
<!--l. 1542--><p class="indent" >
</div>
</div>
<!--l. 1543--><p class="noindent" >Теперь рассмотрим такой же, как раньше, корректный макровызов: <div class=lisp><div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 1545--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 1546--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 1548--><p class="indent" >
</div>
</div>
<!--l. 1549--><p class="noindent" >Это приведёт к тому, что функции раскрытия получит те же значения для своих
параметров, а также значение для параметра <tt>head</tt>:
<div class="flushleft" 
>
<!--l. 1551--><p class="noindent" >
 <!--tex4ht:inline--><div class="tabular"><table width="100%"><tr><td align="left" >Parameter</td><td align="left" >Value                         </td></tr><tr><td align="left" >head </td> <td align="left" >(m (car eyes) (cdr eyes))</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr><td align="left" > </td></tr></table>
</div></div>
<!--l. 1561--><p class="indent" >   Существует условие для деструктуризации, встроенный лямбда-список
разрешён только на позиции, где синтаксис лямбда-списка предусматривает
имя параметра, но не список. Это защищает от двусмысленности. Например,
нельзя записать <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x <tt>&#x0026;optional</tt> (a b <tt>&#x0026;rest</tt> c) <tt>&#x0026;rest</tt> z)
</td></tr></table>
<!--l. 1565--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1567--><p class="indent" >
</div>
</div>
<!--l. 1568--><p class="noindent" >потому что синтаксис лямбда-списка не позволяет использовать списки
после <tt>&#x0026;optional</tt>. Список <tt>(a b <tt>&#x0026;rest</tt> c)</tt> был бы интерпретирован как
необязательный параметр <tt>a</tt>, у которого значение по умолчанию <tt>b</tt>, и
supplied-p параметр с некорректным именем <tt>&#x0026;rest</tt>, и дополнительным
символом <tt>c</tt>, также некорректным. Было бы правильнее выразить это так:
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x <tt>&#x0026;optional</tt> ((a b <tt>&#x0026;rest</tt> c)) <tt>&#x0026;rest</tt> z)
</td></tr></table>
                                                                          

                                                                          
<!--l. 1574--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1576--><p class="indent" >
</div>
</div>
<!--l. 1577--><p class="noindent" >Дополнительные круглые скобки устраняют двусмысленность. Однако, такой
макровызов, как <tt>(loser (car pool))</tt> не предоставляет никакой формы
аргумента для лямбда-списка <tt>(a b <tt>&#x0026;rest</tt> c)</tt>, значит значение по умолчанию
для него будет <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt>. А так как <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt> является пустым списком, то этот
макровызов ошибочен. Полностью корректное определение выглядит так:
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x <tt>&#x0026;optional</tt> ((a b <tt>&#x0026;rest</tt> c) &#x2019;(nil nil)) <tt>&#x0026;rest</tt> z)
</td></tr></table>
<!--l. 1583--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1585--><p class="indent" >
</div>
</div>
<!--l. 1586--><p class="noindent" >или так <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x <tt>&#x0026;optional</tt> ((<tt>&#x0026;optional</tt> a b <tt>&#x0026;rest</tt> c)) <tt>&#x0026;rest</tt> z)
</td></tr></table>
<!--l. 1588--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1590--><p class="indent" >
</div>
</div>
<!--l. 1591--><p class="noindent" >Они слегка отличаются: первое определение требует, что если макровызов явно
указывает <tt>a</tt>, тогда он должен указать явно и <tt>b</tt>, тогда как второе определение
не содержит такого требования. Например, <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(loser (car pool) ((+ x 1)))
</td></tr></table>
<!--l. 1596--><p class="indent" >
                                                                          

                                                                          
</div>
</div>
<!--l. 1597--><p class="noindent" >будет корректным макровызовом для второго определения, но не для
первого.
</div>
                                                                          

                                                                          
   <!--l. 1600--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse45.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#tailclmch8.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse44.html" >Вверх</a><tt>&#x003E;</tt></p></div>
<!--l. 1600--><p class="indent" >   <a 
 id="tailclmse44.html"></a>  </div> </div> 
</body></html> 
