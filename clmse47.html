<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Macro Expansion</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-06 23:16:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 560--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse48.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html#tailclmse46.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse47.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse47.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">8.2   </span> <a 
 id="x60-3150008.2"></a>Macro Expansion</h3>
<!--l. 562--><p class="noindent" >The <a 
href="#x60-222002r138">macroexpand</a> function is the conventional means for expanding a macro call.
A hook is provided for a user function to gain control during the expansion
process.
<div class=defun>
<!--l. 566--><p class="noindent" ><i>[Function]</i><a 
 id="dx60-315001"></a><a 
 id="x60-315002r138"></a><b> macroexpand</b>  <i>form</i> &#x0026;optional  <i>env</i><br 
class="newline" /><i>[Function]</i><a 
 id="dx60-315003"></a><a 
 id="x60-315004r139"></a><b> macroexpand-1</b>  <i>form</i> &#x0026;optional  <i>env</i>
<!--l. 569--><p class="noindent" ><span class="paragraphHead"><a 
 id="x60-316000139"></a></span>
   If <i>form</i> is a macro call, then macroexpand-1 will expand the macro call <i>once</i>
and return two values: the expansion and <a 
href="clmse31.html#x42-87002r20">t</a>. If <i>form</i> is not a macro call, then the
two values <i>form</i> and <a 
href="clmse31.html#x42-86002r19">nil</a> are returned.
<!--l. 575--><p class="indent" >   A <i>form</i> is considered to be a macro call only if it is a cons whose <i>car</i> is a
symbol that names a macro. The environment <i>env</i> is similar to that used within
the evaluator (see <a 
href="clmse110.html#x135-588004r623">evalhook</a>); it defaults to a null environment. Any local macro
deﬁnitions established within <i>env</i> by <a 
href="clmse39.html#x51-170010r95">macrolet</a> will be considered. If only
<i>form</i> is given as an argument, then the environment is eﬀectively null,
and only global macro deﬁnitions (as established by <a 
href="clmse46.html#x59-220002r137">defmacro</a>) will be
considered.
<!--l. 585--><p class="indent" >   Macro expansion is carried out as follows. Once macroexpand-1 has
determined that a symbol names a macro, it obtains the expansion function for
that macro. The value of the variable *macroexpand-hook* is then called as a
function of three arguments: the expansion function, the <i>form</i>, and the
environment <i>env</i>. The value returned from this call is taken to be the expansion of
the macro call. The initial value of *macroexpand-hook* is <a 
href="clmse37.html#x49-155003r78">funcall</a>, and the net
eﬀect is to invoke the expansion function, giving it <i>form</i> and <i>env</i> as its two
arguments.
<div class=newer>
<!--l. 597--><p class="indent" >   X3J13 voted in June 1988 <a 
 id="dx60-316001"></a>to specify that the value of *macroexpand-hook* is
ﬁrst coerced to a function before being called as the expansion interface hook.
Therefore its value may be a symbol, a lambda-expression, or any object of type
                                                                          

                                                                          
<a 
href="clmse35.html#x47-129006r54">function</a>.
</div>
<div class=newer>
<!--l. 605--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx60-316002"></a>to specify that macro environment objects
received by a *macroexpand-hook* function have only dynamic extent. The
consequences are undeﬁned if such objects are referred to outside the dynamic
extent of that particular invocation of the hook function. This allows
implementations to use somewhat more eﬃcient techniques for representing
environment objects.
</div>
<div class=obsolete>
<!--l. 615--><p class="indent" >   (The purpose of *macroexpand-hook* is to facilitate various techniques for
improving interpretation speed by caching macro expansions.)
</div>
<div class=newer>
<!--l. 621--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx60-316003"></a>to clarify that, while *macroexpand-hook*
may be useful for debugging purposes, despite the original design intent
there is currently no correct portable way to use it for caching macro
expansions.
      <ul class="itemize1">
      <li class="itemize">Caching by displacement (performing a side eﬀect on the macro-call
      form) won&#x2019;t work because the same (<a 
href="clmse33.html#x44-117002r46">eq</a>) macro-call form may appear
      in distinct lexical contexts. In addition, the macro-call form may be a
      read-only constant (see <a 
href="clmse35.html#x47-128002r53">quote</a> and also section <a 
href="clmse127.html#x157-77100025.1">25.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
      </li>
      <li class="itemize">Caching by table lookup won&#x2019;t work because such a table would have
      to be keyed by both the macro-call form and the environment, but
      X3J13 voted in March 1989 <a 
 id="dx60-316004"></a>to permit macro environments to have only
      dynamic extent.
      </li>
      <li class="itemize">Caching  by  storing  macro-call  forms  and  expansions  within  the
      environment  object  itself  would  work,  but  there  are  no  portable
      primitives that would allow users to do this.</li></ul>
<!--l. 642--><p class="noindent" >X3J13 also noted that, although there seems to be no correct portable way to use
*macroexpand-hook* to cache macro expansions, there is no requirement that an
                                                                          

                                                                          
implementation call the macro expansion function more than once for a given
form and lexical environment.
</div>
<div class=new>
<!--l. 649--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx60-316005"></a>to specify that macroexpand-1 will also expand
symbol macros deﬁned by <a 
href="clmse39.html#x51-171002r96">symbol-macrolet</a>; therefore a <i>form</i> may also be a macro
call if it is a symbol. The vote did not address the interaction of this feature with
the *macroexpand-hook* function. An obvious implementation choice is that the
hook function is indeed called and given a special expansion function that, when
applied to the <i>form</i> (a symbol) and <i>env</i>, will produce the expansion, just as for an
ordinary macro; but this is only my suggestion.
</div>
<!--l. 661--><p class="indent" >   The evaluator expands macro calls as if through the use of macroexpand-1; the
point is that <a 
href="clmse110.html#x135-586002r620">eval</a> also uses *macroexpand-hook*.
<!--l. 664--><p class="indent" >   <a 
href="#x60-222002r138">macroexpand</a> is similar to macroexpand-1, but repeatedly expands <i>form</i> until
it is no longer a macro call. (In eﬀect, <a 
href="#x60-222002r138">macroexpand</a> simply calls macroexpand-1
repeatedly until the second value returned is <a 
href="clmse31.html#x42-86002r19">nil</a>.) A second value of <a 
href="clmse31.html#x42-87002r20">t</a> or <a 
href="clmse31.html#x42-86002r19">nil</a> is
returned as for macroexpand-1, indicating whether the original <i>form</i> was a macro
call.
</div>
<div class=defun>
<!--l. 672--><p class="noindent" ><i>[Variable]</i><a 
 id="dx60-316006"></a><a 
 id="x60-316007r140"></a><b> *macroexpand-hook*</b>
<!--l. 674--><p class="noindent" ><span class="paragraphHead"><a 
 id="x60-317000140"></a></span>
   The value of *macroexpand-hook* is used as the expansion interface hook by
macroexpand-1.
</div>
<div class=newer>
                                                                          

                                                                          
   <!--l. 680--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse48.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html#tailclmse46.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse47.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse47.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 680--><p class="indent" >   <a 
 id="tailclmse47.html"></a>  
</body></html> 
