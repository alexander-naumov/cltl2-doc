<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Раскрытие макроса</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-16 23:44:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 1598--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse48.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html#tailclmse46.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse47.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse47.html" >Наверх</a><tt>&#x003E;</tt></div><h3 class="sectionHead"><span class="titlemark">8.2   </span> <a 
href="clm.html#QQ2-60-818" id="x60-8090008.2">Раскрытие
макроса</a></h3>
<!--l. 1600--><p class="noindent" >Функция <tt><a 
href="clmli7.html#x196-3479566r566">macroexpand</a></tt> служит для раскрытия макровызовов. Также
предоставляется ловушка для пользовательской функции для управления
процессом раскрытия.
<div class="defun">
<!--l. 1604--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx60-809001"></a><a 
 id="x60-809002r125"></a><b> macroexpand</b>  <i>form</i> &#x0026;optional  <i>env</i><br 
class="newline" /><i>[Функция]</i><a 
 id="dx60-809003"></a><a 
 id="x60-809004r126"></a><b> macroexpand-1</b>  <i>form</i> &#x0026;optional  <i>env</i>
</div>
<!--l. 1607--><p class="noindent" ><span class="paragraphHead"><a 
href="#x60-8100008.2" id="x60-8100008.2"></a></span>
   Если форма <i>form</i> является макровызовом, тогда <tt><a 
href="clmli7.html#x196-3479567r567">macroexpand-1</a></tt> раскроет
макровызов только на <i>один</i> уровень и вернёт два значения: раскрытие и <tt><a 
href="clmli7.html#x196-3479935r935">t</a></tt>.
Если форма <i>form</i> не является макровызовом, тогда будут возвращены два
значения: <i>form</i> и <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>.
<!--l. 1614--><p class="indent" >   Форма <i>form</i> рассматривается как макровызов, только если она является
cons-ячейкой, у которой <i>car</i> элемент является символом имени макроса.
Окружение <i>env</i> похоже на то, что используется внутри вычислителя
(смотрите <tt><a 
href="clmli7.html#x196-3479375r375">evalhook</a></tt>). По-умолчанию равно нулевому окружению. Если
окружение указано будут рассмотрены все установленные внутри <i>env</i> с
помощью <tt><a 
href="clmli7.html#x196-3479568r568">macrolet</a></tt> локальные определения макросов. Если в качестве
аргумента указана только форма <i>form</i>, то берётся нулевое окружение, и
будут рассматриваться только глобальные определения макросов
(установленные с помощью <tt><a 
href="clmli7.html#x196-3479313r313">defmacro</a></tt>).
<!--l. 1624--><p class="indent" >   Раскрытие макросов происходит следующим образом. Когда <tt><a 
href="clmli7.html#x196-3479567r567">macroexpand-1</a></tt>
устанавливает, что символ в форме указывает на макрос, тогда она получает
функцию раскрытия для этого макроса. Затем вызывается значение
переменной <tt><a 
href="clmli7.html#x196-3479022r22">*macroexpand-hook*</a></tt>, как функция трёх аргументов с
параметрами: функция раскрытия, форма <i>form</i> и окружение <i>env</i>. Значение,
возвращённое этим вызовом, расценивается, как раскрытие макровызова.
Значение переменной <tt><a 
href="clmli7.html#x196-3479022r22">*macroexpand-hook*</a></tt> по-умолчанию <tt><a 
href="clmli7.html#x196-3479429r429">funcall</a></tt>, которая
следовательно просто запускает функцию раскрытия с двумя параметрами:
формой <i>form</i> и окружением <i>env</i>.
                                                                          

                                                                          
<div class="newer">
<!--l. 1637--><p class="indent" >   X3J13 voted in June 1988 <a 
 id="dx60-810001"></a>to specify that the value of <tt><a 
href="clmli7.html#x196-3479022r22">*macroexpand-hook*</a></tt> is
ﬁrst coerced to a function before being called as the expansion interface hook.
Therefore its value may be a symbol, a lambda-expression, or any object of type
<tt><a 
href="clmli7.html#x196-3479430r430">function</a></tt>.
</div>
<div class="newer">
<!--l. 1645--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx60-810002"></a>to specify that macro environment objects
received by a <tt><a 
href="clmli7.html#x196-3479022r22">*macroexpand-hook*</a></tt> function have only dynamic extent. The
consequences are undeﬁned if such objects are referred to outside the dynamic
extent of that particular invocation of the hook function. This allows
implementations to use somewhat more eﬃcient techniques for representing
environment objects.
</div>
<div class="newer">
<!--l. 1655--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx60-810003"></a>to clarify that, while <tt><a 
href="clmli7.html#x196-3479022r22">*macroexpand-hook*</a></tt>
may be useful for debugging purposes, despite the original design intent
there is currently no correct portable way to use it for caching macro
expansions.
      <ul class="itemize1">
      <li class="itemize">Caching by displacement (performing a side eﬀect on the macro-call
      form) won&#x2019;t work because the same (<tt><a 
href="clmli7.html#x196-3479367r367">eq</a></tt>) macro-call form may appear
      in distinct lexical contexts. In addition, the macro-call form may be a
      read-only constant (see <tt><a 
href="clmli7.html#x196-3479753r753">quote</a></tt> and also section <a 
href="clmse121.html#x150-237500024.1">24.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
      </li>
      <li class="itemize">Caching by table lookup won&#x2019;t work because such a table would have
      to be keyed by both the macro-call form and the environment, but
      X3J13 voted in March 1989 <a 
 id="dx60-810004"></a>to permit macro environments to have only
      dynamic extent.
      </li>
      <li class="itemize">Caching  by  storing  macro-call  forms  and  expansions  within  the
      environment  object  itself  would  work,  but  there  are  no  portable
      primitives that would allow users to do this.</li></ul>
<!--l. 1676--><p class="noindent" >X3J13 also noted that, although there seems to be no correct portable way to use
<tt><a 
href="clmli7.html#x196-3479022r22">*macroexpand-hook*</a></tt> to cache macro expansions, there is no requirement that an
                                                                          

                                                                          
implementation call the macro expansion function more than once for a given
form and lexical environment.
</div>
<div class="new">
<!--l. 1683--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx60-810005"></a>to specify that <tt><a 
href="clmli7.html#x196-3479567r567">macroexpand-1</a></tt> will also
expand symbol macros deﬁned by <tt><a 
href="clmli7.html#x196-3479928r928">symbol-macrolet</a></tt>; therefore a <i>form</i>
may also be a macro call if it is a symbol. The vote did not address the
interaction of this feature with the <tt><a 
href="clmli7.html#x196-3479022r22">*macroexpand-hook*</a></tt> function. An obvious
implementation choice is that the hook function is indeed called and given a
special expansion function that, when applied to the <i>form</i> (a symbol) and <i>env</i>,
will produce the expansion, just as for an ordinary macro; but this is only my
suggestion.
</div>
<!--l. 1695--><p class="indent" >   Вычислитель раскрывает макровызовы, как если бы использовал
<tt><a 
href="clmli7.html#x196-3479567r567">macroexpand-1</a></tt>. Таким образом <tt><a 
href="clmli7.html#x196-3479373r373">eval</a></tt> также использует <tt><a 
href="clmli7.html#x196-3479022r22">*macroexpand-hook*</a></tt>.
<tt>
<!--l. 1699--><p class="indent" >   <a 
href="clmli7.html#x196-3479566r566">macroexpand</a></tt> похожа на <tt><a 
href="clmli7.html#x196-3479567r567">macroexpand-1</a></tt>, однако циклично раскрывает
форму <i>form</i>, пока в ней не останется макровызовов. (А точнее, <tt><a 
href="clmli7.html#x196-3479566r566">macroexpand</a></tt>
просто циклично вызывает <tt><a 
href="clmli7.html#x196-3479567r567">macroexpand-1</a></tt>, пока последняя не вернёт
<tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt> во втором значении.) Второе возвращаемое значение функции
<tt><a 
href="clmli7.html#x196-3479567r567">macroexpand-1</a></tt> (<tt><a 
href="clmli7.html#x196-3479935r935">t</a></tt> или <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>) указывает на то, являлась ли форма <i>form</i>
макровызовом.
</div>
<div class="defun">
<!--l. 1707--><p class="noindent" ><div class="defunheader"> <i>[Переменная]</i><a 
 id="dx60-810006"></a><a 
 id="x60-810007r127"></a><b> *macroexpand-hook*</b>
</div>
<!--l. 1709--><p class="noindent" ><span class="paragraphHead"><a 
href="#x60-8110008.2" id="x60-8110008.2"></a></span>
   Значение <tt><a 
href="clmli7.html#x196-3479022r22">*macroexpand-hook*</a></tt> используется как интерфейс раскрытия
для <tt><a 
href="clmli7.html#x196-3479567r567">macroexpand-1</a></tt>.
</div>
                                                                          

                                                                          
<!--l. 1714--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse48.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html#tailclmse46.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse47.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse47.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse47.html"></a>  </div> </div> 
</body></html> 
