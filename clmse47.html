<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Macro Expansion Раскрытие макроса</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-10 13:43:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 959--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse48.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html#tailclmse46.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse47.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse47.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">8.2   </span> <a 
 id="x60-1590008.2"></a>Macro Expansion Раскрытие макроса</h3>
<!--l. 961--><p class="noindent" >The <a 
href="#x60-159002r138">macroexpand</a> function is the conventional means for expanding a macro call.
A hook is provided for a user function to gain control during the expansion
process.
<!--l. 965--><p class="indent" >   Функция <a 
href="#x60-159002r138">macroexpand</a> служит для раскрытия макровызовов. Также
предоставляется ловушка для пользовательской функции для управления
процессом раскрытия.
<div class=defun>
<!--l. 969--><p class="noindent" ><i>[Function]</i><a 
 id="dx60-159001"></a><a 
 id="x60-159002r138"></a><b> macroexpand</b>  <i>form</i> &#x0026;optional  <i>env</i><br 
class="newline" /><i>[Function]</i><a 
 id="dx60-159003"></a><a 
 id="x60-159004r139"></a><b> macroexpand-1</b>  <i>form</i> &#x0026;optional  <i>env</i>
<!--l. 972--><p class="noindent" >If <i>form</i> is a macro call, then <a 
href="#x60-159004r139">macroexpand-1</a> will expand the macro call <i>once</i> and
return two values: the expansion and <a 
href="clmse31.html#x42-77004r20">t</a>. If <i>form</i> is not a macro call, then the two
values <i>form</i> and <a 
href="clmse31.html#x42-77002r19">nil</a> are returned.
<!--l. 978--><p class="indent" >   Если форма <i>form</i> является макровызовом, тогда <a 
href="#x60-159004r139">macroexpand-1</a> раскроет
макровызов только на <i>один</i> уровень и вернет два значеия: раскрытие и <a 
href="clmse31.html#x42-77004r20">t</a>.
Если форма <i>form</i> не является макровызовом, тогда будут возвращены два
значения: <i>form</i> и <a 
href="clmse31.html#x42-77002r19">nil</a>.
<!--l. 984--><p class="indent" >   A <i>form</i> is considered to be a macro call only if it is a cons whose <i>car</i> is a
symbol that names a macro. The environment <i>env</i> is similar to that used within
the evaluator (see <a 
href="clmse110.html#x135-261011r623">evalhook</a>); it defaults to a null environment. Any local macro
deﬁnitions established within <i>env</i> by <a 
href="clmse39.html#x51-114010r95">macrolet</a> will be considered. If only
<i>form</i> is given as an argument, then the environment is eﬀectively null,
and only global macro deﬁnitions (as established by <a 
href="clmse46.html#x59-157007r137">defmacro</a>) will be
considered.
<!--l. 994--><p class="indent" >   Форма <i>form</i> рассматривается как макровызов, только если она является
cons-ячейкой, у которой <i>car</i> элемент является символом имени макроса.
Окружение <i>env</i> похоже на то, что используется внутри вычислителя
(смотрите <a 
href="clmse110.html#x135-261011r623">evalhook</a>). По-умолчанию равно нулевому окружению. Если
окружение указано будут рассмотрены все установленные внутри <i>env</i> с
помощью <a 
href="clmse39.html#x51-114010r95">macrolet</a> локальные определения макросов. Если в качестве
аргумента указана только форма <i>form</i>, то берется нулевое окружение, и
                                                                          

                                                                          
будут рассматриваться только глобальные определения макросов
(установленные с помощью <a 
href="clmse46.html#x59-157007r137">defmacro</a>).
<!--l. 1004--><p class="indent" >   Macro expansion is carried out as follows. Once <a 
href="#x60-159004r139">macroexpand-1</a> has
determined that a symbol names a macro, it obtains the expansion function for
that macro. The value of the variable <a 
href="#x60-159011r140">*macroexpand-hook*</a> is then called as a
function of three arguments: the expansion function, the <i>form</i>, and the
environment <i>env</i>. The value returned from this call is taken to be the expansion of
the macro call. The initial value of <a 
href="#x60-159011r140">*macroexpand-hook*</a> is <a 
href="clmse37.html#x49-101005r78">funcall</a>, and the net
eﬀect is to invoke the expansion function, giving it <i>form</i> and <i>env</i> as its two
arguments.
<!--l. 1015--><p class="indent" >   Раскрытие макросов происходит следующим образом. Когда <a 
href="#x60-159004r139">macroexpand-1</a>
устанавливает, что символ в форме указывает на макрос, тогда она получает
функцию раскрытия для этого макроса. Затем вызывается значение
переменной <a 
href="#x60-159011r140">*macroexpand-hook*</a>, как функция трех аргументов с
параметрами: функция раскрытия, форма <i>form</i> и окружение <i>env</i>. Значение,
возвращенное этим вызовом, расенивается, как раскрытие макровызова.
Значение переменной <a 
href="#x60-159011r140">*macroexpand-hook*</a> по-умолчанию <a 
href="clmse37.html#x49-101005r78">funcall</a>, которая
следовательно просто запускает функцию раскрытия с двумя параметрами:
формой <i>form</i> и окружением <i>env</i>.
<div class=newer>
<!--l. 1028--><p class="indent" >   X3J13 voted in June 1988 <a 
 id="dx60-159005"></a>to specify that the value of <a 
href="#x60-159011r140">*macroexpand-hook*</a> is
ﬁrst coerced to a function before being called as the expansion interface hook.
Therefore its value may be a symbol, a lambda-expression, or any object of type
<a 
href="clmse35.html#x47-88006r54">function</a>.
</div>
<div class=newer>
<!--l. 1036--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx60-159006"></a>to specify that macro environment objects
received by a <a 
href="#x60-159011r140">*macroexpand-hook*</a> function have only dynamic extent. The
consequences are undeﬁned if such objects are referred to outside the dynamic
extent of that particular invocation of the hook function. This allows
implementations to use somewhat more eﬃcient techniques for representing
environment objects.
</div>
<div class=obsolete>
<!--l. 1046--><p class="indent" >   (The purpose of <a 
href="#x60-159011r140">*macroexpand-hook*</a> is to facilitate various techniques for
improving interpretation speed by caching macro expansions.)
</div>
<div class=newer>
                                                                          

                                                                          
<!--l. 1052--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx60-159007"></a>to clarify that, while <a 
href="#x60-159011r140">*macroexpand-hook*</a>
may be useful for debugging purposes, despite the original design intent
there is currently no correct portable way to use it for caching macro
expansions.
      <ul class="itemize1">
      <li class="itemize">Caching by displacement (performing a side eﬀect on the macro-call
      form) won&#x2019;t work because the same (<a 
href="clmse33.html#x44-81002r46">eq</a>) macro-call form may appear
      in distinct lexical contexts. In addition, the macro-call form may be a
      read-only constant (see <a 
href="clmse35.html#x47-87002r53">quote</a> and also section <a 
href="clmse127.html#x157-31800025.1">25.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
      </li>
      <li class="itemize">Caching by table lookup won&#x2019;t work because such a table would have
      to be keyed by both the macro-call form and the environment, but
      X3J13 voted in March 1989 <a 
 id="dx60-159008"></a>to permit macro environments to have only
      dynamic extent.
      </li>
      <li class="itemize">Caching  by  storing  macro-call  forms  and  expansions  within  the
      environment  object  itself  would  work,  but  there  are  no  portable
      primitives that would allow users to do this.</li></ul>
<!--l. 1073--><p class="noindent" >X3J13 also noted that, although there seems to be no correct portable way to use
<a 
href="#x60-159011r140">*macroexpand-hook*</a> to cache macro expansions, there is no requirement that an
implementation call the macro expansion function more than once for a given
form and lexical environment.
</div>
<div class=new>
<!--l. 1080--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx60-159009"></a>to specify that <a 
href="#x60-159004r139">macroexpand-1</a> will also expand
symbol macros deﬁned by <a 
href="clmse39.html#x51-115002r96">symbol-macrolet</a>; therefore a <i>form</i> may also be a macro
call if it is a symbol. The vote did not address the interaction of this feature with
the <a 
href="#x60-159011r140">*macroexpand-hook*</a> function. An obvious implementation choice is that the
hook function is indeed called and given a special expansion function that, when
applied to the <i>form</i> (a symbol) and <i>env</i>, will produce the expansion, just as for an
ordinary macro; but this is only my suggestion.
</div>
<!--l. 1092--><p class="indent" >   The evaluator expands macro calls as if through the use of <a 
href="#x60-159004r139">macroexpand-1</a>; the
point is that <a 
href="clmse110.html#x135-261002r620">eval</a> also uses <a 
href="#x60-159011r140">*macroexpand-hook*</a>.
<!--l. 1095--><p class="indent" >   <a 
href="#x60-159002r138">macroexpand</a> is similar to <a 
href="#x60-159004r139">macroexpand-1</a>, but repeatedly expands <i>form</i> until
                                                                          

                                                                          
it is no longer a macro call. (In eﬀect, <a 
href="#x60-159002r138">macroexpand</a> simply calls <a 
href="#x60-159004r139">macroexpand-1</a>
repeatedly until the second value returned is <a 
href="clmse31.html#x42-77002r19">nil</a>.) A second value of <a 
href="clmse31.html#x42-77004r20">t</a> or <a 
href="clmse31.html#x42-77002r19">nil</a> is
returned as for <a 
href="#x60-159004r139">macroexpand-1</a>, indicating whether the original <i>form</i> was a macro
call.
<!--l. 1102--><p class="indent" >   Вычислитель раскрывает макровызовы, как если бы использовал
<a 
href="#x60-159004r139">macroexpand-1</a>. Таким образом <a 
href="clmse110.html#x135-261002r620">eval</a> также использует <a 
href="#x60-159011r140">*macroexpand-hook*</a>.
<!--l. 1106--><p class="indent" >   macroexpan похожа на <a 
href="#x60-159004r139">macroexpand-1</a>, однако циклично раскрывает
форму <i>form</i>, пока в ней не останется макровызовов. (А точнее, <a 
href="#x60-159002r138">macroexpand</a>
просто циклично вызывает <a 
href="#x60-159004r139">macroexpand-1</a>, пока последняя не вернет
<a 
href="clmse31.html#x42-77002r19">nil</a> во втором значении.) Второе возвращаемое значение функции
<a 
href="#x60-159004r139">macroexpand-1</a> (<a 
href="clmse31.html#x42-77004r20">t</a> или <a 
href="clmse31.html#x42-77002r19">nil</a>) указывает на то, являлась ли форма <i>form</i>
макровызовом.
</div>
<div class=defun>
<!--l. 1115--><p class="noindent" ><i>[Variable]</i><a 
 id="dx60-159010"></a><a 
 id="x60-159011r140"></a><b> *macroexpand-hook*</b>
<!--l. 1117--><p class="noindent" >The value of <a 
href="#x60-159011r140">*macroexpand-hook*</a> is used as the expansion interface hook by
<a 
href="#x60-159004r139">macroexpand-1</a>.
<!--l. 1121--><p class="indent" >   Значение <a 
href="#x60-159011r140">*macroexpand-hook*</a> используется как интерфейс раскрытия для
<a 
href="#x60-159004r139">macroexpand-1</a>.
</div>
<div class=newer>
                                                                          

                                                                          
   <!--l. 1126--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse48.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html#tailclmse46.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse47.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse47.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 1126--><p class="indent" >   <a 
 id="tailclmse47.html"></a>  
</body></html> 
