<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Функции для хеш-таблиц</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-20 14:55:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="../cltl2ed.css"></head><body 
>
<!--l. 434--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse90.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="hash.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="hash.html#tailhash.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse89.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="hash.html#clmse89.html" >Наверх</a><tt>&#x003E;</tt>&lt;<a href="../index.html">Main Page</a>&gt;</div><h3 class="sectionHead"><span class="titlemark">16.1   </span> <a 
href="clm.html#QQ2-110-1373" id="x110-134300016.1">Функции для
хеш-таблиц</a></h3>
<!--l. 436--><p class="noindent" >Данный раздел описывает функции для хеш-таблиц, которые используют
<i>объекты</i> для ключей и ассоциируют другие объекты с этими.
<div class="defun">
<!--l. 439--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx110-1343001"></a><a 
 id="x110-1343002r509"></a> <b>make-hash-table</b>  <b>&#x0026;key</b>  <i>:test</i> <i>:size</i> <i>:rehash-size</i> <i>:rehash-threshold</i>
                                                                          

                                                                          
</div>
<!--l. 442--><p class="indent" >   Эта функция создаёт и возвращает новую хеш-таблицу. Аргумент <tt>:test</tt>
определяет как будут сравниваться ключи. Он может быть одним из трёх
значений <tt>#&#x2019;eq</tt>, <tt>#&#x2019;eql</tt> или <tt>#&#x2019;equal</tt>, или одним из трёх символов <tt><a 
href="symbols.html#x185-2605337r337">eq</a></tt>, <tt><a 
href="symbols.html#x185-2605338r338">eql</a></tt> или
<tt><a 
href="symbols.html#x185-2605339r339">equal</a></tt>. По-умолчанию используется <tt><a 
href="symbols.html#x185-2605338r338">eql</a></tt>.
<div class="new">
<!--l. 449--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx110-1343003"></a>to add a fourth type of hash table: the value of
<tt>#&#x2019;equalp</tt> and the symbol <tt><a 
href="symbols.html#x185-2605340r340">equalp</a></tt> are to be additional valid possibilities for the
<tt>:test</tt> argument.
<!--l. 455--><p class="indent" >   Note that one consequence of the vote to change the rules of ﬂoating-point
contagion <a 
 id="dx110-1343004"></a>(described in section <a 
href="clmse64.html#x81-92500012.1">12.1<!--tex4ht:ref: PRECISION-CONTAGION-COERCION-SECTION --></a>) is to require <tt><a 
href="symbols.html#x185-2605061r61">=</a></tt>, and therefore also <tt><a 
href="symbols.html#x185-2605340r340">equalp</a></tt>, to
compare the values of numbers exactly and not approximately, making <tt><a 
href="symbols.html#x185-2605340r340">equalp</a></tt> a
true equivalence relation on numbers.
<!--l. 464--><p class="indent" >   Another valuable use of <tt><a 
href="symbols.html#x185-2605340r340">equalp</a></tt> hash tables is case-insensitive comparison of
keys that are strings.
</div>
<!--l. 468--><p class="indent" >   Аргумент <tt>:size</tt> устанавливает первоначальный размер хеш-таблицы в
парах. (Указанный размер может быть округлён до «хорошего» размера,
например, до первого следующего простого числа.) Вы можете не сохранять
в таблице столько пар, сколько указали. Этот аргумент служит подсказкой
для реализации о том, какое примерно число элементов вы будете хранить в
хеш-таблице.
<div class="new">
<!--l. 476--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx110-1343005"></a>to clarify that the <tt>:size</tt> argument must be a
non-negative integer.
</div>
<div class="newer">
<!--l. 483--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx110-1343006"></a>to regard the preceding description of the <tt>:size</tt>
argument as deﬁnitive: it is approximately the number of entries that can be
inserted without having to enlarge the hash table.
</div>
<!--l. 489--><p class="indent" >   Аргумент <tt>:rehash-size</tt> указывает, на сколько увеличить размер
хеш-таблицы, когда она по размерам достигнет пределов. Если это целое
число, оно должно быть больше нуля, и будет означать абсолютное
приращение. Если это число с плавающей точкой, оно должно быть больше 1,
и будет означать относительное приращение к предыдущему размеру.
Значение по-умолчанию зависит от реализации.
                                                                          

                                                                          
<!--l. 496--><p class="indent" >   Аргумент <tt>:rehash-threshold</tt> указывает, насколько должна наполниться
хеш-таблица, прежде чем она будет увеличена. Он должен быть числом
типа <tt>real</tt> между <tt>0</tt> и <tt>1</tt>, включительно. Он показывает максимальный
уровень заполнения хеш-таблицы. Значение по-умолчанию зависит от
реализации.
<!--l. 502--><p class="indent" >   Пример использования <tt><a 
href="symbols.html#x185-2605539r539">make-hash-table</a></tt>: <div class="lisp"><div class="tabbing">
(make-hash-table :rehash-size 1.5
   <br>                                            :size (* number-of-widgets 43))<br>
<!--l. 506--><p class="noindent" ></div>
<!--l. 506--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-134400016.1" id="x110-134400016.1"></a></span>
<!--l. 506--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-134500016.1" id="x110-134500016.1"></a></span>
</div>
</div>
<div class="defun">
<!--l. 509--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx110-1345001"></a><a 
 id="x110-1345002r510"></a> <b>hash-table-p</b>  <i>object</i>
</div>
<tt>
<!--l. 512--><p class="indent" >   <a 
href="symbols.html#x185-2605428r428">hash-table-p</a></tt> возвращает истину, если аргумент является хеш-таблицей.
Иначе возвращает ложь. <div class="lisp"><div class="tabbing">
(hash-table-p x) <span class="math"> ≡</span> (typep x &#x2019;hash-table)
   <br>
<!--l. 516--><p class="noindent" ></div>
<!--l. 516--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-134600016.1" id="x110-134600016.1"></a></span>
                                                                          

                                                                          
<!--l. 516--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-134700016.1" id="x110-134700016.1"></a></span>
</div>
</div>
<div class="defun">
<!--l. 519--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx110-1347001"></a><a 
 id="x110-1347002r511"></a> <b>gethash</b>  <i>key</i> <i>hash-table</i> <b>&#x0026;optional</b>  <i>default</i>
</div>
<tt>
<!--l. 522--><p class="indent" >   <a 
href="symbols.html#x185-2605422r422">gethash</a></tt> ищет элемент в хеш-<i>hash-table</i>, чей ключ равен <i>key</i> и возвращает
связанное значение. Если элемент не был найден, то возвращается значение
аргумента <i>default</i>, который по-умолчанию равен <tt><a 
href="symbols.html#x185-2605609r609">nil</a></tt>.
<tt>
<!--l. 526--><p class="indent" >   <a 
href="symbols.html#x185-2605422r422">gethash</a></tt> возвращает два значение. Второе значение является предикатом,
и истинно, если значение было найдено, и ложно если нет.
<tt>
<!--l. 529--><p class="indent" >   <a 
href="symbols.html#x185-2605778r778">setf</a></tt> может использоваться вместе с <tt><a 
href="symbols.html#x185-2605422r422">gethash</a></tt> для создания в хеш-таблице
новых элементов. Если элемент с заданным ключом <i>key</i> уже существует, он
будет удалён перед добавлением. В этом контексте может использоваться
аргумент <i>default</i>, он игнорируется <tt><a 
href="symbols.html#x185-2605778r778">setf</a></tt>, но может быть полезным в таких
макросах как <tt><a 
href="symbols.html#x185-2605441r441">incf</a></tt>, которые связаны с <tt><a 
href="symbols.html#x185-2605778r778">setf</a></tt>: <div class="lisp"><div class="tabbing">
(incf (gethash a-key table 0))
   <br>
<!--l. 536--><p class="noindent" ></div>
<!--l. 536--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-134800016.1" id="x110-134800016.1"></a></span>
<!--l. 536--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-134900016.1" id="x110-134900016.1"></a></span>
</div>
<!--l. 537--><p class="indent" >   обозначает то же, что и <div class="lisp"><div class="tabbing">
(setf (gethash a-key table 0)
   <br>                                                    (+ (gethash a-key table 0) 1))<br>
                                                                          

                                                                          
<!--l. 541--><p class="noindent" ></div>
<!--l. 541--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135000016.1" id="x110-135000016.1"></a></span>
<!--l. 541--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135100016.1" id="x110-135100016.1"></a></span>
</div>
<!--l. 542--><p class="indent" >   что можно преобразовать в <div class="lisp"><div class="tabbing">
(setf (gethash a-key table)
   <br>                                                    (+ (gethash a-key table 0) 1))<br>
<!--l. 546--><p class="noindent" ></div>
<!--l. 546--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135200016.1" id="x110-135200016.1"></a></span>
<!--l. 546--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135300016.1" id="x110-135300016.1"></a></span>
</div>
</div>
<div class="defun">
<!--l. 549--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx110-1353001"></a><a 
 id="x110-1353002r512"></a> <b>remhash</b>  <i>key</i> <i>hash-table</i>
</div>
<tt>
<!--l. 552--><p class="indent" >   <a 
href="symbols.html#x185-2605735r735">remhash</a></tt> удаляет любой элемент в хеш-таблице <i>hash-table</i> ключ, которого
равен параметру <i>key</i>. Возвращает истину, если элемент был удалён, и ложь,
если элемента уже не существовало.
</div>
<div class="defun">
<!--l. 557--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx110-1353003"></a><a 
 id="x110-1353004r513"></a> <b>maphash</b>  <i>function</i> <i>hash-table</i>
</div>
<!--l. 560--><p class="indent" >   Для каждого элемента в хеш-таблице <i>hash-table</i>, <tt><a 
href="symbols.html#x185-2605562r562">maphash</a></tt> вызывает
функцию <i>function</i> с двумя аргументами: ключ элемента и значение элемента.
                                                                          

                                                                          
<tt><a 
href="symbols.html#x185-2605562r562">maphash</a></tt> возвращает <tt><a 
href="symbols.html#x185-2605609r609">nil</a></tt>. Если во время выполнения <tt><a 
href="symbols.html#x185-2605562r562">maphash</a></tt> в хеш-таблице
добавлялись или удалялись ключи, то результат непредсказуем, но есть
исключение: если функция <i>function</i> вызывает <tt><a 
href="symbols.html#x185-2605735r735">remhash</a></tt> для удаления
элемента, который в эту функцию и был передан, или устанавливает новое
значение с помощью <tt><a 
href="symbols.html#x185-2605778r778">setf</a></tt> этому элементу, то эти операции будут выполнены
правильно. Например: <div class="lisp"><div class="tabbing">
;;; Изменение каждого элемента в MY-HASH-TABLE, с заменой на
   <br>;;; квадратный корень. Элементы с отрицательными значения удаляются.<br>
(maphash #&#x2019;(lambda (key val)<br>                          (if (minusp val)<br>
                 (remhash key my-hash-table)<br>
                 (setf (gethash key my-hash-table) (sqrt val))))<br>
         my-hash-table)<br>
<!--l. 579--><p class="noindent" ></div>
<!--l. 579--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135400016.1" id="x110-135400016.1"></a></span>
<!--l. 579--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135500016.1" id="x110-135500016.1"></a></span>
</div>
<div class="new">
<!--l. 582--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx110-1355001"></a>to restrict user side eﬀects; see section <a 
href="clmse43.html#x55-6500007.9">7.9<!--tex4ht:ref: STRUCTURE-TRAVERSAL-SECTION --></a>.
</div>
</div>
<div class="defun">
<!--l. 588--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx110-1355002"></a><a 
 id="x110-1355003r514"></a> <b>clrhash</b>  <i>hash-table</i>
</div>
<!--l. 591--><p class="indent" >   Функция удаляет все элемент из хеш-таблицы <i>hash-table</i> и возвращает эту
хеш-таблицу.
</div>
<div class="defun">
<!--l. 595--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx110-1355004"></a><a 
 id="x110-1355005r515"></a> <b>hash-table-count</b>  <i>hash-table</i>
                                                                          

                                                                          
</div>
<!--l. 598--><p class="indent" >   Функция возвращает количество элементов в хеш-таблице <i>hash-table</i>.
Когда хеш-таблица только были сделана, или только что очищена, то
количество элементов равно нулю.
</div>
<div class="defmac">
<div class="defmacheader">
<!--l. 604--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i> <b>with-hash-table-iterator</b> <a 
 id="dx110-1355006"></a><a 
 id="x110-1355007r516"></a> (mname hash-table) {form}*
   <br>
<!--l. 605--><p class="noindent" ></div>
<!--l. 605--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135600016.1" id="x110-135600016.1"></a></span>
</div>
<!--l. 606--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx110-1356001"></a>to add the macro <tt><a 
href="symbols.html#x185-2605935r935">with-hash-table-iterator</a></tt>.
<!--l. 610--><p class="indent" >   The name <i>mname</i> is bound and deﬁned as if by <tt><a 
href="symbols.html#x185-2605532r532">macrolet</a></tt>, with the body
<i>form</i>s as its lexical scope, to be a “generator macro” such that successive
invocations <tt>(<i>mname</i>)</tt> will return entries, one by one, from the hash table
that is the value of the expression <i>hash-table</i> (which is evaluated exactly
once).
<!--l. 616--><p class="indent" >   At each invocation of the generator macro, there are two possibilities. If there
is yet another unprocessed entry in the hash table, then three values are returned:
<tt><a 
href="symbols.html#x185-2605871r871">t</a></tt>, the key of the hash table entry, and the associated value of the hash table entry.
On the other hand, if there are no more unprocessed entries in the hash table,
then one value is returned: <tt><a 
href="symbols.html#x185-2605609r609">nil</a></tt>.
<!--l. 624--><p class="indent" >   The implicit interior state of the iteration over the hash table entries has
dynamic extent. While the name <i>mname</i> has lexical scope, it is an error to invoke
the generator macro once the <tt><a 
href="symbols.html#x185-2605935r935">with-hash-table-iterator</a></tt> form has been
exited.
<!--l. 629--><p class="indent" >   Invocations of <tt><a 
href="symbols.html#x185-2605935r935">with-hash-table-iterator</a></tt> and related macros may be nested,
and the generator macro of an outer invocation may be called from within an
inner invocation (assuming that its name is visible or otherwise made
available).
<div class="new">
<!--l. 635--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx110-1356002"></a>to restrict user side eﬀects; see section <a 
href="clmse43.html#x55-6500007.9">7.9<!--tex4ht:ref: STRUCTURE-TRAVERSAL-SECTION --></a>.
                                                                          

                                                                          
</div>__________________________________________________________________________<div class="rationale">
<!--l. 641--><p class="noindent" ><b>Обоснование:</b> This facility is a bit more ﬂexible than <tt><a 
href="symbols.html#x185-2605562r562">maphash</a></tt>. It makes possible a
portable and eﬃcient implementation of <tt><a 
href="symbols.html#x185-2605522r522">loop</a></tt> clauses for iterating over hash tables (see
chapter <a 
href="loop.html#x154-198900025">25<!--tex4ht:ref: LOOP --></a>).
</div>___________________________________________________________________________________________________________
</div>
<div class="lisp">
<!--l. 649--><p class="indent" >     <div class="tabbing">
(setq turtles (make-hash-table :size 9 :test &#x2019;eq))
     <br>              (setf (gethash &#x2019;howard-kaylan turtles) &#x2019;(musician lead-singer))<br>
(setf (gethash &#x2019;john-barbata turtles) &#x2019;(musician drummer))<br>
(setf (gethash &#x2019;leonardo turtles) &#x2019;(ninja leader blue))<br>
(setf (gethash &#x2019;donatello turtles) &#x2019;(ninja machines purple))<br>
(setf (gethash &#x2019;al-nichol turtles) &#x2019;(musician guitarist))<br>
(setf (gethash &#x2019;mark-volman turtles) &#x2019;(musician great-hair))<br>
(setf (gethash &#x2019;raphael turtles) &#x2019;(ninja cool rude red))<br>
(setf (gethash &#x2019;michaelangelo turtles) &#x2019;(ninja party-dude orange))<br>
(setf (gethash &#x2019;jim-pons turtles) &#x2019;(musician bassist))<br>
<br>                                          (with-hash-table-iterator (get-turtle turtles)<br>
  (labels ((try (got-one &#x0026;optional key value)<br>             (when got-one   ;Remember, keys may show up in any order<br>
               (when (eq (ﬁrst value) &#x2019;ninja)<br>
                 (format t &#x0022;~%~:(~A~): ~{~A~̂, ~}&#x0022;<br>
                         key (rest value)))<br>
               (multiple-value-call #&#x2019;try (get-turtle)))))<br>
    (multiple-value-call #&#x2019;try (get-turtle))))     ;Prints 4 lines<br>
Michaelangelo: PARTY-DUDE, ORANGE<br>       Leonardo: LEADER, BLUE<br>
Raphael: COOL, RUDE, RED<br>              Donatello: MACHINES, PURPLE<br>
  <span class="math"> ⇒</span> nil<br>
<!--l. 674--><p class="noindent" ></div>
<!--l. 674--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135700016.1" id="x110-135700016.1"></a></span>
                                                                          

                                                                          
<!--l. 674--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135800016.1" id="x110-135800016.1"></a></span>
</div>
<div class="defun">
<!--l. 676--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx110-1358001"></a><a 
 id="x110-1358002r517"></a> <b>hash-table-rehash-size</b>  <i>hash-table</i><br />
<i>
[Функция]</i><a 
 id="dx110-1358003"></a><a 
 id="x110-1358004r518"></a> <b>hash-table-rehash-threshold</b>  <i>hash-table</i><br />
<i>
[Функция]</i><a 
 id="dx110-1358005"></a><a 
 id="x110-1358006r519"></a> <b>hash-table-size</b>  <i>hash-table</i><br />
<i>
[Функция]</i><a 
 id="dx110-1358007"></a><a 
 id="x110-1358008r520"></a> <b>hash-table-test</b>  <i>hash-table</i>
</div>
<!--l. 682--><p class="indent" >   Добавлены функции, которые возвращают значения используемые при
вызове <tt><a 
href="symbols.html#x185-2605539r539">make-hash-table</a></tt>.
<tt>
<!--l. 685--><p class="indent" >   <a 
href="symbols.html#x185-2605429r429">hash-table-rehash-size</a></tt> возвращает размер приращения хеш-таблицы.
<tt>
<!--l. 687--><p class="indent" >   <a 
href="symbols.html#x185-2605430r430">hash-table-rehash-threshold</a></tt> возвращает текущий уровень заполнения.
<tt>
<!--l. 689--><p class="indent" >   <a 
href="symbols.html#x185-2605431r431">hash-table-size</a></tt> возвращает рекомендуемый размер хеш-таблицы.
<tt>
<!--l. 691--><p class="indent" >   <a 
href="symbols.html#x185-2605432r432">hash-table-test</a></tt> возвращает функцию сравнения используемую для
ключей. Если данная функция одна из стандартных, то результат всегда
является символом, даже если при создании хеш-таблицы было указано иное.
Например: <div class="lisp"><div class="tabbing">
(hash-table-test (make-hash-table :test #&#x2019;equal)) <span class="math"> ⇒</span> equal
   <br>
<!--l. 696--><p class="noindent" ></div>
<!--l. 696--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-135900016.1" id="x110-135900016.1"></a></span>
                                                                          

                                                                          
<!--l. 696--><p class="noindent" ><span class="paragraphHead"><a 
href="#x110-136000016.1" id="x110-136000016.1"></a></span>
</div>
<!--l. 697--><p class="indent" >   Реализации, которые расширяют <tt><a 
href="symbols.html#x185-2605539r539">make-hash-table</a></tt> дополнительными
функциями сравнения для аргумента <tt>:test</tt>, могут определять, как будет
возвращено значение из <tt><a 
href="symbols.html#x185-2605432r432">hash-table-test</a></tt> для этих дополнительных
функций.
</div>
                                                                          

                                                                          
<!--l. 702--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse90.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="hash.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="hash.html#tailhash.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse89.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="hash.html#clmse89.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse89.html"></a>   </div> </div> 
</body></html> 
