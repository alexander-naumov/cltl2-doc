<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Формы верхнего уровня</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-20 14:55:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="../cltl2ed.css"></head><body 
>
<!--l. 2026--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="preds.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse29.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse29.html#tailclmse29.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse30.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="progs.html#clmse30.html" >Наверх</a><tt>&#x003E;</tt>&lt;<a href="../index.html">Main Page</a>&gt;</div><h3 class="sectionHead"><span class="titlemark">5.3   </span> <a 
href="clm.html#QQ2-40-259" id="x40-2510005.3">Формы верхнего
уровня</a></h3>
<!--l. 2028--><p class="noindent" >Стандартный путь взаимодействия с реализацией Common Lisp через <i>цикл
чтение-выполнение-печать</i> (<i>read-eval-print loop</i>): система циклично
считывает форму из некоторого источника ввода (клавиатура, файл),
выполняет её, затем выводит результат(ы) в некоторое устройство вывода
(дисплей, другой файл). Допускается любая форма (выполняемый объект
данных), однако существуют некоторые ормы разработанные для удобного
применения в качестве форм <i>верхнего уровня</i>. Эти специальные формы
верхнего уровня могут использоваться для определения глобальных функции
(globally named functions), макросов, создания деклараций и определения
глобальных значений для специальных переменных.
<!--l. 2039--><p class="indent" >   While deﬁning forms normally appear at top level, it is meaningful to place
them in non-top-level contexts. All deﬁning forms that create functional objects
from code appearing as argument forms must ensure that such argument forms
refer to the enclosing lexical environment. Compilers must handle deﬁning forms
properly in all situations, not just top-level contexts. However, certain
compile-time side eﬀects of these deﬁning forms are performed only when the
deﬁning forms occur at top level (see section <a 
href="clmse121.html#x150-195000024.1">24.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
<!--l. 2049--><p class="indent" >   Макросы обычно определяются с помощью специальной формы
<tt><a 
href="symbols.html#x185-2605284r284">defmacro</a></tt>. Этот механизм достаточно сложен. Для подробностей смотрите
главу <a 
href="macro.html#x58-7060008">8<!--tex4ht:ref: MACROS --></a>.
<!--l. 2052--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">5.3.1   </span> <a 
href="frontmatter.html#QQ2-40-260" id="x40-2520005.3.1">Определение функций</a></h4>
<!--l. 2054--><p class="noindent" >Специальная форма <tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt> служит для определения функций.
<div class="defmac">
<div class="defmacheader">
<!--l. 2057--><p class="indent" >   <div class="tabbing">
                                                                          

                                                                          
 <i>[Макрос]</i> <b>defun</b> <a 
 id="dx40-252001"></a><a 
 id="x40-252002r13"></a> name lambda-list
   <br>                                                        [[{declaration}* | doc-string]]<br>
   {form}*<br>
<!--l. 2060--><p class="noindent" ></div>
<!--l. 2060--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2530005.3.1" id="x40-2530005.3.1"></a></span>
</div>
<!--l. 2061--><p class="indent" >   Выполнение формы <tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt> приводит к тому, что символ <i>name</i> становиться
глобальным именем для функции определённой лямбда-выражением.
<div class="lisp"><div class="tabbing">
(lambda <i>lambda-list</i> {<i><i>declaration</i> | <i>doc-string</i></i>}*  {<i><i>form</i></i>}* )
   <br>
<!--l. 2065--><p class="noindent" ></div>
<!--l. 2065--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2540005.3.1" id="x40-2540005.3.1"></a></span>
<!--l. 2065--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2550005.3.1" id="x40-2550005.3.1"></a></span>
</div>
<!--l. 2066--><p class="indent" >   определяется в лексическом окружении, в котором выполнялась форма
<tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt>. А так как формы <tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt> обычно выполняются на самом верхнем
уровне, лямбда-выражение обычно выполняется в нулевом лексическом
окружении.
<!--l. 2070--><p class="indent" >   Тогда как данная форма обычно используется на самом верхем уровне,
ее можно также использовать внутри других форм. <tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt> может
определять функцию внутри некоторого, не нулевого, лексического
окружения.
<tt>
<!--l. 2074--><p class="indent" >   <a 
href="symbols.html#x185-2605291r291">defun</a></tt> в качестве параметра <i>name</i> принимает любое имя функции (символ
или список, у которого <i>car</i> элемент равен <tt><a 
href="symbols.html#x185-2605778r778">setf</a></tt>—смотрите раздел <a 
href="clmse35.html#x47-3850007.1">7.1<!--tex4ht:ref: FUNCTION-NAME-SECTION --></a>). Так
теперь для определения <tt><a 
href="symbols.html#x185-2605778r778">setf</a></tt>-оператора для функции <tt><a 
href="symbols.html#x185-2605167r167">cadr</a></tt> можно записать
<div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(defun (setf cadr) ...)
   <br>
<!--l. 2080--><p class="noindent" ></div>
<!--l. 2080--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2560005.3.1" id="x40-2560005.3.1"></a></span>
<!--l. 2080--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2570005.3.1" id="x40-2570005.3.1"></a></span>
</div>
<!--l. 2081--><p class="indent" >   Это удобнее, чем использование <tt><a 
href="symbols.html#x185-2605288r288">defsetf</a></tt> или <tt><a 
href="symbols.html#x185-2605281r281">define-modify-macro</a></tt>.
<!--l. 2083--><p class="indent" >   Если указана необязательная строка документации <i>doc-string</i>, тогда она
присоединяется к символу <i>name</i> в качестве строки документации
типа <tt><a 
href="symbols.html#x185-2605399r399">function</a></tt>. Смотрите <tt><a 
href="symbols.html#x185-2605315r315">documentation</a></tt>. Если после <i>doc-string</i> нет
деклараций, строка документации может быть использована только при
условии существования хотя бы одной формы после неё, иначе она будет
использована в качестве форм <i>form</i> функции. Указывать более чем одну
строку <i>doc-string</i> является ошибкой.
<!--l. 2091--><p class="indent" >   Формы <i>forms</i> составляют тело определяемой функции. Они выполняются
как неявный <tt><a 
href="symbols.html#x185-2605700r700">progn</a></tt>.
<!--l. 2094--><p class="indent" >   Тело определяемой функции неявно заключается в конструкцию <tt><a 
href="symbols.html#x185-2605128r128">block</a></tt>,
имя которой совпадает с <i>именем (name)</i> функции. Таким образом для
выхода из функции может быть использовано выражение<tt><a 
href="symbols.html#x185-2605752r752">return-from</a></tt>.
<!--l. 2098--><p class="indent" >   В некоторых реализациях в <tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt> могут также выполняться другие
специальные учётные действия. <i>name</i> возвращается в качестве значения
формы <tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt>. Например: <div class="lisp"><div class="tabbing">
(defun discriminant (a b c)
   <br>                                                              (declare (number a b c))<br>
  &#x0022;Вычисляет дискриминант квадратного уравнения.<br>
   Получает a, b и c и если они являются действительными числами (не комплексными),<br>
    вычисляет значение b̂2-4*a*c.<br>   Квадратное уравнение a*x̂2+b*x+c=0 имеет действительные, multiple,<br>
   или комплексные корни в зависимости от того, какое соответственно значение было получено<br>
   положительное, ноль или отрицательное.&#x0022;<br>       (- (* b b) (* 4 a c)))<br>
   <span class="math"> ⇒</span> discriminant<br>               теперь (discriminant 1 2/3 -2) <span class="math"> ⇒</span> 76/9<br>
                                                                          

                                                                          
<!--l. 2113--><p class="noindent" ></div>
<!--l. 2113--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2580005.3.1" id="x40-2580005.3.1"></a></span>
<!--l. 2113--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2590005.3.1" id="x40-2590005.3.1"></a></span>
</div>
<!--l. 2115--><p class="indent" >   Пользователю разрешено использовать <tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt> для переопределения
функции, например, для установки корректной версии некорректного
определения. Пользователю также разрешено переопределять макрос на
функцию. Однако является ошибкой, попытка переопределить имя
специальной формы (смотрите таблицу <a 
href="clmse28.html#x38-2190011">5.1<!--tex4ht:ref: SPECIAL-FORM-TABLE --></a>) на функцию.
</div>
<!--l. 2122--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">5.3.2   </span> <a 
href="frontmatter.html#QQ2-40-268" id="x40-2600005.3.2">Определение глобальных переменных и констант</a></h4>
<!--l. 2124--><p class="noindent" >Для определения глобальных переменных используются специальные формы
<tt><a 
href="symbols.html#x185-2605292r292">defvar</a></tt> и <tt><a 
href="symbols.html#x185-2605287r287">defparameter</a></tt>. Для определения констант используется специальная
форма <tt><a 
href="symbols.html#x185-2605275r275">defconstant</a></tt>.
<div class="defmac">
<div class="defmacheader">
<!--l. 2129--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i> <b>defvar</b> <a 
 id="dx40-260001"></a><a 
 id="x40-260002r14"></a> name [initial-value [documentation]]
   <br>
<!--l. 2129--><p class="noindent" ></div>
<!--l. 2129--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2610005.3.2" id="x40-2610005.3.2"></a></span>
</div>
<div class="defmacheader">
<!--l. 2129--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i> <b>defparameter</b> <a 
 id="dx40-261001"></a><a 
 id="x40-261002r15"></a> name initial-value [documentation]
   <br>
                                                                          

                                                                          
<!--l. 2130--><p class="noindent" ></div>
<!--l. 2130--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2620005.3.2" id="x40-2620005.3.2"></a></span>
</div>
<div class="defmacheader">
<!--l. 2130--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i> <b>defconstant</b> <a 
 id="dx40-262001"></a><a 
 id="x40-262002r16"></a> name initial-value [documentation]
   <br>
<!--l. 2132--><p class="noindent" ></div>
<!--l. 2132--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2630005.3.2" id="x40-2630005.3.2"></a></span>
</div>
<tt>
<!--l. 2133--><p class="indent" >   <a 
href="symbols.html#x185-2605292r292">defvar</a></tt> рекомендуется для декларации использования в программе
специальных переменных. <div class="lisp"><div class="tabbing">
(defvar <i>variable</i>)
   <br>
<!--l. 2137--><p class="noindent" ></div>
<!--l. 2137--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2640005.3.2" id="x40-2640005.3.2"></a></span>
<!--l. 2137--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2650005.3.2" id="x40-2650005.3.2"></a></span>
</div>
<!--l. 2138--><p class="indent" >   указывает на то, что переменная <i>variable</i> будет специальной (<tt>special</tt>)
(смотрите <tt><a 
href="symbols.html#x185-2605695r695">proclaim</a></tt>), и может выполнять некоторые учётные действия,
зависимые от реализации.
<!--l. 2142--><p class="indent" >   Если <i>initial-value</i> не было указано, <tt><a 
href="symbols.html#x185-2605292r292">defvar</a></tt> не изменяет значение
переменной <i>variable</i>. Если <i>initial-value</i> не было указано и переменная не имела
значения, <tt><a 
href="symbols.html#x185-2605292r292">defvar</a></tt> не устанавливает значение.
<!--l. 2147--><p class="indent" >   Если для формы указан второй аргумент, <div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(defvar <i>variable</i> <i>initial-value</i>)
   <br>
<!--l. 2150--><p class="noindent" ></div>
<!--l. 2150--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2660005.3.2" id="x40-2660005.3.2"></a></span>
<!--l. 2150--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2670005.3.2" id="x40-2670005.3.2"></a></span>
</div>
<!--l. 2151--><p class="indent" >   тогда переменная <i>variable</i>, если она ещё не была проинициализирована,
инициализируется результатом выполнения формы <i>initial-value</i>. Форма
<i>initial-value</i> не выполняется, если в этом нет необходимости. Это полезно,
если форма <i>initial-value</i> выполняет что-то трудоёмкое, как, например,
создание большой структуры данных.
<!--l. 2157--><p class="indent" >   Если не существует специального связывания этой переменной,
инициализация производится присвоением глобального значения переменной.
Обычно, такого связывания быть не должно. FIXME.
<tt>
<!--l. 2161--><p class="indent" >   <a 
href="symbols.html#x185-2605292r292">defvar</a></tt> также предоставляют хорошее место для комментария,
описывающего значение переменной, тогда как обычное <tt>special</tt> указание
соблазняет задекларировать несколько переменных за один раз и не
предоставляет возможности прокомментировать их. <div class="lisp"><div class="tabbing">
(defvar *visible-windows* 0
   <br>                                       &#x0022;Количество видимых окон на экране&#x0022;)<br>
<!--l. 2168--><p class="noindent" ></div>
<!--l. 2168--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2680005.3.2" id="x40-2680005.3.2"></a></span>
                                                                          

                                                                          
<!--l. 2168--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2690005.3.2" id="x40-2690005.3.2"></a></span>
</div>
<tt>
<!--l. 2170--><p class="indent" >   <a 
href="symbols.html#x185-2605287r287">defparameter</a></tt> подобна <tt><a 
href="symbols.html#x185-2605292r292">defvar</a></tt>, но <tt><a 
href="symbols.html#x185-2605287r287">defparameter</a></tt> требует обязательной
формы <i>initial-value</i>, и, выполняя эту форму присваивает результат
переменной. Семантическое различие заключается в том, что <tt><a 
href="symbols.html#x185-2605292r292">defvar</a></tt>
предназначена декларировать переменную, изменяемую программой, тогда
как <tt><a 
href="symbols.html#x185-2605287r287">defparameter</a></tt> предназначена для декларации переменной, как
константы, которая может быть изменена (и во время выполнения
программы), для изменения поведения программы. Таким образом
<tt><a 
href="symbols.html#x185-2605287r287">defparameter</a></tt> не указывает, что количество никогда не изменяется, в
частности, она не разрешает компилятору предположить то, что значение
может быть вкомпилировано в программу.
<tt>
<!--l. 2181--><p class="indent" >   <a 
href="symbols.html#x185-2605275r275">defconstant</a></tt> похожа на <tt><a 
href="symbols.html#x185-2605287r287">defparameter</a></tt>, но в отличие от последней,
указывает, что значение переменной <i>name</i> фиксировано и позволяет
компилятору предположить, что значение может быть вкомпилировано в
программу. Однако, если компилятор для оптимизации выбирает
путь замены ссылок на имя константы на значения этой константы в
компилируемом коде, он должен позаботиться о том, чтобы такие «копии»
были эквивалентны <tt><a 
href="symbols.html#x185-2605338r338">eql</a></tt> объектам-значениям констант. Например,
компилятор может спокойно копировать числа, но должен позаботиться об
этом правиле, если значение константы является списком.
<!--l. 2191--><p class="indent" >   Если для переменной на момент вызова формы <tt><a 
href="symbols.html#x185-2605275r275">defconstant</a></tt> существует
специальные связывания, то возникает ошибка (но реализации могут
проверять, а могут и не проверять этот факт).
<!--l. 2195--><p class="indent" >   Если имя задекларировано с помощью <tt><a 
href="symbols.html#x185-2605275r275">defconstant</a></tt>, последующие
присваивания и связывания данной специальной переменной будут являться
ошибкой. Это справедливо для системозависимых констант, например, <tt><a 
href="symbols.html#x185-2605871r871">t</a></tt> и
<tt><a 
href="symbols.html#x185-2605589r589">most-positive-fixnum</a></tt>. Компилятор может также сигнализировать о
связывании лексической переменной с одинаковым именем.
<!--l. 2202--><p class="indent" >   Для любой из этих конструкций, документация должна быть строкой.
Строка присоединяется к имени переменной, параметра или константы как
тип документации <tt>variable</tt>, смотрите функцию <tt><a 
href="symbols.html#x185-2605315r315">documentation</a></tt>.
<i>
<!--l. 2206--><p class="indent" >   documentation-string</i> не выполняется и должна представлять строку, когда
выполняется <tt><a 
href="symbols.html#x185-2605292r292">defvar</a></tt>, <tt><a 
href="symbols.html#x185-2605287r287">defparameter</a></tt> или <tt><a 
href="symbols.html#x185-2605275r275">defconstant</a></tt>.
<!--l. 2210--><p class="indent" >   Например, форма <div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(defvar *avoid-registers* nil &#x0022;Compilation control switch #43&#x0022;)
   <br>
<!--l. 2213--><p class="noindent" ></div>
<!--l. 2213--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2700005.3.2" id="x40-2700005.3.2"></a></span>
<!--l. 2213--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2710005.3.2" id="x40-2710005.3.2"></a></span>
</div>
<!--l. 2214--><p class="indent" >   законна, но <div class="lisp"><div class="tabbing">
(defvar *avoid-registers* nil
   <br>                                 (format nil &#x0022;Compilation control switch #~D&#x0022;<br>
          (incf *compiler-switch-number*)))<br>
<!--l. 2219--><p class="noindent" ></div>
<!--l. 2219--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2720005.3.2" id="x40-2720005.3.2"></a></span>
<!--l. 2219--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2730005.3.2" id="x40-2730005.3.2"></a></span>
</div>
<!--l. 2220--><p class="indent" >   ошибочна, так как вызов <tt><a 
href="symbols.html#x185-2605392r392">format</a></tt> не является дословно строкой.
<!--l. 2222--><p class="indent" >   С другой стороны, форма <div class="lisp"><div class="tabbing">
(defvar *avoid-registers* nil
   <br>                             #.(format nil &#x0022;Compilation control switch #~D&#x0022;<br>
            (incf *compiler-switch-number*)))<br>
<!--l. 2227--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 2227--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2740005.3.2" id="x40-2740005.3.2"></a></span>
<!--l. 2227--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2750005.3.2" id="x40-2750005.3.2"></a></span>
</div>
<!--l. 2228--><p class="indent" >   может использоваться для вышеназванной цели, потому что вызов
<tt><a 
href="symbols.html#x185-2605392r392">format</a></tt> выполняется на во время чтения кода <tt><a 
href="symbols.html#x185-2605717r717">read</a></tt>, когда форма <tt><a 
href="symbols.html#x185-2605292r292">defvar</a></tt>
выполняется, в ней указана строка, которая являлась результатом вызова
<tt><a 
href="symbols.html#x185-2605392r392">format</a></tt>.
<!--l. 2233--><p class="indent" >   Эти конструкции обычно используются только как формы верхнего
уровня. Значения, возвращаемые каждой из этих конструкций, это
задекларированные имена <i>name</i>.
</div>
<!--l. 2237--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">5.3.3   </span> <a 
href="frontmatter.html#QQ2-40-284" id="x40-2760005.3.3">Контроль времени выполнения</a></h4>
<div class="defspec">
<div class="defmacheader">
<!--l. 2240--><p class="noindent" ><div class="tabbing">
 <i>[Специальный оператор]</i> <b>eval-when</b> <a 
 id="dx40-276001"></a><a 
 id="x40-276002r17"></a> ({situation}*) {form}*
   <br>
<!--l. 2241--><p class="noindent" ></div>
<!--l. 2241--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2770005.3.3" id="x40-2770005.3.3"></a></span>
</div>
<!--l. 2242--><p class="noindent" >Тело формы <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt> выполняется как неявный <tt><a 
href="symbols.html#x185-2605700r700">progn</a></tt>, но только в
перечисленных ниже ситуациях. Каждая ситуация <i>situation</i> должна быть
одним символов, <tt>:compile-toplevel</tt>, <tt>:load-toplevel</tt> или <tt>:execute</tt>.
<!--l. 2246--><p class="indent" >   Использование <tt>:compile-toplevel</tt> и <tt>:load-toplevel</tt> контролирует, что и
когда выполняется для форм верхнего уровня. Использование <tt>:execute</tt>
контролирует будет ли производится выполнения форм не верхнего
уровня.
<!--l. 2250--><p class="indent" >   Конструкция <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt> может быть более понятна в терминах модели
того, как компилятор файлов, <tt><a 
href="symbols.html#x185-2605232r232">compile-file</a></tt>, выполняет формы в файле для
                                                                          

                                                                          
компиляции.
<!--l. 2254--><p class="indent" >   Формы следующие друг за другом читаются из файла с помощью
компилятора файла используя <tt><a 
href="symbols.html#x185-2605717r717">read</a></tt>. Эти формы верхнего уровня обычно
обрабатываются в том, что мы называем режим «времени некомпиляции
(not-compile-time mode)». Существует и другой режим, называемый режим
«времени-компиляции (compile-time-too mode)», которые вступает в игру для
форм верхнего уровня. Специальная форма <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt> используется для
аннотации программы таким образом, чтобы предоставить программе,
осуществлять выбор режима.
<!--l. 2262--><p class="indent" >   Обработка форм верхнего уровня в компиляторе файла работает так, как
рассказано ниже:
      <ul class="itemize1">
      <li class="itemize">Если          форма          является          макровызовом,          она
      разворачивается и результат обрабатывается, как форма верхнего
      уровня  в  том  же  режиме  обработки  (времени-компиляции  или
      времени-некомпиляции, (compile-time-too или not-compile-time).
      </li>
      <li class="itemize">Если  форма  <tt><a 
href="symbols.html#x185-2605700r700">progn</a></tt> (или  <tt><a 
href="symbols.html#x185-2605501r501">locally</a></tt>),  каждая  из  форм  из  их  тел
      обрабатываются, как формы верхнего уровня в том же режиме
      обработки.
      </li>
      <li class="itemize">Если   форма   <tt>compiler-let</tt>,   <tt><a 
href="symbols.html#x185-2605532r532">macrolet</a></tt>  или   <tt><a 
href="symbols.html#x185-2605864r864">symbol-macrolet</a></tt>,
      компилятор   файла   создаёт   соответствующие   связывания   и
      рекурсивно обрабатывает тела форм, как неявный <tt><a 
href="symbols.html#x185-2605700r700">progn</a></tt> верхнего
      уровня  в  контексте  установленных  связей  в  том  же  режиме
      обработки.
      </li>
      <li class="itemize">Если форма <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt>, она обрабатывается в соответствии со
      следующей таблицей:
      <div class="flushleft" 
>
<!--l. 2281--><p class="noindent" >
                                                                          

                                                                          
 <!--tex4ht:inline--><div class="tabular"><table width="100%" class="tabular"><tr><td align="left" > LT</td><td align="left" >CT</td><td align="left" >EX</td><td align="left" >CTTM</td><td align="left" >Действие                                                     </td>
</tr><tr><td align="left" >  да </td><td align="left" > да </td><td align="left" >  –  </td><td align="left" >    –    </td><td align="left" >обработать тело в режиме время-компиляции   </td>
</tr><tr><td align="left" >  да </td><td align="left" >нет</td><td align="left" > да </td><td align="left" >   да   </td><td align="left" >обработать тело в режиме время-компиляции   </td>
</tr><tr><td align="left" >  да </td><td align="left" >нет</td><td align="left" >  –  </td><td align="left" >  нет  </td><td align="left" >обработать тело в режиме время-некомпиляции</td>
</tr><tr><td align="left" >  да </td><td align="left" >нет</td><td align="left" >нет</td><td align="left" >    –    </td><td align="left" >обработать тело в режиме время-некомпиляции</td></tr><tr><td align="left" > нет</td> <td align="left" > да </td> <td align="left" > – </td> <td align="left" > – </td> <td align="left" >выполнить тело</td>
</tr><tr><td align="left" > нет</td><td align="left" >нет</td><td align="left" > да </td><td align="left" >   да   </td><td align="left" >выполнить тело                                            </td></tr><tr><td align="left" > нет</td> <td align="left" >нет</td> <td align="left" > – </td> <td align="left" > нет </td> <td align="left" >ничего не делать</td>
</tr><tr><td align="left" > нет</td><td align="left" >нет</td><td align="left" >нет</td><td align="left" >    –    </td><td align="left" >ничего не делать                                           </td></tr></table>
</div></div>
      <!--l. 2294--><p class="noindent" >В этой таблице столбец LT спрашивает присутствует ли <tt>:load-toplevel</tt>
      в ситуациях указанных в форме <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt>. CT соответственно
      указывает на <tt>:compile-toplevel</tt> и EX на <tt>:execute</tt>. Столбец
      CTTM спрашивает встречается ли форма <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt> в режиме
      времени-компиляции. Фраза «обработка тела» означает обработку
      последовательно форм тела, как неявного <tt><a 
href="symbols.html#x185-2605700r700">progn</a></tt> верхнего уровня в
      указанном режиме, и «выполнение тела» означает выполнение форм
      тела последовательно, как неявный <tt><a 
href="symbols.html#x185-2605700r700">progn</a></tt> в динамическом контексте
      выполнения компилятора и в лексическом окружении, в котором
      встретилась <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt>.
      </li>
      <li class="itemize">В противном случае, форма верхнего уровня, которая не представлена в
      специальных случаях. Если в режиме времени-компиляции, компилятор
      сначала выполняет форму и затем выполняет обычную обработку
      компилятором. Если установлен режим времени-некомпиляции,
      выполняется только обычная обработка компилятором (смотрите
      раздел <a 
href="clmse121.html#x150-195000024.1">24.1<!--tex4ht:ref: COMPILER-SECTION --></a>). Любые подформы обрабатываются как формы не
      верхнего уровня.</li></ul>
<!--l. 2312--><p class="indent" >   Следует отметить, что формы верхнего уровня обрабатываются
гарантированно в порядке, в котором они были перечислены в тексте в
файле, и каждая форма верхнего уровня прочтённая компилятором
обрабатывается перед тем, как будет прочтена следующая. Однако, порядок
обработки (включая, в частности, раскрытие макросов) подформ, которые не
являются формами верхнего уровня, не определён.
<!--l. 2319--><p class="indent" >   Для формы <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt>, которая не является формой верхнего уровня в
компиляторе файлов (то есть либо в интерпретаторе, либо <tt><a 
href="symbols.html#x185-2605231r231">compile</a></tt>,
либо в компиляторе файлов, но не на верхнем уровне), если указана
ситуация <tt>:execute</tt>, тело формы обрабатывается как неявный <tt><a 
href="symbols.html#x185-2605700r700">progn</a></tt>. В
противном случае, тело игнорируется и форма <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt> имеет значение
<tt><a 
href="symbols.html#x185-2605609r609">nil</a></tt>.
                                                                          

                                                                          
<!--l. 2325--><p class="indent" >   Для сохранения обратной совместимости, <i>situation</i> может также быть
<tt><a 
href="symbols.html#x185-2605231r231">compile</a></tt>, <tt><a 
href="symbols.html#x185-2605498r498">load</a></tt> или <tt><a 
href="symbols.html#x185-2605343r343">eval</a></tt>. Внутри формы верхнего уровня <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt>,
они имеют значения <tt>:compile-toplevel</tt>, <tt>:load-toplevel</tt> и <tt>:execute</tt>
соответственно. Однако их поведение не определено при использовании в
<tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt> не верхнего уровня.
<!--l. 2332--><p class="indent" >   Следующие правила являются логическим продолжением предыдущих
определений:
      <ul class="itemize1">
      <li class="itemize">Никогда  не  случится  так,  чтобы  выполнение  одного  <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt>
      выражения приведёт к выполнению тела более чем один раз.
      </li>
      <li class="itemize">Старый ключевой символ <tt>eval</tt> был неправильно использован, потому
      что выполнение тела не нуждается в <tt>eval</tt>. Например, когда
      определение функции <div class="lisp"><div class="tabbing">
      (defun foo () (eval-when (:execute) (print &#x2019;foo)))
      <br>
      <!--l. 2344--><p class="noindent" ></div>
      <!--l. 2344--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2780005.3.3" id="x40-2780005.3.3"></a></span>
      <!--l. 2344--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2790005.3.3" id="x40-2790005.3.3"></a></span>
</div>
      <!--l. 2345--><p class="noindent" >скомпилируется, вызов <tt><a 
href="symbols.html#x185-2605690r690">print</a></tt> должен быть скомпилирован, а не
      выполнен во время компиляции.
      </li>
      <li class="itemize">Макросы, предназначенные для использования в качестве форм
      верхнего уровня, должны контролировать все побочные эффекты,
                                                                          

                                                                          
      которые будут сделаны формами в процессе развёртывания.
      Разворачиватель макроса сам по себе не должен порождать никаких
      побочных эффектов.
<div class="lisp">
      <!--l. 2355--><p class="noindent" ><div class="tabbing">
      (defmacro foo ()
      <br>          (really-foo)                              ;Неправильно<br>
             ‘(really-foo))<br>                                                <br>
           (defmacro foo ()<br>                  ‘(eval-when (:compile-toplevel<br>
                          :load-toplevel :execute)     ;Правильно<br>
               (really-foo)))<br>
      <!--l. 2364--><p class="noindent" ></div>
      <!--l. 2364--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2800005.3.3" id="x40-2800005.3.3"></a></span>
      <!--l. 2364--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2810005.3.3" id="x40-2810005.3.3"></a></span>
</div>
      <!--l. 2365--><p class="noindent" >Соблюдение этого правила будет значит, что такие макросы будут вести
      себя интуитивно понятно при вызовах в формах не верхнего
      уровня.
      </li>
      <li class="itemize">Расположение связывания переменной окружённой <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt>
      захватывает связывание, потому что режим «время-компиляции» не
      может случиться (потому что <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt> не может быть формой
      верхнего уровня) <div class="lisp"><div class="tabbing">
      (let ((x 3))
                                                                          

                                                                          
      <br>                     (eval-when (:compile-toplevel :load-toplevel :execute)<br>
               (print x)))<br>
      <!--l. 2375--><p class="noindent" ></div>
      <!--l. 2375--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2820005.3.3" id="x40-2820005.3.3"></a></span>
      <!--l. 2375--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2830005.3.3" id="x40-2830005.3.3"></a></span>
</div>
      <!--l. 2376--><p class="noindent" >выведет 3 во время выполнения (в данном случае загрузки) и не будет
      ничего выводить во время компиляции. Разворачивание <tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt> и
      <tt><a 
href="symbols.html#x185-2605284r284">defmacro</a></tt> может быть выполнено в контексте <tt><a 
href="symbols.html#x185-2605344r344">eval-when</a></tt> и могут
      корректно захватывать лексическое окружение. Например, реализация
      может разворачивать форму <tt><a 
href="symbols.html#x185-2605291r291">defun</a></tt>, такую как: <div class="lisp"><div class="tabbing">
      (defun bar (x) (defun foo () (+ x 3)))
      <br>
      <!--l. 2383--><p class="noindent" ></div>
      <!--l. 2383--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2840005.3.3" id="x40-2840005.3.3"></a></span>
      <!--l. 2383--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2850005.3.3" id="x40-2850005.3.3"></a></span>
</div>
      <!--l. 2384--><p class="noindent" >в <div class="lisp"><div class="tabbing">
      (progn (eval-when (:compile-toplevel)
                                                                          

                                                                          
      <br>                                       (compiler::notice-function &#x2019;bar &#x2019;(x)))<br>
                  (eval-when (:load-toplevel :execute)<br>
                    (setf (symbol-function &#x2019;bar)<br>
                          #&#x2019;(lambda (x)<br>                         (progn (eval-when (:compile-toplevel)<br>
                                       (compiler::notice-function &#x2019;foo<br>
                                                                  &#x2019;()))<br>
                                     (eval-when (:load-toplevel :execute)<br>
                                       (setf (symbol-function &#x2019;foo)<br>
                                             #&#x2019;(lambda () (+ x 3)))))))))<br>
      <!--l. 2397--><p class="noindent" ></div>
      <!--l. 2397--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2860005.3.3" id="x40-2860005.3.3"></a></span>
      <!--l. 2397--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2870005.3.3" id="x40-2870005.3.3"></a></span>
</div>
      <!--l. 2398--><p class="noindent" >которая по предыдущим правилам будет обработана также, как и
      <div class="lisp"><div class="tabbing">
      (progn (eval-when (:compile-toplevel)
      <br>                                       (compiler::notice-function &#x2019;bar &#x2019;(x)))<br>
                  (eval-when (:load-toplevel :execute)<br>
                    (setf (symbol-function &#x2019;bar)<br>
                          #&#x2019;(lambda (x)<br>                         (progn (eval-when (:load-toplevel :execute)<br>
                                       (setf (symbol-function &#x2019;foo)<br>
                                             #&#x2019;(lambda () (+ x 3)))))))))<br>
      <!--l. 2408--><p class="noindent" ></div>
      <!--l. 2408--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2880005.3.3" id="x40-2880005.3.3"></a></span>
                                                                          

                                                                          
      <!--l. 2408--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2890005.3.3" id="x40-2890005.3.3"></a></span>
</div>
      </li></ul>
<!--l. 2412--><p class="indent" >   Вот несколько дополнительных примеров. <div class="lisp"><div class="tabbing">
(let ((x 1))
   <br>                        (eval-when (:execute :load-toplevel :compile-toplevel)<br>
    (setf (symbol-function &#x2019;foo1) #&#x2019;(lambda () x))))<br>
<!--l. 2417--><p class="noindent" ></div>
<!--l. 2417--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2900005.3.3" id="x40-2900005.3.3"></a></span>
<!--l. 2417--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2910005.3.3" id="x40-2910005.3.3"></a></span>
</div>
<tt>
<!--l. 2418--><p class="indent" >   <a 
href="symbols.html#x185-2605344r344">eval-when</a></tt> в предыдущем выражении не является формой верхнего
уровня, таким образом во внимание берётся только ключевой символ
<tt>:execute</tt>. это не будет иметь эффекта во время компиляции. Однако этот
код установит в <tt>(symbol-function &#x2019;foo1)</tt> функцию которая возвращает <tt>1</tt> во
время загрузки (если <tt><a 
href="symbols.html#x185-2605488r488">let</a></tt> форма верхнего уровня) или во время выполнения
(если форма <tt><a 
href="symbols.html#x185-2605488r488">let</a></tt> вложена в какую-либо другую форму, которая ещё не была
выполнена). <div class="lisp"><div class="tabbing">
(eval-when (:execute :load-toplevel :compile-toplevel)
   <br>   (let ((x 2))<br>     (eval-when (:execute :load-toplevel :compile-toplevel)<br>
      (setf (symbol-function &#x2019;foo2) #&#x2019;(lambda () x)))))<br>
<!--l. 2430--><p class="noindent" ></div>
<!--l. 2430--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2920005.3.3" id="x40-2920005.3.3"></a></span>
                                                                          

                                                                          
<!--l. 2430--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2930005.3.3" id="x40-2930005.3.3"></a></span>
</div>
<!--l. 2431--><p class="indent" >   Если предыдущее выражение находилось на верхнем уровне в
компилируемом файле, оно будет выполнятся в обоих случаях, и во время
компиляции и во время загрузки.
<div class="lisp">
<!--l. 2434--><p class="indent" >   <div class="tabbing">
(eval-when (:execute :load-toplevel :compile-toplevel)
   <br>                                (setf (symbol-function &#x2019;foo3) #&#x2019;(lambda () 3)))<br>
<!--l. 2437--><p class="noindent" ></div>
<!--l. 2437--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2940005.3.3" id="x40-2940005.3.3"></a></span>
<!--l. 2437--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2950005.3.3" id="x40-2950005.3.3"></a></span>
</div>
<!--l. 2438--><p class="indent" >   Если предыдущее выражение находилось на верхнем уровне в
компилируемом файле, оно будет выполняться в обоих случаях, и во время
компиляции и во время загрузки.
<div class="lisp">
<!--l. 2441--><p class="indent" >   <div class="tabbing">
(eval-when (:compile-toplevel)
   <br>                                                       (eval-when (:compile-toplevel)<br>
    (print &#x2019;foo4)))<br>
<!--l. 2445--><p class="noindent" ></div>
<!--l. 2445--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2960005.3.3" id="x40-2960005.3.3"></a></span>
                                                                          

                                                                          
<!--l. 2445--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2970005.3.3" id="x40-2970005.3.3"></a></span>
</div>
<!--l. 2446--><p class="indent" >   Предыдущее выражение ничего не делает, оно просто возвращает
<tt><a 
href="symbols.html#x185-2605609r609">nil</a></tt>.
<div class="lisp">
<!--l. 2448--><p class="indent" >   <div class="tabbing">
(eval-when (:compile-toplevel)
   <br>                                                                  (eval-when (:execute)<br>
    (print &#x2019;foo5)))<br>
<!--l. 2452--><p class="noindent" ></div>
<!--l. 2452--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2980005.3.3" id="x40-2980005.3.3"></a></span>
<!--l. 2452--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-2990005.3.3" id="x40-2990005.3.3"></a></span>
</div>
<!--l. 2453--><p class="indent" >   Если предыдущее выражение находилось на верхнем уровне в
компилируемом файле, <tt>foo5</tt> будет выведено во время компиляции. Если эта
форма была не на верхнем уровне, ничего не будет выведено во время
компиляции. Вне зависимости от контекста, ничего не будет выведено во
время загрузки или выполнения.
<div class="lisp">
<!--l. 2458--><p class="indent" >   <div class="tabbing">
(eval-when (:execute :load-toplevel)
   <br>                                                       (eval-when (:compile-toplevel)<br>
    (print &#x2019;foo6)))<br>
<!--l. 2462--><p class="noindent" ></div>
<!--l. 2462--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-3000005.3.3" id="x40-3000005.3.3"></a></span>
                                                                          

                                                                          
<!--l. 2462--><p class="noindent" ><span class="paragraphHead"><a 
href="#x40-3010005.3.3" id="x40-3010005.3.3"></a></span>
</div>
<!--l. 2463--><p class="indent" >   Если предыдущая форма находилась на верхнем уровне в компилируемом
файле, <tt>foo6</tt> будет выведено во время компиляции. Если форма была не на
верхнем уровне, ничего не будет выведено во время компиляции. Вне
зависимости от контекста, ничего не будет выведение во время загрузки или
выполнения кода.
</div>
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
<!--l. 1006--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="preds.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse29.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse29.html#tailclmse29.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse30.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="progs.html#clmse30.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse30.html"></a>   </div> </div> 
</body></html> 
