<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Primitives</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-19 23:41:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="../cltl2ed.css"></head><body 
>
<!--l. 1553--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="generators.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse152.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse152.html#tailclmse152.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse153.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="series.html#clmse153.html" >Наверх</a><tt>&#x003E;</tt></div><h3 class="sectionHead"><span class="titlemark">A.4   </span> <a 
href="clm.html#QQ2-187-2778" id="x187-2731000A.4">Primitives</a></h3>
<!--l. 1555--><p class="noindent" >A large number of series functions are provided, because there are a large number
of useful operations that can be performed on series. However, this functionality
can be boiled down to a small number of primitive constructs.
<tt>
<!--l. 1560--><p class="indent" >   <a 
href="symbols.html#x196-2871252r252">collecting-fn</a></tt> embodies the fundamental idea of series computations that
utilize internal state. It can be used as the basis for deﬁning any on-line
transducer.
<tt>
<!--l. 1564--><p class="indent" >   <a 
href="symbols.html#x196-2871964r964">until</a></tt> embodies the fundamental idea of producing a series that is shorter
than the shortest input series. In particular, it embodies the idea of computing a
bounded series from non-series inputs. Together with <tt><a 
href="symbols.html#x196-2871252r252">collecting-fn</a></tt>, <tt><a 
href="symbols.html#x196-2871964r964">until</a></tt> can
be used to deﬁne <tt><a 
href="symbols.html#x196-2871811r811">scan-fn</a></tt>, which can be used as the basis for deﬁning all the
other scanners.
<tt>
<!--l. 1570--><p class="indent" >   <a 
href="symbols.html#x196-2871242r242">collect-last</a></tt> embodies the fundamental idea of producing a non-series value
from a series. Together with <tt><a 
href="symbols.html#x196-2871252r252">collecting-fn</a></tt>, it can be used to deﬁne <tt><a 
href="symbols.html#x196-2871240r240">collect-fn</a></tt>,
which (with the occasional assistance of <tt><a 
href="symbols.html#x196-2871964r964">until</a></tt>) can be used as the basis for
deﬁning all the other collectors.
<tt>
<!--l. 1576--><p class="indent" >   <a 
href="symbols.html#x196-2871734r734">producing</a></tt> embodies the fundamental idea of preorder computation. It can be
used as the basis for deﬁning all the other series functions, including the oﬀ-line
transducers.
<!--l. 1580--><p class="indent" >   In addition to the above, four primitives support various specialized aspects
of series functions. Alterability is supported by the function <tt><a 
href="symbols.html#x196-2871942r942">to-alter</a></tt>
and the declaration <tt><a 
href="symbols.html#x196-2871742r742">propagate-alterability</a></tt>. The propagation of type
information is supported by the type speciﬁer <tt><a 
href="symbols.html#x196-2871825r825">series-element-type</a></tt>.
The best implementation of certain series functions requires the form
<tt><a 
href="symbols.html#x196-2871354r354">encapsulated</a></tt>.
<div class="defmac">
<div class="defmacheader">
<!--l. 1589--><p class="indent" >   <div class="tabbing">
                                                                          

                                                                          
 <i>[Макрос]</i> <b>producing</b> <a 
 id="dx187-2731001"></a><a 
 id="x187-2731002r1063"></a> output-list input-list {declaration}* {form}*
   <br>
<!--l. 1590--><p class="noindent" ></div>
<!--l. 1590--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2732000A.4" id="x187-2732000A.4"></a></span>
</div>
<tt>
<!--l. 1591--><p class="indent" >   <a 
href="symbols.html#x196-2871734r734">producing</a></tt> computes and returns a group of series and non-series outputs
given a group of series and non-series inputs. The key feature of <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt> is
that some or all of the series inputs and outputs can be processed in an
oﬀ-line way. To support this, the processing in the body (consisting of the
<i>forms</i>) is performed from the perspective of generators and gatherers (see
appendix <a 
href="generators.html#x188-2747000B">B<!--tex4ht:ref: GENERATORS --></a>). Each series input is converted to a generator before being
used in the body. Each series output is associated with a gatherer in the
body.
<!--l. 1601--><p class="indent" >   The <i>output-list</i> has the same syntax as the binding list of a <tt><a 
href="symbols.html#x196-2871518r518">let</a></tt>. The names of
the variables must be distinct from each other and from the names of the variables
in the <tt>input-list</tt>. If there are <i>n</i> variables in the <i>output-list</i>, <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt>
computes <i>n</i> outputs. There must be at least one output variable. The variables
act as the names for the outputs and can be used in either of two ways. First, if
an output variable has a value associated with it in the <i>output-list</i>, then the
variable is treated as holding a non-series value. The variable is initialized to the
indicated value and can be used in any way desired in the body. The eventual
output value is whatever value is in the variable when the execution of the
body terminates. Second, if an output variable does not have a value
associated with it in the <i>output-list</i>, the variable is given as its value a
gatherer that collects elements. The only valid way to use the variable
in the body is in a call on <tt><a 
href="symbols.html#x196-2871643r643">next-out</a></tt>. The output returned is a series
containing these elements. If the body never terminates, this series is
unbounded.
<!--l. 1618--><p class="indent" >   The <i>input-list</i> also has the same syntax as the binding list of a <tt><a 
href="symbols.html#x196-2871518r518">let</a></tt>. The names
of the variables must be distinct from each other and the names of the variables in
the <i>output-list</i>. The values can be series or non-series. If the value is not explicitly
speciﬁed, it defaults to <tt><a 
href="symbols.html#x196-2871644r644">nil</a></tt>. The variables act logically both as inputs and state
variables and can be used in one of two ways. First, if an input variable is
                                                                          

                                                                          
associated with a non-series value, then it is given this value before the
evaluation of the body begins and can be used in any way desired in the
body. Second, if an input variable is associated with a series, then the
variable is given a generator corresponding to this series as its initial
value. The only valid way to use the variable in the body is in a call on
<tt><a 
href="symbols.html#x196-2871641r641">next-in</a></tt>.
<!--l. 1631--><p class="indent" >   There can be declarations at the start of the body. However, the only declarations
allowed are <tt>ignore</tt> declarations, type declarations, and <tt><a 
href="symbols.html#x196-2871742r742">propagate-alterability</a></tt>
declarations (see below). In particular, it is an error for any of the input or output
variables to be special.
<!--l. 1637--><p class="indent" >   In conception, the body can contain arbitrary Lisp expressions. After the
appropriate generators and gatherers have been set up, the body is executed until
it terminates. If the body never terminates, the series outputs (if any)
are unbounded in length and the non-series outputs (if any) are never
produced.
<!--l. 1643--><p class="indent" >   Although easy to understand, this view of what can happen in the body
presents severe diﬃculties when optimizing (and even when evaluating)
series expressions that contain calls on <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt>. As a result, several
limitations are imposed on the form of the body to simplify the processing
required.
<!--l. 1649--><p class="indent" >   The ﬁrst limitation is that, exclusive of any declarations, the body must have
the form <tt>(loop (tagbody ...))</tt>. The following example shows how <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt>
could be used to implement a scanner creating an unbounded series of integers.
<div class="lisp"><div class="tabbing">
(producing (nums) ((num 0))
   <br>                          (declare (integer num) (type (series integer) nums))<br>
  (loop<br>                                                         (tagbody<br>
      (setq num (1+ num))<br>                     (next-out nums num))))<br>
  <span class="math"> ⇒</span> #Z(1 2 3 4 ...)<br>
<!--l. 1661--><p class="noindent" ></div>
<!--l. 1661--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2733000A.4" id="x187-2733000A.4"></a></span>
                                                                          

                                                                          
<!--l. 1661--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2734000A.4" id="x187-2734000A.4"></a></span>
</div>
<!--l. 1663--><p class="indent" >   The second limitation is that the form <tt><a 
href="symbols.html#x196-2871935r935">terminate-producing</a></tt> must be used to
terminate the execution of the body. Any other method of terminating the body
(with <tt><a 
href="symbols.html#x196-2871792r792">return</a></tt>, for example) is an error. The following example shows how
<tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt> could be used to implement the operation of summing a series. The
function <tt><a 
href="symbols.html#x196-2871935r935">terminate-producing</a></tt> is used to stop the computation when <tt>numbers</tt>
runs out of elements. <div class="lisp"><div class="tabbing">
(producing ((sum 0)) ((numbers #Z(1 2 3)) num)
   <br>                                                                                       (loop<br>
    (tagbody<br>        (setq num (next-in numbers (terminate-producing)))<br>
      (setq sum (+ sum num)))))<br>                                   <span class="math"> ⇒</span> 6<br>
<!--l. 1677--><p class="noindent" ></div>
<!--l. 1677--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2735000A.4" id="x187-2735000A.4"></a></span>
<!--l. 1677--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2736000A.4" id="x187-2736000A.4"></a></span>
</div>
<!--l. 1679--><p class="indent" >   The third limitation is that calls on <tt><a 
href="symbols.html#x196-2871643r643">next-out</a></tt> associated with output variables
must appear at top level in the <tt><a 
href="symbols.html#x196-2871930r930">tagbody</a></tt> in the body. They cannot be nested in
other forms. In addition, an output variable can be the destination of at most one
call on <tt><a 
href="symbols.html#x196-2871643r643">next-out</a></tt> and if it is the destination of a <tt><a 
href="symbols.html#x196-2871643r643">next-out</a></tt>, it cannot be used in
any other way.
<!--l. 1686--><p class="indent" >   If the call on <tt><a 
href="symbols.html#x196-2871643r643">next-out</a></tt> for a given output appears in the ﬁnal part of the
<tt><a 
href="symbols.html#x196-2871930r930">tagbody</a></tt> in the body, after everything other than other calls on <tt><a 
href="symbols.html#x196-2871643r643">next-out</a></tt>, then
the output is an on-line output—a new value is written on every cycle of the body.
Otherwise the output is oﬀ-line.
<!--l. 1692--><p class="indent" >   The following example shows how <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt> could be used to split a series
into two parts. Items are read in one at a time and tested. Depending on the test,
they are written to one of two outputs. Note the use of labels and branches to
keep the calls on <tt><a 
href="symbols.html#x196-2871643r643">next-out</a></tt> at top level. Both outputs are oﬀ-line. The ﬁrst
example above shows an on-line output. <div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(producing (items-1 items-2) ((items #Z(1 -2 3 -4)) item)
   <br>  (loop<br>    (tagbody (setq item (next-in items (terminate-producing)))<br>
             (if (not (plusp item)) (go D))<br>
             (next-out items-1 item)<br>                           (go F)<br>
      D      (next-out items-2 item)<br>                       F      )))<br>
  <span class="math"> ⇒</span> #Z(1 3) and #Z(-2 -4)<br>
<!--l. 1708--><p class="noindent" ></div>
<!--l. 1708--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2737000A.4" id="x187-2737000A.4"></a></span>
<!--l. 1708--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2738000A.4" id="x187-2738000A.4"></a></span>
</div>
<!--l. 1710--><p class="indent" >   The fourth limitation is that the calls on <tt><a 
href="symbols.html#x196-2871641r641">next-in</a></tt> associated with an input
variable <tt>v</tt> must appear at top level in the <tt><a 
href="symbols.html#x196-2871930r930">tagbody</a></tt> in the body, nested in
assignments of the form <tt>(setq <i>var</i> (next-in v ...))</tt>. They cannot be nested
in other forms. In addition, an input variable can be the source for at most one
call on <tt><a 
href="symbols.html#x196-2871641r641">next-in</a></tt> and if it is the source for a <tt><a 
href="symbols.html#x196-2871641r641">next-in</a></tt>, it cannot be used in any
other way.
<!--l. 1718--><p class="indent" >   If the call on <tt><a 
href="symbols.html#x196-2871641r641">next-in</a></tt> for a given input has as its sole termination action
<tt>(terminate-producing)</tt> and appears in the initial part of the <tt><a 
href="symbols.html#x196-2871930r930">tagbody</a></tt> in the
body, before anything other than similar calls on <tt><a 
href="symbols.html#x196-2871641r641">next-in</a></tt>, then the input is an
on-line input—a new value is read on every cycle of the body. Otherwise the input
is oﬀ-line.
<!--l. 1725--><p class="indent" >   The example below shows how <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt> could be used to concatenate two
series. To start with, elements are read from the ﬁrst input series. When this runs
out, a ﬂag is set and reading begins from the second input. Both inputs are
oﬀ-line. (Compare this to the example above, which shows an on-line input.)
<div class="lisp"><div class="tabbing">
(producing (items) ((item-1 #Z(1 2))
   <br>                                                             (item-2 #Z(3 4))<br>
                    (in-2 nil)<br>                                 item)<br>
                                                                          

                                                                          
  (loop<br>                                          (tagbody (if in-2 (go D))<br>
             (setq item (next-in item-1 (setq in-2 t) (go D)))<br>
             (go F)<br>
      D      (setq item (next-in item-2 (terminate-producing)))<br>
      F      (next-out items item))))<br>                   <span class="math"> ⇒</span> #Z(1 2 3 4)<br>
<!--l. 1743--><p class="noindent" ></div>
<!--l. 1743--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2739000A.4" id="x187-2739000A.4"></a></span>
<!--l. 1743--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2740000A.4" id="x187-2740000A.4"></a></span>
</div>
</div>
<div class="defmac">
<div class="defmacheader">
<!--l. 1747--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i> <b>terminate-producing</b> <a 
 id="dx187-2740001"></a><a 
 id="x187-2740002r1064"></a> <tt></tt>
   <br>
<!--l. 1748--><p class="noindent" ></div>
<!--l. 1748--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2741000A.4" id="x187-2741000A.4"></a></span>
</div>
<!--l. 1749--><p class="indent" >   This form (which takes no arguments) is used to terminate execution of (the
expansion of) the <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt> macro.
<!--l. 1752--><p class="indent" >   As with the form <tt><a 
href="symbols.html#x196-2871452r452">go</a></tt>, <tt><a 
href="symbols.html#x196-2871935r935">terminate-producing</a></tt> does not return any values;
rather, control immediately leaves the current context.
<!--l. 1756--><p class="indent" >   The form <tt><a 
href="symbols.html#x196-2871935r935">terminate-producing</a></tt> is allowed to appear only in a <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt>
body and causes the termination of the enclosing call on <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt>.
</div>
<div class="defun">
<!--l. 1761--><p class="noindent" ><div class="defunheader"> <i>[Declaration speciﬁer]</i><a 
 id="dx187-2741001"></a><a 
 id="x187-2741002r1065"></a> <b>propagate-alterability</b>
</div>
                                                                          

                                                                          
<!--l. 1764--><p class="indent" >   The declaration speciﬁer <tt>(propagate-alterability <i>input</i> <i>output</i>)</tt>
indicates that attempts to alter an element of <i>output</i> should be satisﬁed by
altering the corresponding element of <i>input</i>. (The corresponding element of <i>input</i>
is the one most recently read at the moment when the output element is
written.)
<!--l. 1771--><p class="indent" >   This declaration may appear only in a call on <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt>. The <i>input</i> and
<i>output</i> arguments must be an input and an output, respectively, of the <tt><a 
href="symbols.html#x196-2871734r734">producing</a></tt>
macro. The example below shows how the propagation of alterability could be
supported in a simpliﬁed version of <tt><a 
href="symbols.html#x196-2871964r964">until</a></tt>. <div class="lisp"><div class="tabbing">
(defun simple-until (bools items)
   <br>                                            (declare (optimizable-series-function))<br>
  (producing (z) ((x bools) (y items) bool item)<br>
    (declare (propagate-alterability y z))<br>                            (loop<br>
      (tagbody<br>            (setq bool (next-in x (terminate-producing)))<br>
        (setq item (next-in y (terminate-producing)))<br>
        (if bool (terminate-producing))<br>             (next-out z item)))))<br>
<!--l. 1787--><p class="noindent" ></div>
<!--l. 1787--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2742000A.4" id="x187-2742000A.4"></a></span>
<!--l. 1787--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2743000A.4" id="x187-2743000A.4"></a></span>
</div>
</div>
<div class="defmac">
<div class="defmacheader">
<!--l. 1791--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i> <b>encapsulated</b> <a 
 id="dx187-2743001"></a><a 
 id="x187-2743002r1066"></a> encapsulating-fn scanner-or-collector
   <br>
<!--l. 1792--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 1792--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2744000A.4" id="x187-2744000A.4"></a></span>
</div>
<!--l. 1793--><p class="indent" >   Some of the features provided by Common Lisp are supported solely by
encapsulating forms. For example, there is no way to specify a cleanup
expression that will always be run, even when an abort occurs, without using
<tt><a 
href="symbols.html#x196-2871969r969">unwind-protect</a></tt>. <tt><a 
href="symbols.html#x196-2871354r354">encapsulated</a></tt> makes it possible to take advantage of forms
such as <tt><a 
href="symbols.html#x196-2871969r969">unwind-protect</a></tt> when deﬁning a series function.
<tt>
<!--l. 1798--><p class="indent" >   <a 
href="symbols.html#x196-2871354r354">encapsulated</a></tt> speciﬁes a function that places an encapsulating form around
the computation performed by its second argument. The ﬁrst argument
must be a quoted function that takes a Lisp expression and wraps the
appropriate encapsulating form around it, returning the resulting code. The
second input must be a literal call on <tt><a 
href="symbols.html#x196-2871811r811">scan-fn</a></tt>, <tt><a 
href="symbols.html#x196-2871812r812">scan-fn-inclusive</a></tt>, or
<tt><a 
href="symbols.html#x196-2871240r240">collect-fn</a></tt>. The second argument can count on being evaluated in the scope of
the encapsulating form. The values returned by the second argument
are returned as the values of <tt><a 
href="symbols.html#x196-2871354r354">encapsulated</a></tt>. The following shows how
<tt><a 
href="symbols.html#x196-2871354r354">encapsulated</a></tt> could be used to deﬁne a simpliﬁed version of <tt><a 
href="symbols.html#x196-2871238r238">collect-file</a></tt>.
<div class="lisp"><div class="tabbing">
(defun collect-ﬁle-wrap (ﬁle name body)
   <br>                      ‘(with-open-ﬁle (,ﬁle ,name :direction :output) ,body))<br>
<br>                                 (defmacro simple-collect-ﬁle (name items)<br>
  (let ((ﬁle (gensym)))<br>                  ‘(encapsulated #&#x2019;(lambda (body)<br>
                       (collect-ﬁle-wrap &#x2019;,ﬁle &#x2019;,name body))<br>
                   (collect-fn t #&#x2019;(lambda () t)<br>
                               #&#x2019;(lambda (state item)<br>
                                   (print item ,ﬁle)<br>
                                   state)<br>
                               ,items))))<br>
<!--l. 1820--><p class="noindent" ></div>
<!--l. 1820--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2745000A.4" id="x187-2745000A.4"></a></span>
<!--l. 1820--><p class="noindent" ><span class="paragraphHead"><a 
href="#x187-2746000A.4" id="x187-2746000A.4"></a></span>
                                                                          

                                                                          
</div>
</div>
<!--l. 1822--><p class="indent" >
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
<!--l. 7--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="generators.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse152.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse152.html#tailclmse152.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse153.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="series.html#clmse153.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse153.html"></a>   </div> </div> 
</body></html> 
