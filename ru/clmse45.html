<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Динамические нелокальные выходы</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-20 14:55:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="../cltl2ed.css"></head><body 
>
<!--l. 8098--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="macro.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html#tailclmse44.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse45.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="contrl.html#clmse45.html" >Наверх</a><tt>&#x003E;</tt>&lt;<a href="../index.html">Main Page</a>&gt;</div><h3 class="sectionHead"><span class="titlemark">7.11   </span> <a 
href="clm.html#QQ2-57-699" id="x57-6900007.11">Динамические
нелокальные выходы</a></h3>
<a 
 id="dx57-690001"></a>
<a 
 id="dx57-690002"></a>
<a 
 id="dx57-690003"></a>
<a 
 id="dx57-690004"></a>
<!--l. 8105--><p class="noindent" >Common Lisp предоставляет функциональность для выхода из сложного
процесса в нелокальном, динамических ограниченном стиле. Для этих целей
есть два вида специальных форм, называемых <i>catch</i> и <i>throw</i>. Форма catch
выполняет некоторые подформы так, что если форма throw выполняется в
ходе этих вычислений, в данной точке вычисления прерываются и форма
catch немедленно возвращает значение указанное в throw. В отличие от <tt><a 
href="symbols.html#x185-2605128r128">block</a></tt>
и <tt><a 
href="symbols.html#x185-2605751r751">return</a></tt> (раздел <a 
href="clmse41.html#x53-5870007.7">7.7<!--tex4ht:ref: BLOCK-RETURN-SECTION --></a>), которые позволяют выйти из тела <tt><a 
href="symbols.html#x185-2605128r128">block</a></tt> из любой
точки лексически, находящейся внутри тела, <tt>catch/throw</tt> механизм работает,
даже если форма <tt>throw</tt> по тексту не находится внутри тела формы <tt>catch</tt>.
Throw может использовать только в течение (продолжительности
времени) выполнения тела catch. Можно провести аналогию между ними,
как между динамически связываемыми переменными и лексически
связываемыми.
<div class="defspec">
<div class="defmacheader">
<!--l. 8120--><p class="indent" >   <div class="tabbing">
 <i>[Специальный оператор]</i> <b>catch</b> <a 
 id="dx57-690005"></a><a 
 id="x57-690006r120"></a> tag {form}*
   <br>
<!--l. 8121--><p class="noindent" ></div>
<!--l. 8121--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-6910007.11" id="x57-6910007.11"></a></span>
</div>
<!--l. 8122--><p class="indent" >   Специальная форма <tt>catch</tt> служит мишенью для передачи управления с
помощью <tt>throw</tt>. Первой выполняется форма <i>tag</i> для создания объекта
для имени catch. Он может быть любым Lisp&#x2019;овым объектом. Затем
                                                                          

                                                                          
устанавливается ловушка с тегом, в качестве которого используется этот
объект. Формы <i>form</i> выполняются как неявный <tt><a 
href="symbols.html#x185-2605700r700">progn</a></tt>, и возвращается
результат последней формы. Однако если во время вычислений будет
выполнена форма <tt>throw</tt> с тегом, который равен <tt><a 
href="symbols.html#x185-2605337r337">eq</a></tt> тегу catch, то управление
немедленно прерывается и возвращается результат указанный в форме throw.
Ловушка, устанавливаемая с помощью <tt>catch</tt>, упраздняется перед тем, как
будет возвращён результат.
<!--l. 8136--><p class="indent" >   Тег используется для соотнесения throws и catches. <tt>(catch &#x2019;foo <i>form</i>)</tt>
будет перехватывать <tt>(throw &#x2019;foo <i>form</i>)</tt>, но не будет <tt>(throw &#x2019;bar <i>form</i>)</tt>.
Если <tt>throw</tt> выполнен без соответствующего <tt>catch</tt>, готового его обработать,
то это является ошибкой.
<!--l. 8141--><p class="indent" >   Теги catch сравниваются с использованием <tt><a 
href="symbols.html#x185-2605337r337">eq</a></tt>, а не <tt><a 
href="symbols.html#x185-2605338r338">eql</a></tt>. Таким
образом числа и строковые символы не могут использоваться в качестве
тегов.
</div>
<a 
 id="dx57-691001"></a>
<a 
 id="dx57-691002"></a>
<div class="defspec">
<div class="defmacheader">
<!--l. 8149--><p class="indent" >   <div class="tabbing">
 <i>[Специальный оператор]</i> <b>unwind-protect</b> <a 
 id="dx57-691003"></a><a 
 id="x57-691004r121"></a> protected-form {cleanup-form}*
   <br>
<!--l. 8150--><p class="noindent" ></div>
<!--l. 8150--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-6920007.11" id="x57-6920007.11"></a></span>
</div>
<!--l. 8151--><p class="indent" >   Иногда необходимо выполнить форму и быть уверенным, что некоторые
побочные эффекты выполняются после её завершения. Например:
<div class="lisp"><div class="tabbing">
(progn (start-motor)
   <br>                                                                             (drill-hole)<br>
       (stop-motor))<br>
<!--l. 8158--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 8158--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-6930007.11" id="x57-6930007.11"></a></span>
<!--l. 8158--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-6940007.11" id="x57-6940007.11"></a></span>
</div>
<!--l. 8159--><p class="indent" >   Функциональность нелокальных выходов в Common Lisp создаёт
ситуацию, в которой однако данный код может не сработать правильно. Если
<tt>drill-hole</tt> может бросить исключение в ловушку, находящуюся выше
данного <tt><a 
href="symbols.html#x185-2605700r700">progn</a></tt>, то <tt>(stop-motor)</tt> никогда не выполниться. Более удобный
пример с открытием/закрытием файлов: <div class="lisp"><div class="tabbing">
(prog2 (open-a-ﬁle)
   <br>                                                                          (process-ﬁle)<br>
       (close-the-ﬁle))<br>
<!--l. 8168--><p class="noindent" ></div>
<!--l. 8168--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-6950007.11" id="x57-6950007.11"></a></span>
<!--l. 8168--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-6960007.11" id="x57-6960007.11"></a></span>
</div>
<!--l. 8169--><p class="indent" >   где закрытие файла может не произойти, по причине ошибки в функции
<tt>process-file</tt>.
<!--l. 8172--><p class="indent" >   Для того, чтобы вышеприведённый код работал корректно, можно
переписать его с использованием <tt><a 
href="symbols.html#x185-2605908r908">unwind-protect</a></tt>: <div class="lisp"><div class="tabbing">
;; Stop the motor no matter what (even if it failed to start).
   <br>                                     <br>                                     (unwind-protect<br>
  (progn (start-motor)<br>                                       (drill-hole))<br>
  (stop-motor))<br>
<!--l. 8181--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 8181--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-6970007.11" id="x57-6970007.11"></a></span>
<!--l. 8181--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-6980007.11" id="x57-6980007.11"></a></span>
</div>
<!--l. 8182--><p class="indent" >   Если <tt>drill-hole</tt> бросит исключение, которое попытается выйти из блока
<tt><a 
href="symbols.html#x185-2605908r908">unwind-protect</a></tt>, то <tt>(stop-motor)</tt> будет обязательно выполнена.
<!--l. 8185--><p class="indent" >   Этот пример допускает то, что вызов <tt>stop-motor</tt> корректен, даже если
мотор ещё не был запущен. Помните, что ошибка или прерывание может
осуществить выход перед тем, как будет проведена инициализация. Любой
код по восстановлению состояния должен правильно работать вне
зависимости от того, где произошла ошибка. Например, следующий код
неправильный: <div class="lisp"><div class="tabbing">
(unwind-protect
   <br>           (progn (incf *access-count*)<br>                  (perform-access))<br>
  (decf *access-count*))<br>
<!--l. 8196--><p class="noindent" ></div>
<!--l. 8196--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-6990007.11" id="x57-6990007.11"></a></span>
<!--l. 8196--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-7000007.11" id="x57-7000007.11"></a></span>
</div>
<!--l. 8197--><p class="indent" >   Если выход случиться перед тем, как выполниться операция <tt><a 
href="symbols.html#x185-2605441r441">incf</a></tt>, то
выполнение <tt><a 
href="symbols.html#x185-2605268r268">decf</a></tt> приведён к некорректному значению в <tt>*access-count*</tt>.
Правильно будет записать этот код так: <div class="lisp"><div class="tabbing">
(let ((old-count *access-count*))
   <br>                                                                         (unwind-protect<br>
    (progn (incf *access-count*)<br>                       (perform-access))<br>
    (setq *access-count* old-count)))<br>
<!--l. 8206--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 8206--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-7010007.11" id="x57-7010007.11"></a></span>
<!--l. 8206--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-7020007.11" id="x57-7020007.11"></a></span>
</div>
<!--l. 8208--><p class="indent" >   Как правило, <tt><a 
href="symbols.html#x185-2605908r908">unwind-protect</a></tt> гарантирует выполнение форм <i>cleanup-form</i>
перед выходом, как в случае нормального выхода, так и в случае генерации
исключения. (Если, однако, выход случился в ходе выполнения форм
<i>cleanup-form</i>, никакого специального действия не предпринимается. Формы
<i>cleanup-form</i> не защищаются. Для этого необходимо использовать
дополнительные конструкции <tt><a 
href="symbols.html#x185-2605908r908">unwind-protect</a></tt>.) <tt><a 
href="symbols.html#x185-2605908r908">unwind-protect</a></tt> возвращает
результат выполнения защищённой формы <i>protected-form</i> и игнорирует все
результаты выполнения форм чистки <i>cleanup-form</i>.
<!--l. 8219--><p class="indent" >   Следует подчеркнуть, что <tt><a 
href="symbols.html#x185-2605908r908">unwind-protect</a></tt> защищает против <i>всех</i>
попыток выйти из защищённой формы, включая не только «динамический
выход» с помощью <tt>throw</tt>, но и также «лексический выход» с помощью <tt><a 
href="symbols.html#x185-2605423r423">go</a></tt> и
<tt><a 
href="symbols.html#x185-2605752r752">return-from</a></tt>. Рассмотрим следующую ситуацию: <div class="lisp"><div class="tabbing">
(tagbody
   <br>                                                                                (let ((x 3))<br>
    (unwind-protect<br>                            (if (numberp x) (go out))<br>
      (print x)))<br>                                                      out<br>
  ...)<br>
<!--l. 8231--><p class="noindent" ></div>
<!--l. 8231--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-7030007.11" id="x57-7030007.11"></a></span>
<!--l. 8231--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-7040007.11" id="x57-7040007.11"></a></span>
</div>
<!--l. 8232--><p class="indent" >   Когда выполнится <tt><a 
href="symbols.html#x185-2605423r423">go</a></tt>, то сначала выполнится <tt><a 
href="symbols.html#x185-2605690r690">print</a></tt>, а затем перенос
управления на тег <tt>out</tt> будет завершён.
</div>
<div class="defspec">
<div class="defmacheader">
                                                                          

                                                                          
<!--l. 8237--><p class="indent" >   <div class="tabbing">
 <i>[Специальный оператор]</i> <b>throw</b> <a 
 id="dx57-704001"></a><a 
 id="x57-704002r122"></a> tag result
   <br>
<!--l. 8238--><p class="noindent" ></div>
<!--l. 8238--><p class="noindent" ><span class="paragraphHead"><a 
href="#x57-7050007.11" id="x57-7050007.11"></a></span>
</div>
<!--l. 8239--><p class="indent" >   Специальная форма <tt>throw</tt> переносит управление к соответствующей
конструкции <tt>catch</tt>. Сначала выполняется <i>tag</i> для вычисления объекта,
называемого тег throw. Затем вычисляется форма результата <i>result</i>, и этот
результат сохраняется (если форма <i>result</i> возвращает несколько значений, то
<i>все</i> значения сохраняются). Управление выходит и самого последнего
установленного catch, тег которого совпадает с тегом throw. Сохранённые
результаты возвращаются, как значения конструкции <tt>catch</tt>. Теги catch и
throw совпадают, только если они равны <tt><a 
href="symbols.html#x185-2605337r337">eq</a></tt>.
<!--l. 8250--><p class="indent" >   В процессе, связывания динамических переменных упраздняются
до точки catch, и выполнятся все формы очистки в конструкциях
unwind-protect. Форма <i>result</i> вычисляется перед началом процесса
раскручивания, и её значение возвращается из блока catch.
<!--l. 8255--><p class="indent" >   Если внешний блок catch с совпадающим тегом не найден, раскрутка стека
не происходит и сигнализируется ошибка. Когда ошибка сигнализируется,
ловушки и динамические связывания переменных являются теми, которые
были в точке throw.
</div>
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
<!--l. 1152--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="macro.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html#tailclmse44.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse45.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="contrl.html#clmse45.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse45.html"></a>  </div> </div> 
</body></html> 
