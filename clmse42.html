<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Формы циклов</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-16 23:44:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 6965--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse43.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse41.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse41.html#tailclmse41.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse42.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch7.html#clmse42.html" >Наверх</a><tt>&#x003E;</tt></div><h3 class="sectionHead"><span class="titlemark">7.8   </span> <a 
href="clm.html#QQ2-54-654" id="x54-6460007.8">Формы циклов</a></h3>
<a 
 id="dx54-646001"></a>
<!--l. 6968--><p class="noindent" >Common Lisp предоставляет некоторые конструкции для циклов.
Конструкция <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt> предоставляет простую функциональность. Она слегка
больше, чем <tt><a 
href="clmli7.html#x196-3479745r745">progn</a></tt>, и имеет ветку для переноса управления снизу вверх.
Конструкции <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> и <tt><a 
href="clmli7.html#x196-3479340r340">do*</a></tt> предоставляют общую функциональность для
управления на каждом цикле изменением нескольких переменных. Для
специализированных циклов над элементами списка или <i>n</i> последовательных
чисел предоставляются формы <tt><a 
href="clmli7.html#x196-3479346r346">dolist</a></tt> и <tt><a 
href="clmli7.html#x196-3479347r347">dotimes</a></tt>. Конструкция <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>
наиболее общая конструкция, которая внутри себя позволяет использование
выражений <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>. (Традиционная конструкция <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt> — это синтез <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>,
<tt><a 
href="clmli7.html#x196-3479135r135">block</a></tt> и <tt><a 
href="clmli7.html#x196-3479524r524">let</a></tt>.) Большинство конструкций циклов позволяют определённые
статически нелокальные выходы (смотрите <tt><a 
href="clmli7.html#x196-3479799r799">return-from</a></tt> и <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt>).
<!--l. 6981--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.1   </span> <a 
href="clmli1.html#QQ2-54-655" id="x54-6470007.8.1">Бесконечный цикл</a></h4>
<!--l. 6983--><p class="noindent" >Конструкция <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt> является наипростейшей функциональностью для
итераций. Она не управляет переменными, и просто циклично выполняет
своё тело.
<div class="defmac">
<div class="defmacheader">
<!--l. 6987--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i><b> loop </b> <a 
 id="dx54-647001"></a><a 
 id="x54-647002r96"></a> {form}*
   <br>
<!--l. 6988--><p class="noindent" ></div>
<!--l. 6988--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6480007.8.1" id="x54-6480007.8.1"></a></span>
</div>
                                                                          

                                                                          
<!--l. 6989--><p class="indent" >   Каждая форма <i>form</i> выполняется последовательно слева направо. Когда
вычислена последняя форма, тогда вычисляется первая форма и так далее, в
безостановочном цикле. Конструкция <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt> никогда не возвращает значение.
Её выполнение может быть остановлено явно, с помощью <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> или <tt>throw</tt>,
например.
<tt>
<!--l. 6995--><p class="indent" >   <a 
href="clmli7.html#x196-3479558r558">loop</a></tt>, как и многие конструкции циклов, устанавливает неявный блок с
именем <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>. Таким образом, <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> с заданным результатом может
использоваться для выхода и <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt>.
</div>
<!--l. 7001--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.2   </span> <a 
href="clmli1.html#QQ2-54-657" id="x54-6490007.8.2">Основные формы циклов</a></h4>
<!--l. 7003--><p class="noindent" >В отличие от <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt>, <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> и <tt><a 
href="clmli7.html#x196-3479340r340">do*</a></tt> предоставляют мощный механизм для повторных
вычислений большого количества переменных.
<div class="defmac">
<div class="defmacheader">
<!--l. 7008--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i><b> do </b> <a 
 id="dx54-649001"></a><a 
 id="x54-649002r97"></a> ({var | (var [init [step]])}*)
   <br>                                                                    (end-test {result}*)<br>
   {declaration}* {tag | statement}*<br>
<!--l. 7010--><p class="noindent" ></div>
<!--l. 7010--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6500007.8.2" id="x54-6500007.8.2"></a></span>
</div>
<div class="defmacheader">
<!--l. 7010--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i><b> do* </b> <a 
 id="dx54-650001"></a><a 
 id="x54-650002r98"></a> ({var | (var [init [step]])}*)
   <br>                                                                    (end-test {result}*)<br>
   {declaration}* {tag | statement}*<br>
<!--l. 7014--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 7014--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6510007.8.2" id="x54-6510007.8.2"></a></span>
</div>
<!--l. 7015--><p class="indent" >   Специальная форма <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> представляет общую функциональность цикла, с
произвольным количеством «переменных-индексов». Эти переменные
связываются при входе в цикл и параллельно наращиваются, как это было
задано. Они могут быть использованы, как для генерации необходимых
последовательных чисел (как, например, последовательные целые
числа), так и для накопления результата. Когда условие окончания
цикла успешно выполнилось, тогда цикл завершается с заданным
значением.
<!--l. 7024--><p class="indent" >   В общем виде <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> выглядит так: <div class="lisp"><div class="tabbing">
(do ((<i>var1</i> <i>init1</i> <i>step1</i>)
   <br>                                                                    (<i>var2</i> <i>init2</i> <i>step2</i>)<br>
     ...<br>                                               (<i>varn</i> <i>initn</i> <i>stepn</i>))<br>
    (<i>end-test</i> . <i>result</i>)<br>                                      {<i><i>declaration</i></i>}* <br>
  . <i>tagbody</i>)<br>
<!--l. 7033--><p class="noindent" ></div>
<!--l. 7033--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6520007.8.2" id="x54-6520007.8.2"></a></span>
<!--l. 7033--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6530007.8.2" id="x54-6530007.8.2"></a></span>
</div>
<!--l. 7034--><p class="indent" >   Цикл <tt><a 
href="clmli7.html#x196-3479340r340">do*</a></tt> выглядит также, кроме изменения имени с <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> на <tt><a 
href="clmli7.html#x196-3479340r340">do*</a></tt>.
<!--l. 7036--><p class="indent" >   Первый элемент формы является списком нуля и более спецификаторов
переменных-индексов. Каждый спецификатор является списком из имени
переменной <i>var</i>, первоначального значения <i>init</i>, и форма приращения <i>step</i>.
Если <i>init</i> опущен, используется первоначальное значение <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>. Если <i>step</i>
опущен, <i>var</i> не изменяется на итерациях цикла (но может изменяться в теле
цикла с помощью формы <tt><a 
href="clmli7.html#x196-3479841r841">setq</a></tt>).
<!--l. 7044--><p class="indent" >   Спецификатор переменной-индекса может также быть просто именем
переменной. В этом случае переменная будет иметь первоначальное
значение <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt> и не будет изменяться при итерациях цикла. В целях стиля,
использовать просто имя переменной рекомендуется, только если
                                                                          

                                                                          
перед первым использованием для неё устанавливается значение с
помощью <tt><a 
href="clmli7.html#x196-3479841r841">setq</a></tt>. Если необходимо чтобы первоначальное значение
было <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>, а не неопределённое, то лучше указывать это явно, если
нужна ложь так: <tt>(<i>varj</i> <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>)</tt> или если нужен пустой список так: <tt>(<i>varj</i>
&#x2019;())</tt>.
<!--l. 7055--><p class="indent" >   Перед первой итерацией вычисляются все формы <i>init</i>, и каждая
переменная <i>var</i> связывается с соответствующим результатом вычислений
<i>init</i>. Используется именно связывание, а не присвоение. Когда цикл
завершается, старые значения этих переменных восстанавливаются. Для <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>,
<i>все</i> формы <i>init</i> вычисляется перед тем, как будут связаны переменные <i>var</i>.
Таким образом все формы могут ссылаться на старые связывания этих
переменных (то есть на значения, которые были видимы до начала
выполнения конструкции <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>). Для <tt><a 
href="clmli7.html#x196-3479340r340">do*</a></tt> вычисляется первая форма <i>init</i>, затем
первая переменная связывается с результатом этих вычислений. Затем
вычисляется вторая форма <i>init</i> и вторая переменная <i>var</i> связывается с этим
значением, и так далее. В целом, форма <i>initj</i> может ссылаться на <i>новые</i>
связывания <i>vark</i>, если <span class="math">k &#x003C; j</span>, иначе ссылка происходит на <i>старое</i>
связывание.
<!--l. 7071--><p class="indent" >   Второй элемент конструкции цикла это список из формы предиката-выхода
<i>end-test</i> и нуля и более форм результата <i>result</i>. Этот элемент напоминает
подвыражение <tt><a 
href="clmli7.html#x196-3479273r273">cond</a></tt>. В начале каждой итерации, после обработки всех
переменных, вычисляется форма <i>end-test</i>. Если результат <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>, выполняется
тело формы <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> (или <tt><a 
href="clmli7.html#x196-3479340r340">do*</a></tt>). Если результат не <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>, последовательно
вычисляются формы <i>result</i>, как неявный <tt><a 
href="clmli7.html#x196-3479745r745">progn</a></tt>, и затем <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> возвращает
управление. <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> возвращает результаты вычисления последней формы <i>result</i>.
Если таких форм не быть, значением <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> становиться <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>. Следует отметить,
что аналогия с подвыражениями <tt><a 
href="clmli7.html#x196-3479273r273">cond</a></tt> не полная, так как <tt><a 
href="clmli7.html#x196-3479273r273">cond</a></tt> в этом случае
возвращает результат формы условия.
<!--l. 7085--><p class="indent" >   Переменные-индексы изменяются в начале каждой непервой итерации
так, как написано далее. Слева направо вычисляются все формы <i>step</i>, и
затем результаты присваиваются переменным-индексам. Если такой формы
<i>step</i> для переменной указано не было, то переменная и не изменяется. Для
<tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>, все формы <i>step</i> вычисляются перед там, как будут изменены переменные.
Присваивания переменным осуществляются параллельно, как в <tt><a 
href="clmli7.html#x196-3479750r750">psetq</a></tt>. Так
как <i>все</i> формы <i>step</i> вычисляются перед тем, как будет изменена хоть одна
переменных, форма <i>step</i> при вычислении всегда ссылается на старые
значения <i>всех</i> переменных-индексов, даже если другие формы <i>step</i>
были выполнены. Для <tt><a 
href="clmli7.html#x196-3479340r340">do*</a></tt>, вычисляется первая форма <i>step</i>, затем
                                                                          

                                                                          
полученное значение присваивается первой переменной-индексом, затем
вычисляется вторая форма <i>step</i>, и полученное значение присваивается второй
переменной, и так далее. Присваивание происходит последовательно, как в
<tt><a 
href="clmli7.html#x196-3479841r841">setq</a></tt>. И для <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>, и для <tt><a 
href="clmli7.html#x196-3479340r340">do*</a></tt> после того как переменные были изменены,
вычисляется <i>end-test</i> так, как уже было описано выше. Затем продолжаются
итерации.
<!--l. 7105--><p class="indent" >   Если <i>end-test</i> формы <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> равен <tt><tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt></tt>, тогда предикат всегда ложен. Таким
образом получается «бесконечный цикл»: тело <i>body</i> <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> выполняется
циклично, переменные-индексы изменяются как обычно. (Конструкция <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt>
также является «бесконечным циклом», только без переменных-индексов.)
Бесконечный цикл может быть остановлен использованием <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt>,
<tt><a 
href="clmli7.html#x196-3479799r799">return-from</a></tt>, <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> на более высокий уровень или <tt>throw</tt>. Например:
<div class="lisp"><div class="tabbing">
(do ((j 0 (+ j 1)))
   <br>                       (<tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>)                        ;Выполнять вечно<br>
  (format t &#x0022;~%Input ~D:&#x0022; j)<br>                          (let ((item (read)))<br>
    (if (null item) (return)     ;Обрабатывать элементы пока не найден <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt><br>
        (format t &#x0022;~&#x0026;Output ~D: ~S&#x0022; j (process item)))))<br>
<!--l. 7121--><p class="noindent" ></div>
<!--l. 7121--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6540007.8.2" id="x54-6540007.8.2"></a></span>
<!--l. 7121--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6550007.8.2" id="x54-6550007.8.2"></a></span>
</div>
<!--l. 7123--><p class="indent" >   Оставшаяся часть <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> оборачивается в неявный <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>. Теги могут
использоваться внутри тела цикла <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> для того, чтобы затем использовать
выражения <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>. На такие выражения <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> не могут использоваться в
спецификаторах переменных-индексов, в предикате <i>end-test</i> и в формах
результата <i>result</i>. Когда управление достигает конца тела цикла <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>,
наступает следующая цикл итерации (начинающийся с вычисления форм
<i>step</i>).
<!--l. 7131--><p class="indent" >   Неявный <tt><a 
href="clmli7.html#x196-3479135r135">block</a></tt> с именем <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt> окружает всю форму <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>. Выражение <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt>
может использоваться в любом месте для немедленного выхода из
цикла.
                                                                          

                                                                          
<!--l. 7135--><p class="indent" >   Формы <tt><a 
href="clmli7.html#x196-3479300r300">declare</a></tt> могут использоваться в начала тела <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>. Они применяются
к коду внутри тела <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>, для связываний переменных-индексов, для форм
<i>init</i>, для форм <i>step</i>, для предиката <i>end-test</i> и для форм результата
<i>result</i>.
<!--l. 7140--><p class="indent" >   Вот парочка примеров использования <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>: <div class="lisp"><div class="tabbing">
(do ((i 0 (+ i 1))     ;Sets every null element of <tt>a-vector</tt> to zero
   <br>                                                                (n (length a-vector)))<br>
    ((= i n))<br>                                (when (null (aref a-vector i))<br>
    (setf (aref a-vector i) 0)))<br>
<!--l. 7147--><p class="noindent" ></div>
<!--l. 7147--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6560007.8.2" id="x54-6560007.8.2"></a></span>
<!--l. 7147--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6570007.8.2" id="x54-6570007.8.2"></a></span>
</div>
<!--l. 7148--><p class="indent" >   Конструкция <div class="lisp"><div class="tabbing">
(do ((x e (cdr x))
   <br>                                (oldx x x))<br>                               ((null x))<br>
  <i>body</i>)<br>
<!--l. 7154--><p class="noindent" ></div>
<!--l. 7154--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6580007.8.2" id="x54-6580007.8.2"></a></span>
<!--l. 7154--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6590007.8.2" id="x54-6590007.8.2"></a></span>
</div>
<!--l. 7155--><p class="indent" >   использует параллельное присваивание переменным-индексам. На первой
итерации значение <tt>oldx</tt> получает значение <tt>x</tt>, которое было до входа в цикл.
При выходе из цикла <tt>oldx</tt> будет содержать значение <tt>x</tt>, которое было на
предыдущей итерации.
                                                                          

                                                                          
<!--l. 7160--><p class="indent" >   Очень часто алгоритм цикла может быть по большей части выражен в
формах <i>step</i> и тело при этом останется пустым. Например, <div class="lisp"><div class="tabbing">
(do ((x foo (cdr x))
   <br>                                                                         (y bar (cdr y))<br>
     (z &#x2019;() (cons (f (car x) (car y)) z)))<br>              ((or (null x) (null y))<br>
     (nreverse z)))<br>
<!--l. 7169--><p class="noindent" ></div>
<!--l. 7169--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6600007.8.2" id="x54-6600007.8.2"></a></span>
<!--l. 7169--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6610007.8.2" id="x54-6610007.8.2"></a></span>
</div>
<!--l. 7170--><p class="indent" >   делает то же, что и <tt>(mapcar #&#x2019;f foo bar)</tt>. Следует отметить, что
вычисление <i>step</i> для <tt>z</tt> использует тот факт, что переменные переприсваиваются
параллельно. Тело функции пустое. Наконец, использование <tt><a 
href="clmli7.html#x196-3479660r660">nreverse</a></tt> в
форме возврата результата, переставляет элементы списка для правильного
результата. Другой пример: <div class="lisp"><div class="tabbing">
(defun list-reverse (list)
   <br>           (do ((x list (cdr x))<br>                (y &#x2019;() (cons (car x) y)))<br>
           ((endp x) y)))<br>
<!--l. 7181--><p class="noindent" ></div>
<!--l. 7181--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6620007.8.2" id="x54-6620007.8.2"></a></span>
<!--l. 7181--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6630007.8.2" id="x54-6630007.8.2"></a></span>
</div>
<!--l. 7182--><p class="indent" >   Нужно заметить, что используется <tt><a 
href="clmli7.html#x196-3479363r363">endp</a></tt> вместо <tt><a 
href="clmli7.html#x196-3479676r676">null</a></tt> или <tt><a 
href="clmli7.html#x196-3479120r120">atom</a></tt> для
проверки конца списка. Это даёт более надёжный алгоритм.
                                                                          

                                                                          
<!--l. 7185--><p class="indent" >   В качестве примера вложенных циклов, предположим что <tt>env</tt> содержит
список cons-ячеек. <i>car</i> элемента каждой cons-ячейки является списком
символов, и <i>cdr</i> каждой cons-ячейки является списком такой же длины с
соответствующими значениями. Такая структура данных похожа на
ассоциативный список, но она в отличие разделена на «кадры». Общая
структура напоминает грудную клетку. Функция поиска по такой структуре
может быть такой: <div class="lisp"><div class="tabbing">
(defun ribcage-lookup (sym ribcage)
   <br>                (do ((r ribcage (cdr r)))<br>                    ((null r) <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>)<br>
         (do ((s (caar r) (cdr s))<br>                   (v (cdar r) (cdr v)))<br>
             ((null s))<br>                          (when (eq (car s) sym)<br>
             (return-from ribcage-lookup (car v))))))<br>
<!--l. 7202--><p class="noindent" ></div>
<!--l. 7202--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6640007.8.2" id="x54-6640007.8.2"></a></span>
<!--l. 7202--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6650007.8.2" id="x54-6650007.8.2"></a></span>
</div>
<!--l. 7203--><p class="indent" >   (Примечание, использование отступов в примере выше выделяет тела
вложенных циклов.)
<!--l. 7206--><p class="indent" >   Цикл <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> может быть выражен в терминах более примитивных
конструкций <tt><a 
href="clmli7.html#x196-3479135r135">block</a></tt>, <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt>, <tt><a 
href="clmli7.html#x196-3479524r524">let</a></tt>, <tt><a 
href="clmli7.html#x196-3479558r558">loop</a></tt>, <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt> и <tt><a 
href="clmli7.html#x196-3479750r750">psetq</a></tt>: <div class="lisp"><div class="tabbing">
(block nil
   <br>                      (let ((<i>var1</i> <i>init1</i>)<br>                            (<i>var2</i> <i>init2</i>)<br>
        ...<br>                                                 (<i>varn</i> <i>initn</i>))<br>
     {<i><i>declaration</i></i>}* <br>          (loop (when <i>end-test</i> (return (progn . <i>result</i>)))<br>
          (tagbody . <i>tagbody</i>)<br>                        (psetq <i>var1</i> <i>step1</i><br>
                 <i>var2</i> <i>step2</i><br>                                       ...<br>
                 <i>varn</i> <i>stepn</i>))))<br>
<!--l. 7222--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 7222--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6660007.8.2" id="x54-6660007.8.2"></a></span>
<!--l. 7222--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6670007.8.2" id="x54-6670007.8.2"></a></span>
</div>
<tt>
<!--l. 7223--><p class="indent" >   <a 
href="clmli7.html#x196-3479340r340">do*</a></tt> почти то же, что и <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> за исключением того, что связывание и
наращение переменных происходит последовательно, а не параллельно.
Таким образом, в вышеприведённой конструкции, <tt><a 
href="clmli7.html#x196-3479524r524">let</a></tt> будет заменена на <tt><a 
href="clmli7.html#x196-3479525r525">let*</a></tt>
и <tt><a 
href="clmli7.html#x196-3479750r750">psetq</a></tt> на <tt><a 
href="clmli7.html#x196-3479841r841">setq</a></tt>.
</div>
<!--l. 7229--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.3   </span> <a 
href="clmli1.html#QQ2-54-676" id="x54-6680007.8.3">Простые формы циклов</a></h4>
<!--l. 7231--><p class="noindent" >Конструкции <tt><a 
href="clmli7.html#x196-3479346r346">dolist</a></tt> и <tt><a 
href="clmli7.html#x196-3479347r347">dotimes</a></tt> для каждого значения взятого для одной
переменной выполняют тело один раз. Они хоть и выражаются в терминах
<tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>, но захватывают очень простые шаблоны использования.
<!--l. 7235--><p class="indent" >   И <tt><a 
href="clmli7.html#x196-3479346r346">dolist</a></tt> и <tt><a 
href="clmli7.html#x196-3479347r347">dotimes</a></tt> циклично выполняют тело. На каждой итерации
заданная переменная связывается с элементом, которая затем может
использоваться в теле. <tt><a 
href="clmli7.html#x196-3479346r346">dolist</a></tt> использует элементы списка, и <tt><a 
href="clmli7.html#x196-3479347r347">dotimes</a></tt>
использует целые числа от 0 по <span class="math">n− 1</span>, при некотором указанном положительном
целом <i>n</i>.
<!--l. 7240--><p class="indent" >   Результат двух этих конструкций может быть указан с помощью
необязательной формы результата. Если эта форма опущена результат равен
<tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>.
<!--l. 7243--><p class="indent" >   Выражение <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> может быть использовано для немедленного возврата
из форм <tt><a 
href="clmli7.html#x196-3479346r346">dolist</a></tt> или <tt><a 
href="clmli7.html#x196-3479347r347">dotimes</a></tt>, игнорируя все оставшиеся итерации, которые
должны были быть выполнены. <tt><a 
href="clmli7.html#x196-3479135r135">block</a></tt> с именем <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt> окружает конструкцию.
Тело цикла неявно обернуто конструкцией <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>. Таким образом тело
может содержать теги и <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> выражения. Декларации могут быть указаны
перед телом цикла.
<div class="defmac">
<div class="defmacheader">
<!--l. 7251--><p class="indent" >   <div class="tabbing">
                                                                          

                                                                          
 <i>[Макрос]</i><b> dolist </b> <a 
 id="dx54-668001"></a><a 
 id="x54-668002r99"></a> (var listform [resultform])
   <br>                                                 {declaration}* {tag | statement}*<br>
<!--l. 7253--><p class="noindent" ></div>
<!--l. 7253--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6690007.8.3" id="x54-6690007.8.3"></a></span>
</div>
<tt>
<!--l. 7254--><p class="indent" >   <a 
href="clmli7.html#x196-3479346r346">dolist</a></tt> предоставляет прямой цикл по списку элементов. Сначала <tt><a 
href="clmli7.html#x196-3479346r346">dolist</a></tt>
вычисляет форму <i>listform</i>, которая должна вернуть список. Затем для
каждого элемента вычисляется тело цикла. Данный элемент на каждой
итерации связывается с переменной <i>var</i>. Затем вычисляется <i>resultform</i> (одна
форма, <i>не</i> неявный <tt><a 
href="clmli7.html#x196-3479745r745">progn</a></tt>). (Когда вычисляется <i>resultform</i>, переменная <i>var</i>
все ещё связана, и имеет значение <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>.) Если <i>resultform</i> опущена, то
результат равен <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>. <div class="lisp"><div class="tabbing">
(dolist (x &#x2019;(a b c d)) (prin1 x) (princ &#x0022; &#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>
   <br>                  вывод «<tt>a b c d </tt>» (в том числе пробел в конце)<br>
<!--l. 7266--><p class="noindent" ></div>
<!--l. 7266--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6700007.8.3" id="x54-6700007.8.3"></a></span>
<!--l. 7266--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6710007.8.3" id="x54-6710007.8.3"></a></span>
</div>
<!--l. 7267--><p class="indent" >   Для завершения цикла и возврата заданного значения может использоваться
явное выражение <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt>.
</div>
<div class="defmac">
<div class="defmacheader">
<!--l. 7272--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i><b> dotimes </b> <a 
 id="dx54-671001"></a><a 
 id="x54-671002r100"></a> (var countform [resultform])
   <br>                                                 {declaration}* {tag | statement}*<br>
<!--l. 7274--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 7274--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6720007.8.3" id="x54-6720007.8.3"></a></span>
</div>
<tt>
<!--l. 7275--><p class="indent" >   <a 
href="clmli7.html#x196-3479347r347">dotimes</a></tt> предоставляет цикл над последовательностью целых чисел.
Выражение <tt>(dotimes (<i>var</i> <i>countform</i> <i>resultform</i>) . <i>progbody</i>)</tt>
вычисляет форму <i>countform</i>, которая должна вернуть целое число. Затем
тело цикла выполняется по порядку один раз для каждого число
от нуля (включительно) до <i>count</i> (исключая). При этом переменная
<i>var</i> связывается с текущим целым числом. Если значение <i>countform</i>
отрицательно или равно нулю, тогда <i>progbody</i> не выполняется ни разу.
Наконец выполняется <i>resultform</i> (одна форма, <i>не</i> неявный <tt><a 
href="clmli7.html#x196-3479745r745">progn</a></tt>), и
полученный результат возвращается из формы цикла. (Когда <i>result</i>
вычисляется, переменная-индекс <i>var</i> все ещё связана и содержит количество
выполненных итераций.) Если <i>resultform</i> опущена, то результат равен
<tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>.
<!--l. 7289--><p class="indent" >   Для завершения цикла и возврата заданного значения может использоваться
выражение <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt>.
<!--l. 7292--><p class="indent" >   Пример использования <tt><a 
href="clmli7.html#x196-3479347r347">dotimes</a></tt> для обработки строк: <div class="lisp"><div class="tabbing">
;;; True if the speciﬁed subsequence of the string is a
   <br>                     ;;; palindrome (reads the same forwards and backwards).<br>
<br>                                     (defun palindromep (string <tt>&#x0026;optional</tt><br>
                           (start 0)<br>
                           (end (length string)))<br>
  (dotimes (k (ﬂoor (- end start) 2) <tt><a 
href="clmli7.html#x196-3479935r935">t</a></tt>)<br>
    (unless (char-equal (char string (+ start k))<br>
                        (char string (- end k 1)))<br>
      (return <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>))))<br>  <br>   (palindromep &#x0022;Able was I ere I saw Elba&#x0022;) <span class="math"> ⇒</span> <tt><a 
href="clmli7.html#x196-3479935r935">t</a></tt><br>
<br>                 (palindromep &#x0022;A man, a plan, a canal–Panama!&#x0022;) <span class="math"> ⇒</span> <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt><br>
<br>          (remove-if-not #&#x2019;alpha-char-p     ;Удалить знаки препинания<br>
               &#x0022;A man, a plan, a canal–Panama!&#x0022;)<br>
   <span class="math"> ⇒</span> &#x0022;AmanaplanacanalPanama&#x0022;<br>                                       <br>
(palindromep<br>                                (remove-if-not #&#x2019;alpha-char-p<br>
                &#x0022;A man, a plan, a canal–Panama!&#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="clmli7.html#x196-3479935r935">t</a></tt><br><br>(palindromep<br>
 (remove-if-not<br>                                            #&#x2019;alpha-char-p<br>
   &#x0022;Unremarkable was I ere I saw Elba Kramer, nu?&#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="clmli7.html#x196-3479935r935">t</a></tt><br>             <br>
                                                                          

                                                                          
(palindromep<br>                                               (remove-if-not<br>
   #&#x2019;alpha-char-p<br>                   &#x0022;A man, a plan, a cat, a ham, a yak,<br>
                   a yam, a hat, a canal–Panama!&#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="clmli7.html#x196-3479935r935">t</a></tt><br>
(palindromep<br>               (remove-if-not<br>                 #&#x2019;alpha-char-p<br>
   &#x0022;Ja-da, ja-da, ja-da ja-da jing jing jing&#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt><br>
<!--l. 7332--><p class="noindent" ></div>
<!--l. 7332--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6730007.8.3" id="x54-6730007.8.3"></a></span>
<!--l. 7332--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6740007.8.3" id="x54-6740007.8.3"></a></span>
</div>
<!--l. 7334--><p class="indent" >   Изменение значения переменной <i>var</i> в теле цикла (с помощью <tt><a 
href="clmli7.html#x196-3479841r841">setq</a></tt>
например) будет иметь непредсказуемые последствия, возможно зависящие
от реализации. Компилятор Common Lisp&#x2019;а может вывести предупреждение о
том, что переменная-индекс используется в <tt><a 
href="clmli7.html#x196-3479841r841">setq</a></tt>.
</div>
<!--l. 7340--><p class="indent" >   Смотрите также <tt><a 
href="clmli7.html#x196-3479343r343">do-symbols</a></tt>, <tt><a 
href="clmli7.html#x196-3479342r342">do-external-symbols</a></tt> и <tt><a 
href="clmli7.html#x196-3479341r341">do-all-symbols</a></tt>.
<!--l. 7343--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.4   </span> <a 
href="clmli1.html#QQ2-54-683" id="x54-6750007.8.4">Отображение</a></h4>
<a 
 id="dx54-675001"></a>
<!--l. 7346--><p class="noindent" >Отображение — это тип цикла, в котором заданная функция применяется к
частям одной или более последовательностей. Результатом цикла является
последовательность, полученная из результатов выполнения это функции.
Существует несколько опции для указания того, какие части списка будут
использоваться в цикле, и что будет происходить с результатом применения
функции.
<!--l. 7353--><p class="indent" >   Функция <tt><a 
href="clmli7.html#x196-3479592r592">map</a></tt> может быть использована для отображения любого
типа последовательности. Следующие же функции оперируют только
списками.
<div class="defun">
<!--l. 7357--><p class="noindent" ><div class="defunheader"> <i>[Функция]</i><a 
 id="dx54-675002"></a><a 
 id="x54-675003r101"></a><b> mapcar</b>  <i>function</i> <i>list</i> &#x0026;rest  <i>more-lists</i><br 
class="newline" /><i>[Функция]</i><a 
 id="dx54-675004"></a><a 
 id="x54-675005r102"></a><b> maplist</b>  <i>function</i> <i>list</i> &#x0026;rest  <i>more-lists</i><br 
class="newline" /><i>[Функция]</i><a 
 id="dx54-675006"></a><a 
 id="x54-675007r103"></a><b> mapc</b>  <i>function</i> <i>list</i> &#x0026;rest  <i>more-lists</i><br 
class="newline" /><i>[Функция]</i><a 
 id="dx54-675008"></a><a 
 id="x54-675009r104"></a><b> mapl</b>  <i>function</i> <i>list</i> &#x0026;rest  <i>more-lists</i><br 
class="newline" /><i>[Функция]</i><a 
 id="dx54-675010"></a><a 
 id="x54-675011r105"></a><b> mapcan</b>  <i>function</i> <i>list</i> &#x0026;rest  <i>more-lists</i><br 
class="newline" /><i>[Функция]</i><a 
 id="dx54-675012"></a><a 
 id="x54-675013r106"></a><b> mapcon</b>  <i>function</i> <i>list</i> &#x0026;rest  <i>more-lists</i>
</div>
<!--l. 7364--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6760007.8.4" id="x54-6760007.8.4"></a></span>
   Для каждой из этих функций отображения, первый аргумент является
функцией и оставшиеся аргументы должны быть списками. Функция в
первом аргументе должно принимать столько аргументов, сколько было
передано списков в функцию отображения.
<tt>
<!--l. 7370--><p class="indent" >   <a 
href="clmli7.html#x196-3479597r597">mapcar</a></tt> последовательно обрабатывает элементы списков. Сначала
функция применяется к <i>car</i> элементу каждого списка, затем к <i>cadr</i> элементу,
и так далее. (Лучше всего, чтобы все переданные списки имели одинаковую
длину. Если это не так, то цикл завершиться, как только закончится самый
короткий список, и все оставшиеся элементы в других списках будут
проигнорированы.) Значение, возвращаемое <tt><a 
href="clmli7.html#x196-3479597r597">mapcar</a></tt>, является списком
результатов последовательных вызовов функции из первого параметра.
Например: <div class="lisp"><div class="tabbing">
(mapcar #&#x2019;abs &#x2019;(3 -4 2 -5 -6)) <span class="math"> ⇒</span> (3 4 2 5 6)
   <br>                (mapcar #&#x2019;cons &#x2019;(a b c) &#x2019;(1 2 3)) <span class="math"> ⇒</span> ((a . 1) (b . 2) (c . 3))<br>
<!--l. 7382--><p class="noindent" ></div>
<!--l. 7382--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6770007.8.4" id="x54-6770007.8.4"></a></span>
<!--l. 7382--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6780007.8.4" id="x54-6780007.8.4"></a></span>
</div>
<tt>
<!--l. 7384--><p class="indent" >   <a 
href="clmli7.html#x196-3479601r601">maplist</a></tt> похожа на <tt><a 
href="clmli7.html#x196-3479597r597">mapcar</a></tt> за исключением того, что функция
применяется к спискам и последующим <i>cdr</i> элементам этих списков, а не
последовательно к элементам спискам. Например: <div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(maplist #&#x2019;(lambda (x) (cons &#x2019;foo x))
   <br>                                                                            &#x2019;(a b c d))<br>
   <span class="math"> ⇒</span> ((foo a b c d) (foo b c d) (foo c d) (foo d))<br>
<!--l. 7392--><p class="noindent" ></div>
<!--l. 7392--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6790007.8.4" id="x54-6790007.8.4"></a></span>
<!--l. 7392--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6800007.8.4" id="x54-6800007.8.4"></a></span>
</div>
<div class="lisp">
<!--l. 7394--><p class="indent" >   <div class="tabbing">
(maplist #&#x2019;(lambda (x) (if (member (car x) (cdr x)) 0 1)))
   <br>                        &#x2019;(a b a c d b c))<br>                  <span class="math"> ⇒</span> (0 0 1 0 1 1 1)<br>
   ;Возвращается <tt>1</tt>, если соответствующий элемент входящего списка<br>
   ;  появлялся последний раз в данном списке.<br>
<!--l. 7400--><p class="noindent" ></div>
<!--l. 7400--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6810007.8.4" id="x54-6810007.8.4"></a></span>
<!--l. 7400--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6820007.8.4" id="x54-6820007.8.4"></a></span>
</div>
<tt>
<!--l. 7402--><p class="indent" >   <a 
href="clmli7.html#x196-3479600r600">mapl</a></tt> и <tt><a 
href="clmli7.html#x196-3479595r595">mapc</a></tt> похожи на <tt><a 
href="clmli7.html#x196-3479601r601">maplist</a></tt> и <tt><a 
href="clmli7.html#x196-3479597r597">mapcar</a></tt>, соответственно, за исключением
того, что они не накапливают результаты вызова функций.
<!--l. 7405--><p class="indent" >   Эти функции используются, когда функция в первом параметре
предназначена для побочных эффектов, а не для возвращаемого значения.
Значение возвращаемое <tt><a 
href="clmli7.html#x196-3479600r600">mapl</a></tt> или <tt><a 
href="clmli7.html#x196-3479595r595">mapc</a></tt> является вторым аргументом, то есть
первой последовательностью для отображения.
<tt>
<!--l. 7410--><p class="indent" >   <a 
href="clmli7.html#x196-3479596r596">mapcan</a></tt> и <tt><a 
href="clmli7.html#x196-3479598r598">mapcon</a></tt> похожи на <tt><a 
href="clmli7.html#x196-3479597r597">mapcar</a></tt> и <tt><a 
href="clmli7.html#x196-3479601r601">maplist</a></tt> соответственно, за
исключением того, что результат создаётся с помощью функции <tt><a 
href="clmli7.html#x196-3479644r644">nconc</a></tt>, а не
<tt><a 
href="clmli7.html#x196-3479528r528">list</a></tt>. То есть, <div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(mapcon <i>f </i> <i>x1</i> ... <i>xn</i>)
   <br>                                       <span class="math"> ≡</span> (apply #&#x2019;nconc (maplist <i>f </i> <i>x1</i> ... <i>xn</i>))<br>
<!--l. 7416--><p class="noindent" ></div>
<!--l. 7416--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6830007.8.4" id="x54-6830007.8.4"></a></span>
<!--l. 7416--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6840007.8.4" id="x54-6840007.8.4"></a></span>
</div>
<!--l. 7417--><p class="indent" >   Такое же различие между <tt><a 
href="clmli7.html#x196-3479596r596">mapcan</a></tt> и <tt><a 
href="clmli7.html#x196-3479597r597">mapcar</a></tt>. Концептуально, эти функции
позволяют функции отображения возвращать переменное количество
элементов. Таким образом длина результата может быть не равна длине
входного списка. Это, в частности, полезно для возврата нуля или одного
элемента: <div class="lisp"><div class="tabbing">
(mapcan #&#x2019;(lambda (x) (and (numberp x) (list x)))
   <br>                                                                   &#x2019;(a 1 b c 3 4 d 5))<br>
   <span class="math"> ⇒</span> (1 3 4 5)<br>
<!--l. 7426--><p class="noindent" ></div>
<!--l. 7426--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6850007.8.4" id="x54-6850007.8.4"></a></span>
<!--l. 7426--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6860007.8.4" id="x54-6860007.8.4"></a></span>
</div>
<!--l. 7427--><p class="indent" >   В этом случае функция действует, как фильтр. Это стандартная
Lisp&#x2019;овая идиома использования <tt><a 
href="clmli7.html#x196-3479596r596">mapcan</a></tt>. (Однако, в этом контексте
функция <tt><a 
href="clmli7.html#x196-3479785r785">remove-if-not</a></tt> также может быть полезна.) Помните, что <tt><a 
href="clmli7.html#x196-3479644r644">nconc</a></tt>
деструктивная операция, следовательно и <tt><a 
href="clmli7.html#x196-3479596r596">mapcan</a></tt> и <tt><a 
href="clmli7.html#x196-3479598r598">mapcon</a></tt> также
деструктивны. Список возвращаемый функцией <i>function</i> изменяется для
соединения и возврата результата.
                                                                          

                                                                          
<!--l. 7434--><p class="indent" >   Иногда <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt> или прямая последовательная рекурсия удобнее, чем функции
отображения. Однако, функции отображения должны быть использованы
везде, где они действительно необходимы, так как они увеличивают ясность
кода.
<!--l. 7438--><p class="indent" >   Функциональный аргумент функции отображения должен быть
подходящим для функции <tt><a 
href="clmli7.html#x196-3479088r88">apply</a></tt>. Он не может быть макросов или
именем специальной формы. Кроме того, в качестве функционального
аргумента можно использовать функцию, имеющую <tt>&#x0026;optional</tt> и <tt>&#x0026;rest</tt>
параметры.
</div>
<!--l. 7444--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.5   </span> <a 
href="clmli1.html#QQ2-54-695" id="x54-6870007.8.5">Использование «GOTO»</a></h4>
<!--l. 7446--><p class="noindent" >Реализации Lisp&#x2019;а начиная с Lisp&#x2019;а 1.5 содержат то, что изначально
называлось «the program feature», как будто без этого невозможно писать
программы! Конструкция <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt> позволяет писать в Algol- или Fortran-
императивном стиле, используя выражения <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>, которые могут ссылаться на
теги в теле <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt>. Современный стиль программирования на Lisp&#x2019;е стремится
снизить использование <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt>. Различные конструкции циклов, как <tt><a 
href="clmli7.html#x196-3479339r339">do</a></tt>, имеют
тела с характеристиками <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt>. (Тем не менее, возможность использовать
выражения <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> внутри конструкции цикла очень редко используется на
практике.)
<tt>
<!--l. 7456--><p class="indent" >   <a 
href="clmli7.html#x196-3479741r741">prog</a></tt> предоставляет три различные операции: связывание локальный
переменных, использование выражения <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> и использование выражения
<tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>. В Common Lisp&#x2019;е эти три операции были разделены на три конструкции:
<tt><a 
href="clmli7.html#x196-3479524r524">let</a></tt>, <tt><a 
href="clmli7.html#x196-3479135r135">block</a></tt> и <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>. Эти три конструкции могут использоваться
независимо, как строительные кирпичики для других типов конструкций.
<div class="defspec">
<div class="defmacheader">
<!--l. 7466--><p class="indent" >   <div class="tabbing">
 <i>[Специальный оператор]</i><b> tagbody </b> <a 
 id="dx54-687001"></a><a 
 id="x54-687002r107"></a> {tag | statement}*
   <br>
<!--l. 7467--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 7467--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6880007.8.5" id="x54-6880007.8.5"></a></span>
</div>
<!--l. 7468--><p class="indent" >   Часть <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt> после списка переменные называется <i>телом</i>. Элемент тела
может быть символов или целым числом, и называться в этом случае <i>тег</i>.
Также элемент тела может быть списком, и называться в этом случае
<i>выражением</i>.
<!--l. 7473--><p class="indent" >   Каждый элемент тела обрабатывается слева направо. <i>Теги</i> игнорируются.
<i>Выражения</i> вычисляются и их результаты игнорируются. Если управление
достигает конца тела, <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt> возвращает <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>.
<!--l. 7478--><p class="indent" >   Если вычисляется форма <tt>(go <i>tag</i>)</tt>, управление перемещается на часть
тела, обозначенную <i>тегом</i>.
<!--l. 7481--><p class="indent" >   Область видимости тегов, устанавливаемых в <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>, является
лексической. Продолжительность видимости тегов динамическая. Когда
управление вышло из конструкции <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>, ссылка <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> на теги в её теле
невозможны. Существует возможность для <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> прыжка в <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>,
которая не находится внутри конструкции <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>, которая и содержала
этот <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>. То есть возможны прыжки в родительский <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>. Теги
устанавливаемые <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt> будут только скрывать другие одноимённые
теги.
<!--l. 7490--><p class="indent" >   Лексическая область видимости для тегов (целей <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>) полностью
полноправно и последствия могут быть сюрпризом для пользователей и
разработчиков других Lisp систем. Например, <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> в следующем примере,
работает в Common Lisp так, как это и ожидается: <div class="lisp"><div class="tabbing">
(tagbody
   <br>         (catch &#x2019;stuﬀ<br>            (mapcar #&#x2019;(lambda (x) (if (numberp x)<br>
                                (hairyfun x)<br>
                                (go lose)))<br>                 items))<br>
   (return)<br>                                                           lose<br>
   (error &#x0022;I lost big!&#x0022;))<br>
<!--l. 7505--><p class="noindent" ></div>
<!--l. 7505--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6890007.8.5" id="x54-6890007.8.5"></a></span>
                                                                          

                                                                          
<!--l. 7505--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6900007.8.5" id="x54-6900007.8.5"></a></span>
</div>
<!--l. 7506--><p class="indent" >   В зависимости от ситуации, <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> в Common Lisp&#x2019;е не обязательно похож на
простую машинную инструкцию «jump». Если необходимо, <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> может
перепрыгивать ловушки исключений. Возможно так, что «замыкание»,
созданное с помощью <tt><a 
href="clmli7.html#x196-3479430r430">function</a></tt>, для лямбда-выражения ссылается на тег
(цель <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>) так долго, сколько лексически доступен данный тег. Смотрите <a 
href="clmch3.html#x25-1250003">3<!--tex4ht:ref: SCOPE --></a>
для понимания этого примера.
</div>
<div class="defmac">
<div class="defmacheader">
<!--l. 7515--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i><b> prog </b> <a 
 id="dx54-690001"></a><a 
 id="x54-690002r108"></a> ({var | (var [init])}*) {declaration}* {tag | statement}*
   <br>
<!--l. 7515--><p class="noindent" ></div>
<!--l. 7515--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6910007.8.5" id="x54-6910007.8.5"></a></span>
</div>
<div class="defmacheader">
<!--l. 7515--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i><b> prog* </b> <a 
 id="dx54-691001"></a><a 
 id="x54-691002r109"></a> ({var | (var [init])}*) {declaration}* {tag | statement}*
   <br>
<!--l. 7517--><p class="noindent" ></div>
<!--l. 7517--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6920007.8.5" id="x54-6920007.8.5"></a></span>
</div>
<!--l. 7518--><p class="indent" >   Конструкция <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt> является синтезом <tt><a 
href="clmli7.html#x196-3479524r524">let</a></tt>, <tt><a 
href="clmli7.html#x196-3479135r135">block</a></tt> и <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>, позволяющая
связывать переменные, использовать <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> и <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> в одной конструкции.
Обычно конструкция <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt> выглядит так: <div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(prog (<i>var1</i> <i>var2</i> (<i>var3</i> <i>init3</i>) <i>var4</i> (<i>var5</i> <i>init5</i>))
   <br>                                                                         {<i><i>declaration</i></i>}* <br>
      <i>statement1</i><br>                                                    <i>tag1</i><br>
      <i>statement2</i><br>                                            <i>statement3</i><br>
      <i>statement4</i><br>                                                    <i>tag2</i><br>
      <i>statement5</i><br>                                                     ...<br>
      )<br>
<!--l. 7533--><p class="noindent" ></div>
<!--l. 7533--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6930007.8.5" id="x54-6930007.8.5"></a></span>
<!--l. 7533--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6940007.8.5" id="x54-6940007.8.5"></a></span>
</div>
<!--l. 7534--><p class="indent" >   Список после ключевого символа <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt> является множеством
спецификаторов для связывания переменных <i>var1</i>, <i>var2</i>. Этот список
обрабатывается так же, как и в выражении <tt><a 
href="clmli7.html#x196-3479524r524">let</a></tt>: сначала слева направо
выполняются все формы <i>init</i> (если формы нет, берётся значение <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>), и затем
переменные параллельно связываются с полученными ранее значениями.
Возможно использовать <i>декларации</i> в начале дела <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt> так же, как и в
<tt><a 
href="clmli7.html#x196-3479524r524">let</a></tt>.
<!--l. 7543--><p class="indent" >   Тело <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt> выполняется, как обернутое в <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>. Таким образом, для
перемещения управления к <i>тегу</i> могут использоваться выражения
<tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>.
<tt>
<!--l. 7546--><p class="indent" >   <a 
href="clmli7.html#x196-3479741r741">prog</a></tt> неявно устанавливает вокруг тела <tt><a 
href="clmli7.html#x196-3479135r135">block</a></tt> с именем <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt>. Это значит,
можно в любое время использовать <tt><a 
href="clmli7.html#x196-3479798r798">return</a></tt> для выхода из конструкции
<tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt>.
<!--l. 7549--><p class="indent" >   Вот небольшой пример того, что можно сделать с помощью <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt>:
<div class="lisp"><div class="tabbing">
(defun king-of-confusion (w)
                                                                          

                                                                          
   <br>                           &#x0022;Take a cons of two lists and make a list of conses.<br>
   Think of this function as being like a zipper.&#x0022;<br>
  (prog (x y z)     ;Инициализировать <tt>x</tt>, <tt>y</tt>, <tt>z</tt> в <tt><a 
href="clmli7.html#x196-3479650r650">nil</a></tt><br>
        (setq y (car w) z (cdr w))<br>                                   loop<br>
        (cond ((null y) (return x))<br>                   ((null z) (go err)))<br>
   rejoin<br>                          (setq x (cons (cons (car y) (car z)) x))<br>
        (setq y (cdr y) z (cdr z))<br>                              (go loop)<br>
   err<br>                           (cerror &#x0022;Will self-pair extraneous items&#x0022;<br>
                &#x0022;Mismatch - gleep!  S&#x0022; y)<br>                   (setq z y)<br>
        (go rejoin)))<br>
<!--l. 7568--><p class="noindent" ></div>
<!--l. 7568--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6950007.8.5" id="x54-6950007.8.5"></a></span>
<!--l. 7568--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6960007.8.5" id="x54-6960007.8.5"></a></span>
</div>
<!--l. 7569--><p class="indent" >   которые делает то же, что и: <div class="lisp"><div class="tabbing">
(defun prince-of-clarity (w)
   <br>                           &#x0022;Take a cons of two lists and make a list of conses.<br>
   Think of this function as being like a zipper.&#x0022;<br>
  (do ((y (car w) (cdr y))<br>                              (z (cdr w) (cdr z))<br>
       (x &#x2019;() (cons (cons (car y) (car z)) x)))<br>                 ((null y) x)<br>
    (when (null z)<br>               (cerror &#x0022;Will self-pair extraneous items&#x0022;<br>
              &#x0022;Mismatch - gleep!  S&#x0022; y)<br>                   (setq z y))))<br>
<!--l. 7582--><p class="noindent" ></div>
<!--l. 7582--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6970007.8.5" id="x54-6970007.8.5"></a></span>
<!--l. 7582--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6980007.8.5" id="x54-6980007.8.5"></a></span>
</div>
<!--l. 7584--><p class="indent" >   Конструкция <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt> может быть выражена в терминах более простых
конструкций <tt><a 
href="clmli7.html#x196-3479135r135">block</a></tt>, <tt><a 
href="clmli7.html#x196-3479524r524">let</a></tt> и <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>: <div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(prog <i>variable-list</i> {<i><i>declaration</i></i>}*  . <i>body</i>)
   <br>        <span class="math"> ≡</span> (block nil (let <i>variable-list</i> {<i><i>declaration</i></i>}*  (tagbody . <i>body</i>)))<br>
<!--l. 7589--><p class="noindent" ></div>
<!--l. 7589--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6990007.8.5" id="x54-6990007.8.5"></a></span>
<!--l. 7589--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-7000007.8.5" id="x54-7000007.8.5"></a></span>
</div>
<!--l. 7591--><p class="indent" >   Специальная форма <tt><a 
href="clmli7.html#x196-3479742r742">prog*</a></tt> очень похожа на <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt>. Одно отличие в том, что
связывание и инициализация переменных осуществляется <i>последовательно</i>,
тем самым форма <i>init</i> использовать значения ранее связанных переменных.
Таким образом <tt><a 
href="clmli7.html#x196-3479742r742">prog*</a></tt> относится к <tt><a 
href="clmli7.html#x196-3479741r741">prog</a></tt>, как <tt><a 
href="clmli7.html#x196-3479525r525">let*</a></tt> к <tt><a 
href="clmli7.html#x196-3479524r524">let</a></tt>. Например,
<div class="lisp"><div class="tabbing">
(prog* ((y z) (x (car y)))
   <br>                                                                             (return x))<br>
<!--l. 7599--><p class="noindent" ></div>
<!--l. 7599--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-7010007.8.5" id="x54-7010007.8.5"></a></span>
<!--l. 7599--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-7020007.8.5" id="x54-7020007.8.5"></a></span>
</div>
<!--l. 7600--><p class="indent" >   возвращает <i>car</i> элемент значения <tt>z</tt>.
</div>
<div class="defspec">
<div class="defmacheader">
<!--l. 7604--><p class="indent" >   <div class="tabbing">
 <i>[Специальный оператор]</i><b> go </b> <a 
 id="dx54-702001"></a><a 
 id="x54-702002r110"></a> tag
   <br>
                                                                          

                                                                          
<!--l. 7605--><p class="noindent" ></div>
<!--l. 7605--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-7030007.8.5" id="x54-7030007.8.5"></a></span>
</div>
<!--l. 7606--><p class="indent" >   Специальная форма <tt>(go <i>tag</i>)</tt> используется для применения «goto»
внутри конструкции <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>. <i>tag</i> должен быть символов или целым
числом. <i>tag</i> не вычисляется. <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> переносит управление на точку тела,
которая была помечена тегом равным <tt><a 
href="clmli7.html#x196-3479368r368">eql</a></tt> заданному. Если такого тега в
теле нет, поиск осуществляется в лексически доступном теле другой
конструкции <tt><a 
href="clmli7.html#x196-3479936r936">tagbody</a></tt>. Использоваться <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> с тегом, которого нет, является
ошибкой.
<!--l. 7614--><p class="indent" >   Форма <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> никогда не возвращает значение.
<!--l. 7616--><p class="indent" >   В целях стиля, рекомендуется дважды подумать, прежде чем использовать
<tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>. Большинство функций <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> могут быть заменены циклами, вложенными
условными формами или <tt><a 
href="clmli7.html#x196-3479799r799">return-from</a></tt>. Если использование <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt> неизбежно,
рекомендуется управляющую структуру реализованную с помощью <tt><a 
href="clmli7.html#x196-3479457r457">go</a></tt>
«упаковать» в определении макроса.
</div>
                                                                          

                                                                          
<!--l. 7624--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse43.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse41.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse41.html#tailclmse41.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse42.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch7.html#clmse42.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse42.html"></a>   </div> </div> 
</body></html> 
