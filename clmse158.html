<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Gatherers</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-19 16:08:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 87--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse159.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse157.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse157.html#tailclmse157.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse158.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmap2.html#clmse158.html" >Вверх</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">B.3   </span> <a 
href="clm.html#QQ2-194-537" id="x194-497000B.3">Gatherers</a></h3>
<!--l. 89--><p class="noindent" >These functions create and process gatherers.
<div class=defun>
<!--l. 91--><p class="noindent" ><i>[Function]</i><a 
 id="dx194-497001"></a><a 
 id="x194-497002r1081"></a><b> gatherer</b>  <i>collector</i>
<!--l. 93--><p class="noindent" >The collector must be a function of type (function ((series <span class="math">t<sub>1</sub></span>)) <span class="math">t<sub>2</sub></span>). Given this
function, <a 
href="#x194-497002r1081">gatherer</a> returns a gatherer that accepts elements of type <span class="math">t<sub>1</sub></span> and returns
a ﬁnal result of type <span class="math">t<sub>2</sub></span>. The method for combining elements used by the gatherer
is the same as the one used by the collector.
</div>
<div class=defun>
<!--l. 102--><p class="noindent" ><i>[Function]</i><a 
 id="dx194-497003"></a><a 
 id="x194-497004r1082"></a><b> next-out</b>  <i>gatherer</i> <i>item</i>
<!--l. 104--><p class="noindent" >Given a gatherer and a value, <a 
href="#x194-497004r1082">next-out</a> enters the value into the gatherer.
</div>
<div class=defun>
<!--l. 110--><p class="noindent" ><i>[Function]</i><a 
 id="dx194-497005"></a><a 
 id="x194-497006r1083"></a><b> result-of</b>  <i>gatherer</i>
<!--l. 112--><p class="noindent" ><a 
href="#x194-497006r1083">result-of</a> retrieves the net result from a gatherer. <a 
href="#x194-497006r1083">result-of</a> can be applied at
any time. However, it is an error to apply <a 
href="#x194-497006r1083">result-of</a> twice to the same
gatherer or to apply <a 
href="#x194-497004r1082">next-out</a> to a gatherer once <a 
href="#x194-497006r1083">result-of</a> has been applied.
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((g (gatherer #&#x2019;collect-sum)))
</td></tr></table>
<!--l. 118--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (dolist (i &#x2019;(1 2 3 4))</td></tr></table>
<!--l. 119--><p class="indent" >                                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (next-out g i)</td></tr></table>
<!--l. 120--><p class="indent" >                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (if (evenp i) (next-out g (* 10 i))))</td></tr></table>
<!--l. 121--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (result-of g))</td></tr></table>
<!--l. 122--><p class="indent" >                                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <span class="math"> ⇒</span> 70</td></tr></table>
<!--l. 124--><p class="indent" >
</div>
</div>
                                                                          

                                                                          
</div>
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> gathering </b><a 
 id="dx194-497007"></a><a 
 id="x194-497008r1084"></a> ( {(var fn)}* )  { form}*
</td></tr></table>
<!--l. 129--><p class="indent" >
</div>
<!--l. 129--><p class="noindent" ><span class="paragraphHead"><a 
href="#x194-498000B.3" id="x194-498000B.3"></a></span>
   The ﬁrst subform must be a list of pairs. The ﬁrst element of each pair, var,
must be a variable name. The second element of each pair, fn, must be a form
that when wrapped in (function ...) is acceptable as an argument to <a 
href="#x194-497002r1081">gatherer</a>.
Each symbol is bound to a gatherer constructed from the corresponding collector.
The body (consisting of the forms) is evaluated in the scope of these bindings.
When this evaluation is complete, <a 
href="#x194-497008r1084">gathering</a> returns the <a 
href="#x194-497006r1083">result-of</a> each gatherer. If
there are <span class="math">n</span> pairs in the binding list, <a 
href="#x194-497008r1084">gathering</a> returns <span class="math">n</span> values. For example:
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defun examp (data)
</td></tr></table>
<!--l. 141--><p class="indent" >                                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (gathering ((x collect) (y collect-sum))</td></tr></table>
<!--l. 142--><p class="indent" >                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (iterate ((i (scan data)))</td></tr></table>
<!--l. 143--><p class="indent" >                                                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (case (ﬁrst i)</td></tr></table>
<!--l. 144--><p class="indent" >                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (:slot (next-out x (second i)))</td></tr></table>
<!--l. 145--><p class="indent" >                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (:part (dolist (j (second i)) (next-out x j))))</td></tr></table>
<!--l. 146--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (next-out y (third i)))))</td></tr></table>
<!--l. 147--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 148--><p class="indent" >                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(examp &#x2019;((:slot a 10) (:part (c d) 40))) <span class="math"> ⇒</span> (a c d) and 50</td></tr></table>
<!--l. 150--><p class="indent" >
</div>
</div>
                                                                          

                                                                          
<!--l. 152--><p class="indent" >   As a further illustration of gatherers, consider the following deﬁnition
for a simpliﬁed version of <a 
href="#x194-497008r1084">gathering</a> that handles only one binding pair.
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro simple-gathering (((var collector)) &#x0026;body body)
</td></tr></table>
<!--l. 155--><p class="indent" >                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ‘(let ((,var (gatherer (function ,collector))))</td></tr></table>
<!--l. 156--><p class="indent" >                                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">     ,@body</td></tr></table>
<!--l. 157--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">     (result-of ,var)))</td></tr></table>
<!--l. 159--><p class="indent" >
</div>
</div>
<!--l. 160--><p class="noindent" >The full capabilities of <a 
href="#x194-497008r1084">gathering</a> can be supported in much the same way.
</div>
                                                                          

                                                                          
   <!--l. 164--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse159.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse157.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse157.html#tailclmse157.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse158.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmap2.html#clmse158.html" >Вверх</a><tt>&#x003E;</tt></p></div>
<!--l. 164--><p class="indent" >   <a 
 id="tailclmse158.html"></a>  
</body></html> 
