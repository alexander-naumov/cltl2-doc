<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Структуры с явно заданным типом представления</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-16 00:55:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 1800--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmch20.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse104.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse104.html#tailclmse104.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse105.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch19.html#clmse105.html" >Наверх</a><tt>&#x003E;</tt></div><h3 class="sectionHead"><span class="titlemark">19.7   </span> <a 
href="clm.html#QQ2-129-1617" id="x129-160800019.7">Структуры с явно
заданным типом представления</a></h3>
<!--l. 1803--><p class="noindent" >Иногда необходимо явно контролировать представление структуры. Опция
<tt>:type</tt> позволяет выбрать представление между списком или некоторым
видом вектора и указать соотвествие для размещения слотов в выбранном
представлении. Структура также может быть «безымянной» или
«именованной». Это означает может ли имя структуры быть сохранено в ней
самой (и соответственно, прочитано из неё).
<!--l. 1810--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">19.7.1   </span> <a 
href="clmli1.html#QQ2-129-1618" id="x129-160900019.7.1">Безымянные структуры</a></h4>
<!--l. 1812--><p class="noindent" >Иногда конкретное представление данных навязывается внешними
требованиями и, кроме того, формат данных прекрасно ложится в
структурный стиль хранения. Например, рассмотрим выражение созданное
из чисел, символов и таких операций как <tt><a 
href="clmse107.html#x132-1644002r586">+</a></tt> и <tt><a 
href="clmse107.html#x132-1646002r590">*</a></tt>. Операция может быть
представлена, как в Lisp&#x2019;е, списком из оператора и двух операндов. Этот
факт может быть выражен кратко в терминах <tt><a 
href="clmse100.html#x124-1572002r579">defstruct</a></tt>: е<div class="lisp"><div class="tabbing">
(defstruct (binop (:type list))
   <br>                      (operator &#x2019;? :type symbol)<br>                      operand-1<br>
  operand-2)<br>
<!--l. 1823--><p class="noindent" ></div>
<!--l. 1823--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-161000019.7.1" id="x129-161000019.7.1"></a></span>
<!--l. 1823--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-161100019.7.1" id="x129-161100019.7.1"></a></span>
</div>
<!--l. 1825--><p class="indent" >   Результатом выполнения <tt>make-binop</tt> является 3-ёх элементный список:
<div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(make-binop :operator &#x2019;+ :operand-1 &#x2019;x :operand-2 5)
   <br>                                                                              <span class="math"> ⇒</span> (+ x 5)<br>
<br>                                    (make-binop :operand-2 4 :operator &#x2019;*)<br>
   <span class="math"> ⇒</span> (* <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> 4)<br>
<!--l. 1832--><p class="noindent" ></div>
<!--l. 1832--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-161200019.7.1" id="x129-161200019.7.1"></a></span>
<!--l. 1832--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-161300019.7.1" id="x129-161300019.7.1"></a></span>
</div>
<!--l. 1833--><p class="indent" >   Выглядит как функция <tt><a 
href="clmse83.html#x103-1304002r458">list</a></tt> за исключением того, что принимает
именованные параметры и выполняет инициализацию слотов соответствующую
концептуальному типу данных <tt>binop</tt>. Таким же образом, селекторы
<tt>binop-operator</tt>, <tt>binop-operand-1</tt> и <tt>binop-operand-2</tt> эквивалентны
соответственно <tt><a 
href="clmse82.html#x102-1267002r410">car</a></tt>, <tt><a 
href="clmse82.html#x102-1273004r413">cadr</a></tt> и <tt><a 
href="clmse82.html#x102-1273016r419">caddr</a></tt>. (Они, конечно, не полностью
эквивалентны, так как реализация может осуществлять проверки типов
элементов, длины массивов при использовании селекторов слотов
структур.)
<!--l. 1842--><p class="indent" >   Мы говорим о <tt>binop</tt> как о «концептуальном» типе данных, потому что
<tt>binop</tt> не принадлежит Common Lisp&#x2019;овой системе типов. Предикат <tt><a 
href="clmse32.html#x43-316002r20">typep</a></tt> не
может использовать <tt>binop</tt> как спецификатор типа, и <tt><a 
href="clmse26.html#x35-211002r8">type-of</a></tt> будет
возвращать <tt><a 
href="clmse83.html#x103-1304002r458">list</a></tt> для заданной <tt>binop</tt> структуры. Несомненно, различий
между структурой данных, созданной с помощью <tt>make-binop</tt>, и простым
списком нет.
<!--l. 1849--><p class="indent" >   Невозможно даже получить имя структуры для объекта, созданного с
помощью <tt>make-binop</tt>. Однако имя может быть сохранено и получено, если
структура содержит «имя».
<!--l. 1853--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">19.7.2   </span> <a 
href="clmli1.html#QQ2-129-1623" id="x129-161400019.7.2">Именованные структуры</a></h4>
<!--l. 1855--><p class="noindent" >Структура с «именем» имеет свойство, которое заключается в том, что для
любого экземпляра структуры можно получить имя этой структуры. Для
                                                                          

                                                                          
структур определённых без указания опции <tt>:type</tt>, имя структуры
фактически становится частью Common Lisp&#x2019;овой системы типов. Функция
<tt><a 
href="clmse26.html#x35-211002r8">type-of</a></tt> при применении к экземпляру такой структуры будет возвращать
имя структуры. Предикат <tt><a 
href="clmse32.html#x43-316002r20">typep</a></tt> будет рассматривать имя структуры, как
корректный спецификатор типа.
<!--l. 1862--><p class="indent" >   Для структур определённых с опцией <tt>:type</tt>, <tt><a 
href="clmse26.html#x35-211002r8">type-of</a></tt> будет возвращать
спецификатор типа один из <tt><a 
href="clmse83.html#x103-1304002r458">list</a></tt> или <tt>(vector t)</tt>, в зависимости от
указанного аргумента опции <tt>:type</tt>. Имя структуры не становится
корректным спецификатором типа. Однако если также указана опция
<tt>:named</tt>, тогда первый компонент структуры всегда содержит её имя. Это
позволяет получить это имя, имея только экземпляр структуры. Это также
позволяет автоматически определить предикат для концептуального типа.
Предикат <tt><i>name</i>-p</tt> для структуры принимает в качестве первого аргумента
объект и истинен, если объект является экземпляром структуры, иначе
ложен.
<!--l. 1872--><p class="indent" >   Рассмотрим вышеупомянутый пример <tt>binop</tt> и модифицируем его, добавив
опцию <tt>:named</tt>: <div class="lisp"><div class="tabbing">
(defstruct (binop (:type list) :named)
   <br>                      (operator &#x2019;? :type symbol)<br>                      operand-1<br>
  operand-2)<br>
<!--l. 1879--><p class="noindent" ></div>
<!--l. 1879--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-161500019.7.2" id="x129-161500019.7.2"></a></span>
<!--l. 1879--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-161600019.7.2" id="x129-161600019.7.2"></a></span>
</div>
<!--l. 1880--><p class="indent" >   Как и раньше, конструкция определить функцию-конструктор
<tt>make-binop</tt> и три функции-селектора <tt>binop-operator</tt>, <tt>binop-operand-1</tt> и
<tt>binop-operand-2</tt>. Она также определит предикат <tt>binop-p</tt>.
<!--l. 1884--><p class="indent" >   Результатом <tt>make-binop</tt> теперь является список с 4-мя элементами:
<div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(make-binop :operator &#x2019;+ :operand-1 &#x2019;x :operand-2 5)
   <br>                                                                      <span class="math"> ⇒</span> (binop + x 5)<br>
<br>                                    (make-binop :operand-2 4 :operator &#x2019;*)<br>
   <span class="math"> ⇒</span> (binop * <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> 4)<br>
<!--l. 1891--><p class="noindent" ></div>
<!--l. 1891--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-161700019.7.2" id="x129-161700019.7.2"></a></span>
<!--l. 1891--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-161800019.7.2" id="x129-161800019.7.2"></a></span>
</div>
<!--l. 1892--><p class="indent" >   Структура имеет такую же разметку как и раньше за исключением имени
структуры в первом элементе. Функции-селекторы <tt>binop-operator</tt>,
<tt>binop-operand-1</tt>и <tt>binop-operand-2</tt> эквивалентны соответственно <tt><a 
href="clmse82.html#x102-1273004r413">cadr</a></tt>,
<tt><a 
href="clmse82.html#x102-1273016r419">caddr</a></tt> и <tt><a 
href="clmse82.html#x102-1273040r431">cadddr</a></tt>. Предикат <tt>binop-p</tt> примерно соответствует следующему
определению. <div class="lisp"><div class="tabbing">
(defun binop-p (x)
   <br>                                               (and (consp x) (eq (car x) &#x2019;binop)))<br>
<!--l. 1901--><p class="noindent" ></div>
<!--l. 1901--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-161900019.7.2" id="x129-161900019.7.2"></a></span>
<!--l. 1901--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-162000019.7.2" id="x129-162000019.7.2"></a></span>
</div>
<!--l. 1902--><p class="indent" >   Имя <tt>binop</tt> не является корректным спецификатором типа, и не может
использоваться в <tt><a 
href="clmse32.html#x43-316002r20">typep</a></tt>. Но с помощью предиката структура теперь
отличима от других структур.
                                                                          

                                                                          
<!--l. 1906--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">19.7.3   </span> <a 
href="clmli1.html#QQ2-129-1630" id="x129-162100019.7.3">Другие аспекты явно определённых типов для представления
структур</a></h4>
<!--l. 1909--><p class="noindent" >Опция <tt>:initial-offset</tt> позволяет указывать начало размещения слотов в
представлении структуры. Например, форма <div class="lisp"><div class="tabbing">
(defstruct (binop (:type list) (:initial-oﬀset 2))
   <br>                      (operator &#x2019;? :type symbol)<br>                      operand-1<br>
  operand-2)<br>
<!--l. 1916--><p class="noindent" ></div>
<!--l. 1916--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-162200019.7.3" id="x129-162200019.7.3"></a></span>
<!--l. 1916--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-162300019.7.3" id="x129-162300019.7.3"></a></span>
</div>
<!--l. 1917--><p class="indent" >   создаст конструктор <tt>make-binop</tt> со следующим поведением: <div class="lisp"><div class="tabbing">
(make-binop :operator &#x2019;+ :operand-1 &#x2019;x :operand-2 5)
   <br>                                                                     <span class="math"> ⇒</span> (nil nil + x 5)<br>
<br>                                    (make-binop :operand-2 4 :operator &#x2019;*)<br>
   <span class="math"> ⇒</span> (nil nil * <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> 4)<br>
<!--l. 1924--><p class="noindent" ></div>
<!--l. 1924--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-162400019.7.3" id="x129-162400019.7.3"></a></span>
<!--l. 1924--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-162500019.7.3" id="x129-162500019.7.3"></a></span>
</div>
<!--l. 1925--><p class="indent" >   Селекторы <tt>binop-operator</tt>, <tt>binop-operand-1</tt> и <tt>binop-operand-2</tt> будут
эквивалентны соответственно <tt><a 
href="clmse82.html#x102-1273016r419">caddr</a></tt>, <tt><a 
href="clmse82.html#x102-1273040r431">cadddr</a></tt>, и <tt><a 
href="clmse82.html#x102-1267002r410">car</a></tt> от <tt><a 
href="clmse82.html#x102-1273056r439">cddddr</a></tt>. Таким же
образом, форма <div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(defstruct (binop (:type list) :named (:initial-oﬀset 2))
   <br>                      (operator &#x2019;? :type symbol)<br>                      operand-1<br>
  operand-2)<br>
<!--l. 1935--><p class="noindent" ></div>
<!--l. 1935--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-162600019.7.3" id="x129-162600019.7.3"></a></span>
<!--l. 1935--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-162700019.7.3" id="x129-162700019.7.3"></a></span>
</div>
<!--l. 1936--><p class="indent" >   создаст конструктор <tt>make-binop</tt> со следующим поведением: <div class="lisp"><div class="tabbing">
(make-binop :operator &#x2019;+ :operand-1 &#x2019;x :operand-2 5)
   <br>                                                             <span class="math"> ⇒</span> (nil nil binop + x 5)<br>
<br>                                    (make-binop :operand-2 4 :operator &#x2019;*)<br>
   <span class="math"> ⇒</span> (nil nil binop * <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> 4)<br>
<!--l. 1943--><p class="noindent" ></div>
<!--l. 1943--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-162800019.7.3" id="x129-162800019.7.3"></a></span>
<!--l. 1943--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-162900019.7.3" id="x129-162900019.7.3"></a></span>
</div>
<!--l. 1945--><p class="indent" >   Если вместе с опцией <tt>:type</tt> используется <tt>:include</tt>, тогда в представлении
выделяется столько места, сколько необходимо для родительской
структуры, затем пропускается столько места, сколько указано в опции
<tt>:initial-offset</tt>, и затем начинается расположение элементов определяемой
структуры. Например: <div class="lisp"><div class="tabbing">
(defstruct (binop (:type list) :named (:initial-oﬀset 2))
                                                                          

                                                                          
   <br>                                                           (operator &#x2019;? :type symbol)<br>
  operand-1<br>                                                   operand-2)<br>
<br>                                    (defstruct (annotated-binop (:type list)<br>
                            (:initial-oﬀset 3)<br>
                            (:include binop))<br>
  commutative associative identity)<br>                                       <br>
(make-annotated-binop :operator &#x2019;*<br>                       :operand-1 &#x2019;x<br>
                      :operand-2 5<br>
                      :commutative t<br>
                      :associative t<br>
                      :identity 1)<br>
   <span class="math"> ⇒</span> (nil nil binop * x 5 nil nil nil t t 1)<br>
<!--l. 1969--><p class="noindent" ></div>
<!--l. 1969--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-163000019.7.3" id="x129-163000019.7.3"></a></span>
<!--l. 1969--><p class="noindent" ><span class="paragraphHead"><a 
href="#x129-163100019.7.3" id="x129-163100019.7.3"></a></span>
</div>
<!--l. 1970--><p class="indent" >   Первые два <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> элемента пропущены по причине опции <tt>:initial-offset</tt>
со значением <tt>2</tt> в определении <tt>binop</tt>. Следующие четыре элемента содержат
имя и три слота структуры <tt>binop</tt>. Следующие три <tt><a 
href="clmse31.html#x42-312002r18">nil</a></tt> элементы пропущено
по причине опции <tt>:initial-offset</tt> за значением <tt>3</tt> в определении
структуры <tt>annotated-binop</tt>. Последние три элемента содержат три слота,
определённых в структуре <tt>annotated-binop</tt>.
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
<!--l. 378--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmch20.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse104.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse104.html#tailclmse104.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse105.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch19.html#clmse105.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse105.html"></a>   </div> </div> 
</body></html> 
