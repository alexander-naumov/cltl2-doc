<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>The Compiler</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-02-20 00:42:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 14--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse128.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch25.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch25.html#tailclmch25.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse127.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch25.html#clmse127.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">25.1   </span> <a 
 id="x157-22400025.1"></a>The Compiler</h3>
<div class=obsolete>
<!--l. 17--><p class="noindent" >The compiler is a program that may make code run faster by translating
programs into an implementation-dependent form that can be executed more
eﬃciently by the computer. Most of the time you can write programs without
worrying about the compiler; compiling a ﬁle of code should produce an
equivalent but more eﬃcient program. When doing more esoteric things, you may
need to think carefully about what happens at “compile time” and what
happens at “load time.” Then the diﬀerence between the syntaxes <i>#.</i> and <i>#,</i>
becomes important, and the <i>eval-when</i> construct becomes particularly
useful.
</div>
<div class=newer>
                                                                          

                                                                          
<!--l. 31--><p class="noindent" >X3J13 voted in January 1989 ⟨<b>?</b>⟩ to remove <i>#,</i> from the language.
</div>
   Most declarations are not used by the Common Lisp interpreter; they may be
used to give advice to the compiler. The compiler may attempt to check your
advice and warn you if it is inconsistent.
   Unlike most other Lisp dialects, Common Lisp recognizes <i>special</i> declarations
in interpreted code as well as compiled code. This potential source of
incompatibility between interpreted and compiled code is thereby eliminated in
Common Lisp.
   The internal workings of a compiler will of course be highly
implementation-dependent. The following functions provide a standard interface
to the compiler, however.
<div class=defun>
    <i>[Function]</i>   <b>compile</b> <a 
 id="dx157-224001"></a><a 
 id="x157-224002r796"></a>   <i>name</i>  <b>&#x0026;optional</b>  <i>deﬁnition</i>
   <div class=obsolete>If deﬁnition is supplied, it should be a lambda-expression, the interpreted
function to be compiled. If it is not supplied, then name should be a symbol with
a deﬁnition that is a lambda-expression; that deﬁnition is compiled and
the resulting compiled code is put back into the symbol as its function
deﬁnition.
</div>
<div class=newer>
   X3J13 voted in October 1988 ⟨<b>?</b>⟩ to restate the preceding paragraph more
precisely and to extend the capabilities of <i>compile</i>. If the optional deﬁnition
argument is supplied, it may be either a lambda-expression (which is coerced to a
function) or a function to be compiled; if no deﬁnition is supplied, the
<i>symbol-function</i> of the symbol is extracted and compiled. It is permissible for the
symbol to have a macro deﬁnition rather than a function deﬁnition; both macros
and functions may be compiled.
   It is an error if the function to be compiled was deﬁned interpretively in a
non-null lexical environment. (An implementation is free to extend the behavior of
<i>compile</i> to compile such functions properly, but portable programs may not
depend on this capability.) The consequences of calling <i>compile</i> on a function that
is already compiled are unspeciﬁed.
</div>
<div class=obsolete>
   The deﬁnition is compiled and a compiled-function object produced. If name is
a non-<i>nil</i> symbol, then the compiled-function object is installed as the global
function deﬁnition of the symbol and the symbol is returned. If name is
                                                                          

                                                                          
<i>nil</i>, then the compiled-function object itself is returned. For example: <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">
</td></tr></table>
<!--l. 89--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td style="width:242;" 
class="tabbing">(defun foo ...)  ⇒ foo        </td><td  
class="tabbing">;A function deﬁnition</td></tr></table>
<!--l. 90--><p class="indent" >                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td style="width:242;" 
class="tabbing">(compile &#x2019;foo)  ⇒ foo             </td><td  
class="tabbing">;Compile it</td></tr></table>
<!--l. 91--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td style="width:242;" 
class="tabbing">                                         </td><td  
class="tabbing">;Now <i>foo</i> runs faster (maybe)</td></tr></table>
<!--l. 92--><p class="indent" >
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(compile <i>nil</i>
</td></tr></table>
<!--l. 93--><p class="indent" >                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         &#x2019;(lambda (a b c) (- (* b b) (* 4 a c))))</td></tr></table>
<!--l. 94--><p class="indent" >     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ⇒ a compiled function of three arguments that computes b<sup>2</sup> − 4ac</td></tr></table>
<!--l. 96--><p class="indent" >
</div>
</div>
</div>
<div class=newer>
<!--l. 100--><p class="noindent" >X3J13 voted in June 1989 ⟨<b>?</b>⟩ to specify that <i>compile</i> returns two additional
values indicating whether the compiler issued any diagnostics (see
section <a 
href="#x157-22500025.1.1">25.1.1<!--tex4ht:ref: COMPILER-DIAGNOSTICS-SECTION --></a>).
</div>
<div class=newer>
<!--l. 107--><p class="noindent" >X3J13 voted in March 1989 ⟨<b>?</b>⟩ to extend <i>compile</i> to accept as a name any
function-name (a symbol or a list whose car is <i>setf </i>—see section <a 
href="clmse35.html#x47-770007.1">7.1<!--tex4ht:ref: FUNCTION-NAME-SECTION --></a>). One may
write <i>(compile &#x2019;(setf cadr))</i> to compile the <i>setf </i> expansion function for
<i>cadr</i>.
</div>
</div>
<div class=obsolete>
<div class=defun>
    <i>[Function]</i>   <b>compile-ﬁle</b> <a 
 id="dx157-224003"></a><a 
 id="x157-224004r797"></a>   <i>input-pathname</i>  <b>&#x0026;key</b>  :output-ﬁle
   The input-pathname must be a valid ﬁle speciﬁer, such as a pathname. The
defaults for input-ﬁlename are taken from the variable <i>*default-pathname-defaults*</i>.
The ﬁle should be a Lisp source ﬁle; its contents are compiled and written as a
binary object ﬁle.
</div>
                                                                          

                                                                          
</div>
<div class=newer>
   X3J13 voted in March 1989 ⟨<b>?</b>⟩ to add two new keyword arguments <i>:verbose</i>
and <i>:print</i> to <i>compile-ﬁle</i> by analogy with <i>load</i>. The new function deﬁnition is as
follows.
<div class=defun>
    <i>[Function]</i>   <b>compile-ﬁle</b> <a 
 id="dx157-224005"></a><a 
 id="x157-224006r798"></a>   <i>input-pathname</i>  <b>&#x0026;key</b>  :output-ﬁle  :verbose
:print
   The <i>:verbose</i> argument (which defaults to the value of <i>*compile-verbose*</i>), if
true, permits <i>compile-ﬁle</i> to print a message in the form of a comment to
<i>*standard-output*</i> indicating what ﬁle is being compiled and other useful
information.
   The <i>:print</i> argument (which defaults to the value of <i>*compile-print*</i>), if true,
causes information about top-level forms in the ﬁle being compiled to be printed
to <i>*standard-output*</i>. Exactly what is printed is implementation-dependent;
nevertheless something will be printed.
</div>
</div>
<div class=new>
   X3J13 voted in March 1988 ⟨<b>?</b>⟩ to specify exactly which streams may be used
as pathnames (see section <a 
href="clmse119.html#x147-21400023.1.6">23.1.6<!--tex4ht:ref: PATHNAME-FUNCTIONS --></a>).
</div> <div class=newer> X3J13 voted in June 1989 ⟨<b>?</b>⟩ to clarify that supplying a wild pathname as the
input-pathname argument to <i>compile-ﬁle</i> has implementation-dependent
consequences; <i>compile-ﬁle</i> might signal an error, for example, or might compile all
ﬁles that match the wild pathname.
</div>
<div class=newer>
   X3J13 voted in June 1989 ⟨<b>?</b>⟩ to require <i>compile-ﬁle</i> to accept logical
pathnames (see section <a 
href="clmse119.html#x147-20800023.1.5">23.1.5<!--tex4ht:ref: LOGICAL-PATHNAMES-SECTION --></a>).
</div>
   The <i>:output-ﬁle</i> argument may be used to specify an output pathname; it
defaults in a manner appropriate to the implementation&#x2019;s ﬁle system
conventions.
<div class=newer>
   X3J13 voted in June 1989 ⟨<b>?</b>⟩ to specify that <i>compile-ﬁle</i> returns three values:
the <i>truename</i> of the output ﬁle (or <i>nil</i> if the ﬁle could not be created) and
two values indicating whether the compiler issued any diagnostics (see
section <a 
href="#x157-22500025.1.1">25.1.1<!--tex4ht:ref: COMPILER-DIAGNOSTICS-SECTION --></a>).
                                                                          

                                                                          
</div>
<div class=newer>
   X3J13 voted in October 1988 ⟨<b>?</b>⟩ to specify that <i>compile-ﬁle</i>, like <i>load</i>,
rebinds <i>*package*</i> to its current value. If some form in the ﬁle changes the
value of <i>*package*</i>, the old value will be restored when compilation is
completed.
</div>
<div class=newer>
   X3J13 voted in June 1989 ⟨<b>?</b>⟩ to specify restrictions on conforming programs
to ensure consistent handling of symbols and packages.
   In order to guarantee that compiled ﬁles can be loaded correctly, the user must
ensure that the packages referenced in the ﬁle are deﬁned consistently at compile
and load time. Conforming Common Lisp programs must satisfy the following
requirements.
      <ul class="itemize1">
      <li class="itemize">The value of <i>*package*</i> when a top-level form in the ﬁle is processed by
      <i>compile-ﬁle</i> must be the same as the value of <i>*package*</i> when the code
      corresponding to that top-level form in the compiled ﬁle is executed
      by the loader. In particular, any top-level form in a ﬁle that alters the
      value of <i>*package*</i> must change it to a package of the same name at
      both compile and load time; moreover, if the ﬁrst non-atomic top-level
      form in the ﬁle is not a call to <i>in-package</i>, then the value of <i>*package*</i>
      at the time <i>load</i> is called must be a package with the same name as the
      package that was the value of <i>*package*</i> at the time <i>compile-ﬁle</i> was
      called.
      </li>
      <li class="itemize">For  every  symbol  appearing  lexically  within  a  top-level  form  that
      was accessible in the package that was the value of <i>*package*</i> during
      processing of that top-level form at compile time, but whose home
      package was another package, at load time there must be a symbol with
      the same name that is accessible in both the load-time <i>*package*</i> and
      in the package with the same name as the compile-time home package.
      </li>
      <li class="itemize">For every symbol in the compiled ﬁle that was an external symbol in
      its home package at compile time, there must be a symbol with the
      same name that is an external symbol in the package with the same
                                                                          

                                                                          
      name at load time.</li></ul>
<!--l. 223--><p class="noindent" >If any of these conditions do not hold, the package in which <i>load</i> looks for the
aﬀected symbols is unspeciﬁed. Implementations are permitted to signal an error
or otherwise deﬁne this behavior.
<!--l. 227--><p class="indent" >   These requirements are merely an explicit statement of the status quo,
namely that users cannot depend on any particular behavior if the package
environment at load time is inconsistent with what existed at compile
time.
</div>
<div class=newer>
   X3J13 voted in March 1989 ⟨<b>?</b>⟩ to specify that <i>compile-ﬁle</i> must bind
<i>*readtable*</i> to its current value at the time <i>compile-ﬁle</i> is called; the dynamic
extent of the binding should encompass all of the ﬁle-loading activity. This allows
a portable program to include forms such as <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(in-package &#x0022;FOO&#x0022;)
</td></tr></table>
<!--l. 241--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 242--><p class="indent" >                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(eval-when (:execute :load-toplevel :compile-toplevel)</td></tr></table>
<!--l. 243--><p class="indent" >                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (setq *readtable* foo:my-readtable))</td></tr></table>
<!--l. 245--><p class="indent" >
</div>
</div>
<!--l. 246--><p class="noindent" >without performing a net global side eﬀect on the loading environment. Such
statements allow the remainder of such a ﬁle to be read either as interpreted code
or by <i>compile-ﬁle</i> in a syntax determined by an alternative readtable.
</div>
<div class=newer>
   X3J13 voted in June 1989 ⟨<b>?</b>⟩ to require that <i>compile-ﬁle</i> bind two
new variables <i>*compile-ﬁle-pathname*</i> and <i>*compile-ﬁle-truename*</i>; the
dynamic extent of the bindings should encompass all of the ﬁle-compiling
activity.
</div>
<div class=newer>
<div class=defun>
                                                                          

                                                                          
    <i>[Variable]</i>   <b>*compile-verbose*</b> <a 
 id="dx157-224007"></a><a 
 id="x157-224008r799"></a>
   X3J13 voted in March 1989 ⟨<b>?</b>⟩ to add <i>*compile-verbose*</i>. This variable
provides the default for the <i>:verbose</i> argument to <i>compile-ﬁle</i>. Its initial value is
implementation-dependent.
   A proposal was submitted to X3J13 in October 1989 to rename this
<i>*compile-ﬁle-verbose*</i> for consistency.
</div>
</div>
<div class=newer>
<div class=defun>
    <i>[Variable]</i>   <b>*compile-print*</b> <a 
 id="dx157-224009"></a><a 
 id="x157-224010r800"></a>
   X3J13 voted in March 1989 ⟨<b>?</b>⟩ to add <i>*compile-print*</i>. This variable provides
the default for the <i>:print</i> argument to <i>compile-ﬁle</i>. Its initial value is
implementation-dependent.
   A proposal was submitted to X3J13 in October 1989 to rename this
<i>*compile-ﬁle-print*</i> for consistency.
</div>
</div>
<div class=newer>
<div class=defun>
    <i>[Variable]</i>   <b>*compile-ﬁle-pathname*</b> <a 
 id="dx157-224011"></a><a 
 id="x157-224012r801"></a>
   X3J13 voted in June 1989 ⟨<b>?</b>⟩ to introduce <i>*compile-ﬁle-pathname*</i>; it is
initially <i>nil</i> but <i>compile-ﬁle</i> binds it to a pathname that represents the ﬁle name
given as the ﬁrst argument to <i>compile-ﬁle</i> merged with the defaults (see
<i>merge-pathname</i>).
</div>
<div class=defun>
    <i>[Variable]</i>   <b>*compile-ﬁle-truename*</b> <a 
 id="dx157-224013"></a><a 
 id="x157-224014r802"></a>
   X3J13 voted in June 1989 ⟨<b>?</b>⟩ to introduce <i>*compile-ﬁle-truename*</i>; it is
initially <i>nil</i> but <i>compile-ﬁle</i> binds it to the “true name” of the pathname of the ﬁle
being compiled. See <i>truename</i>.
</div>
</div>
<div class=newer>
<div class=defspec>
   <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Special form]</i><b> load-time-value </b> <a 
 id="dx157-224015"></a><a 
 id="x157-224016r803"></a>   form  [ <i>read-only-p</i>]
</td></tr></table>
<!--l. 310--><p class="indent" >
</div>
   X3J13 voted in March 1989 ⟨<b>?</b>⟩ to add a mechanism for delaying evaluation of
a form until it can be done in the run-time environment.
   If a <i>load-time-value</i> expression is seen by <i>compile-ﬁle</i>, the compiler performs
its normal semantic processing (such as macro expansion and translation into
machine code) on the form, but arranges for the execution of the form to
occur at load time in a null lexical environment, with the result of this
evaluation then being treated as an immediate quantity (that is, as if
originally quoted) at run time. It is guaranteed that the evaluation of the
form will take place only once when the ﬁle is loaded, but the order of
evaluation with respect to the execution of top-level forms in the ﬁle is
unspeciﬁed.
   If a <i>load-time-value</i> expression appears within a function compiled with
<i>compile</i>, the form is evaluated at compile time in a null lexical environment. The
result of this compile-time evaluation is treated as an immediate quantity in the
compiled code.
   In interpreted code, form is evaluated (by <i>eval</i>) in a null lexical environment
and one value is returned. Implementations that implicitly compile (or partially
compile) expressions passed to <i>eval</i> may evaluate the form only once, at the time
this compilation is performed. This is intentionally similar to the freedom that
implementations are given for the time of expanding macros in interpreted
code.
   If the same (as determined by <i>eq</i>) list <i>(load-time-value form)</i> is evaluated or
compiled more than once, it is unspeciﬁed whether the form is evaluated only
once or is evaluated more than once. This can happen both when an
expression being evaluated or compiled shares substructure and when the
same expression is passed to <i>eval</i> or to <i>compile</i> multiple times. Since a
<i>load-time-value</i> expression may be referenced in more than one place and may be
evaluated multiple times by the interpreter, it is unspeciﬁed whether each
execution returns a “fresh” object or returns the same object as some other
execution. Users must use caution when destructively modifying the resulting
object.
   If two lists <i>(load-time-value form)</i> are <i>equal</i> but not <i>eq</i>, their values always
come from distinct evaluations of form. Coalescing of these forms is not
                                                                          

                                                                          
permitted.
   The optional read-only-p argument designates whether the result may be
considered a read-only constant. If <i>nil</i> (the default), the result must be considered
ordinary, modiﬁable data. If <i>t</i>, the result is a read-only quantity that may, as
appropriate, be copied into read-only space and may, as appropriate, be shared
with other programs. The read-only-p argument is not evaluated and only the
literal symbols <i>t</i> and <i>nil</i> are permitted.
   This new feature addresses the same set of needs as the now-defunct <i>#,</i> reader
syntax but in a cleaner and more general manner. Note that <i>#,</i> syntax was
reliably useful only inside quoted structure (though this was not explicitly
mentioned in the ﬁrst edition), whereas a <i>load-time-value</i> form must appear
outside quoted structure in a for-evaluation position.
   See <i>make-load-form</i>.
</div>
</div>
<div class=defun>
    <i>[Function]</i>   <b>disassemble</b> <a 
 id="dx157-224017"></a><a 
 id="x157-224018r804"></a>   <i>name-or-compiled-function</i>
   The argument should be a function object, a lambda-expression, or a symbol
with a function deﬁnition. If the relevant function is not a compiled function, it is
ﬁrst compiled. In any case, the compiled code is then “reverse-assembled” and
printed out in a symbolic format. This is primarily useful for debugging the
compiler, but also often of use to the novice who wishes to understand the
workings of compiled code.
<div class=implementation>
   <b>Implementation note:</b> Implementors are encouraged to make the output readable,
preferably with helpful comments.
</div>
<div class=newer>
   X3J13 voted in March 1988 ⟨<b>?</b>⟩ to clarify that when <i>disassemble</i> compiles a
function, it never installs the resulting compiled-function object in the
<i>symbol-function</i> of a symbol.
</div>
<div class=newer>
   X3J13 voted in March 1989 ⟨<b>?</b>⟩ to extend <i>disassemble</i> to accept as a name any
function-name (a symbol or a list whose car is <i>setf </i>—see section <a 
href="clmse35.html#x47-770007.1">7.1<!--tex4ht:ref: FUNCTION-NAME-SECTION --></a>). Thus one
may write <i>(disassemble &#x2019;(setf cadr))</i> to disassemble the <i>setf </i> expansion function for
<i>cadr</i>.
</div>
                                                                          

                                                                          
</div>
<div class=new>
<div class=defun>
    <i>[Function]</i>   <b>function-lambda-expression</b> <a 
 id="dx157-224019"></a><a 
 id="x157-224020r805"></a>   <i>fn</i>
   X3J13 voted in January 1989 ⟨<b>?</b>⟩ to add a new function to allow the source
code for a deﬁned function to be recovered. (The committee noted that the ﬁrst
edition provided no portable way to recover a lambda-expression once it had been
compiled or evaluated to produce a function.)
   This function takes one argument, which must be a function, and returns three
values.
   The ﬁrst value is the deﬁning lambda-expression for the function, or <i>nil</i> if
that information is not available. The lambda-expression may have been
preprocessed in some ways but should nevertheless be of a form suitable as
an argument to the function <i>compile</i> or for use in the <i>function</i> special
form.
   The second value is <i>nil</i> if the function was deﬁnitely produced by
closing a lambda-expression in the null lexical environment; it is some
non-<i>nil</i> value if the function might have been closed in some non-null lexical
environment.
   The third value is the “name” of the function; this is <i>nil</i> if the name is
not available or if the function had no name. The name is intended for
debugging purposes only and may be any Lisp object (not necessarily one that
would be valid for use as a name in a <i>defun</i> or <i>function</i> special form, for
example).
<div class=implementation>
   <b>Implementation note:</b> An implementation is always free to return the values <i>nil</i>,
<i>t</i>, <i>nil</i> from this function but is encouraged to make more useful information available as
appropriate. For example, it may not be desirable for ﬁles of compiled code to retain the
source lambda-expressions for use after the ﬁle is loaded, but it is probably
desirable for functions produced by “in-core” calls to <i>eval</i>, <i>compile</i>, or <i>defun</i> to
retain the deﬁning lambda-expression for debugging purposes. The function
<i>function-lambda-expression</i> makes this information, if retained, accessible in a standard
and portable manner.
</div>
</div>
</div>
<div class=newer>
<div class=defmac>
                                                                          

                                                                          
   <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Macro]</i><b> with-compilation-unit </b> <a 
 id="dx157-224021"></a><a 
 id="x157-224022r806"></a>   ( {<i>option − nameoption − value</i>}∗ )  {<i>form</i>}∗
</td></tr></table>
<!--l. 463--><p class="indent" >
</div>
   X3J13 voted in March 1989 ⟨<b>?</b>⟩ to add <i>with-compilation-unit</i>, which executes
the body forms as an implicit <i>progn</i>. Within the dynamic context of this form,
warnings deferred by the compiler until “the end of compilation” will be
deferred until the end of the outermost call to <i>with-compilation-unit</i>. The
results are the same as those of the last of the forms (or <i>nil</i> if there is no
form).
   Each option-name is an unevaluated keyword; each option-value is evaluated.
The set of keywords permitted may be extended by the implementation, but the
only standard option keyword is <i>:override</i>; the default value for this option
is <i>nil</i>. If <i>with-compilation-unit</i> forms are nested dynamically, only the
outermost such call has any eﬀect unless the <i>:override</i> value of an inner call is
true.
   The function <i>compile-ﬁle</i> should provide the eﬀect of <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(with-compilation-unit (:override nil) ...)
</td></tr></table>
<!--l. 484--><p class="indent" >
</div>
</div>
<!--l. 485--><p class="noindent" >around its code.
<!--l. 487--><p class="indent" >   Any implementation-dependent extensions to this behavior may be
provided only as the result of an explicit programmer request by use of an
implementation-dependent keyword. It is forbidden for an implementation to
attach additional meaning to a conforming use of this macro.
<!--l. 493--><p class="indent" >   Note that not all compiler warnings are deferred. In some implementations, it
may be that none are deferred. This macro only creates an interface to the
capability where it exists, it does not require the creation of the capability. An
implementation that does not defer any compiler warnings may correctly
implement this macro as an expansion into a simple <i>progn</i>.
                                                                          

                                                                          
</div>
</div>
<div class=newer>
   <h4 class="subsectionHead"><span class="titlemark">25.1.1   </span> <a 
 id="x157-22500025.1.1"></a>Compiler Diagnostics</h4>
<!--l. 506--><p class="noindent" >X3J13 voted in June 1987 ⟨<b>?</b>⟩ to specify that <i>compile</i> and <i>compile-ﬁle</i> may output
warning messages; any such messages should go to the stream that is the value of
<i>*error-output*</i>.
<!--l. 511--><p class="indent" >   X3J13 voted in June 1989 ⟨<b>?</b>⟩ to specify the use of conditions to signal
various erroneous situations during compilation. First, note that <i>error</i> and
<i>warning</i> conditions may be signaled either by the compiler itself or by code
being processed by the compiler (for example, arbitrary errors may occur
during compile-time macro expansion or processing of <i>eval-when</i> forms).
Considering only those conditions signaled by the compiler (as opposed to during
compilation):
      <ul class="itemize1">
      <li class="itemize">Conditions of type <i>error</i> may be signaled by the compiler in situations
      where the compilation cannot proceed without intervention. Examples
      of such situations may include errors when opening a ﬁle or syntax
      errors.
      </li>
      <li class="itemize">Conditions  of  type  <i>warning</i>  may  be  signaled  by  the  compiler  in
      situations where the standard explicitly states that a warning must,
      should,  or  may  be  signaled.  They  may  also  be  signaled  when  the
      compiler can determine that a situation would result at runtime that
      would  have  undeﬁned  consequences  or  would  cause  an  error  to  be
      signaled. Examples of such situations may include violations of type
      declarations, altering or rebinding a constant deﬁned with <i>defconstant</i>,
      calls to built-in Lisp functions with too few or too many arguments or
      with malformed keyword argument lists, referring to a variable declared
      <i>ignore</i>, or unrecognized declaration speciﬁers.
      </li>
      <li class="itemize">The  compiler  is  permitted  to  signal  diagnostics  about  matters  of
                                                                          

                                                                          
      programming  style  as  conditions  of  type  <i>style-warning</i>,  a  subtype
      of <i>warning</i>. Although a <i>style-warning</i> condition may be signaled in
      these situations, no implementation is required to do so. However, if
      an implementation does choose to signal a condition, that condition
      will be of type <i>style-warning</i> and will be signaled by a call to the
      function <i>warn</i>. Examples of such situations may include redeﬁnition
      of a function with an incompatible argument list, calls to functions
      (other than built-in functions) with too few or too many arguments or
      with malformed keyword argument lists, unreferenced local variables
      not declared <i>ignore</i>, or standard declaration speciﬁers that are ignored
      by the particular compiler in question.</li></ul>
<!--l. 561--><p class="indent" >   Both <i>compile</i> and <i>compile-ﬁle</i> are permitted (but not required) to establish a
handler for conditions of type <i>error</i>. Such a handler might, for example, issue a
warning and restart compilation from some implementation-dependent point in
order to let the compilation proceed without manual intervention.
<!--l. 568--><p class="indent" >   The functions <i>compile</i> and <i>compile-ﬁle</i> each return three values. See the
deﬁnitions of these functions for descriptions of the ﬁrst value. The second value is
<i>nil</i> if no compiler diagnostics were issued, and true otherwise. The third value is
<i>nil</i> if no compiler diagnostics other than style warnings were issued; a non-<i>nil</i>
value indicates that there were “serious” compiler diagnostics issued or that other
conditions of type <i>error</i> or <i>warning</i> (but not <i>style-warning</i>) were signaled during
compilation.
</div>
<div class=newer>
   <h4 class="subsectionHead"><span class="titlemark">25.1.2   </span> <a 
 id="x157-22600025.1.2"></a>Compiled Functions</h4>
<!--l. 582--><p class="noindent" >X3J13 voted in June 1989 ⟨<b>?</b>⟩ to impose certain requirements on the functions
produced by the compilation process.
<!--l. 587--><p class="indent" >   If a function is of type <i>compiled-function</i>, then all macro calls appearing
lexically within the function have already been expanded and will not be
expanded again when the function is called. The process of compilation eﬀectively
turns every <i>macrolet</i> or <i>symbol-macrolet</i> construct into a <i>progn</i> (or a <i>locally</i>) with
all instances of the local macros in the body fully expanded.
<!--l. 595--><p class="indent" >   If a function is of type <i>compiled-function</i>, then all <i>load-time-value</i> forms
appearing lexically within the function have already been pre-evaluated and will
                                                                          

                                                                          
not be evaluated again when the function is called.
<!--l. 600--><p class="indent" >   Implementations are free to classify every function as a <i>compiled-function</i>
provided that all functions satisfy the preceding requirements. Conversely, it is
permissible for a function that is not a <i>compiled-function</i> to satisfy the preceding
requirements.
<!--l. 606--><p class="indent" >   If one or more functions are deﬁned in a ﬁle that is compiled with <i>compile-ﬁle</i>
and the compiled ﬁle is subsequently loaded by the function <i>load</i>, the resulting
loaded function deﬁnitions must be of type <i>compiled-function</i>.
<!--l. 612--><p class="indent" >   The function <i>compile</i> must produce an object of type <i>compiled-function</i> as the
value that is either returned or stored into the <i>symbol-function</i> of a symbol
argument.
<!--l. 616--><p class="indent" >   Note that none of these restrictions addresses questions of the compilation
technology or target instruction set. For example, a compiled function does not
necessarily consist of native machine instructions. These requirements merely
specify the behavior of the type system with respect to certain actions taken by
<i>compile</i>, <i>compile-ﬁle</i>, and <i>load</i>.
</div>
<div class=newer>
   <h4 class="subsectionHead"><span class="titlemark">25.1.3   </span> <a 
 id="x157-22700025.1.3"></a>Compilation Environment</h4>
<!--l. 626--><p class="noindent" >X3J13 voted in June 1989 ⟨<b>?</b>⟩ to specify what information must be available at
compile time for correct compilation and what need not be available until run
time.
<!--l. 631--><p class="indent" >   The following information must be present in the compile-time environment
for a program to be compiled correctly. This information need not also be present
in the run-time environment.
      <ul class="itemize1">
      <li class="itemize">In conforming code, macros referenced in the code being compiled must
      have been previously deﬁned in the compile-time environment. The
      compiler must treat as a function call any form that is a list whose car
      is a symbol that does not name a macro or special form. (This implies
      that <i>setf </i> methods must also be available at compile time.)
      </li>
      <li class="itemize">In conforming code, proclamations for <i>special</i> variables must be made
                                                                          

                                                                          
      in the compile-time environment before any bindings of those variables
      are processed by the compiler. The compiler must treat any binding of
      an undeclared variable as a lexical binding.</li></ul>
<!--l. 650--><p class="indent" >   The compiler may incorporate the following kinds of information into the code
it produces, if the information is present in the compile-time environment and is
referenced within the code being compiled; however, the compiler is not
required to do so. When compile-time and run-time deﬁnitions diﬀer, it
is unspeciﬁed which will prevail within the compiled code (unless some
other behavior is explicitly speciﬁed below). It is also permissible for an
implementation to signal an error at run time on detecting such a discrepancy.
In all cases, the absence of the information at compile time is not an
error, but its presence may enable the compiler to generate more eﬃcient
code.
      <ul class="itemize1">
      <li class="itemize">The compiler may assume that functions that are deﬁned and declared
      <i>inline</i> in the compile-time environment will retain the same deﬁnitions
      at run time.
      </li>
      <li class="itemize">The compiler may assume that, within a named function, a recursive
      call to a function of the same name refers to the same function, unless
      that function has been declared <i>notinline</i>. (This permits tail-recursive
      calls of a function to itself to be compiled as jumps, for example, thereby
      turning certain recursive schemas into eﬃcient loops.)
      </li>
      <li class="itemize">In the absence of <i>notinline</i> declarations to the contrary, <i>compile-ﬁle</i>
      may assume that a call within the ﬁle being compiled to a named
      function that is deﬁned in that ﬁle refers to that function. (This rule
      permits  block compilation of  ﬁles.)  The  behavior  of  the  program  is
      unspeciﬁed if functions are redeﬁned individually at run time.
      </li>
      <li class="itemize">The compiler may assume that the signature (or “interface contract”)
      of all built-in Common Lisp functions will not change. In addition, the
      compiler may treat all built-in Common Lisp functions as if they had
      been proclaimed <i>inline</i>.
                                                                          

                                                                          
      </li>
      <li class="itemize">The compiler may assume that the signature (or “interface contract”)
      of functions with <i>ftype</i> information available will not change.
      </li>
      <li class="itemize">The compiler may “wire in”  (that is, open-code or inline) the values
      of symbolic constants that have been deﬁned with <i>defconstant</i> in the
      compile-time environment.
      </li>
      <li class="itemize">The compiler may assume that any type deﬁnition made with <i>defstruct</i>
      or  <i>deftype</i>  in  the  compile-time  environment  will  retain  the  same
      deﬁnition  in  the  run-time  environment.  It  may  also  assume  that  a
      class  deﬁned  by  <i>defclass</i>  in  the  compile-time  environment  will  be
      deﬁned  in  the  run-time  environment  in  such  a  way  as  to  have  the
      same superclasses and metaclass. This implies that subtype/supertype
      relationships of type speciﬁers will not change between compile time
      and run time. (Note that it is not an error for an unknown type to
      appear in a declaration at compile time, although it is reasonable for
      the compiler to emit a warning in such a case.)
      </li>
      <li class="itemize">The compiler may assume that if type declarations are present in the
      compile-time environment, the corresponding variables and functions
      present in the run-time environment will actually be of those types. If
      this assumption is violated, the run-time behavior of the program is
      undeﬁned.</li></ul>
<!--l. 713--><p class="indent" >   The compiler must not make any additional assumptions about consistency
between the compile-time and run-time environments. In particular, the compiler
may not assume that functions that are deﬁned in the compile-time environment
will retain either the same deﬁnition or the same signature at run time, except as
described above. Similarly, the compiler may not signal an error if it sees a call to
a function that is not deﬁned at compile time, since that function may be
provided at run time.
<!--l. 724--><p class="indent" >   X3J13 voted in January 1989 ⟨<b>?</b>⟩ to specify the compile-time side eﬀects of
processing various macro forms.
<!--l. 727--><p class="indent" >   Calls to deﬁning macros such as <i>defmacro</i> or <i>defvar</i> appearing within a ﬁle
being processed by <i>compile-ﬁle</i> normally have compile-time side eﬀects that aﬀect
                                                                          

                                                                          
how subsequent forms in the same ﬁle are compiled. A convenient model for
explaining how these side eﬀects happen is that each deﬁning macro expands into
one or more <i>eval-when</i> forms and that compile-time side eﬀects are caused
by calls occurring in the body of an <i>(eval-when (:compile-toplevel) ...)</i>
form.
<!--l. 736--><p class="indent" >   The aﬀected deﬁning macros and their speciﬁc side eﬀects are as follows. In
each case, it is identiﬁed what a user must do to ensure that a program is
conforming, and what a compiler must do in order to correctly process a
conforming program.
<div class=flushdesc>
<!--l. 742--><p class="indent" >
  <div><br /><b>
<i>deftype</i>                                                                   </b>
The  user  must  ensure  that  the  body  of  a  <i>deftype</i>  form  is  evaluable  at
compile time if the type is referenced in subsequent type declarations. The
compiler must ensure that a type speciﬁer deﬁned by <i>deftype</i> is recognized
in subsequent type declarations. If the expansion of a type speciﬁer is not
deﬁned fully at compile time (perhaps because it expands into an unknown
type speciﬁer or a <i>satisﬁes</i> of a named function that isn&#x2019;t deﬁned in the
compile-time environment), an implementation may ignore any references to
this type in declarations and may signal a warning.
  <br /><b>
<i>defmacro</i> and <i>deﬁne-modify-macro</i>                                        </b>
The  compiler  must  store  macro  deﬁnitions  at  compile  time,  so  that
occurrences of the macro later on in the ﬁle can be expanded correctly. The
user must ensure that the body of the macro is evaluable at compile time if
it is referenced within the ﬁle being compiled.
  <br /><b>
<i>defun</i>                                                                     </b>
No required compile-time side eﬀects are associated with <i>defun</i> forms. In
particular, <i>defun</i> does not make the function deﬁnition available at compile
time. An implementation may choose to store information about the function
for the purposes of compile-time error checking (such as checking the number
of arguments on calls) or to permit later <i>inline</i> expansion of the function.
                                                                          

                                                                          
  <br /><b>
<i>defvar</i> and <i>defparameter</i>                                                  </b>
The compiler must recognize that the variables named by these forms have
been proclaimed <i>special</i>. However, it must not evaluate the initial-value form
or <i>set</i> the variable at compile time.
  <br /><b>
<i>defconstant</i>                                                               </b>
The  compiler  must  recognize  that  the  symbol  names  a  constant.  An
implementation may choose to evaluate the value-form at compile time, load
time, or both. Therefore the user must ensure that the value-form is evaluable
at compile time (regardless of whether or not references to the constant
appear in the ﬁle) and that it always evaluates to the same value. (There
has been considerable variance among implementations on this point. The
eﬀect of this speciﬁcation is to legitimize all of the implementation variants
by requiring care of the user.)
  <br /><b>
<i>defsetf </i> and <i>deﬁne-setf-method</i>                                             </b>
The compiler must make <i>setf </i> methods available so that they may be used
to expand calls to <i>setf </i> later on in the ﬁle. Users must ensure that the body
of a call to <i>deﬁne-setf-method</i> or the complex form of <i>defsetf </i> is evaluable at
compile time if the corresponding place is referred to in a subsequent <i>setf </i>
in the same ﬁle. The compiler must make these <i>setf </i> methods available to
compile-time calls to <i>get-setf-method</i> when its environment argument is a
value received as the <i>&#x0026;environment</i> parameter of a macro.
  <br /><b>
<i>defstruct</i>                                                                  </b>
The compiler must make the structure type name recognized as a valid type
name in subsequent declarations (as described above for <i>deftype</i>) and make
the structure slot accessors known to <i>setf </i>. In addition, the compiler must save
enough information so that further <i>defstruct</i> deﬁnitions can include (with the
<i>:include</i> option) a structure type deﬁned earlier in the ﬁle being compiled.
The functions that <i>defstruct</i> generates are not deﬁned in the compile-time
environment, although the compiler may save enough information about the
functions to allow <i>inline</i> expansion of subsequent calls to these functions.
The <i>#S</i> reader syntax may or may not be available for that structure type
                                                                          

                                                                          
at compile time.
  <br /><b>
<i>deﬁne-condition</i>                                                           </b>
The  rules  are  essentially  the  same  as  those  for  <i>defstruct</i>.  The  compiler
must  make  the  condition  type  recognizable  as  a  valid  type  name,  and
it must be possible to reference the condition type as the parent-type of
another condition type in a subsequent <i>deﬁne-condition</i> form in the ﬁle being
compiled.
  <br /><b>
<i>defpackage</i>                                                                </b>
All of the actions normally performed by the <i>defpackage</i> macro at load time
must also be performed at compile time.</div>
</div>
<!--l. 825--><p class="indent" >   Compile-time side eﬀects may cause information about a deﬁnition to be
stored in a diﬀerent manner from information about deﬁnitions processed either
interpretively or by loading a compiled ﬁle. In particular, the information stored
by a deﬁning macro at compile time may or may not be available to the
interpreter (either during or after compilation) or during subsequent calls to
<i>compile</i> or <i>compile-ﬁle</i>. For example, the following code is not portable because it
assumes that the compiler stores the macro deﬁnition of <i>foo</i> where it is available
to the interpreter. <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro foo (x) <tt>‘</tt>(car ,x))
</td></tr></table>
<!--l. 837--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 838--><p class="indent" >                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(eval-when (:execute :compile-toplevel :load-toplevel)</td></tr></table>
<!--l. 839--><p class="indent" >                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (print (foo &#x2019;(a b c))))     ;Wrong</td></tr></table>
<!--l. 841--><p class="indent" >
</div>
</div>
<!--l. 842--><p class="noindent" >The goal may be accomplished portably by including the macro deﬁnition within the
<i>eval-when</i> form: <div class=lisp> <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(eval-when (eval compile load)
</td></tr></table>
<!--l. 845--><p class="indent" >                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (defmacro foo (x) <tt>‘</tt>(car ,x))</td></tr></table>
<!--l. 846--><p class="indent" >                                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (print (foo &#x2019;(a b c))))     ;Right</td></tr></table>
<!--l. 848--><p class="indent" >
</div>
</div>
<div class=flushdesc>
<!--l. 851--><p class="indent" >
  <div><br /><b>
<i>declaim</i>                                                                   </b>
<!--l. 853--><p class="indent" >  X3J13 voted in June 1989 ⟨<b>?</b>⟩ to add a new macro <i>declaim</i> for making
proclamations recognizable at compile time. The declaration speciﬁers in
the <i>declaim</i> form are eﬀectively proclaimed at compile time so as to aﬀect
compilation of subsequent forms. (Note that compiler processing of a call
to <i>proclaim</i> does not have any compile-time side eﬀects, for <i>proclaim</i> is a
function.)</div>
</div>
<div class=flushdesc>
<!--l. 864--><p class="indent" >
  <div><br /><b>
<i>in-package</i>                                                                </b>
<!--l. 866--><p class="indent" >  X3J13 voted in March 1989 ⟨<b>?</b>⟩ to specify that all of the actions normally
performed by the <i>in-package</i> macro at load time must also be performed at
compile time.</div>
</div>
<!--l. 871--><p class="indent" >   X3J13 voted in June 1989 ⟨<b>?</b>⟩ to specify the compile-time side eﬀects of
processing various CLOS-related macro forms. Top-level calls to the CLOS
deﬁning macros have the following compile-time side eﬀects; any other
compile-time behavior is explicitly left unspeciﬁed.
<div class=flushdesc>
<!--l. 878--><p class="indent" >
  <div><br /><b>
<i>defclass</i>                                                                   </b>
                                                                          

                                                                          
The class name may appear in subsequent type declarations and can be
used as a specializer in subsequent <i>defmethod</i> forms. Thus the compile-time
behavior of <i>defclass</i> is similar to that of <i>deftype</i> or <i>defstruct</i>.
  <br /><b>
<i>defgeneric</i>                                                                </b>
The generic function can be referenced in subsequent <i>defmethod</i> forms, but
the  compiler  does  not  arrange  for  the  generic  function  to  be  callable  at
compile time.
  <br /><b>
<i>defmethod</i>                                                                </b>
The compiler does not arrange for the method to be callable at compile
time. If there is a generic function with the same name deﬁned at compile
time, compiling a <i>defmethod</i> form does not add the method to that generic
function;  the  method  is  added  to  the  generic  function  only  when  the
<i>defmethod</i> form is actually executed.
<!--l. 896--><p class="indent" >  The error-signaling behavior described in the speciﬁcation of <i>defmethod</i> in
chapter <a 
href="clmch28.html#x182-26000028">28<!--tex4ht:ref: CLOS --></a> (if the function isn&#x2019;t a generic function or if the lambda-list is not
congruent) occurs only when the deﬁning form is executed, not at compile
time.
<!--l. 901--><p class="indent" >  The forms in <i>eql</i> parameter specializers are evaluated when the <i>defmethod</i>
form is executed. The compiler is permitted to build in knowledge about what
the form in an <i>eql</i> specializer will evaluate to in cases where the ultimate
result can be syntactically inferred without actually evaluating it.
  <br /><b>
<i>deﬁne-method-combination</i>                                                </b>
The method combination can be used in subsequent <i>defgeneric</i> forms.
<!--l. 910--><p class="indent" >  The  body  of  a  <i>deﬁne-method-combination</i> form  is  evaluated  no  earlier
than when the deﬁning macro is executed and possibly as late as generic
function invocation time. The compiler may attempt to evaluate these forms
at compile time but must not depend on being able to do so.</div>
</div>
</div>
<div class=newer>
                                                                          

                                                                          
<!--l. 921--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">25.1.4   </span> <a 
 id="x157-22800025.1.4"></a>Similarity of Constants</h4>
<!--l. 924--><p class="noindent" >X3J13 voted in March 1989 ⟨<b>?</b>⟩ to specify what objects can be in compiled
constants and what relationship there must be between a constant passed to the
compiler and the one that is established by compiling it and then loading its
ﬁle.
<!--l. 930--><p class="indent" >   The key is a deﬁnition of an equivalence relationship called “similarity as
constants” between Lisp objects. Code passed through the ﬁle compiler and then
loaded must behave as though quoted constants in it are similar in this sense to
quoted constants in the corresponding source code. An object may be used as a
quoted constant processed by <i>compile-ﬁle</i> if and only if the compiler can
guarantee that the resulting constant established by loading the compiled ﬁle is
“similar as a constant” to the original. Speciﬁc requirements are spelled out
below.
<!--l. 941--><p class="indent" >   Some types of objects, such as streams, are not supported in constants
processed by the ﬁle compiler. Such objects may not portably appear as constants
in code processed with <i>compile-ﬁle</i>. Conforming implementations are required to
handle such objects either by having the compiler or loader reconstruct an
equivalent copy of the object in some implementation-speciﬁc manner or by
having the compiler signal an error.
<!--l. 949--><p class="indent" >   Of the types supported in constants, some are treated as aggregate objects.
For these types, being similar as constants is deﬁned recursively. We say that an
object of such a type has certain “basic attributes”; to be similar as a constant to
another object, the values of the corresponding attributes of the two objects must
also be similar as constants.
<!--l. 956--><p class="indent" >   A deﬁnition of this recursive form has problems with any circular or inﬁnitely
recursive object such as a list that is an element of itself. We use the
idea of depth-limited comparison and say that two objects are similar as
constants if they are similar at all ﬁnite levels. This idea is implicit in
the deﬁnitions below, and it applies in all the places where attributes
of two objects are required to be similar as constants. The question of
handling circular constants is the subject of a separate vote by X3J13 (see
below).
<!--l. 965--><p class="indent" >   The following terms are used throughout this section. The term constant refers
to a quoted or self-evaluating constant, not a named constant deﬁned by
<i>defconstant</i>. The term source code is used to refer to the objects constructed when
<i>compile-ﬁle</i> calls <i>read</i> (or the equivalent) and to additional objects constructed by
macro expansion during ﬁle compilation. The term compiled code is used to refer
                                                                          

                                                                          
to objects constructed by <i>load</i>.
<!--l. 975--><p class="indent" >   Two objects are similar as a constant if and only if they are both of one of the
types listed below and satisfy the additional requirements listed for that
type.
<div class=flushdesc>
<!--l. 980--><p class="indent" >
  <div><br /><b>
<i>number</i>                                                                   </b>
<!--l. 982--><p class="indent" >  Two numbers are similar as constants if they are of the same type and
represent the same mathematical value.
  <br /><b>
<i>character</i>                                                                 </b>
<!--l. 987--><p class="indent" >  Two characters are similar as constants if they both represent the same
character. (The intent is that this be compatible with how <i>eql</i> is deﬁned on
characters.)
  <br /><b>
<i>symbol</i>                                                                    </b>X3J13
voted in June 1989 ⟨<b>?</b>⟩ to deﬁne similarity as a constant for interned symbols. A
symbol S appearing in the source code is similar as a constant to a symbol S′ in
the compiled code if their print names are similar as constants and either of the
following conditions holds:
     <ul class="itemize1">
     <li class="itemize">S is accessible in <i>*package*</i> at compile time and S′ is accessible in
     <i>*package*</i> at load time.
     </li>
     <li class="itemize">S′ is accessible in the package that is similar as a constant to the home
     package of symbol S.</li></ul>
<!--l. 1003--><p class="noindent" >The “similar as constants” relationship for interned symbols has nothing to do with
<i>*readtable*</i> or how the function <i>read</i> would parse the characters in the print name
of the symbol.
<!--l. 1007--><p class="indent" >  An uninterned symbol in the source code is similar as a constant to an
uninterned symbol in the compiled code if their print names are similar as
constants.
                                                                          

                                                                          
  <br /><b>
<i>package</i>                                                                   </b>
<!--l. 1013--><p class="indent" >  A package in the source code is similar as a constant to a package in the
compiled code if their names are similar as constants. Note that the loader ﬁnds
the corresponding package object as if by calling <i>ﬁnd-package</i> with the package
name as an argument. An error is signaled if no package of that name exists at
load time.
  <br /><b>
<i>random-state</i>                                                             </b>
<!--l. 1021--><p class="indent" >  We say that two <i>random-state</i> objects are functionally equivalent if applying
<i>random</i> to them repeatedly always produces the same pseudo-random numbers in
the same order.
<!--l. 1025--><p class="indent" >  Two random-states are similar as constants if and only if copies of them made
via <i>make-random-state</i> are functionally equivalent. (Note that a constant
<i>random-state</i> object cannot be used as the state argument to the function <i>random</i>
because <i>random</i> performs a side eﬀect on that argument.)
  <br /><b>
<i>cons</i>                                                                      </b>
<!--l. 1033--><p class="indent" >  Two conses are similar as constants if the values of their respective car and cdr
attributes are similar as constants.
  <br /><b>
<i>array</i>                                                                     </b>
<!--l. 1038--><p class="indent" >  Two arrays are similar as constants if the corresponding values of each of the
following attributes are similar as constants: for vectors (one-dimensional arrays),
the <i>length</i> and <i>element-type</i> and the result of <i>elt</i> for all valid indices; for all
other arrays, the <i>array-rank</i>, the result of <i>array-dimension</i> for all valid
axis numbers, the <i>array-element-type</i>, and the result of <i>aref </i> for all valid
indices. (The point of distinguishing vectors is to take any ﬁll pointers into
account.)
<!--l. 1047--><p class="indent" >  If the array in the source code is a <i>simple-array</i>, then the corresponding
array in the compiled code must also be a <i>simple-array</i>, but if the array
in the source code is displaced, has a ﬁll pointer, or is adjustable, the
corresponding array in the compiled code is permitted to lack any or all of these
qualities.
                                                                          

                                                                          
  <br /><b>
<i>hash-table</i>                                                                </b>
<!--l. 1055--><p class="indent" >  Two hash tables are similar as constants if they meet three requirements. First,
they must have the same test (for example, both are <i>eql</i> hash tables or both are
<i>equal</i> hash tables). Second, there must be a unique bijective correspondence
between the keys of the two tables, such that the corresponding keys are similar as
constants. Third, for all keys, the values associated with two corresponding keys
must be similar as constants.
<!--l. 1065--><p class="indent" >  If there is more than one possible one-to-one correspondence between
the keys of the two tables, it is unspeciﬁed whether the two tables are
similar as constants. A conforming program cannot use such a table as a
constant.
  <br /><b>
<i>pathname</i>                                                                 </b>
<!--l. 1072--><p class="indent" >  Two pathnames are similar as constants if all corresponding pathname
components are similar as constants.
  <br /><b>
<i>stream</i>, <i>readtable</i>, and <i>method</i>                                             </b>
<!--l. 1077--><p class="indent" >  Objects of these types are not supported in compiled constants.
  <br /><b>
<i>function</i>                                                                  </b>
<!--l. 1082--><p class="indent" >  X3J13 voted in June 1989 ⟨<b>?</b>⟩ to specify that objects of type <i>function</i> are not
supported in compiled constants.
  <br /><b>
<i>structure</i> and <i>standard-object</i>                                              </b>
<!--l. 1088--><p class="indent" >  X3J13 voted in March 1989 ⟨<b>?</b>⟩ to introduce a facility based on the Common
Lisp Object System whereby a user can specify how <i>compile-ﬁle</i> and <i>load</i> must
cooperate to reconstruct compile-time constant objects at load time (see
<i>make-load-form</i>).</div>
</div>
<!--l. 1095--><p class="indent" >   X3J13 voted in March 1989 ⟨<b>?</b>⟩ to specify the circumstances under which
constants may be coalesced in compiled code.
<!--l. 1098--><p class="indent" >   Suppose A and B are two objects used as quoted constants in the source code,
                                                                          

                                                                          
and that A′ and B′ are the corresponding objects in the compiled code. If A′ and
B′ are <i>eql</i> but A and B were not <i>eql</i>, then we say that A and B have been
coalesced by the compiler.
<!--l. 1104--><p class="indent" >   An implementation is permitted to coalesce constants appearing in code to be
compiled if and only if they are similar as constants, except that objects of type
<i>symbol</i>, <i>package</i>, <i>structure</i>, or <i>standard-object</i> obey their own rules and may not
be coalesced by a separate mechanism.
<div class=rationale>
<!--l. 1111--><p class="noindent" ><b>Rationale:</b> Objects of type <i>symbol</i> and <i>package</i> cannot be coalesced because the fact
that they are named, interned objects means they are already as coalesced as it is useful
for them to be. Uninterned symbols could perhaps be coalesced, but that was
thought to be more dangerous than useful. Structures and objects could be
coalesced if a “similar as a constant” predicate were deﬁned for them; it would be a
generic function. However, at present there is no such predicate. Currently
<i>make-load-form</i> provides a protocol by which <i>compile-ﬁle</i> and <i>load</i> work together
to construct an object in the compiled code that is equivalent to the object
in the source code; a diﬀerent mechanism would have to be added to permit
coalescing.
</div>
<!--l. 1126--><p class="indent" >   Note that coalescing is possible only because it is forbidden to destructively
modify constants ⟨<b>?</b>⟩ (see <i>quote</i>).
<!--l. 1129--><p class="indent" >   X3J13 voted in March 1989 ⟨<b>?</b>⟩ to specify that objects containing circular or
inﬁnitely recursive references may legitimately appear as constants to be
compiled. The compiler is required to preserve <i>eql</i>-ness of substructures within a
ﬁle compiled by <i>compile-ﬁle</i>.
</div>
<div class=obsolete>
                                                                          

                                                                          
   <!--l. 1137--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse128.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch25.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch25.html#tailclmch25.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse127.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch25.html#clmse127.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 1137--><p class="indent" >   <a 
 id="tailclmse127.html"></a>  
</body></html> 
