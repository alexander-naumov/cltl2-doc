<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Run-Time Evaluation of Forms</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-08 00:30:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 31--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse111.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch20.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch20.html#tailclmch20.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse110.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch20.html#clmse110.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">20.1   </span> <a 
 id="x135-26100020.1"></a>Run-Time Evaluation of Forms</h3>
<!--l. 33--><p class="noindent" >The function <a 
href="#x135-261002r620">eval</a> is the main user interface to the evaluator. Hooks are provided
for user-supplied debugging routines to obtain control during the execution of an
interpretive evaluator. The functions <a 
href="#x135-261011r623">evalhook</a> and <a 
href="#x135-261013r624">applyhook</a> provide
alternative interfaces to the evaluator mechanism for use by these debugging
routines.
<div class=defun>
<!--l. 39--><p class="noindent" ><i>[Function]</i><a 
 id="dx135-261001"></a><a 
 id="x135-261002r620"></a><b> eval</b>  <i>form</i>
<!--l. 41--><p class="noindent" >The form is evaluated in the current dynamic environment and a null lexical
                                                                          

                                                                          
environment. Whatever results from the evaluation is returned from the call to
<a 
href="#x135-261002r620">eval</a>.
<!--l. 46--><p class="indent" >   Note that when you write a call to <a 
href="#x135-261002r620">eval</a> two levels of evaluation occur on the
argument form you write. First the argument form is evaluated, as for arguments
to any function, by the usual argument evaluation mechanism (which involves an
implicit use of <a 
href="#x135-261002r620">eval</a>). Then the argument is passed to the <a 
href="#x135-261002r620">eval</a> function, where
another evaluation occurs. For example: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(eval (list &#x2019;cdr (car &#x2019;((quote (a . b)) c))))  ⇒ b
</td></tr></table>
<!--l. 55--><p class="indent" >
</div>
</div>
<!--l. 56--><p class="noindent" >The argument form (list &#x2019;cdr (car &#x2019;((quote (a . b)) c))) is evaluated in the usual way
to produce the argument (cdr (quote (a . b))); this is then given to <a 
href="#x135-261002r620">eval</a> because
<a 
href="#x135-261002r620">eval</a> is being called explicitly, and <a 
href="#x135-261002r620">eval</a> evaluates its argument (cdr (quote (a . b)))
to produce b.
<!--l. 61--><p class="indent" >   If all that is required for some application is to obtain the current dynamic
value of a given symbol, the function <a 
href="clmse35.html#x47-89005r55">symbol-value</a> may be more eﬃcient than
<a 
href="#x135-261002r620">eval</a>.
<div class=new>
<!--l. 66--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx135-261003"></a>to restrict user side eﬀects; see section <a 
href="clmse43.html#x55-1420007.9">7.9<!--tex4ht:ref: STRUCTURE-TRAVERSAL-SECTION --></a>.
</div>
</div>
<div class=defun>
<!--l. 72--><p class="noindent" ><i>[Variable]</i><a 
 id="dx135-261004"></a><a 
 id="x135-261005r621"></a><b> *evalhook*</b> <br 
class="newline" /><i>[Variable]</i><a 
 id="dx135-261006"></a><a 
 id="x135-261007r622"></a><b> *applyhook*</b>
<!--l. 75--><p class="noindent" >If the value of *evalhook* is not <a 
href="clmse31.html#x42-77002r19">nil</a>, then <a 
href="#x135-261002r620">eval</a> behaves in a special way. The
non-<a 
href="clmse31.html#x42-77002r19">nil</a> value of *evalhook* should be a function that takes two arguments, a form
and an environment; this is called the eval hook function. When a form is to be
evaluated (any form at all, even a number or a symbol), whether implicitly or via
an explicit call to <a 
href="#x135-261002r620">eval</a>, no attempt is made to evaluate the form. Instead, the hook
function is invoked and is passed the form to be evaluated as its ﬁrst argument.
The hook function is then responsible for evaluating the form; whatever is
returned by the hook function is assumed to be the result of evaluating the
form.
                                                                          

                                                                          
<!--l. 88--><p class="indent" >   The variable *applyhook* is similar to *evalhook* but is used when a function
is about to be applied to arguments. If the value of *applyhook* is not <a 
href="clmse31.html#x42-77002r19">nil</a>, then
<a 
href="#x135-261002r620">eval</a> behaves in a special way. <div class=obsolete> The non-<a 
href="clmse31.html#x42-77002r19">nil</a> value of *applyhook* should be a
function that takes three arguments: a function, a list of arguments, and an
environment; this is called the apply hook function.
</div>
<div class=new>
<!--l. 100--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx135-261008"></a>to revise the deﬁnition of *applyhook*.
Its value should be a function of two arguments, a function and a list
of arguments; no environment information is passed to an apply hook
function.
<!--l. 107--><p class="indent" >   This was simply a ﬂaw in the ﬁrst edition. Sorry about that.
</div>
<!--l. 110--><p class="indent" >   When a function is about to be applied to a list of arguments, no attempt is
made to apply the function. Instead, the hook function is invoked and is passed
the function and the list of arguments as its ﬁrst and second arguments. The hook
function is then responsible for evaluating the form; whatever is returned by the
hook function is assumed to be the result of evaluating the form. The apply hook
function is used only for application of ordinary functions within <a 
href="#x135-261002r620">eval</a>. It is not
used for applications via <a 
href="clmse37.html#x49-101002r77">apply</a> or <a 
href="clmse37.html#x49-101005r78">funcall</a>, for applications by such functions as
<a 
href="clmse82.html#x101-219005r407">map</a> or <a 
href="clmse82.html#x101-219021r413">reduce</a>, or for invocation of macro-expansion functions by either <a 
href="#x135-261002r620">eval</a> or
<a 
href="clmse47.html#x60-159002r138">macroexpand</a>.
<div class=newer>
<!--l. 124--><p class="indent" >   X3J13 voted in June 1988 <a 
 id="dx135-261009"></a>to specify that the value of <a 
href="clmse47.html#x60-159011r140">*macroexpand-hook*</a> is
ﬁrst coerced to a function before being called as the expansion interface hook.
This vote made no mention of *evalhook* or *applyhook*, but this may have been
an oversight.
<!--l. 130--><p class="indent" >   A proposal was submitted to X3J13 in September 1989 to specify
that the value of *evalhook* or *applyhook* is ﬁrst coerced to a function
before being called. If this proposal is accepted, the value of either variable
may be <a 
href="clmse31.html#x42-77002r19">nil</a>, any other symbol, a lambda-expression, or any object of type
<a 
href="clmse35.html#x47-88006r54">function</a>.
</div>
<!--l. 137--><p class="indent" >   The last argument passed to either kind of hook function contains information
about the lexical environment in an implementation-dependent format.
These arguments are suitable for the functions <a 
href="#x135-261011r623">evalhook</a>, <a 
href="#x135-261013r624">applyhook</a>, and
<a 
href="clmse47.html#x60-159002r138">macroexpand</a>.
<!--l. 142--><p class="indent" >   When either kind of hook function is invoked, both of the variables *evalhook*
                                                                          

                                                                          
and *applyhook* are rebound to the value <a 
href="clmse31.html#x42-77002r19">nil</a> around the invocation of the hook
function. This is so that the hook function will not be invoked recursively on
evaluations and applications that occur in the course of executing the code
of the hook function. The functions <a 
href="#x135-261011r623">evalhook</a> and <a 
href="#x135-261013r624">applyhook</a> are useful
for performing recursive evaluations and applications within the hook
function.
<!--l. 152--><p class="indent" >   The hook feature is provided as an aid to debugging. The <a 
href="clmse129.html#x159-327004r811">step</a> facility is
implemented using this hook.
<!--l. 155--><p class="indent" >   If a non-local exit causes a throw back to the top level of Lisp, perhaps
because an error could not be corrected, then *evalhook* and *applyhook* are
automatically reset to <a 
href="clmse31.html#x42-77002r19">nil</a> as a safety feature.
</div>
<div class=defun>
<!--l. 161--><p class="noindent" ><i>[Function]</i><a 
 id="dx135-261010"></a><a 
 id="x135-261011r623"></a><b> evalhook</b>  <i>form</i> <i>evalhookfn</i> <i>applyhookfn</i> &#x0026;optional  <i>env</i><br 
class="newline" /><i>[Function]</i><a 
 id="dx135-261012"></a><a 
 id="x135-261013r624"></a><b> applyhook</b>  <i>function</i> <i>args</i> <i>evalhookfn</i> <i>applyhookfn</i> &#x0026;optional
<i>env</i>
<!--l. 164--><p class="noindent" >The functions <a 
href="#x135-261011r623">evalhook</a> and <a 
href="#x135-261013r624">applyhook</a> are provided to make it easier to exploit
the hook feature.
<!--l. 168--><p class="indent" >   In the case of <a 
href="#x135-261011r623">evalhook</a>, the form is evaluated. In the case of <a 
href="#x135-261013r624">applyhook</a>, the
function is applied to the list of arguments args. In either case, for the duration of
the operation the variable *evalhook* is bound to evalhookfn, and *applyhook* is
bound to applyhookfn. Furthermore, the env argument is used as the lexical
environment for the operation; env defaults to the null environment. The check for
a hook function is bypassed for the evaluation of the form itself (for <a 
href="#x135-261011r623">evalhook</a>) or
for the application of the function to the args itself (for <a 
href="#x135-261013r624">applyhook</a>), but
not for subsidiary evaluations and applications such as evaluations of
subforms. It is this one-shot bypass that makes <a 
href="#x135-261011r623">evalhook</a> and <a 
href="#x135-261013r624">applyhook</a> so
useful.
<div class=new>
<!--l. 185--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx135-261014"></a>to eliminate the optional env parameter to
<a 
href="#x135-261013r624">applyhook</a>, because it is not (and cannot) be useful. Any function that can be
applied carries its own environment and does not need another environment to be
speciﬁed separately. This was a ﬂaw in the ﬁrst edition.
</div>
<!--l. 195--><p class="indent" >   Here is an example of a very simple tracing routine that uses just the <a 
href="#x135-261011r623">evalhook</a>
feature. <div class=lisp> <div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defvar *hooklevel* 0)
</td></tr></table>
<!--l. 198--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 199--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defun hook (x)</td></tr></table>
<!--l. 200--><p class="indent" >                                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((*evalhook* &#x2019;eval-hook-function))</td></tr></table>
<!--l. 201--><p class="indent" >                                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (eval x)))</td></tr></table>
<!--l. 202--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 203--><p class="indent" >                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defun eval-hook-function (form &#x0026;rest env)</td></tr></table>
<!--l. 204--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((*hooklevel* (+ *hooklevel* 1)))</td></tr></table>
<!--l. 205--><p class="indent" >                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (format *trace-output* &#x0022;~%~V@TForm:  ~S&#x0022;</td></tr></table>
<!--l. 206--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">            (* *hooklevel* 2) form)</td></tr></table>
<!--l. 207--><p class="indent" >                                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (let ((values (multiple-value-list</td></tr></table>
<!--l. 208--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                     (evalhook form</td></tr></table>
<!--l. 209--><p class="indent" >                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                               #&#x2019;eval-hook-function</td></tr></table>
<!--l. 210--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                               <a 
href="clmse31.html#x42-77002r19">nil</a></td></tr></table>
<!--l. 211--><p class="indent" >                               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                               env))))</td></tr></table>
<!--l. 212--><p class="indent" >                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (format *trace-output* &#x0022;~%~V@TValue:~{ ~S~}&#x0022;</td></tr></table>
<!--l. 213--><p class="indent" >                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">              (* *hooklevel* 2) values)</td></tr></table>
<!--l. 214--><p class="indent" >                                               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (values-list values))))</td></tr></table>
<!--l. 216--><p class="indent" >
</div>
</div>
<!--l. 217--><p class="noindent" >Using these routines, one might see the following interaction: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(hook &#x2019;(cons (ﬂoor *print-base* 2) &#x2019;b))
</td></tr></table>
<!--l. 219--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  Form: (CONS (FLOOR *PRINT-BASE* 2) (QUOTE B))</td></tr></table>
<!--l. 220--><p class="indent" >                                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    Form: (FLOOR *PRINT-BASE* 3)</td></tr></table>
<!--l. 221--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      Form: *PRINT-BASE*</td></tr></table>
<!--l. 222--><p class="indent" >                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      Value: 10</td></tr></table>
<!--l. 223--><p class="indent" >                                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      Form: 3</td></tr></table>
<!--l. 224--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      Value: 3</td></tr></table>
<!--l. 225--><p class="indent" >                                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    Value: 3 1</td></tr></table>
<!--l. 226--><p class="indent" >                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    Form: (QUOTE B)</td></tr></table>
<!--l. 227--><p class="indent" >                                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    Value: B</td></tr></table>
<!--l. 228--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  Value: (3 . B)</td></tr></table>
                                                                          

                                                                          
<!--l. 229--><p class="indent" >                                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(3 . B)</td></tr></table>
<!--l. 231--><p class="indent" >
</div>
</div>
</div>
<div class=defun>
<!--l. 234--><p class="noindent" ><i>[Function]</i><a 
 id="dx135-261015"></a><a 
 id="x135-261016r625"></a><b> constantp</b>  <i>object</i>
<!--l. 236--><p class="noindent" >If the predicate <a 
href="#x135-261016r625">constantp</a> is true of an object, then that object, when considered
as a form to be evaluated, always evaluates to the same thing; it is a constant.
This includes self-evaluating objects such as numbers, characters, strings,
bit-vectors, and keywords, as well as all constant symbols declared by <a 
href="clmse30.html#x40-71006r16">defconstant</a>,
such as <a 
href="clmse31.html#x42-77002r19">nil</a>, <a 
href="clmse31.html#x42-77004r20">t</a>, and <a 
href="clmse70.html#x87-204025r244">pi</a>. In addition, a list whose car is <a 
href="clmse35.html#x47-87002r53">quote</a>, such as (quote foo), is
considered to be a constant.
<!--l. 248--><p class="indent" >   If <a 
href="#x135-261016r625">constantp</a> is false of an object, then that object, considered as a form, might
or might not always evaluate to the same thing.
</div>
                                                                          

                                                                          
   <!--l. 253--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse111.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch20.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch20.html#tailclmch20.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse110.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch20.html#clmse110.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 253--><p class="indent" >   <a 
 id="tailclmse110.html"></a>  
</body></html> 
