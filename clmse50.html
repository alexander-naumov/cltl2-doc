<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Environments</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-02-20 00:42:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 830--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmch9.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse49.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse49.html#tailclmse49.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse50.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse50.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">8.5   </span> <a 
 id="x63-1020008.5"></a>Environments</h3>
<!--l. 832--><p class="noindent" >X3J13 voted in June 1989 ⟨<b>?</b>⟩ to add some facilities for obtaining information
from environment objects of the kind received as arguments by macro expansion
functions, <i>*macroexpand-hook*</i> functions, and <i>*evalhook*</i> functions. There is a
minimal set of accessors (<i>variable-information</i>, <i>function-information</i>, and
<i>declaration-information</i>) and a constructor (<i>augment-environment</i>) for
environments.
<!--l. 840--><p class="indent" >   All of the standard declaration speciﬁers, with the exception of <i>special</i>, can be
deﬁned fairly easily using <i>deﬁne-declaration</i>. It also seems to be able to handle
most extended declarations.
<!--l. 844--><p class="indent" >   The function <i>parse-macro</i> is provided so that users don&#x2019;t have to write their
own code to destructure macro arguments. This function is not entirely
necessary since X3J13 voted in March 1989 ⟨<b>?</b>⟩ to add <i>destructuring-bind</i>
to the language. However, <i>parse-macro</i> is worth having anyway, since
any program-analyzing program is going to need to deﬁne it, and the
implementation isn&#x2019;t completely trivial even with <i>destructuring-bind</i> to build
upon.
<!--l. 854--><p class="indent" >   The function <i>enclose</i> allows expander functions to be deﬁned in a non-null
lexical environment, as required by the vote of X3J13 in March 1989 ⟨<b>?</b>⟩. It also
provides a mechanism by which a program processing the body of an <i>(eval-when
(:compile-toplevel) ...)</i> form can execute it in the enclosing environment (see issue
⟨<b>?</b>⟩).
<!--l. 862--><p class="indent" >   In all of these functions the argument named env is an environment object. (It
is not required that implementations provide a distinguished representation for
such objects.) Optional env arguments default to <i>nil</i>, which represents the local
null lexical environment (containing only global deﬁnitions and proclamations
that are present in the run-time environment). All of these functions should signal
an error of type <i>type-error</i> if the value of an environment argument is not a
syntactic environment object.
<!--l. 871--><p class="indent" >   The accessor functions <i>variable-information</i>, <i>function-information</i>, and
<i>declaration-information</i> retrieve information about declarations that are in eﬀect
                                                                          

                                                                          
in the environment. Since implementations are permitted to ignore declarations
(except for <i>special</i> declarations and <i>optimize safety</i> declarations if they ever
compile unsafe code), these accessors are required only to return information
about declarations that were explicitly added to the environment using
<i>augment-environment</i>. They might also return information about declarations
recognized and added to the environment by the interpreter or the compiler, but
that is at the discretion of the implementor. Implementations are also
permitted to canonicalize declarations, so the information returned by the
accessors might not be identical to the information that was passed to
<i>augment-environment</i>.
<div class=defun>
<!--l. 885--><p class="noindent" > <i>[Function]</i>   <b>variable-information</b> <a 
 id="dx63-102001"></a><a 
 id="x63-102002r145"></a>   <i>variable</i>  <b>&#x0026;optional</b>  <i>env</i>
<!--l. 887--><p class="noindent" >This function returns information about the interpretation of the symbol variable
when it appears as a variable within the lexical environment env. Three values are
returned.
<!--l. 892--><p class="indent" >   The ﬁrst value indicates the type of deﬁnition or binding for variable in env:
<div class=indentdesc>
                <div><br /><b>
<i>nil</i>             </b>There is no apparent deﬁnition or binding for variable.
                <br /><b>
<i>:special</i>         </b>The variable refers to a special variable, either declared or
                proclaimed.
                <br /><b>
<i>:lexical</i>         </b>The variable refers to a lexical variable.
                <br /><b>
<i>:symbol-macro</i>  </b>The variable refers to a <i>symbol-macrolet</i> binding.
                <br /><b>
<i>:constant</i>       </b>Either the variable refers to a named constant deﬁned by
                <i>defconstant</i> or the variable is a keyword symbol.</div>
</div>
<!--l. 912--><p class="indent" >   The second value indicates whether there is a local binding of the name. If the
name is locally bound, the second value is true; otherwise, the second value is
<i>nil</i>.
                                                                          

                                                                          
<!--l. 916--><p class="indent" >   The third value is an a-list containing information about declarations that
apply to the apparent binding of the variable. The keys in the a-list are symbols
that name declaration speciﬁers, and the format of the corresponding value in the
cdr of each pair depends on the particular declaration name involved. The
standard declaration names that might appear as keys in this a-list are:
<div class=indentdesc>
                <div><br /><b>
<i>dynamic-extent</i> </b>A non-<i>nil</i> value indicates that the variable has been declared
                <i>dynamic-extent</i>. If the value is <i>nil</i>, the pair might be omitted.
                <br /><b>
<i>ignore</i>          </b>A non-<i>nil</i> value indicates that the variable has been declared
                <i>ignore</i>. If the value is <i>nil</i>, the pair might be omitted.
                <br /><b>
<i>type</i>            </b>The value is a type speciﬁer associated with the variable
                by  a  <i>type</i> declaration  or  an  abbreviated  declaration  such
                as <i>(ﬁxnum variable)</i>. If no explicit association exists, either
                by <i>proclaim</i> or <i>declare</i>, then the type speciﬁer is <i>t</i>. It is
                permissible for implementations to use a type speciﬁer that
                is equivalent to or a supertype of the one appearing in the
                original  declaration.  If  the  value  is  <i>t</i>,  the  pair  might  be
                omitted.</div>
</div>
<!--l. 943--><p class="noindent" >If an implementation supports additional declaration speciﬁers that apply to variable
bindings, those declaration names might also appear in the a-list. However, the
corresponding key must not be a symbol that is external in any package deﬁned
in the standard or that is otherwise accessible in the <i>common-lisp-user</i>
package.
<!--l. 949--><p class="indent" >   The a-list might contain multiple entries for a given key. The consequences of
destructively modifying the list structure of this a-list or its elements (except
for values that appear in the a-list as a result of <i>deﬁne-declaration</i>) are
undeﬁned.
<!--l. 954--><p class="indent" >   Note that the global binding might diﬀer from the local one and can be
retrieved by calling <i>variable-information</i> with a null lexical environment.
</div>
<div class=defun>
                                                                          

                                                                          
<!--l. 959--><p class="noindent" > <i>[Function]</i>   <b>function-information</b> <a 
 id="dx63-102003"></a><a 
 id="x63-102004r146"></a>   <i>function</i>  <b>&#x0026;optional</b>  <i>env</i>
<!--l. 961--><p class="noindent" >This function returns information about the interpretation of the function-name
function when it appears in a functional position within lexical environment env.
Three values are returned.
<!--l. 966--><p class="indent" >   The ﬁrst value indicates the type of deﬁnition or binding of the function-name
which is apparent in env: <div class=indentdesc>
                <div><br /><b>
<i>nil</i>             </b>There is no apparent deﬁnition for function.
                <br /><b>
<i>:function</i>       </b>The function refers to a function.
                <br /><b>
<i>:macro</i>         </b>The function refers to a macro.
                <br /><b>
<i>:special-form</i>   </b>The function refers to a special form.</div>
</div>
<!--l. 977--><p class="noindent" >Some function-names can refer to both a global macro and a global special form. In
such a case the macro takes precedence and <i>:macro</i> is returned as the ﬁrst
value.
<!--l. 981--><p class="indent" >   The second value speciﬁes whether the deﬁnition is local or global. If local, the
second value is true; it is <i>nil</i> when the deﬁnition is global.
<!--l. 985--><p class="indent" >   The third value is an a-list containing information about declarations that
apply to the apparent binding of the function. The keys in the a-list are symbols
that name declaration speciﬁers, and the format of the corresponding values in the
cdr of each pair depends on the particular declaration name involved. The
standard declaration names that might appear as keys in this a-list are:
<div class=indentdesc>
                <div><br /><b>
<i>dynamic-extent</i> </b>A non-<i>nil</i> value indicates that the function has been declared
                <i>dynamic-extent</i>. If the value is <i>nil</i>, the pair might be omitted.
                <br /><b>
<i>inline</i>          </b>The value is one of the symbols <i>inline</i>, <i>notinline</i>, or <i>nil</i> to
                indicate whether the function-name has been declared <i>inline</i>,
                declared <i>notinline</i>, or neither, respectively. If the value is <i>nil</i>,
                the pair might be omitted.
                                                                          

                                                                          
                <br /><b>
<i>ftype</i>           </b>The   value   is   the   type   speciﬁer   associated   with   the
                function-name in the environment, or the symbol <i>function</i>
                if there is no functional type declaration or proclamation
                associated   with   the   function-name.   This   value   might
                not  include  all  the  apparent  <i>ftype</i>  declarations  for  the
                function-name. It is permissible for implementations to use
                a type speciﬁer that is equivalent to or a supertype of the
                one that appeared in the original declaration. If the value is
                <i>function</i>, the pair might be omitted.</div>
</div>
<!--l. 1014--><p class="noindent" >If an implementation supports additional declaration speciﬁers that apply to function
bindings, those declaration names might also appear in the a-list. However, the
corresponding key must not be a symbol that is external in any package deﬁned
in the standard or that is otherwise accessible in the <i>common-lisp-user</i>
package.
<!--l. 1020--><p class="indent" >   The a-list might contain multiple entries for a given key. In this case the
value associated with the ﬁrst entry has precedence. The consequences of
destructively modifying the list structure of this a-list or its elements (except
for values that appear in the a-list as a result of <i>deﬁne-declaration</i>) are
undeﬁned.
<!--l. 1027--><p class="indent" >   Note that the global binding might diﬀer from the local one and can be
retrieved by calling <i>function-information</i> with a null lexical environment.
</div>
<div class=defun>
<!--l. 1032--><p class="noindent" > <i>[Function]</i>   <b>declaration-information</b> <a 
 id="dx63-102005"></a><a 
 id="x63-102006r147"></a>   <i>decl-name</i>  <b>&#x0026;optional</b>  <i>env</i>
<!--l. 1034--><p class="noindent" >This function returns information about declarations named by the symbol
decl-name that are in force in the environment env. Only declarations that do not
apply to function or variable bindings can be accessed with this function. The
format of the information that is returned depends on the decl-name
involved.
<!--l. 1041--><p class="indent" >   It is required that this function recognize <i>optimize</i> and <i>declaration</i>
as decl-names. The values returned for these two cases are as follows:
<div class=indentdesc>
                <div><br /><b>
<i>optimize</i>        </b>A single value is returned, a list whose entries are of the
                form <i>(quality value)</i>, where quality is one of the standard
                                                                          

                                                                          
                optimization  qualities  (<i>speed</i>,  <i>safety</i>,  <i>compilation-speed</i>,
                <i>space</i>, <i>debug</i>) or some implementation-speciﬁc optimization
                quality,  and  value  is  an  integer  in  the  range  0  to
                3   (inclusive).   The   returned   list   always   contains   an
                entry  for  each  of  the  standard  qualities  and  for  each
                of  the  implementation-speciﬁc  qualities.  In  the  absence
                of  any  previous  declarations,  the  associated  values  are
                implementation-dependent. The list might contain multiple
                entries  for  a  quality,  in  which  case  the  ﬁrst  such  entry
                speciﬁes the current value. The consequences of destructively
                modifying this list or its elements are undeﬁned.
                <br /><b>
<i>declaration</i>     </b>A single value is returned, a list of the declaration names
                that have been proclaimed as valid through the use of the
                <i>declaration</i> proclamation. The consequences of destructively
                modifying this list or its elements are undeﬁned.</div>
</div>
<!--l. 1069--><p class="noindent" >If an implementation is extended to recognize additional declaration speciﬁers in
<i>declare</i> or <i>proclaim</i>, it is required that either the <i>declaration-information</i> function
should recognize those declarations also or the implementation should
provide a similar accessor that is specialized for that declaration speciﬁer. If
<i>declaration-information</i> is used to return the information, the corresponding
decl-name must not be a symbol that is external in any package deﬁned
in the standard or that is otherwise accessible in the <i>common-lisp-user</i>
package.
</div>
<div class=defun>
<!--l. 1079--><p class="noindent" > <i>[Function]</i>   <b>augment-environment</b> <a 
 id="dx63-102007"></a><a 
 id="x63-102008r148"></a>   <i>env</i>  <b>&#x0026;key</b>  :variable  :symbol-macro
:function  :macro  :declare
<!--l. 1081--><p class="noindent" >This function returns a new environment containing the information present in
env augmented with the information provided by the keyword arguments. It is
intended to be used by program analyzers that perform a code walk.
<!--l. 1086--><p class="indent" >   The arguments are supplied as follows. <div class=flushdesc>
  <div><br /><b>
<i>:variable</i>                                                                  </b>
The argument is a list of symbols that will be visible as bound variables in
                                                                          

                                                                          
the new environment. Whether each binding is to be interpreted as special
or lexical depends on <i>special</i> declarations recorded in the environment or
provided in the <i>:declare</i> argument.
  <br /><b>
<i>:symbol-macro</i>                                                            </b>
The  argument  is  a  list  of  symbol  macro  deﬁnitions,  each  of  the  form
<i>(name deﬁnition)</i>; that is, the argument is in the same format as the cadr
of  a  <i>symbol-macrolet</i> special  form.  The  new  environment  will  have  local
symbol-macro bindings of each symbol to the corresponding expansion, so
that <i>macroexpand</i> will be able to expand them properly. A type declaration
in the <i>:declare</i> argument that refers to a name in this list implicitly modiﬁes
the deﬁnition associated with the name. The eﬀect is to wrap a <i>the</i> form
mentioning the type around the deﬁnition.
  <br /><b>
<i>:function</i>                                                                 </b>
The argument is a list of function-names that will be visible as local function
bindings in the new environment.
  <br /><b>
<i>:macro</i>                                                                   </b>
The argument is a list of local macro deﬁnitions, each of the form <i>(name
deﬁnition)</i>. Note that the argument is not in the same format as the cadr of a
<i>macrolet</i> special form. Each deﬁnition must be a function of two arguments
(a form and an environment). The new environment will have local macro
bindings of each name to the corresponding expander function, which will be
returned by <i>macro-function</i> and used by <i>macroexpand</i>.
  <br /><b>
<i>:declare</i>                                                                   </b>
The  argument  is  a  list  of  declaration  speciﬁers.  Information  about
these declarations can be retrieved from the resulting environment using
<i>variable-information</i>, <i>function-information</i>, and <i>declaration-information</i>.</div>
</div>
<!--l. 1130--><p class="noindent" >The consequences of subsequently destructively modifying the list structure of any of
the arguments to this function are undeﬁned.
                                                                          

                                                                          
<!--l. 1134--><p class="indent" >   An error is signaled if any of the symbols naming a symbol macro in the
<i>:symbol-macro</i> argument is also included in the <i>:variable</i> argument. An error is
signaled if any symbol naming a symbol macro in the <i>:symbol-macro</i> argument is
also included in a <i>special</i> declaration speciﬁer in the <i>:declare</i> argument. An error
is signaled if any symbol naming a macro in the <i>:macro</i> argument is also included
in the <i>:function</i> argument. The condition type of each of these errors is
<i>program-error</i>.
<!--l. 1144--><p class="indent" >   The extent of the returned environment is the same as the extent of the
argument environment env. The result might share structure with env but env is
not modiﬁed.
<!--l. 1148--><p class="indent" >   While an environment argument received by an <i>*evalhook*</i> function is
permitted to be used as the environment argument to <i>augment-environment</i>, the
consequences are undeﬁned if an attempt is made to use the result of
<i>augment-environment</i> as the environment argument for <i>evalhook</i>. The
environment returned by <i>augment-environment</i> can be used only for syntactic
analysis, that is, as an argument to the functions deﬁned in this section and
functions such as <i>macroexpand</i>.
</div>
<div class=defmac>
<!--l. 1159--><p class="noindent" ><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Macro]</i><b> deﬁne-declaration </b> <a 
 id="dx63-102009"></a><a 
 id="x63-102010r149"></a>   decl-name lambda-list  {<i>form</i>}∗
</td></tr></table>
<!--l. 1160--><p class="indent" >
</div>
   This macro deﬁnes a handler for the named declaration. It is the mechanism
by which <i>augment-environment</i> is extended to support additional declaration
speciﬁers. The function deﬁned by this macro will be called with two arguments, a
declaration speciﬁer whose car is decl-name and the env argument to
<i>augment-environment</i>. This function must return two values. The ﬁrst value must
be one of the following keywords: <div class=indentdesc>
                <div><br /><b>
<i>:variable</i>        </b>The declaration applies to variable bindings.
                <br /><b>
<i>:function</i>       </b>The declaration applies to function bindings.
                                                                          

                                                                          
                <br /><b>
<i>:declare</i>        </b>The declaration does not apply to bindings.</div>
</div>
<!--l. 1173--><p class="noindent" >If the ﬁrst value is <i>:variable</i> or <i>:function</i> then the second value must be a list,
the elements of which are lists of the form <i>(binding-name key value)</i>. If
the corresponding information function (either <i>variable-information</i> or
<i>function-information</i>) is applied to the binding-name and the augmented
environment, the a-list returned by the information function as its third value will
contain the value under the speciﬁed key.
<!--l. 1181--><p class="indent" >   If the ﬁrst value is <i>:declare</i>, the second value must be a cons of the form
<i>(key . value)</i>. The function <i>declaration-information</i> will return value when
applied to the key and the augmented environment.
<i>
<!--l. 1186--><p class="indent" >   deﬁne-declaration</i> causes decl-name to be proclaimed to be a declaration; it is
as if its expansion included a call <i>(proclaim &#x2019;(declaration decl-name))</i>. As is the
case with standard declaration speciﬁers, the evaluator and compiler are
permitted, but not required, to add information about declaration speciﬁers
deﬁned with <i>deﬁne-declaration</i> to the macro expansion and <i>*evalhook*</i>
environments.
<!--l. 1194--><p class="indent" >   The consequences are undeﬁned if decl-name is a symbol that can appear as
the car of any standard declaration speciﬁer.
<!--l. 1197--><p class="indent" >   The consequences are also undeﬁned if the return value from a declaration
handler deﬁned with <i>deﬁne-declaration</i> includes a key name that is used by the
corresponding accessor to return information about any standard declaration
speciﬁer. (For example, if the ﬁrst return value from the handler is <i>:variable</i>, the
second return value may not use the symbols <i>dynamic-extent</i>, <i>ignore</i>, or <i>type</i> as
key names.)
<!--l. 1205--><p class="indent" >   The <i>deﬁne-declaration</i> macro does not have any special compile-time side
eﬀects (see section <a 
href="clmse127.html#x157-22400025.1">25.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
</div>
<div class=defun>
<!--l. 1209--><p class="noindent" > <i>[Function]</i>   <b>parse-macro</b> <a 
 id="dx63-102011"></a><a 
 id="x63-102012r150"></a>   <i>name</i>  <i>lambda-list</i>  <i>body</i>  <b>&#x0026;optional</b>  <i>env</i>
<!--l. 1211--><p class="noindent" >This function is used to process a macro deﬁnition in the same way as <i>defmacro</i>
and <i>macrolet</i>. It returns a lambda-expression that accepts two arguments, a form
and an environment. The name, lambda-list, and body arguments correspond to
the parts of a <i>defmacro</i> or <i>macrolet</i> deﬁnition.
<!--l. 1218--><p class="indent" >   The lambda-list argument may include <i>&#x0026;environment</i> and <i>&#x0026;whole</i> and may
                                                                          

                                                                          
include destructuring. The name argument is used to enclose the body in an
implicit <i>block</i> and might also be used for implementation-dependent purposes
(such as including the name of the macro in error messages if the form does not
match the lambda-list).
</div>
<div class=defun>
<!--l. 1226--><p class="noindent" > <i>[Function]</i>   <b>enclose</b> <a 
 id="dx63-102013"></a><a 
 id="x63-102014r151"></a>   <i>lambda-expression</i>  <b>&#x0026;optional</b>  <i>env</i>
<!--l. 1228--><p class="noindent" >This function returns an object of type <i>function</i> that is equivalent to
what would be obtained by evaluating <i><tt>`</tt>(function ,lambda-expression)</i>
in a syntactic environment env. The lambda-expression is permitted to
reference only the parts of the environment argument env that are relevant
only to syntactic processing, speciﬁcally declarations and the deﬁnitions
of macros and symbol macros. The consequences are undeﬁned if the
lambda-expression contains any references to variable or function bindings that are
lexically visible in env, any <i>go</i> to a tag that is lexically visible in env,
or any <i>return-from</i> mentioning a block name that is lexically visible in
env.
</div>
</div>
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
   <!--l. 6--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmch9.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse49.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse49.html#tailclmse49.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse50.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse50.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 6--><p class="indent" >   <a 
 id="tailclmse50.html"></a>  
</body></html> 
