<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Определение макроса</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-18 22:46:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 1293--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse46.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#tailclmch8.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse45.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse45.html" >Вверх</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">8.1   </span> <a 
 id="x58-1440008.1"></a>Определение макроса</h3>
<!--l. 1295--><p class="noindent" >Функция <a 
href="#x58-144002r117">macro-function</a> определяет, является ли данный символ именем
макроса. Конструкция <a 
href="#x58-144004r118">defmacro</a> предоставляет удобный способ определить
новый макрос.
<div class=defun>
<!--l. 1299--><p class="noindent" ><i>[Функция]</i><a 
 id="dx58-144001"></a><a 
 id="x58-144002r117"></a><b> macro-function</b>  <i>symbol</i> &#x0026;optional  <i>env</i>
<!--l. 1301--><p class="noindent" >Первый аргумент должен быть символом. Если символ содержит
определение функции, то есть определение макроса, локально созданное в
окружении <i>env</i> с помощью <a 
href="clmse39.html#x51-103006r79">macrolet</a> или глобально созданное с помощью
<a 
href="#x58-144004r118">defmacro</a>, тогда возвращается функция раскрытия (функция двух
аргументов, первый форма макровызова и второй — окружение). Если
символ не содержит определение функции, или это определение обычной
функции или это специальная форма, но не макрос, тогда возвращается <a 
href="clmse31.html#x42-74002r18">nil</a>.
Наилучший способ вызвать функцию раскрытия использовать <a 
href="clmse46.html#x59-146002r119">macroexpand</a>
или <a 
href="clmse46.html#x59-146004r120">macroexpand-1</a>.
<!--l. 1312--><p class="indent" >   Возможно такое, что и <a 
href="#x58-144002r117">macro-function</a>, и <a 
href="clmse35.html#x47-86015r58">special-operator-p</a> обе возвращают
истину для одного заданного символа. Так происходит, потому что
реализация может для увеличения производительности реализовывать любой
макрос, как специальную форму. С другой стороны, определения макросов
должны быть доступны для использования программами, которые
понимают только стандартные специальные формы, перечисленные в
                                                                          

                                                                          
таблице ??.
<!--l. 1320--><p class="indent" >   <a 
href="clmse36.html#x48-90002r64">setf</a> может быть использована с <a 
href="#x58-144002r117">macro-function</a> для установки в символ
глобального определения макроса: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(setf (macro-function <i>symbol</i>) <i>fn</i>)
</td></tr></table>
<!--l. 1324--><p class="indent" >
</div>
</div>
<!--l. 1325--><p class="noindent" >Устанавливаемое значение должно быть функцией, которая принимает два
аргументы, список макровызова и окружение, и вычислять раскрытие этого
макровызова. Выполнение этой операции указывает на то, что символ будет
содержать <i>только</i> это определение макроса в качестве определения
глобальной функции. Предыдущее определение функции или макроса
утрачивается. С помощью <a 
href="clmse36.html#x48-90002r64">setf</a> невозможно установить локальное определение
макроса. При использовании <a 
href="clmse36.html#x48-90002r64">setf</a> указание второго параметра (окружение)
является ошибкой. Переопределение специальной формы также является
ошибкой.
<!--l. 1334--><p class="indent" >   Смотрите также compiler-macro-function.
</div>
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> defmacro </b><a 
 id="dx58-144003"></a><a 
 id="x58-144004r118"></a> name lambda-list  [[ {declaration}*  | doc-string]]  { form}*
</td></tr></table>
<!--l. 1339--><p class="indent" >
</div>
<!--l. 1339--><p class="noindent" ><span class="paragraphHead"><a 
 id="x58-1450008.1"></a></span>
   <a 
href="#x58-144004r118">defmacro</a> является макросом определяющим макросы, которые
преобразуют формы макровызовов. <a 
href="#x58-144004r118">defmacro</a> имеет почти такой же
синтаксис, как и <a 
href="clmse30.html#x40-67002r13">defun</a>: <i>name</i> является символом, для которого создаётся
макрос, <i>lambda-list</i> похож на список параметров лямбда-выражения и <i>form</i>
                                                                          

                                                                          
содержит тело функции раскрытия. Конструкция <i>defmacro</i> устанавливает
функцию раскрытия, как глобальное определение макроса для символа
<i>name</i>. FIXME
<!--l. 1350--><p class="indent" >   Форма <a 
href="#x58-144004r118">defmacro</a> возвращает в качестве значение <i>name</i>.
<!--l. 1352--><p class="indent" >   Если мы рассмотрим макровызов, как список содержащий имя
функции и некоторые формы аргументов, то механизм заключается в
передаче в функцию <a 
href="clmse37.html#x49-95002r68">apply</a> этой функции и списка её (невычисленных)
аргументов. Спецификаторы параметров обрабатываются также, как и для
любого лямбда-выражения. В качестве параметров используются
формы аргументов макровызова. Затем вычисляются формы тела, как
неявный <a 
href="clmse38.html#x50-96002r71">progn</a>. Значение последней формы возвращается, как раскрытие
макровызова.
<!--l. 1360--><p class="indent" >   Если указана необязательная строка документации <i>doc-string</i>,
тогда она присоединяется к символу <i>name</i>, как строка документации
типа <a 
href="clmse35.html#x47-85002r52">function</a>. Смотрите <a 
href="clmse146.html#x179-417017r889">documentation</a>. Если в определении макроса
представлена только строка документации, и после неё нет ни одной
формы, ни деклараций, ни просто для тела, то данная строка сама
становиться формой, и тело считается состоящим из одной формы — этой
строки.
<!--l. 1367--><p class="indent" >   Следующие три дополнительных маркера доступны в определении
лямбда-списка. <div class=indentdesc>
      <ul><li><b>
&#x0026;body </b></li>
      <!--l. 1371--><p class="noindent" >Данный  маркер  эквивалентен  &#x0026;rest  маркеру,  но  дополнительно
      сообщает для функций вывода-форматирования и редактирования,
      что   оставшаяся   часть   формы   рассматривается   как   тело   и
      должна быть правильно отформатирована. (Можно использовать
      исключительно один маркер или &#x0026;body, или &#x0026;rest)
      <li><b>
&#x0026;whole </b></li>За  данным  маркером  указывается  одна  переменная,  которая
      будет связана со всей формой макровызова. Это значение, которое
      получает функция определения макроса в качестве своего первого
      аргумента. &#x0026;whole и следующая переменная должны указываться
      на первой позиции в лямбда-списке, перед другими параметрами
      или маркерами.
      <li><b>
                                                                          

                                                                          
&#x0026;environment </b></li>
      <!--l. 1385--><p class="noindent" >За данным маркером указывается одна переменная, которая будет
      связана с окружением, отображающим лексическое окружение, в
      котором произошёл макровызов. Это окружение может не быть
      полным  лексическим  окружением.  Оно  должно  использоваться
      только                 с                 функцией                 <a 
href="clmse46.html#x59-146002r119">macroexpand</a>
      ради  любых  локальных  определений  макросов,  которые  могли
      быть установлены с помощью <a 
href="clmse39.html#x51-103006r79">macrolet</a> конструкции внутри этого
      лексического окружения. Этот функционал полезен крайне редко,
      когда определение макроса должно явно раскрыть другие макросы
      в процессе своего раскрытия.</ul>
</div>
<!--l. 1395--><p class="indent" >   Смотрите <a 
href="clmse29.html#x39-65003r11">lambda-list-keywords</a>.
<!--l. 1397--><p class="indent" >   <a 
href="#x58-144004r118">defmacro</a>, в отличие от любых других конструкций Common
Lisp&#x2019;а, имеющих лямбда-списки в своём синтаксисе, предоставляет
дополнительную функциональность известную как <i>деструктуризация</i>. <div class=newer>
Смотрите <a 
href="clmse47.html#x60-147002r122">destructuring-bind</a>, которая отдельно предоставляет эту
функциональность.
</div> В любом месте, где могло бы стоять имя параметра, и где по синтаксису не
ожидается использование списка (как описано в разделе <a 
href="clmse29.html#x39-650005.2.2">5.2.2<!--tex4ht:ref: LAMBDA-EXPRESSIONS-SECTION --></a>), можно
использовать ещё один встроенный лямбда-список. Когда использован такой
приём, при передаче форм аргументов для встроенного лямбда-списка,
необходимо обернуть эти формы в отдельный список. В качестве
примера, определение макроса для <a 
href="clmse42.html#x54-122002r93">dolist</a> можно записать в таком стиле:
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform &#x0026;optional resultform)
</td></tr></table>
<!--l. 1412--><p class="indent" >                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  &#x0026;rest body)</td></tr></table>
<!--l. 1413--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1415--><p class="indent" >
</div>
</div>
<!--l. 1416--><p class="noindent" >Ниже будет больше примеров использования встраиваемых лямбда-списков в
<a 
href="#x58-144004r118">defmacro</a>.
                                                                          

                                                                          
<!--l. 1419--><p class="indent" >   Следующим правилом деструктуризации является то, что <a 
href="#x58-144004r118">defmacro</a>
позволяет любому лямбда-списку (верхнего уровня или встроенному) быть
dotted, заканчивающимся именем параметра. Такая ситуация обрабатывается
так, как будто имя параметра в конце списка, стоит после неявного маркера
&#x0026;rest. Например, уже показанное определение <a 
href="clmse42.html#x54-122002r93">dolist</a> может быть записано
так: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform &#x0026;optional resultform)
</td></tr></table>
<!--l. 1425--><p class="indent" >                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  . body)</td></tr></table>
<!--l. 1426--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1428--><p class="indent" >
</div>
</div>
<!--l. 1430--><p class="indent" >   Если компилятор встречает <a 
href="#x58-144004r118">defmacro</a>, он добавляет новый макрос в
окружение компиляции, и также функция раскрытия добавляется в
выходной файл. Таким образом новый макрос будет более быстрым во время
выполнения. Если необходимо избежать такого механизма, можно
использовать <a 
href="#x58-144004r118">defmacro</a> внутри конструкции <a 
href="clmse30.html#x40-71003r17">eval-when</a>.
<!--l. 1436--><p class="indent" >   <a 
href="#x58-144004r118">defmacro</a> может также использоваться для переопределения макроса
(например, для установки корректной версии определения вместо
некорректной), или для переопределения функции в макрос. Переопределение
специальной формы (смотрите таблицу ??) не допускается. Смотрите
<a 
href="clmse39.html#x51-103006r79">macrolet</a>, которая устанавливает определение макроса в замкнутом
лексическом области видимости.
<!--l. 1444--><p class="indent" >   Допустим, для примера, что необходимо реализовать условную
конструкцию аналогичную Fortran&#x2019;овскому арифметическому выражению
IF. (Это конечно требует определённого расширения воображения
и приостановки неверия.) Конструкция должна принимать четыре
формы: <i>test-value</i>, <i>neg-form</i>, <i>zero-form</i> и <i>pos-form</i>. В зависимости от того,
является ли <i>test-form</i> отрицательным, нулём или положительным
числом, для выполнения будет выбрана одна из трёх последних форм. С
использованием <a 
href="#x58-144004r118">defmacro</a>, определение этой конструкции может выглядеть
так: <div class=lisp><div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro arithmetic-if (test neg-form zero-form pos-form)
</td></tr></table>
<!--l. 1457--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 1458--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(let ((,var ,test))</td></tr></table>
<!--l. 1459--><p class="indent" >                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (cond ((&#x003C; ,var 0) ,neg-form)</td></tr></table>
<!--l. 1460--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             ((= ,var 0) ,zero-form)</td></tr></table>
<!--l. 1461--><p class="indent" >                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (t ,pos-form)))))</td></tr></table>
<!--l. 1463--><p class="indent" >
</div>
</div>
<!--l. 1464--><p class="noindent" >Необходимо отметить, что в данном определении используется функциональность
обратной кавычки (смотрите раздел <a 
href="clmse110.html#x137-25100022.1.3">22.1.3<!--tex4ht:ref: MACRO-CHARACTERS-SECTION --></a>). Также необходимо заметить, что
используется <a 
href="clmse53.html#x68-160006r136">gensym</a> для создания нового имени переменной. Это необходимо
для избежания конфликтов с другими переменными, которые могут
использоваться в формах <i>neg-form</i>, <i>zero-form</i> или <i>pos-form</i>.
<!--l. 1471--><p class="indent" >   Если форма выполняется интерпретатором, то определение функции для
символа arithmetic-if будет является макросом, с которым ассоциирована
функция двух аргументом эквивалентная данной <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(lambda (calling-form environment)
</td></tr></table>
<!--l. 1475--><p class="indent" >                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (declare (ignore environment))</td></tr></table>
<!--l. 1476--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
<!--l. 1477--><p class="indent" >                                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (list &#x2019;let</td></tr></table>
<!--l. 1478--><p class="indent" >                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">          (list (list &#x2019;var (cadr calling-form)))</td></tr></table>
<!--l. 1479--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">          (list &#x2019;cond</td></tr></table>
<!--l. 1480--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list (list &#x2019;&#x003C; var &#x2019;0) (caddr calling-form))</td></tr></table>
<!--l. 1481--><p class="indent" >              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list (list &#x2019;= var &#x2019;0) (cadddr calling-form))</td></tr></table>
<!--l. 1482--><p class="indent" >                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                (list &#x2019;t (ﬁfth calling-form))))))</td></tr></table>
<!--l. 1484--><p class="indent" >
</div>
</div>
<!--l. 1485--><p class="noindent" >Лямбда-выражение является результатом выполнения декларации <a 
href="#x58-144004r118">defmacro</a>.
Вызов <a 
href="clmse82.html#x102-203038r456">list</a> является (гипотетически) результатом макросимвола обратной
кавычки (‘) и связанной с ним запятой. Конкретная функция раскрытия
макроса может зависеть от реализации, например, она также может
содержать проверку на корректность входных аргументов в макровызове.
                                                                          

                                                                          
<!--l. 1491--><p class="indent" >   Теперь, если <a 
href="clmse105.html#x130-238002r581">eval</a> встретит <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(arithmetic-if (- x 4.0)
</td></tr></table>
<!--l. 1493--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               (- x)</td></tr></table>
<!--l. 1494--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               (error &#x0022;Strange zero&#x0022;)</td></tr></table>
<!--l. 1495--><p class="indent" >                                                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">               x)</td></tr></table>
<!--l. 1497--><p class="indent" >
</div>
</div>
<!--l. 1498--><p class="noindent" >то раскроет эту форму в <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((g407 (- x 4.0)))
</td></tr></table>
<!--l. 1500--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (cond ((&#x003C; g407 0) (- x))</td></tr></table>
<!--l. 1501--><p class="indent" >                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        ((= g407 0) (error &#x0022;Strange zero&#x0022;))</td></tr></table>
<!--l. 1502--><p class="indent" >                                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (t x)))</td></tr></table>
<!--l. 1504--><p class="indent" >
</div>
</div>
<!--l. 1505--><p class="noindent" >и <a 
href="clmse105.html#x130-238002r581">eval</a> выполнит полученную форму. (Сейчас должно быть понятно, что
функциональность обратной кавычки очень полезна для написания
макросов. Она используется для построения шаблона, возвращаемой
формы, с константными частями и частями для выполнения. Шаблон
представляет собой «картину» кода, с местами для заполнения выделенными
запятыми.)
<!--l. 1511--><p class="indent" >   Для улучшения примера мы можем сделать так, чтобы <i>pos-form</i> и
<i>zero-form</i> могли быть заменены на <a 
href="clmse31.html#x42-74002r18">nil</a> в результате раскрытия макроса.
Таким же образом действует и <a 
href="clmse136.html#x167-340002r835">if</a> опуская ветку <i>else</i> в случае истинности
условия. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro arithmetic-if (test neg-form
</td></tr></table>
<!--l. 1516--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                         &#x0026;optional zero-form pos-form)</td></tr></table>
<!--l. 1517--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((var (gensym)))</td></tr></table>
                                                                          

                                                                          
<!--l. 1518--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(let ((,var ,test))</td></tr></table>
<!--l. 1519--><p class="indent" >                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (cond ((&#x003C; ,var 0) ,neg-form)</td></tr></table>
<!--l. 1520--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             ((= ,var 0) ,zero-form)</td></tr></table>
<!--l. 1521--><p class="indent" >                                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (t ,pos-form)))))</td></tr></table>
<!--l. 1523--><p class="indent" >
</div>
</div>
<!--l. 1524--><p class="noindent" >Тогда можно записать <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(arithmetic-if (- x 4.0) (print x))
</td></tr></table>
<!--l. 1527--><p class="indent" >
</div>
</div>
<!--l. 1528--><p class="noindent" >и это раскроется в что-то вроде <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((g408 (- x 4.0)))
</td></tr></table>
<!--l. 1530--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (cond ((&#x003C; g408 0) (print x))</td></tr></table>
<!--l. 1531--><p class="indent" >                                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        ((= g408 0) nil)</td></tr></table>
<!--l. 1532--><p class="indent" >                                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (t nil)))</td></tr></table>
<!--l. 1534--><p class="indent" >
</div>
</div>
<!--l. 1535--><p class="noindent" >Результирующий код корректен, но некрасиво выглядит. Можно переписать
определение макроса для генерации лучшего кода, когда <i>pos-form</i> и
<i>zero-form</i> могут быть вообще опущены. Или же можно положиться на
реализацию Common Lisp&#x2019;а, которая возможно оптимизирует этот
код.
<!--l. 1541--><p class="indent" >   Деструктуризация является очень мощной функциональностью, которая
позволяет лямбда-списку в <a 
href="#x58-144004r118">defmacro</a> выразить сложную структуру
макровызова. Если не использовались ключевые символы лямбда-списка, то
он представляет собой просто список с некоторой степенью вложенности и
параметрами в качестве листьев. Структура макровызова должна иметь
такую же структуру списка. Например, рассмотрим следующее определение
макроса: <div class=lisp><div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro halibut ((mouth eye1 eye2)
</td></tr></table>
<!--l. 1548--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   ((ﬁn1 length1) (ﬁn2 length2))</td></tr></table>
<!--l. 1549--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   tail)</td></tr></table>
<!--l. 1550--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1552--><p class="indent" >
</div>
</div>
<!--l. 1553--><p class="noindent" >Теперь давайте рассмотрим макровызов: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
<!--l. 1555--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 1556--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 1558--><p class="indent" >
</div>
</div>
<!--l. 1559--><p class="noindent" >Все это приведёт к тому, что функция раскрытия получит следующие значения
для её параметров:
<div class="flushleft" 
>
<!--l. 1561--><p class="noindent" >
 <!--tex4ht:inline--><div class="tabular"><table width="100%"><tr><td align="left" >Parameter</td><td align="left" >Value              </td></tr><tr><td align="left" >mouth </td> <td align="left" >m</td>
</tr><tr><td align="left" >eye1        </td><td align="left" >(car eyes)         </td>
</tr><tr><td align="left" >eye2        </td><td align="left" >(cdr eyes)         </td>
</tr><tr><td align="left" >ﬁn1         </td><td align="left" >f1                   </td>
</tr><tr><td align="left" >length1    </td><td align="left" >(count-scales f1)</td>
</tr><tr><td align="left" >ﬁn2         </td><td align="left" >f2                   </td>
</tr><tr><td align="left" >length2    </td><td align="left" >(count-scales f2)</td>
</tr><tr><td align="left" >tail         </td><td align="left" >my-favorite-tail </td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr><td align="left" > </td></tr></table></div></div>
<!--l. 1577--><p class="noindent" >Следующий макровызов ошибочный, так как аргумента для параметра length1
не представлено: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
                                                                          

                                                                          
<!--l. 1580--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1) (f2 (count-scales f2)))</td></tr></table>
<!--l. 1581--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 1583--><p class="indent" >
</div>
</div>
<!--l. 1584--><p class="noindent" >Следующий макровызов также ошибочный, так как на месте предполагаемого
списка указан символ. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut my-favorite-head
</td></tr></table>
<!--l. 1587--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 1588--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 1590--><p class="indent" >
</div>
</div>
<!--l. 1591--><p class="noindent" >Тот факт, что значение переменной my-favorite-head может быть списком, не
имеет здесь значения. В макровызове структура должна совпадать с
лямбда-списком в определении.
<!--l. 1595--><p class="indent" >   Использование ключевых символов лямбда-списка предоставляет ещё
большую гибкость. Например, предположим, что удобно будет в функции
раскрытия обращаться к элементам списка, называемым cdmouth, eye1, and
eye2, как к head. Можно записать так: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro halibut ((&#x0026;whole head mouth eye1 eye2)
</td></tr></table>
<!--l. 1602--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   ((ﬁn1 length1) (ﬁn2 length2))</td></tr></table>
<!--l. 1603--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   tail)</td></tr></table>
<!--l. 1605--><p class="indent" >
</div>
</div>
<!--l. 1606--><p class="noindent" >Теперь рассмотрим такой же, как раньше, корректный макровызов: <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(halibut (m (car eyes) (cdr eyes))
</td></tr></table>
                                                                          

                                                                          
<!--l. 1608--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((f1 (count-scales f1)) (f2 (count-scales f2)))</td></tr></table>
<!--l. 1609--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         my-favorite-tail)</td></tr></table>
<!--l. 1611--><p class="indent" >
</div>
</div>
<!--l. 1612--><p class="noindent" >Это приведёт к тому, что функции раскрытия получит те же значения для своих
параметров, а также значение для параметра head:
<div class="flushleft" 
>
<!--l. 1614--><p class="noindent" >
 <!--tex4ht:inline--><div class="tabular"><table width="100%"><tr><td align="left" >Parameter</td><td align="left" >Value                         </td></tr><tr><td align="left" >head </td> <td align="left" >(m (car eyes) (cdr eyes))</td></tr><tr 
class="hline"><td><hr></td><td><hr></td></tr><tr><td align="left" > </td></tr></table>
</div></div>
<!--l. 1624--><p class="indent" >   Существует условие для деструктуризации, встроенный лямбда-список
разрешён только на позиции, где синтаксис лямбда-списка предусматривает
имя параметра, но не список. Это защищает от двусмысленности. Например,
нельзя записать <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional (a b &#x0026;rest c) &#x0026;rest z)
</td></tr></table>
<!--l. 1628--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1630--><p class="indent" >
</div>
</div>
<!--l. 1631--><p class="noindent" >потому что синтаксис лямбда-списка не позволяет использовать списки
после &#x0026;optional. Список (a b &#x0026;rest c) был бы интерпретирован как
необязательный параметр a, у которого значение по умолчанию b, и
supplied-p параметр с некорректным именем &#x0026;rest, и дополнительным
символом c, также некорректным. Было бы правильнее выразить это так:
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional ((a b &#x0026;rest c)) &#x0026;rest z)
</td></tr></table>
<!--l. 1637--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1639--><p class="indent" >
                                                                          

                                                                          
</div>
</div>
<!--l. 1640--><p class="noindent" >Дополнительные круглые скобки устраняют двусмысленность. Однако, такой
макровызов, как (loser (car pool)) не предоставляет никакой формы
аргумента для лямбда-списка (a b &#x0026;rest c), значит значение по умолчанию
для него будет <a 
href="clmse31.html#x42-74002r18">nil</a>. А так как <a 
href="clmse31.html#x42-74002r18">nil</a> является пустым списком, то этот
макровызов ошибочен. Полностью корректное определение выглядит так:
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional ((a b &#x0026;rest c) &#x2019;(nil nil)) &#x0026;rest z)
</td></tr></table>
<!--l. 1646--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1648--><p class="indent" >
</div>
</div>
<!--l. 1649--><p class="noindent" >или так <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro loser (x &#x0026;optional ((&#x0026;optional a b &#x0026;rest c)) &#x0026;rest z)
</td></tr></table>
<!--l. 1651--><p class="indent" >                                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ...)</td></tr></table>
<!--l. 1653--><p class="indent" >
</div>
</div>
<!--l. 1654--><p class="noindent" >Они слегка отличаются: первое определение требует, что если макровызов явно
указывает a, тогда он должен указать явно и b, тогда как второе определение
не содержит такого требования. Например, <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(loser (car pool) ((+ x 1)))
</td></tr></table>
<!--l. 1659--><p class="indent" >
</div>
</div>
<!--l. 1660--><p class="noindent" >будет корректным макровызовом для второго определения, но не для
первого.
</div>
                                                                          

                                                                          
   <!--l. 1663--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse46.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#tailclmch8.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse45.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html#clmse45.html" >Вверх</a><tt>&#x003E;</tt></p></div>
<!--l. 1663--><p class="indent" >   <a 
 id="tailclmse45.html"></a>  
</body></html> 
