<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>8 Macros</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-01 16:01:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 6--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse46.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse45.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse45.html#tailclmse45.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmch8.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clm.html#clmch8.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h2 class="chapterHead"><span class="titlemark">Chapter 8</span><br /><a 
 id="x58-970008"></a>Macros</h2>
<!--l. 10--><p class="noindent" >The Common Lisp macro facility allows the user to deﬁne arbitrary functions that
convert certain Lisp forms into diﬀerent forms before evaluating or compiling
them. This is done at the expression level, not at the character-string level as in
most other languages. Macros are important in the writing of good code: they
make it possible to write code that is clear and elegant at the user level but
that is converted to a more complex or more eﬃcient internal form for
execution.
<!--l. 19--><p class="indent" >   When <a 
href="clmse110.html#x135-180002r620">eval</a> is given a list whose <i>car</i> is a symbol, it looks for local deﬁnitions of
that symbol (by <a 
href="clmse39.html#x51-83030r93">ﬂet</a>, <a 
href="clmse39.html#x51-83032r94">labels</a>, and <a 
href="clmse39.html#x51-83034r95">macrolet</a>); if that fails, it looks for a global
deﬁnition. If the deﬁnition is a macro deﬁnition, then the original list is said to be
a <i>macro call</i>. Associated with the deﬁnition will be a function of two
arguments, called the <i>expansion function</i>. This function is called with the
entire macro call as its ﬁrst argument (the second argument is a lexical
environment); it must return some new Lisp form, called the <i>expansion</i>
of the macro call. (Actually, a more general mechanism is involved; see
<a 
href="clmse47.html#x60-99002r138">macroexpand</a>.) This expansion is then evaluated in place of the original
form.
<!--l. 33--><p class="indent" >   When a function is being compiled, any macros it contains are expanded at
compilation time. This means that a macro deﬁnition must be seen by the
compiler before the ﬁrst use of the macro.
<!--l. 37--><p class="indent" >   More generally, an implementation of Common Lisp has great latitude in
deciding exactly when to expand macro calls within a program. For example, it is
acceptable for the <a 
href="clmse30.html#x40-66002r13">defun</a> special form to expand all macro calls within its body at
the time the <a 
href="clmse30.html#x40-66002r13">defun</a> form is executed and record the fully expanded body as the
body of the function being deﬁned. (An implementation might even choose always
to compile functions deﬁned by <a 
href="clmse30.html#x40-66002r13">defun</a>, even when operating in an “interpretive”
mode.)
<!--l. 46--><p class="indent" >   Macros should be written so as to depend as little as possible on the execution
environment to produce a correct expansion. To ensure consistent behavior, it is
best to ensure that all macro deﬁnitions are available, whether to the
interpreter or compiler, before any code containing calls to those macros is
introduced.
<!--l. 52--><p class="indent" >   In Common Lisp, macros are not functions. In particular, macros cannot be
used as functional arguments to such functions as <a 
href="clmse37.html#x49-81002r77">apply</a>, <a 
href="clmse37.html#x49-81005r78">funcall</a>, or <a 
href="clmse82.html#x101-143005r407">map</a>; in such
situations, the list representing the “original macro call” does not exist, and
                                                                          

                                                                          
cannot exist, because in some sense the arguments have already been
evaluated.
   <div class="sectionTOCS">
    <span class="sectionToc" >8.1 <a 
href="clmse46.html#x59-980008.1">Macro Deﬁnition</a></span>
<br />    <span class="sectionToc" >8.2 <a 
href="clmse47.html#x60-990008.2">Macro Expansion</a></span>
<br />    <span class="sectionToc" >8.3 <a 
href="clmse48.html#x61-1000008.3">Destructuring</a></span>
<br />    <span class="sectionToc" >8.4 <a 
href="clmse49.html#x62-1010008.4">Compiler Macros</a></span>
<br />    <span class="sectionToc" >8.5 <a 
href="clmse50.html#x63-1020008.5">Environments</a></span>
   </div>




                                                                          

                                                                          
   <!--l. 6--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse46.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse45.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse45.html#tailclmse45.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clm.html#clmch8.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 6--><p class="indent" >   <a 
 id="tailclmch8.html"></a>  
</body></html> 
