<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>8 Макросы</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-16 00:55:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 1171--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse45.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html#tailclmse44.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmch8.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clm.html#clmch8.html" >Наверх</a><tt>&#x003E;</tt></div><h2 class="chapterHead"><span class="titlemark">Глава 8</span><br /><a 
href="clm.html#QQ2-57-760" id="x57-7520008">Макросы</a></h2><div class="chapterTOCS">
    <span class="sectionToc" >8.1 <a 
href="clmse45.html#x58-7530008.1">Определение макроса</a></span>
<br />    <span class="sectionToc" >8.2 <a 
href="clmse46.html#x59-7980008.2">Раскрытие макроса</a></span>
<br />    <span class="sectionToc" >8.3 <a 
href="clmse47.html#x60-8010008.3">Деструктуризация</a></span>
<br />    <span class="sectionToc" >8.4 <a 
href="clmse48.html#x61-8030008.4">Compiler Macros</a></span>
<br />    <span class="sectionToc" >8.5 <a 
href="clmse49.html#x62-8090008.5">Environments</a></span>
   </div>
<!--l. 1174--><p class="indent" >   Функциональность макросов Common Lisp&#x2019;а позволяет пользователю
определять произвольные функции, которые преобразуют заданные Lisp&#x2019;овые
формы в другие формы, перед тем, как они будут вычислены или
скомпилированы. Это делается на уровне выражений, а не на уровне строк,
как в других языках. При написании хорошего кода макросы важны: они
предоставляют возможность писать код, которые ясен и элегантен на
пользовательском уровне, но после преобразования становится сложным или
более эффективным для выполнения.
<!--l. 1182--><p class="indent" >   Когда <tt><a 
href="clmse106.html#x131-1633002r580">eval</a></tt> получает список, у которого <i>car</i> элемент является символом,
она ищет локальные определения для этого символа (<tt><a 
href="clmse39.html#x51-599002r82">flet</a></tt>, <tt><a 
href="clmse39.html#x51-600002r83">labels</a></tt> и
<tt><a 
href="clmse39.html#x51-601002r84">macrolet</a></tt>). Если поиски не увенчались успехом, она ищет глобальное
определение. Если это глобальное определение является макросом, тогда
исходный список называется <i>макровызовом</i>. С определением будет
ассоциирована функция двух аргументов, называемая <i>функцией раскрытия</i>.
Эта функция вызывается с макровызовом в качестве первого аргумента и
лексическим окружением в качестве второго. Функция должна вернуть
новую Lisp&#x2019;овую форму, называемую <i>раскрытием</i> макровызова. (На
самом деле участвует более общий механизм, смотрите <tt><a 
href="clmse46.html#x59-798002r125">macroexpand</a></tt>.)
Затем это раскрытие выполняется по месту оригинальной (исходной)
формы.
<!--l. 1194--><p class="indent" >   Когда функция компилируется, все макросы, в ней содержащиеся,
раскрываются во время компиляции. Это значит, что определение макроса
должно быть прочитано компилятором до его первого использования.
<!--l. 1198--><p class="indent" >   В целом, реализация Common Lisp&#x2019;а имеет большую свободу в выборе
того, когда в программе раскрываются макровызовы. Например, допускается
для специальной формы <tt><a 
href="clmse30.html#x40-261002r13">defun</a></tt> раскрытие всех внутренних макровызовов
в время выполнения формы <tt><a 
href="clmse30.html#x40-261002r13">defun</a></tt> и записи полностью раскрытого
тела функции, как определение данной функции для дальнейшего
использования. (Реализация может даже выбрать путь, все время
                                                                          

                                                                          
компилировать функции определённые с помощью <tt><a 
href="clmse30.html#x40-261002r13">defun</a></tt>, даже в режиме
«интерпретации».)
<!--l. 1207--><p class="indent" >   Для правильного раскрытия макросы должны быть написаны так, чтобы
иметь наименьшие зависимости от выполняемого окружения. Лучше всего
удостовериться, что все определения макросов доступны перед тем, как
компилятор или интерпретатор будет обрабатывает код, содержащий
макровызовы к ним.
<!--l. 1212--><p class="indent" >   В Common Lisp, макросы не являются функциями. В частности, макросы
не могут использоваться, как функциональные аргументы к таким
функциям, как <tt><a 
href="clmse37.html#x49-568002r73">apply</a></tt>, <tt><a 
href="clmse37.html#x49-575002r74">funcall</a></tt> или <tt><a 
href="clmse78.html#x97-1210002r373">map</a></tt>. В таких ситуациях список,
отображающий «первоначальный макровызов» не существует и не может
существовать, потому что в некотором смысле аргументы уже были
вычислены.





                                                                          

                                                                          
   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse45.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse44.html#tailclmse44.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch8.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clm.html#clmch8.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmch8.html"></a>  </div> </div> 
</body></html> 
