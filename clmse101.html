<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Как использовать defstruct</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-16 23:44:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 1332--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse102.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse100.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse100.html#tailclmse100.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse101.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch19.html#clmse101.html" >Наверх</a><tt>&#x003E;</tt></div><h3 class="sectionHead"><span class="titlemark">19.2   </span> <a 
href="clm.html#QQ2-125-1777" id="x125-174700019.2">Как использовать
defstruct</a></h3>
<!--l. 1334--><p class="noindent" >Все структуры определяются с помощью конструкции <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt>. Вызов
<tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> определяет новый тип данных, экземпляры которого содержат
именованные слоты.
<div class="defmac">
<div class="defmacheader">
<!--l. 1339--><p class="indent" >   <div class="tabbing">
 <i>[Макрос]</i><b> defstruct </b> <a 
 id="dx125-1747001"></a><a 
 id="x125-1747002r583"></a> name-and-options [doc-string] {slot-description}+
   <br>
<!--l. 1340--><p class="noindent" ></div>
<!--l. 1340--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-174800019.2" id="x125-174800019.2"></a></span>
</div>
<!--l. 1341--><p class="indent" >   Этот макрос определяет структурный тип данных. Обычно вызов
<tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> выглядит как следующий пример. <div class="lisp"><div class="tabbing">
(defstruct (<i>name</i> <i>option-1</i> <i>option-2</i> ... <i>option-m</i>)
   <br>                                                                            <i>doc-string</i><br>
           <i>slot-description-1</i><br>                         <i>slot-description-2</i><br>
           ...<br>                                       <i>slot-description-n</i>)<br>
<br>
<!--l. 1350--><p class="noindent" ></div>
<!--l. 1350--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-174900019.2" id="x125-174900019.2"></a></span>
                                                                          

                                                                          
<!--l. 1350--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-175000019.2" id="x125-175000019.2"></a></span>
</div>
<!--l. 1351--><p class="indent" >   Имя структуры <i>name</i> должно быть символом. Он становиться именем
нового типа данных, который включает в себя все экземпляры данной
структуры. Соответственно функция <tt><a 
href="clmli7.html#x196-3479962r962">typep</a></tt> будет принимать и использовать
это имя. Имя структуры <i>name</i> возвращается как значение формы
<i>defstruct</i>.
<div class="new">
<!--l. 1356--><p class="noindent" >X3J13 voted in June 1988 <a 
 id="dx125-1750001"></a>to allow a <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> deﬁnition to have no
<i>slot-description</i> at all; in other words, the occurrence of {<i><i>slot-description</i></i>}+ in
the preceding header line would be replaced by  {<i><i>slot-description</i></i>}* .
<!--l. 1364--><p class="indent" >   Such structure deﬁnitions are particularly useful if the <tt>:include</tt> option is
used, perhaps with other options; for example, one can have two structures
that are exactly alike except that they print diﬀerently (having diﬀerent
<tt>:print-function</tt> options).
<!--l. 1369--><p class="indent" >   Implementors are encouraged to permit this simple extension as soon as
convenient. Users, however, may wish to maximize portability of their code by
avoiding the use of this extension unless and until it is adopted as part of the
ANSI standard.
</div>
<!--l. 1375--><p class="indent" >   Обычно опции не нужны. Если они не заданы, то после слова <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt>
вместо <tt>(<i>name</i>)</tt> можно записать просто <i>name</i> . Синтаксис опций и их смысл
раскрываются в разделе <a 
href="clmse104.html#x128-176900019.5">19.5<!--tex4ht:ref: DEFSTRUCT-OPTIONS --></a>.
<!--l. 1379--><p class="indent" >   Если присутствует необязательная строка документации <i>doc-string</i>, тогда
она присоединяется к символу <i>name</i>, как документация для типа <tt>structure</tt>.
Смотрите <tt><a 
href="clmli7.html#x196-3479344r344">documentation</a></tt>.
<!--l. 1383--><p class="indent" >   Каждое описание слота <i>slot-description-j</i> выглядит так: <div class="lisp"><div class="tabbing">
(<i>slot-name</i> <i>default-init</i>
   <br>                                       <i>slot-option-name-1</i> <i>slot-option-value-1</i><br>
     <i>slot-option-name-2</i> <i>slot-option-value-2</i><br>                            ...<br>
     <i>slot-option-name-k<span class="math"><sub>j</sub></span></i> <i>slot-option-value-k<span class="math"><sub>j</sub></span></i>)<br>
<!--l. 1390--><p class="noindent" ></div>
<!--l. 1390--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-175100019.2" id="x125-175100019.2"></a></span>
                                                                          

                                                                          
<!--l. 1390--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-175200019.2" id="x125-175200019.2"></a></span>
</div>
<!--l. 1391--><p class="indent" >   Каждое имя слота <i>slot-name</i> должно быть символом. Для каждого слота
определяется функция доступа. Если опции и первоначальные значения не
указаны, тогда в качестве описания слота вместо <tt>(slot-name)</tt> можно
записать просто <i>slot-name</i>.
<!--l. 1396--><p class="indent" >   Форма <i>default-init</i> вычисляется, только если соответствующий аргумент не
указан при вызове функций-конструкторов. <i>default-init</i> вычисляется
<i>каждый раз</i>, когда необходимо получить первоначальное значение для
слота.
<!--l. 1401--><p class="indent" >   Если <i>default-init</i> не указано, тогда первоначальное значение слота не
определено и зависит от реализации. Доступные опции для слотов разобраны
в разделе <a 
href="clmse103.html#x127-176600019.4">19.4<!--tex4ht:ref: Defstruct-Slot-Options --></a>.
<div class="new">
<!--l. 1406--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx125-1752001"></a>to specify that it is an error for two slots to
have the same name; more precisely, no two slots may have names for
whose print names <tt><a 
href="clmli7.html#x196-3479907r907">string=</a></tt> would be true. Under this interpretation
<div class="lisp"><div class="tabbing">
(defstruct lotsa-slots slot slot)
   <br>
<!--l. 1414--><p class="noindent" ></div>
<!--l. 1414--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-175300019.2" id="x125-175300019.2"></a></span>
<!--l. 1414--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-175400019.2" id="x125-175400019.2"></a></span>
</div>
<!--l. 1415--><p class="indent" >   obviously is incorrect but the following one is also in error, even assuming that
the symbols <tt>coin:slot</tt> and <tt>blot:slot</tt> really are distinct (non-<tt><a 
href="clmli7.html#x196-3479368r368">eql</a></tt>) symbols:
<div class="lisp"><div class="tabbing">
(defstruct no-dice coin:slot blot:slot)
   <br>
                                                                          

                                                                          
<!--l. 1420--><p class="noindent" ></div>
<!--l. 1420--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-175500019.2" id="x125-175500019.2"></a></span>
<!--l. 1420--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-175600019.2" id="x125-175600019.2"></a></span>
</div>
<!--l. 1421--><p class="indent" >   To illustrate another case, the ﬁrst <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> form below is correct, but the
second one is in error. <div class="lisp"><div class="tabbing">
(defstruct one-slot slot)
   <br>                                    (defstruct (two-slots (:include one-slot)) slot)<br>
<!--l. 1426--><p class="noindent" ></div>
<!--l. 1426--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-175700019.2" id="x125-175700019.2"></a></span>
<!--l. 1426--><p class="noindent" ><span class="paragraphHead"><a 
href="#x125-175800019.2" id="x125-175800019.2"></a></span>
</div>
<div class="rationale">
<!--l. 1429--><p class="noindent" ><b>Обоснование:</b> Print names are the criterion for slot-names being the same, rather
than the symbols themselves, because <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> constructs names of accessor
functions from the print names and interns the resulting new names in the current
package.
</div>
<!--l. 1437--><p class="indent" >   X3J13 recommended that expanding a <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> form violating this
restriction should signal an error and noted, with an eye to the Common Lisp
Object System <a 
 id="dx125-1758001"></a>, that the restriction applies only to the operation of the
<tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> macro as such and not to the <tt>structure-class</tt> or structures deﬁned
with <tt><a 
href="clmli7.html#x196-3479303r303">defclass</a></tt>.
</div>
<div class="newer">
<!--l. 1447--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx125-1758002"></a>to clarify that, while deﬁning forms normally
appear at top level, it is meaningful to place them in non-top-level contexts;
<tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> must treat slot <i>default-init</i> forms and any initialization forms within
                                                                          

                                                                          
the speciﬁcation of a by-position constructor function as occurring within the
enclosing lexical environment, not within the global environment.
</div>
<tt>
<!--l. 1458--><p class="indent" >   <a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> не только определяет функции доступа к слотам, но
также выполняет интеграцию с <tt><a 
href="clmli7.html#x196-3479840r840">setf</a></tt> для этих функций, определяет
предикат с именем <tt><i>name</i>-p</tt>, определяет функцию-конструктор с именем
<tt>make-<i>name</i></tt> и определяет функцию копирования с именем <tt>copy-<i>name</i></tt>. Все
имена автоматически создаваемых функций интернируются в текущий
пакет на время выполнения <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> (смотрите <tt><a 
href="clmli7.html#x196-3479023r23">*package*</a></tt>). Кроме
того, все эти функции могут быть задекларированы как <tt>inline</tt> на
усмотрение реализации для повышения производительности. Если вы не
хотите, чтобы функции были задекларированы как <tt>inline</tt>, укажите
декларацию <tt>notinline</tt> после формы <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> для перезаписи декларации
<tt>inline</tt>.
<div class="newer">
<!--l. 1472--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx125-1758003"></a>to specify that the results of redeﬁning a
<tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> structure (that is, evaluating more than one <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> structure for
the same name) are undeﬁned.
<!--l. 1477--><p class="indent" >   The problem is that if instances have been created under the old deﬁnition and
then remain accessible after the new deﬁnition has been evaluated, the accessors
and other functions for the new deﬁnition may be incompatible with the old
instances. Conversely, functions associated with the old deﬁnition may have been
declared <tt>inline</tt> and compiled into code that remains accessible after the new
deﬁnition has been evaluated; such code may be incompatible with the new
instances.
<!--l. 1485--><p class="indent" >   In practice this restriction aﬀects the development and debugging process
rather than production runs of fully developed code. The <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt> feature is
intended to provide “the most eﬃcient” structure class. CLOS classes
deﬁned by <tt><a 
href="clmli7.html#x196-3479303r303">defclass</a></tt> allow much more ﬂexible structures to be deﬁned and
redeﬁned.
<!--l. 1492--><p class="indent" >   Programming environments are allowed and encouraged to permit <tt><a 
href="clmli7.html#x196-3479318r318">defstruct</a></tt>
redeﬁnition, perhaps with warning messages about possible interactions with
other parts of the programming environment or memory state. It is beyond the
scope of the Common Lisp language standard to deﬁne those interactions except
to note that they are not portable.
</div>
</div>
                                                                          

                                                                          
                                                                          

                                                                          
<!--l. 1501--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse102.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse100.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse100.html#tailclmse100.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse101.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch19.html#clmse101.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse101.html"></a>   </div> </div> 
</body></html> 
