<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Macro Expansion</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-20 14:21:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="../cltl2ed.css"></head><body 
>
<!--l. 484--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse48.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html#tailclmse46.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse47.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="macro.html#clmse47.html" >Up</a><tt>&#x003E;</tt>&lt;<a href="../index.html">Main Page</a>&gt;</div><h3 class="sectionHead"><span class="titlemark">8.2   </span> <a 
href="clm.html#QQ2-60-790" id="x60-7810008.2">Macro Expansion</a></h3>
<!--l. 486--><p class="noindent" >The <tt><a 
href="symbols.html#x185-2637530r530">macroexpand</a></tt> function is the conventional means for expanding a macro call.
A hook is provided for a user function to gain control during the expansion
process.
<div class="defun">
<!--l. 490--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx60-781001"></a><a 
 id="x60-781002r127"></a> <b>macroexpand</b>  <i>form</i> <b>&#x0026;optional</b>  <i>env</i><br />
<i>
[Function]</i><a 
 id="dx60-781003"></a><a 
 id="x60-781004r128"></a> <b>macroexpand-1</b>  <i>form</i> <b>&#x0026;optional</b>  <i>env</i>
</div>
<!--l. 494--><p class="indent" >   If <i>form</i> is a macro call, then <tt><a 
href="symbols.html#x185-2637531r531">macroexpand-1</a></tt> will expand the macro call <i>once</i>
and return two values: the expansion and <tt><a 
href="symbols.html#x185-2637871r871">t</a></tt>. If <i>form</i> is not a macro call, then the
two values <i>form</i> and <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> are returned.
<!--l. 499--><p class="indent" >   A <i>form</i> is considered to be a macro call only if it is a cons whose <i>car</i> is a
symbol that names a macro. The environment <i>env</i> is similar to that used within
the evaluator (see <tt><a 
href="symbols.html#x185-2637345r345">evalhook</a></tt>); it defaults to a null environment. Any local macro
deﬁnitions established within <i>env</i> by <tt><a 
href="symbols.html#x185-2637532r532">macrolet</a></tt> will be considered. If only
<i>form</i> is given as an argument, then the environment is eﬀectively null,
and only global macro deﬁnitions (as established by <tt><a 
href="symbols.html#x185-2637284r284">defmacro</a></tt>) will be
considered.
<!--l. 509--><p class="indent" >   Macro expansion is carried out as follows. Once <tt><a 
href="symbols.html#x185-2637531r531">macroexpand-1</a></tt> has
determined that a symbol names a macro, it obtains the expansion function for
that macro. The value of the variable <tt><a 
href="symbols.html#x185-2637022r22">*macroexpand-hook*</a></tt> is then called as a
function of three arguments: the expansion function, the <i>form</i>, and the
environment <i>env</i>. The value returned from this call is taken to be the expansion of
the macro call. The initial value of <tt><a 
href="symbols.html#x185-2637022r22">*macroexpand-hook*</a></tt> is <tt><a 
href="symbols.html#x185-2637398r398">funcall</a></tt>, and the net
eﬀect is to invoke the expansion function, giving it <i>form</i> and <i>env</i> as its two
arguments.
<div class="newer">
<!--l. 521--><p class="indent" >   X3J13 voted in June 1988 <a 
 id="dx60-781005"></a>to specify that the value of <tt><a 
href="symbols.html#x185-2637022r22">*macroexpand-hook*</a></tt> is
ﬁrst coerced to a function before being called as the expansion interface hook.
Therefore its value may be a symbol, a lambda-expression, or any object of type
                                                                          

                                                                          
<tt><a 
href="symbols.html#x185-2637399r399">function</a></tt>.
</div>
<div class="newer">
<!--l. 529--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx60-781006"></a>to specify that macro environment objects
received by a <tt><a 
href="symbols.html#x185-2637022r22">*macroexpand-hook*</a></tt> function have only dynamic extent. The
consequences are undeﬁned if such objects are referred to outside the dynamic
extent of that particular invocation of the hook function. This allows
implementations to use somewhat more eﬃcient techniques for representing
environment objects.
</div>
<div class="newer">
<!--l. 539--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx60-781007"></a>to clarify that, while <tt><a 
href="symbols.html#x185-2637022r22">*macroexpand-hook*</a></tt>
may be useful for debugging purposes, despite the original design intent
there is currently no correct portable way to use it for caching macro
expansions.
      <ul class="itemize1">
      <li class="itemize">Caching by displacement (performing a side eﬀect on the macro-call
      form) won&#x2019;t work because the same (<tt><a 
href="symbols.html#x185-2637337r337">eq</a></tt>) macro-call form may appear
      in distinct lexical contexts. In addition, the macro-call form may be a
      read-only constant (see <tt><a 
href="symbols.html#x185-2637707r707">quote</a></tt> and also section <a 
href="clmse121.html#x150-198200024.1">24.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
      </li>
      <li class="itemize">Caching by table lookup won&#x2019;t work because such a table would have
      to be keyed by both the macro-call form and the environment, but
      X3J13 voted in March 1989 <a 
 id="dx60-781008"></a>to permit macro environments to have only
      dynamic extent.
      </li>
      <li class="itemize">Caching  by  storing  macro-call  forms  and  expansions  within  the
      environment  object  itself  would  work,  but  there  are  no  portable
      primitives that would allow users to do this.</li></ul>
<!--l. 560--><p class="noindent" >X3J13 also noted that, although there seems to be no correct portable way to use
<tt><a 
href="symbols.html#x185-2637022r22">*macroexpand-hook*</a></tt> to cache macro expansions, there is no requirement that an
implementation call the macro expansion function more than once for a given
form and lexical environment.
</div>
<div class="new">
                                                                          

                                                                          
<!--l. 567--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx60-781009"></a>to specify that <tt><a 
href="symbols.html#x185-2637531r531">macroexpand-1</a></tt> will also
expand symbol macros deﬁned by <tt><a 
href="symbols.html#x185-2637864r864">symbol-macrolet</a></tt>; therefore a <i>form</i>
may also be a macro call if it is a symbol. The vote did not address the
interaction of this feature with the <tt><a 
href="symbols.html#x185-2637022r22">*macroexpand-hook*</a></tt> function. An obvious
implementation choice is that the hook function is indeed called and given a
special expansion function that, when applied to the <i>form</i> (a symbol) and <i>env</i>,
will produce the expansion, just as for an ordinary macro; but this is only my
suggestion.
</div>
<!--l. 579--><p class="indent" >   The evaluator expands macro calls as if through the use of <tt><a 
href="symbols.html#x185-2637531r531">macroexpand-1</a></tt>;
the point is that <tt><a 
href="symbols.html#x185-2637343r343">eval</a></tt> also uses <tt><a 
href="symbols.html#x185-2637022r22">*macroexpand-hook*</a></tt>.
<tt>
<!--l. 582--><p class="indent" >   <a 
href="symbols.html#x185-2637530r530">macroexpand</a></tt> is similar to <tt><a 
href="symbols.html#x185-2637531r531">macroexpand-1</a></tt>, but repeatedly expands <i>form</i> until
it is no longer a macro call. (In eﬀect, <tt><a 
href="symbols.html#x185-2637530r530">macroexpand</a></tt> simply calls <tt><a 
href="symbols.html#x185-2637531r531">macroexpand-1</a></tt>
repeatedly until the second value returned is <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>.) A second value of <tt><a 
href="symbols.html#x185-2637871r871">t</a></tt> or <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> is
returned as for <tt><a 
href="symbols.html#x185-2637531r531">macroexpand-1</a></tt>, indicating whether the original <i>form</i> was a macro
call.
</div>
<div class="defun">
<!--l. 590--><p class="noindent" ><div class="defunheader"> <i>[Variable]</i><a 
 id="dx60-781010"></a><a 
 id="x60-781011r129"></a> <b>*macroexpand-hook*</b>
</div>
<!--l. 593--><p class="indent" >   The value of <tt><a 
href="symbols.html#x185-2637022r22">*macroexpand-hook*</a></tt> is used as the expansion interface hook by
<tt><a 
href="symbols.html#x185-2637531r531">macroexpand-1</a></tt>.
</div>
                                                                          

                                                                          
<!--l. 597--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse48.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse46.html#tailclmse46.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse47.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="macro.html#clmse47.html" >Up</a><tt>&#x003E;</tt></div><a 
 id="tailclmse47.html"></a>  </div> </div> 
</body></html> 
