<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Run-Time Evaluation of Forms</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-20 16:10:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="../cltl2ed.css"></head><body 
>
<!--l. 32--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse108.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="eval.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="eval.html#taileval.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse107.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="eval.html#clmse107.html" >Up</a><tt>&#x003E;</tt>&lt;<a href="../index.html">Main Page</a>&gt;</div><h3 class="sectionHead"><span class="titlemark">20.1   </span> <a 
href="clm.html#QQ2-132-1586" id="x132-155600020.1">Run-Time Evaluation of Forms</a></h3>
<!--l. 34--><p class="noindent" >The function <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt> is the main user interface to the evaluator. Hooks are provided
for user-supplied debugging routines to obtain control during the execution of an
interpretive evaluator. The functions <tt><a 
href="symbols.html#x187-2636345r345">evalhook</a></tt> and <tt><a 
href="symbols.html#x187-2636082r82">applyhook</a></tt> provide
alternative interfaces to the evaluator mechanism for use by these debugging
routines.
<div class="defun">
<!--l. 40--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx132-1556001"></a><a 
 id="x132-1556002r586"></a> <b>eval</b>  <i>form</i>
</div>
<!--l. 43--><p class="indent" >   The <i>form</i> is evaluated in the current dynamic environment and a null lexical
environment. Whatever results from the evaluation is returned from the call to
                                                                          

                                                                          
<tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt>.
<!--l. 47--><p class="indent" >   Note that when you write a call to <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt> <i>two</i> levels of evaluation occur on the
argument form you write. First the argument form is evaluated, as for arguments
to any function, by the usual argument evaluation mechanism (which involves an
implicit use of <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt>). Then the argument is passed to the <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt> function, where
another evaluation occurs. For example: <div class="lisp"><div class="tabbing">
(eval (list &#x2019;cdr (car &#x2019;((quote (a . b)) c)))) <span class="math"> ⇒</span> b
   <br>
<!--l. 56--><p class="noindent" ></div>
<!--l. 56--><p class="noindent" ><span class="paragraphHead"><a 
href="#x132-155700020.1" id="x132-155700020.1"></a></span>
<!--l. 56--><p class="noindent" ><span class="paragraphHead"><a 
href="#x132-155800020.1" id="x132-155800020.1"></a></span>
</div>
<!--l. 57--><p class="indent" >   The argument form <tt>(list &#x2019;cdr (car &#x2019;((quote (a . b)) c)))</tt> is
evaluated in the usual way to produce the argument <tt>(cdr (quote (a .
b)))</tt>; this is then given to <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt> because <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt> is being called explicitly,
and <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt> evaluates its argument <tt>(cdr (quote (a . b)))</tt> to produce
<tt>b</tt>.
<!--l. 62--><p class="indent" >   If all that is required for some application is to obtain the current dynamic
value of a given symbol, the function <tt><a 
href="symbols.html#x187-2636868r868">symbol-value</a></tt> may be more eﬃcient than
<tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt>.
<div class="new">
<!--l. 67--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx132-1558001"></a>to restrict user side eﬀects; see section <a 
href="clmse43.html#x55-6760007.9">7.9<!--tex4ht:ref: STRUCTURE-TRAVERSAL-SECTION --></a>.
</div>
</div>
<div class="defun">
<!--l. 73--><p class="noindent" ><div class="defunheader"> <i>[Variable]</i><a 
 id="dx132-1558002"></a><a 
 id="x132-1558003r587"></a> <b>*evalhook*</b><br />
<i>
[Variable]</i><a 
 id="dx132-1558004"></a><a 
 id="x132-1558005r588"></a> <b>*applyhook*</b>
</div>
<!--l. 77--><p class="indent" >   If the value of <tt><a 
href="symbols.html#x187-2636015r15">*evalhook*</a></tt> is not <tt><a 
href="symbols.html#x187-2636609r609">nil</a></tt>, then <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt> behaves in a special way. The
                                                                          

                                                                          
non-<tt><a 
href="symbols.html#x187-2636609r609">nil</a></tt> value of <tt><a 
href="symbols.html#x187-2636015r15">*evalhook*</a></tt> should be a function that takes two arguments, a
form and an environment; this is called the <i>eval hook function</i>. When a form is to
be evaluated (any form at all, even a number or a symbol), whether implicitly or
via an explicit call to <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt>, no attempt is made to evaluate the form. Instead, the
hook function is invoked and is passed the form to be evaluated as its ﬁrst
argument. The hook function is then responsible for evaluating the form; whatever
is returned by the hook function is assumed to be the result of evaluating the
form.
<!--l. 89--><p class="indent" >   The variable <tt><a 
href="symbols.html#x187-2636005r5">*applyhook*</a></tt> is similar to <tt><a 
href="symbols.html#x187-2636015r15">*evalhook*</a></tt> but is used when a
function is about to be applied to arguments. If the value of <tt><a 
href="symbols.html#x187-2636005r5">*applyhook*</a></tt> is not
<tt><a 
href="symbols.html#x187-2636609r609">nil</a></tt>, then <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt> behaves in a special way.
<div class="new">
<!--l. 95--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx132-1558006"></a>to revise the deﬁnition of <tt><a 
href="symbols.html#x187-2636005r5">*applyhook*</a></tt>.
Its value should be a function of <i>two</i> arguments, a function and a list
of arguments; no environment information is passed to an apply hook
function.
<!--l. 102--><p class="indent" >   This was simply a ﬂaw in the ﬁrst edition. Sorry about that.
</div>
<!--l. 105--><p class="indent" >   When a function is about to be applied to a list of arguments, no attempt is
made to apply the function. Instead, the hook function is invoked and is passed
the function and the list of arguments as its ﬁrst and second arguments. The hook
function is then responsible for evaluating the form; whatever is returned by the
hook function is assumed to be the result of evaluating the form. The apply hook
function is used only for application of ordinary functions within <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt>. It is not
used for applications via <tt><a 
href="symbols.html#x187-2636081r81">apply</a></tt> or <tt><a 
href="symbols.html#x187-2636398r398">funcall</a></tt>, for applications by such functions as
<tt><a 
href="symbols.html#x187-2636556r556">map</a></tt> or <tt><a 
href="symbols.html#x187-2636731r731">reduce</a></tt>, or for invocation of macro-expansion functions by either <tt><a 
href="symbols.html#x187-2636343r343">eval</a></tt> or
<tt><a 
href="symbols.html#x187-2636530r530">macroexpand</a></tt>.
<div class="newer">
<!--l. 119--><p class="indent" >   X3J13 voted in June 1988 <a 
 id="dx132-1558007"></a>to specify that the value of <tt><a 
href="symbols.html#x187-2636022r22">*macroexpand-hook*</a></tt> is
ﬁrst coerced to a function before being called as the expansion interface hook.
This vote made no mention of <tt><a 
href="symbols.html#x187-2636015r15">*evalhook*</a></tt> or <tt><a 
href="symbols.html#x187-2636005r5">*applyhook*</a></tt>, but this may have
been an oversight.
<!--l. 125--><p class="indent" >   A proposal was submitted to X3J13 in September 1989 to specify that the
value of <tt><a 
href="symbols.html#x187-2636015r15">*evalhook*</a></tt> or <tt><a 
href="symbols.html#x187-2636005r5">*applyhook*</a></tt> is ﬁrst coerced to a function before
being called. If this proposal is accepted, the value of either variable may
be <tt><a 
href="symbols.html#x187-2636609r609">nil</a></tt>, any other symbol, a lambda-expression, or any object of type
<tt><a 
href="symbols.html#x187-2636399r399">function</a></tt>.
</div>
                                                                          

                                                                          
<!--l. 132--><p class="indent" >   The last argument passed to either kind of hook function contains information
about the lexical environment in an implementation-dependent format.
These arguments are suitable for the functions <tt><a 
href="symbols.html#x187-2636345r345">evalhook</a></tt>, <tt><a 
href="symbols.html#x187-2636082r82">applyhook</a></tt>, and
<tt><a 
href="symbols.html#x187-2636530r530">macroexpand</a></tt>.
<!--l. 137--><p class="indent" >   When either kind of hook function is invoked, both of the variables
<tt><a 
href="symbols.html#x187-2636015r15">*evalhook*</a></tt> and <tt><a 
href="symbols.html#x187-2636005r5">*applyhook*</a></tt> are rebound to the value <tt><a 
href="symbols.html#x187-2636609r609">nil</a></tt> around the
invocation of the hook function. This is so that the hook function will not be
invoked recursively on evaluations and applications that occur in the course of
executing the code of the hook function. The functions <tt><a 
href="symbols.html#x187-2636345r345">evalhook</a></tt> and <tt><a 
href="symbols.html#x187-2636082r82">applyhook</a></tt>
are useful for performing recursive evaluations and applications within the hook
function.
<!--l. 147--><p class="indent" >   The hook feature is provided as an aid to debugging. The <tt><a 
href="symbols.html#x187-2636820r820">step</a></tt> facility is
implemented using this hook.
<!--l. 150--><p class="indent" >   If a non-local exit causes a throw back to the top level of Lisp, perhaps
because an error could not be corrected, then <tt><a 
href="symbols.html#x187-2636015r15">*evalhook*</a></tt> and <tt><a 
href="symbols.html#x187-2636005r5">*applyhook*</a></tt> are
automatically reset to <tt><a 
href="symbols.html#x187-2636609r609">nil</a></tt> as a safety feature.
</div>
<div class="defun">
<!--l. 156--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx132-1558008"></a><a 
 id="x132-1558009r589"></a> <b>evalhook</b>  <i>form</i> <i>evalhookfn</i> <i>applyhookfn</i> <b>&#x0026;optional</b>  <i>env</i><br />
<i>
[Function]</i><a 
 id="dx132-1558010"></a><a 
 id="x132-1558011r590"></a> <b>applyhook</b>  <i>function</i> <i>args</i> <i>evalhookfn</i> <i>applyhookfn</i> <b>&#x0026;optional</b>
<i>env</i>
</div>
<!--l. 160--><p class="indent" >   The functions <tt><a 
href="symbols.html#x187-2636345r345">evalhook</a></tt> and <tt><a 
href="symbols.html#x187-2636082r82">applyhook</a></tt> are provided to make it easier to
exploit the hook feature.
<!--l. 163--><p class="indent" >   In the case of <tt><a 
href="symbols.html#x187-2636345r345">evalhook</a></tt>, the <i>form</i> is evaluated. In the case of <tt><a 
href="symbols.html#x187-2636082r82">applyhook</a></tt>, the
<i>function</i> is applied to the list of arguments <i>args</i>. In either case, for the duration of
the operation the variable <tt><a 
href="symbols.html#x187-2636015r15">*evalhook*</a></tt> is bound to <i>evalhookfn</i>, and <tt><a 
href="symbols.html#x187-2636005r5">*applyhook*</a></tt>
is bound to <i>applyhookfn</i>. Furthermore, the <i>env</i> argument is used as the lexical
environment for the operation; <i>env</i> defaults to the null environment. The check
for a hook function is <i>bypassed</i> for the evaluation of the <i>form</i> itself (for <tt><a 
href="symbols.html#x187-2636345r345">evalhook</a></tt>)
or for the application of the <i>function</i> to the <i>args</i> itself (for <tt><a 
href="symbols.html#x187-2636082r82">applyhook</a></tt>), but
not for subsidiary evaluations and applications such as evaluations of
subforms. It is this one-shot bypass that makes <tt><a 
href="symbols.html#x187-2636345r345">evalhook</a></tt> and <tt><a 
href="symbols.html#x187-2636082r82">applyhook</a></tt> so
useful.
<div class="new">
                                                                          

                                                                          
<!--l. 180--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx132-1558012"></a>to eliminate the optional <i>env</i> parameter to
<tt><a 
href="symbols.html#x187-2636082r82">applyhook</a></tt>, because it is not (and cannot) be useful. Any function that can be
applied carries its own environment and does not need another environment to be
speciﬁed separately. This was a ﬂaw in the ﬁrst edition.
</div>
<!--l. 190--><p class="indent" >   Here is an example of a very simple tracing routine that uses just the
<tt><a 
href="symbols.html#x187-2636345r345">evalhook</a></tt> feature. <div class="lisp"><div class="tabbing">
(defvar *hooklevel* 0)
   <br>                                     <br>                                     (defun hook (x)<br>
  (let ((*evalhook* &#x2019;eval-hook-function))<br>                        (eval x)))<br>
<br>                               (defun eval-hook-function (form <tt>&#x0026;rest</tt> env)<br>
  (let ((*hooklevel* (+ *hooklevel* 1)))<br>
    (format *trace-output* &#x0022;~%~V@TForm:  ~S&#x0022;<br>
            (* *hooklevel* 2) form)<br>      (let ((values (multiple-value-list<br>
                     (evalhook form<br>
                               #&#x2019;eval-hook-function<br>
                               <tt><a 
href="symbols.html#x187-2636609r609">nil</a></tt><br>
                               env))))<br>
      (format *trace-output* &#x0022;~%~V@TValue:~{ ~S~}&#x0022;<br>
              (* *hooklevel* 2) values)<br>            (values-list values))))<br>
<!--l. 211--><p class="noindent" ></div>
<!--l. 211--><p class="noindent" ><span class="paragraphHead"><a 
href="#x132-155900020.1" id="x132-155900020.1"></a></span>
<!--l. 211--><p class="noindent" ><span class="paragraphHead"><a 
href="#x132-156000020.1" id="x132-156000020.1"></a></span>
</div>
<!--l. 212--><p class="indent" >   Using these routines, one might see the following interaction: <div class="lisp"><div class="tabbing">
(hook &#x2019;(cons (ﬂoor *print-base* 2) &#x2019;b))
   <br>                  Form: (CONS (FLOOR *PRINT-BASE* 2) (QUOTE B))<br>
    Form: (FLOOR *PRINT-BASE* 3)<br>           Form: *PRINT-BASE*<br>
                                                                          

                                                                          
      Value: 10<br>                    Form: 3<br>                    Value: 3<br>
    Value: 3 1<br>                                        Form: (QUOTE B)<br>
    Value: B<br>                                               Value: (3 . B)<br>
(3 . B)<br>
<!--l. 226--><p class="noindent" ></div>
<!--l. 226--><p class="noindent" ><span class="paragraphHead"><a 
href="#x132-156100020.1" id="x132-156100020.1"></a></span>
<!--l. 226--><p class="noindent" ><span class="paragraphHead"><a 
href="#x132-156200020.1" id="x132-156200020.1"></a></span>
</div>
</div>
<div class="defun">
<!--l. 229--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx132-1562001"></a><a 
 id="x132-1562002r591"></a> <b>constantp</b>  <i>object</i>
</div>
<!--l. 232--><p class="indent" >   If the predicate <tt><a 
href="symbols.html#x187-2636251r251">constantp</a></tt> is true of an object, then that object, when
considered as a form to be evaluated, always evaluates to the same thing; it is a
constant. This includes self-evaluating objects such as numbers, characters,
strings, bit-vectors, and keywords, as well as all constant symbols declared by
<tt><a 
href="symbols.html#x187-2636275r275">defconstant</a></tt>, such as <tt><a 
href="symbols.html#x187-2636609r609">nil</a></tt>, <tt><a 
href="symbols.html#x187-2636871r871">t</a></tt>, and <tt><a 
href="symbols.html#x187-2636668r668">pi</a></tt>. In addition, a list whose <i>car</i> is <tt><a 
href="symbols.html#x187-2636707r707">quote</a></tt>, such
as <tt>(quote foo)</tt>, is considered to be a constant.
<!--l. 243--><p class="indent" >   If <tt><a 
href="symbols.html#x187-2636251r251">constantp</a></tt> is false of an object, then that object, considered as a form,
might or might not always evaluate to the same thing.
</div>
                                                                          

                                                                          
<!--l. 248--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse108.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="eval.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="eval.html#taileval.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse107.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="eval.html#clmse107.html" >Up</a><tt>&#x003E;</tt></div><a 
 id="tailclmse107.html"></a>   </div> </div> 
</body></html> 
