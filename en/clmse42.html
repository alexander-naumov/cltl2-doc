<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Iteration</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-20 14:21:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="../cltl2ed.css"></head><body 
>
<!--l. 2732--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse43.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse41.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse41.html#tailclmse41.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse42.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="contrl.html#clmse42.html" >Up</a><tt>&#x003E;</tt>&lt;<a href="../index.html">Main Page</a>&gt;</div><h3 class="sectionHead"><span class="titlemark">7.8   </span> <a 
href="clm.html#QQ2-54-623" id="x54-6150007.8">Iteration</a></h3>
<a 
 id="dx54-615001"></a>
<!--l. 2735--><p class="noindent" >Common Lisp provides a number of iteration constructs. The <tt><a 
href="symbols.html#x185-2637522r522">loop</a></tt> construct
provides a trivial iteration facility; it is little more than a <tt><a 
href="symbols.html#x185-2637700r700">progn</a></tt> with a branch
from the bottom back to the top. The <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> and <tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt> constructs provide a general
iteration facility for controlling the variation of several variables on each cycle. For
specialized iterations over the elements of a list or <i>n</i> consecutive integers,
<tt><a 
href="symbols.html#x185-2637317r317">dolist</a></tt> and <tt><a 
href="symbols.html#x185-2637318r318">dotimes</a></tt> are provided. The <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> construct is the most
general, permitting arbitrary <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> statements within it. (The traditional <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>
construct is a synthesis of <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt>, <tt><a 
href="symbols.html#x185-2637128r128">block</a></tt>, and <tt><a 
href="symbols.html#x185-2637488r488">let</a></tt>.) Most of the iteration
constructs permit statically deﬁned non-local exits (see <tt><a 
href="symbols.html#x185-2637752r752">return-from</a></tt> and
<tt><a 
href="symbols.html#x185-2637751r751">return</a></tt>).
<!--l. 2750--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.1   </span> <a 
href="frontmatter.html#QQ2-54-624" id="x54-6160007.8.1">Indeﬁnite Iteration</a></h4>
<!--l. 2752--><p class="noindent" >The <tt><a 
href="symbols.html#x185-2637522r522">loop</a></tt> construct is the simplest iteration facility. It controls no variables, and
simply executes its body repeatedly.
<div class="defmac">
<div class="defmacheader">
<!--l. 2756--><p class="indent" >   <div class="tabbing">
 <i>[Macro]</i> <b>loop</b> <a 
 id="dx54-616001"></a><a 
 id="x54-616002r96"></a> {form}*
   <br>
<!--l. 2757--><p class="noindent" ></div>
<!--l. 2757--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6170007.8.1" id="x54-6170007.8.1"></a></span>
</div>
<!--l. 2758--><p class="indent" >   Each <i>form</i> is evaluated in turn from left to right. When the last <i>form</i> has been
evaluated, then the ﬁrst <i>form</i> is evaluated again, and so on, in a never-ending
cycle. The <tt><a 
href="symbols.html#x185-2637522r522">loop</a></tt> construct never returns a value. Its execution must be terminated
                                                                          

                                                                          
explicitly, using <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt> or <tt>throw</tt>, for example.
<tt>
<!--l. 2764--><p class="indent" >   <a 
href="symbols.html#x185-2637522r522">loop</a></tt>, like most iteration constructs, establishes an implicit block named <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>.
Thus <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt> may be used to exit from a <tt><a 
href="symbols.html#x185-2637522r522">loop</a></tt> with speciﬁed results.
<!--l. 2768--><p class="indent" >   There is an extension of <tt><a 
href="symbols.html#x185-2637522r522">loop</a></tt>. See chapter <a 
href="loop.html#x154-202100025">25<!--tex4ht:ref: LOOP --></a>.
</div>
<!--l. 2772--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.2   </span> <a 
href="frontmatter.html#QQ2-54-626" id="x54-6180007.8.2">General Iteration</a></h4>
<!--l. 2774--><p class="noindent" >In contrast to <tt><a 
href="symbols.html#x185-2637522r522">loop</a></tt>, <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> and <tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt> provide a powerful and general mechanism for
repetitively recalculating many variables.
<div class="defmac">
<div class="defmacheader">
<!--l. 2778--><p class="indent" >   <div class="tabbing">
 <i>[Macro]</i> <b>do</b> <a 
 id="dx54-618001"></a><a 
 id="x54-618002r97"></a> ({(var [init [step]])}*)
   <br>                                                                    (end-test {result}*)<br>
   {declaration}* {tag | statement}*<br>
<!--l. 2780--><p class="noindent" ></div>
<!--l. 2780--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6190007.8.2" id="x54-6190007.8.2"></a></span>
</div>
<div class="defmacheader">
<!--l. 2780--><p class="indent" >   <div class="tabbing">
 <i>[Macro]</i> <b>do*</b> <a 
 id="dx54-619001"></a><a 
 id="x54-619002r98"></a> ({(var [init [step]])}*)
   <br>                                                                    (end-test {result}*)<br>
   {declaration}* {tag | statement}*<br>
<!--l. 2784--><p class="noindent" ></div>
<!--l. 2784--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6200007.8.2" id="x54-6200007.8.2"></a></span>
</div>
<!--l. 2785--><p class="indent" >   The <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> special operator provides a generalized iteration facility, with an
arbitrary number of “index variables.” These variables are bound within the
                                                                          

                                                                          
iteration and stepped in parallel in speciﬁed ways. They may be used both to
generate successive values of interest (such as successive integers) or to
accumulate results. When an end condition is met, the iteration terminates with a
speciﬁed value.
<!--l. 2792--><p class="indent" >   In general, a <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> loop looks like this: <div class="lisp"><div class="tabbing">
(do ((<i>var1</i> <i>init1</i> <i>step1</i>)
   <br>                                                                    (<i>var2</i> <i>init2</i> <i>step2</i>)<br>
     ...<br>                                               (<i>varn</i> <i>initn</i> <i>stepn</i>))<br>
    (<i>end-test</i> . <i>result</i>)<br>                                      {<i><i>declaration</i></i>}* <br>
  . <i>tagbody</i>)<br>
<!--l. 2801--><p class="noindent" ></div>
<!--l. 2801--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6210007.8.2" id="x54-6210007.8.2"></a></span>
<!--l. 2801--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6220007.8.2" id="x54-6220007.8.2"></a></span>
</div>
<!--l. 2802--><p class="indent" >   A <tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt> loop looks exactly the same except that the name <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> is replaced by
<tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt>.
<!--l. 2805--><p class="indent" >   The ﬁrst item in the form is a list of zero or more index-variable speciﬁers.
Each index-variable speciﬁer is a list of the name of a variable <i>var</i>, an initial value
<i>init</i>, and a stepping form <i>step</i>. If <i>init</i> is omitted, it defaults to <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>. If <i>step</i> is
omitted, the <i>var</i> is not changed by the <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> construct between repetitions
(though code within the <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> is free to alter the value of the variable by using
<tt><a 
href="symbols.html#x185-2637779r779">setq</a></tt>).
<!--l. 2814--><p class="indent" >   An index-variable speciﬁer can also be just the name of a variable. In this case,
the variable has an initial value of <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> and is not changed between repetitions. As
a matter of style, it is recommended that an unadorned variable name be written
only when that variable will be stored into (such as by <tt><a 
href="symbols.html#x185-2637779r779">setq</a></tt>) before its ﬁrst use. If
it is important that the initial value be <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> rather than some undeﬁned value,
then it is clearer to write out <tt>(<i>varj</i> <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>)</tt> if the initial value is intended to mean
“false,” or <tt>(<i>varj</i> &#x2019;())</tt> if the initial value is intended to be an empty
list.
<div class="new">
                                                                          

                                                                          
<!--l. 2828--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx54-622001"></a>to regularize the binding formats for <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt>, <tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt>,
<tt><a 
href="symbols.html#x185-2637488r488">let</a></tt>, <tt><a 
href="symbols.html#x185-2637489r489">let*</a></tt>, <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>, <tt><a 
href="symbols.html#x185-2637697r697">prog*</a></tt>, and <tt>compiler-let</tt>. In the case of <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> and <tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt> the ﬁrst
edition was inconsistent; the formal syntax fails to reﬂect the fact that a simple
variable name may appear, as described in the preceding paragraph. The
deﬁnitions should read
<div class="defmac">
<div class="defmacheader">
<!--l. 2838--><p class="indent" >   <div class="tabbing">
 <i>[Macro]</i> <b>do</b> <a 
 id="dx54-622002"></a><a 
 id="x54-622003r99"></a> ({var | (var [init [step]])}*)
   <br>                                                                    (end-test {result}*)<br>
   {declaration}* {tag | statement}*<br>
<!--l. 2840--><p class="noindent" ></div>
<!--l. 2840--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6230007.8.2" id="x54-6230007.8.2"></a></span>
</div>
<div class="defmacheader">
<!--l. 2840--><p class="indent" >   <div class="tabbing">
 <i>[Macro]</i> <b>do*</b> <a 
 id="dx54-623001"></a><a 
 id="x54-623002r100"></a> ({var | (var [init [step]])}*)
   <br>                                                                    (end-test {result}*)<br>
   {declaration}* {tag | statement}*<br>
<!--l. 2844--><p class="noindent" ></div>
<!--l. 2844--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6240007.8.2" id="x54-6240007.8.2"></a></span>
</div>
<!--l. 2845--><p class="indent" >   for consistency with the reading of the ﬁrst edition and the X3J13
vote.
</div>
</div>
<!--l. 2849--><p class="indent" >   Before the ﬁrst iteration, all the <i>init</i> forms are evaluated, and each
<i>var</i> is bound to the value of its respective <i>init</i>. This is a binding, not an
assignment; when the loop terminates, the old values of those variables will
be restored. For <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt>, <i>all</i> of the <i>init</i> forms are evaluated <i>before</i> any <i>var</i>
is bound; hence all the <i>init</i> forms may refer to the old bindings of all
                                                                          

                                                                          
the variables (that is, to the values visible before beginning execution of
the <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> construct). For <tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt>, the ﬁrst <i>init</i> form is evaluated, then the ﬁrst
<i>var</i> is bound to that value, then the second <i>init</i> form is evaluated, then
the second <i>var</i> is bound, and so on; in general, the <i>initj</i> form can refer
to the <i>new</i> binding <i>vark</i> if <span class="math">k &#x003C; j</span>, and otherwise to the <i>old</i> binding of
<i>vark</i>.
<!--l. 2865--><p class="indent" >   The second element of the loop is a list of an end-testing predicate form
<i>end-test</i> and zero or more <i>result</i> forms. This resembles a <tt><a 
href="symbols.html#x185-2637245r245">cond</a></tt> clause. At the
beginning of each iteration, after processing the variables, the <i>end-test</i> is
evaluated. If the result is <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>, execution proceeds with the body of the <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> (or
<tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt>) form. If the result is not <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>, the <i>result</i> forms are evaluated in order as an
implicit <tt><a 
href="symbols.html#x185-2637700r700">progn</a></tt>, <a 
 id="dx54-624001"></a>and then <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> returns. <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> returns the results of evaluating the last
<i>result</i> form. If there are no <i>result</i> forms, the value of <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> is <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>. Note that this is
not quite analogous to the treatment of clauses in a <tt><a 
href="symbols.html#x185-2637245r245">cond</a></tt> form, because
a <tt><a 
href="symbols.html#x185-2637245r245">cond</a></tt> clause with no <i>result</i> forms returns the (non-<tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>) result of the
test.
<!--l. 2882--><p class="indent" >   At the beginning of each iteration other than the ﬁrst, the index variables are
updated as follows. All the <i>step</i> forms are evaluated, from left to right, and the
resulting values are assigned to the respective index variables. Any variable that
has no associated <i>step</i> form is not assigned to. For <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt>, all the <i>step</i> forms are
evaluated before any variable is updated; the assignment of values to variables is
done in parallel, as if by <tt><a 
href="symbols.html#x185-2637704r704">psetq</a></tt>. Because <i>all</i> of the <i>step</i> forms are evaluated before
<i>any</i> of the variables are altered, a <i>step</i> form when evaluated always has access to
the <i>old</i> values of <i>all</i> the index variables, even if other <i>step</i> forms precede it. For
<tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt>, the ﬁrst <i>step</i> form is evaluated, then the value is assigned to the ﬁrst
<i>var</i>, then the second <i>step</i> form is evaluated, then the value is assigned to
the second <i>var</i>, and so on; the assignment of values to variables is done
sequentially, as if by <tt><a 
href="symbols.html#x185-2637779r779">setq</a></tt>. For either <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> or <tt><a 
href="symbols.html#x185-2637311r311">do*</a></tt>, after the variables have been
updated, the <i>end-test</i> is evaluated as described above, and the iteration
continues.
<!--l. 2904--><p class="indent" >   If the <i>end-test</i> of a <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> form is <tt><tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt></tt>, the test will never succeed. Therefore this
provides an idiom for “do forever”: the <i>body</i> of the <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> is executed repeatedly,
stepping variables as usual. (The <tt><a 
href="symbols.html#x185-2637522r522">loop</a></tt> construct performs a “do forever”
that steps no variables.) The inﬁnite loop can be terminated by the use
of <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt>, <tt><a 
href="symbols.html#x185-2637752r752">return-from</a></tt>, <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> to an outer level, or <tt>throw</tt>. For example:
<div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(do ((j 0 (+ j 1)))
   <br>                                 (<tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>)                        ;Do forever<br>
  (format t &#x0022;~%Input ~D:&#x0022; j)<br>                          (let ((item (read)))<br>
    (if (null item) (return)     ;Process items until <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> seen<br>
        (format t &#x0022;~&#x0026;Output ~D: ~S&#x0022; j (process item)))))<br>
<!--l. 2920--><p class="noindent" ></div>
<!--l. 2920--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6250007.8.2" id="x54-6250007.8.2"></a></span>
<!--l. 2920--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6260007.8.2" id="x54-6260007.8.2"></a></span>
</div>
<!--l. 2922--><p class="indent" >   The remainder of the <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> form constitutes an implicit <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt>. Tags may
appear within the body of a <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> loop for use by <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> statements appearing in the
body (but such <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> statements may not appear in the variable speciﬁers, the
<i>end-test</i>, or the <i>result</i> forms). When the end of a <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> body is reached,
the next iteration cycle (beginning with the evaluation of <i>step</i> forms)
occurs.
<!--l. 2930--><p class="indent" >   An implicit <tt><a 
href="symbols.html#x185-2637128r128">block</a></tt> named <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> surrounds the entire <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> form. A <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt>
statement may be used at any point to exit the loop immediately.
<tt>
<!--l. 2934--><p class="indent" >   <a 
href="symbols.html#x185-2637271r271">declare</a></tt> forms may appear at the beginning of a <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> body. They apply to code
in the <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> body, to the bindings of the <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> variables, to the <i>init</i> forms, to the <i>step</i>
forms, to the <i>end-test</i>, and to the <i>result</i> forms.
<!--l. 2939--><p class="indent" >   Here are some examples of the use of <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt>: <div class="lisp"><div class="tabbing">
(do ((i 0 (+ i 1))     ;Sets every null element of <tt>a-vector</tt> to zero
   <br>                                                                (n (length a-vector)))<br>
    ((= i n))<br>                                (when (null (aref a-vector i))<br>
    (setf (aref a-vector i) 0)))<br>
<!--l. 2946--><p class="noindent" ></div>
<!--l. 2946--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6270007.8.2" id="x54-6270007.8.2"></a></span>
                                                                          

                                                                          
<!--l. 2946--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6280007.8.2" id="x54-6280007.8.2"></a></span>
</div>
<!--l. 2947--><p class="indent" >   The construction <div class="lisp"><div class="tabbing">
(do ((x e (cdr x))
   <br>                                (oldx x x))<br>                               ((null x))<br>
  <i>body</i>)<br>
<!--l. 2953--><p class="noindent" ></div>
<!--l. 2953--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6290007.8.2" id="x54-6290007.8.2"></a></span>
<!--l. 2953--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6300007.8.2" id="x54-6300007.8.2"></a></span>
</div>
<!--l. 2954--><p class="indent" >   exploits parallel assignment to index variables. On the ﬁrst iteration, the
value of <tt>oldx</tt> is whatever value <tt>x</tt> had before the <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> was entered. On
succeeding iterations, <tt>oldx</tt> contains the value that <tt>x</tt> had on the previous
iteration.
<!--l. 2959--><p class="indent" >   Very often an iterative algorithm can be most clearly expressed entirely in the
<i>step</i> forms of a <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt>, and the <i>body</i> is empty. For example, <div class="lisp"><div class="tabbing">
(do ((x foo (cdr x))
   <br>                                                                         (y bar (cdr y))<br>
     (z &#x2019;() (cons (f (car x) (car y)) z)))<br>              ((or (null x) (null y))<br>
     (nreverse z)))<br>
<!--l. 2968--><p class="noindent" ></div>
<!--l. 2968--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6310007.8.2" id="x54-6310007.8.2"></a></span>
                                                                          

                                                                          
<!--l. 2968--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6320007.8.2" id="x54-6320007.8.2"></a></span>
</div>
<!--l. 2969--><p class="indent" >   does the same thing as <tt>(mapcar #&#x2019;f foo bar)</tt>. Note that the <i>step</i>
computation for <tt>z</tt> exploits the fact that variables are stepped in parallel. Also, the
body of the loop is empty. Finally, the use of <tt><a 
href="symbols.html#x185-2637619r619">nreverse</a></tt> to put an accumulated <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt>
loop result into the correct order is a standard idiom. Another example:
<div class="lisp"><div class="tabbing">
(defun list-reverse (list)
   <br>           (do ((x list (cdr x))<br>                (y &#x2019;() (cons (car x) y)))<br>
           ((endp x) y)))<br>
<!--l. 2979--><p class="noindent" ></div>
<!--l. 2979--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6330007.8.2" id="x54-6330007.8.2"></a></span>
<!--l. 2979--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6340007.8.2" id="x54-6340007.8.2"></a></span>
</div>
<!--l. 2980--><p class="indent" >   Note the use of <tt><a 
href="symbols.html#x185-2637333r333">endp</a></tt> rather than <tt><a 
href="symbols.html#x185-2637635r635">null</a></tt> or <tt><a 
href="symbols.html#x185-2637113r113">atom</a></tt> to test for the end of a list; this
may result in more robust code.
<!--l. 2983--><p class="indent" >   As an example of nested loops, suppose that <tt>env</tt> holds a list of conses. The
<i>car</i> of each cons is a list of symbols, and the <i>cdr</i> of each cons is a list of equal
length containing corresponding values. Such a data structure is similar
to an association list but is divided into “frames”; the overall structure
resembles a rib cage. A lookup function on such a data structure might be
<div class="lisp"><div class="tabbing">
(defun ribcage-lookup (sym ribcage)
   <br>                (do ((r ribcage (cdr r)))<br>                    ((null r) <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>)<br>
         (do ((s (caar r) (cdr s))<br>                   (v (cdar r) (cdr v)))<br>
             ((null s))<br>                          (when (eq (car s) sym)<br>
             (return-from ribcage-lookup (car v))))))<br>
<!--l. 2999--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 2999--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6350007.8.2" id="x54-6350007.8.2"></a></span>
<!--l. 2999--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6360007.8.2" id="x54-6360007.8.2"></a></span>
</div>
<!--l. 3000--><p class="indent" >   (Notice the use of indentation in the above example to set oﬀ the bodies of the
<tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> loops.)
<!--l. 3003--><p class="indent" >   A <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> loop may be explained in terms of the more primitive constructs <tt><a 
href="symbols.html#x185-2637128r128">block</a></tt>,
<tt><a 
href="symbols.html#x185-2637751r751">return</a></tt>, <tt><a 
href="symbols.html#x185-2637488r488">let</a></tt>, <tt><a 
href="symbols.html#x185-2637522r522">loop</a></tt>, <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt>, and <tt><a 
href="symbols.html#x185-2637704r704">psetq</a></tt> as follows: <div class="lisp"><div class="tabbing">
(block nil
   <br>                      (let ((<i>var1</i> <i>init1</i>)<br>                            (<i>var2</i> <i>init2</i>)<br>
        ...<br>                                                 (<i>varn</i> <i>initn</i>))<br>
     {<i><i>declaration</i></i>}* <br>          (loop (when <i>end-test</i> (return (progn . <i>result</i>)))<br>
          (tagbody . <i>tagbody</i>)<br>                        (psetq <i>var1</i> <i>step1</i><br>
                 <i>var2</i> <i>step2</i><br>                                       ...<br>
                 <i>varn</i> <i>stepn</i>))))<br>
<!--l. 3019--><p class="noindent" ></div>
<!--l. 3019--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6370007.8.2" id="x54-6370007.8.2"></a></span>
<!--l. 3019--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6380007.8.2" id="x54-6380007.8.2"></a></span>
</div>
<tt>
<!--l. 3020--><p class="indent" >   <a 
href="symbols.html#x185-2637311r311">do*</a></tt> is exactly like <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> except that the bindings and steppings of the
variables are performed sequentially rather than in parallel. It is as if, in the
above explanation, <tt><a 
href="symbols.html#x185-2637488r488">let</a></tt> were replaced by <tt><a 
href="symbols.html#x185-2637489r489">let*</a></tt> and <tt><a 
href="symbols.html#x185-2637704r704">psetq</a></tt> were replaced by
<tt><a 
href="symbols.html#x185-2637779r779">setq</a></tt>.
</div>
<!--l. 3027--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.3   </span> <a 
href="frontmatter.html#QQ2-54-647" id="x54-6390007.8.3">Simple Iteration Constructs</a></h4>
                                                                          

                                                                          
<!--l. 3029--><p class="noindent" >The constructs <tt><a 
href="symbols.html#x185-2637317r317">dolist</a></tt> and <tt><a 
href="symbols.html#x185-2637318r318">dotimes</a></tt> execute a body of code once for each value
taken by a single variable. They are expressible in terms of <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt>, but capture very
common patterns of use.
<!--l. 3033--><p class="indent" >   Both <tt><a 
href="symbols.html#x185-2637317r317">dolist</a></tt> and <tt><a 
href="symbols.html#x185-2637318r318">dotimes</a></tt> perform a body of statements repeatedly. On each
iteration a speciﬁed variable is bound to an element of interest that the
body may examine. <tt><a 
href="symbols.html#x185-2637317r317">dolist</a></tt> examines successive elements of a list, and
<tt><a 
href="symbols.html#x185-2637318r318">dotimes</a></tt> examines integers from 0 to <span class="math">n − 1</span> for some speciﬁed positive integer
<i>n</i>.
<!--l. 3040--><p class="indent" >   The value of any of these constructs may be speciﬁed by an optional result
form, which if omitted defaults to the value <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>.
<!--l. 3043--><p class="indent" >   The <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt> statement may be used to return immediately from a <tt><a 
href="symbols.html#x185-2637317r317">dolist</a></tt> or
<tt><a 
href="symbols.html#x185-2637318r318">dotimes</a></tt> form, discarding any following iterations that might have been
performed; in eﬀect, a <tt><a 
href="symbols.html#x185-2637128r128">block</a></tt> named <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> surrounds the construct. The body of the
loop is implicitly a <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> construct; it may contain tags to serve as the
targets of <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> statements. Declarations may appear before the body of the
loop.
<div class="defmac">
<div class="defmacheader">
<!--l. 3053--><p class="indent" >   <div class="tabbing">
 <i>[Macro]</i> <b>dolist</b> <a 
 id="dx54-639001"></a><a 
 id="x54-639002r101"></a> (var listform [resultform])
   <br>                                                 {declaration}* {tag | statement}*<br>
<!--l. 3055--><p class="noindent" ></div>
<!--l. 3055--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6400007.8.3" id="x54-6400007.8.3"></a></span>
</div>
<tt>
<!--l. 3056--><p class="indent" >   <a 
href="symbols.html#x185-2637317r317">dolist</a></tt> provides straightforward iteration over the elements of a list.
First <tt><a 
href="symbols.html#x185-2637317r317">dolist</a></tt> evaluates the form <i>listform</i>, which should produce a list. It
then executes the body once for each element in the list, in order, with
the variable <i>var</i> bound to the element. Then <i>resultform</i> (a single form,
<i>not</i> an implicit <tt><a 
href="symbols.html#x185-2637700r700">progn</a></tt>) is evaluated, and the result is the value of the
<tt><a 
href="symbols.html#x185-2637317r317">dolist</a></tt> form. (When the <i>resultform</i> is evaluated, the control variable <i>var</i> is
still bound and has the value <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>.) If <i>resultform</i> is omitted, the result is
<tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>.
<div class="lisp">
                                                                          

                                                                          
<!--l. 3068--><p class="indent" >   <div class="tabbing">
(dolist (x &#x2019;(a b c d)) (prin1 x) (princ &#x0022; &#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>
   <br>                  after printing “<tt>a b c d </tt>” (note the trailing space)<br>
<!--l. 3071--><p class="noindent" ></div>
<!--l. 3071--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6410007.8.3" id="x54-6410007.8.3"></a></span>
<!--l. 3071--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6420007.8.3" id="x54-6420007.8.3"></a></span>
</div>
<!--l. 3073--><p class="indent" >   An explicit <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt> statement may be used to terminate the loop and return a
speciﬁed value.
<div class="new">
<!--l. 3077--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx54-642001"></a>to restrict user side eﬀects; see section <a 
href="clmse43.html#x55-6760007.9">7.9<!--tex4ht:ref: STRUCTURE-TRAVERSAL-SECTION --></a>.
</div>
</div>
<div class="defmac">
<div class="defmacheader">
<!--l. 3084--><p class="indent" >   <div class="tabbing">
 <i>[Macro]</i> <b>dotimes</b> <a 
 id="dx54-642002"></a><a 
 id="x54-642003r102"></a> (var countform [resultform])
   <br>                                                 {declaration}* {tag | statement}*<br>
<!--l. 3086--><p class="noindent" ></div>
<!--l. 3086--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6430007.8.3" id="x54-6430007.8.3"></a></span>
</div>
<tt>
<!--l. 3087--><p class="indent" >   <a 
href="symbols.html#x185-2637318r318">dotimes</a></tt> provides straightforward iteration over a sequence of integers. The
expression <tt>(dotimes (<i>var</i> <i>countform</i> <i>resultform</i>) . <i>progbody</i>)</tt> evaluates
the form <i>countform</i>, which should produce an integer. It then performs <i>progbody</i>
once for each integer from zero (inclusive) to <i>count</i> (exclusive), in order,
with the variable <i>var</i> bound to the integer; if the value of <i>countform</i>
is zero or negative, then the <i>progbody</i> is performed zero times. Finally,
                                                                          

                                                                          
<i>resultform</i> (a single form, <i>not</i> an implicit <tt><a 
href="symbols.html#x185-2637700r700">progn</a></tt>) is evaluated, and the result
is the value of the <tt><a 
href="symbols.html#x185-2637318r318">dotimes</a></tt> form. (When the <i>resultform</i> is evaluated,
the control variable <i>var</i> is still bound and has as its value the number
of times the body was executed.) If <i>resultform</i> is omitted, the result is
<tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>.
<!--l. 3102--><p class="indent" >   An explicit <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt> statement may be used to terminate the loop and return a
speciﬁed value.
<!--l. 3105--><p class="indent" >   Here is an example of the use of <tt><a 
href="symbols.html#x185-2637318r318">dotimes</a></tt> in processing strings: <div class="lisp"><div class="tabbing">
;;; True if the speciﬁed subsequence of the string is a
   <br>                     ;;; palindrome (reads the same forwards and backwards).<br>
<br>                                     (defun palindromep (string <tt>&#x0026;optional</tt><br>
                           (start 0)<br>
                           (end (length string)))<br>
  (dotimes (k (ﬂoor (- end start) 2) <tt><a 
href="symbols.html#x185-2637871r871">t</a></tt>)<br>
    (unless (char-equal (char string (+ start k))<br>
                        (char string (- end k 1)))<br>
      (return <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>))))<br>  <br>   (palindromep &#x0022;Able was I ere I saw Elba&#x0022;) <span class="math"> ⇒</span> <tt><a 
href="symbols.html#x185-2637871r871">t</a></tt><br>
<br>                 (palindromep &#x0022;A man, a plan, a canal–Panama!&#x0022;) <span class="math"> ⇒</span> <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt><br>
<br>                  (remove-if-not #&#x2019;alpha-char-p     ;Remove punctuation<br>
               &#x0022;A man, a plan, a canal–Panama!&#x0022;)<br>
   <span class="math"> ⇒</span> &#x0022;AmanaplanacanalPanama&#x0022;<br>                                       <br>
(palindromep<br>                                (remove-if-not #&#x2019;alpha-char-p<br>
                &#x0022;A man, a plan, a canal–Panama!&#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="symbols.html#x185-2637871r871">t</a></tt><br><br>(palindromep<br>
 (remove-if-not<br>                                            #&#x2019;alpha-char-p<br>
   &#x0022;Unremarkable was I ere I saw Elba Kramer, nu?&#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="symbols.html#x185-2637871r871">t</a></tt><br>             <br>
(palindromep<br>                                               (remove-if-not<br>
   #&#x2019;alpha-char-p<br>                   &#x0022;A man, a plan, a cat, a ham, a yak,<br>
                   a yam, a hat, a canal–Panama!&#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="symbols.html#x185-2637871r871">t</a></tt><br>
(palindromep<br>               (remove-if-not<br>                 #&#x2019;alpha-char-p<br>
   &#x0022;Ja-da, ja-da, ja-da ja-da jing jing jing&#x0022;)) <span class="math"> ⇒</span> <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt><br>
<!--l. 3145--><p class="noindent" ></div>
<!--l. 3145--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6440007.8.3" id="x54-6440007.8.3"></a></span>
                                                                          

                                                                          
<!--l. 3145--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6450007.8.3" id="x54-6450007.8.3"></a></span>
</div>
<!--l. 3147--><p class="indent" >   Altering the value of <i>var</i> in the body of the loop (by using <tt><a 
href="symbols.html#x185-2637779r779">setq</a></tt>, for example)
will have unpredictable, possibly implementation-dependent results. A Common
Lisp compiler may choose to issue a warning if such a variable appears in a
<tt><a 
href="symbols.html#x185-2637779r779">setq</a></tt>.
</div>
<!--l. 3153--><p class="indent" >   See also <tt><a 
href="symbols.html#x185-2637314r314">do-symbols</a></tt>, <tt><a 
href="symbols.html#x185-2637313r313">do-external-symbols</a></tt>, and <tt><a 
href="symbols.html#x185-2637312r312">do-all-symbols</a></tt>.
<!--l. 3156--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.4   </span> <a 
href="frontmatter.html#QQ2-54-654" id="x54-6460007.8.4">Mapping</a></h4>
<a 
 id="dx54-646001"></a>
<!--l. 3159--><p class="noindent" >Mapping is a type of iteration in which a function is successively applied to pieces
of one or more sequences. The result of the iteration is a sequence containing the
respective results of the function applications. There are several options for the
way in which the pieces of the list are chosen and for what is done with the results
returned by the applications of the function.
<!--l. 3167--><p class="indent" >   The function <tt><a 
href="symbols.html#x185-2637556r556">map</a></tt> may be used to map over any kind of sequence. The
following functions operate only on lists.
<div class="defun">
<!--l. 3170--><p class="noindent" ><div class="defunheader"> <i>[Function]</i><a 
 id="dx54-646002"></a><a 
 id="x54-646003r103"></a> <b>mapcar</b>  <i>function</i> <i>list</i> <b>&#x0026;rest</b>  <i>more-lists</i><br />
<i>
[Function]</i><a 
 id="dx54-646004"></a><a 
 id="x54-646005r104"></a> <b>maplist</b>  <i>function</i> <i>list</i> <b>&#x0026;rest</b>  <i>more-lists</i><br />
<i>
[Function]</i><a 
 id="dx54-646006"></a><a 
 id="x54-646007r105"></a> <b>mapc</b>  <i>function</i> <i>list</i> <b>&#x0026;rest</b>  <i>more-lists</i><br />
<i>
[Function]</i><a 
 id="dx54-646008"></a><a 
 id="x54-646009r106"></a> <b>mapl</b>  <i>function</i> <i>list</i> <b>&#x0026;rest</b>  <i>more-lists</i><br />
<i>
[Function]</i><a 
 id="dx54-646010"></a><a 
 id="x54-646011r107"></a> <b>mapcan</b>  <i>function</i> <i>list</i> <b>&#x0026;rest</b>  <i>more-lists</i><br />
<i>
[Function]</i><a 
 id="dx54-646012"></a><a 
 id="x54-646013r108"></a> <b>mapcon</b>  <i>function</i> <i>list</i> <b>&#x0026;rest</b>  <i>more-lists</i>
</div>
<!--l. 3178--><p class="indent" >   For each of these mapping functions, the ﬁrst argument is a function and the
rest must be lists. The function must take as many arguments as there are
lists.
                                                                          

                                                                          
<tt>
<!--l. 3182--><p class="indent" >   <a 
href="symbols.html#x185-2637560r560">mapcar</a></tt> operates on successive elements of the lists. First the function is
applied to the <i>car</i> of each list, then to the <i>cadr</i> of each list, and so on. (Ideally all
the lists are the same length; if not, the iteration terminates when the shortest list
runs out, and excess elements in other lists are ignored.) The value returned by
<tt><a 
href="symbols.html#x185-2637560r560">mapcar</a></tt> is a list of the results of the successive calls to the function. For example:
<div class="lisp"><div class="tabbing">
(mapcar #&#x2019;abs &#x2019;(3 -4 2 -5 -6)) <span class="math"> ⇒</span> (3 4 2 5 6)
   <br>                (mapcar #&#x2019;cons &#x2019;(a b c) &#x2019;(1 2 3)) <span class="math"> ⇒</span> ((a . 1) (b . 2) (c . 3))<br>
<!--l. 3194--><p class="noindent" ></div>
<!--l. 3194--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6470007.8.4" id="x54-6470007.8.4"></a></span>
<!--l. 3194--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6480007.8.4" id="x54-6480007.8.4"></a></span>
</div>
<tt>
<!--l. 3196--><p class="indent" >   <a 
href="symbols.html#x185-2637564r564">maplist</a></tt> is like <tt><a 
href="symbols.html#x185-2637560r560">mapcar</a></tt> except that the function is applied to the lists and
successive <i>cdr</i>&#x2019;s of those lists rather than to successive elements of the lists. For
example: <div class="lisp"><div class="tabbing">
(maplist #&#x2019;(lambda (x) (cons &#x2019;foo x))
   <br>                                                                            &#x2019;(a b c d))<br>
   <span class="math"> ⇒</span> ((foo a b c d) (foo b c d) (foo c d) (foo d))<br>
<!--l. 3204--><p class="noindent" ></div>
<!--l. 3204--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6490007.8.4" id="x54-6490007.8.4"></a></span>
                                                                          

                                                                          
<!--l. 3204--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6500007.8.4" id="x54-6500007.8.4"></a></span>
</div>
<div class="lisp">
<!--l. 3206--><p class="indent" >   <div class="tabbing">
(maplist #&#x2019;(lambda (x) (if (member (car x) (cdr x)) 0 1)))
   <br>                        &#x2019;(a b a c d b c))<br>                  <span class="math"> ⇒</span> (0 0 1 0 1 1 1)<br>
   ;An entry is <tt>1</tt> if the corresponding element of the input<br>
   ; list was the last instance of that element in the input list.<br>
<!--l. 3212--><p class="noindent" ></div>
<!--l. 3212--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6510007.8.4" id="x54-6510007.8.4"></a></span>
<!--l. 3212--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6520007.8.4" id="x54-6520007.8.4"></a></span>
</div>
<tt>
<!--l. 3214--><p class="indent" >   <a 
href="symbols.html#x185-2637563r563">mapl</a></tt> and <tt><a 
href="symbols.html#x185-2637558r558">mapc</a></tt> are like <tt><a 
href="symbols.html#x185-2637564r564">maplist</a></tt> and <tt><a 
href="symbols.html#x185-2637560r560">mapcar</a></tt>, respectively, except that they do
not accumulate the results of calling the function.
<!--l. 3218--><p class="indent" >   These functions are used when the function is being called merely for its side
eﬀects rather than for its returned values. The value returned by <tt><a 
href="symbols.html#x185-2637563r563">mapl</a></tt> or <tt><a 
href="symbols.html#x185-2637558r558">mapc</a></tt> is
the second argument, that is, the ﬁrst sequence argument.
<tt>
<!--l. 3223--><p class="indent" >   <a 
href="symbols.html#x185-2637559r559">mapcan</a></tt> and <tt><a 
href="symbols.html#x185-2637561r561">mapcon</a></tt> are like <tt><a 
href="symbols.html#x185-2637560r560">mapcar</a></tt> and <tt><a 
href="symbols.html#x185-2637564r564">maplist</a></tt>, respectively, except that
they combine the results of the function using <tt><a 
href="symbols.html#x185-2637605r605">nconc</a></tt> instead of <tt><a 
href="symbols.html#x185-2637492r492">list</a></tt>. That is,
<div class="lisp"><div class="tabbing">
(mapcon <i>f </i> <i>x1</i> ... <i>xn</i>)
   <br>                                       <span class="math"> ≡</span> (apply #&#x2019;nconc (maplist <i>f </i> <i>x1</i> ... <i>xn</i>))<br>
<!--l. 3229--><p class="noindent" ></div>
<!--l. 3229--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6530007.8.4" id="x54-6530007.8.4"></a></span>
                                                                          

                                                                          
<!--l. 3229--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6540007.8.4" id="x54-6540007.8.4"></a></span>
</div>
<!--l. 3230--><p class="indent" >   and similarly for the relationship between <tt><a 
href="symbols.html#x185-2637559r559">mapcan</a></tt> and <tt><a 
href="symbols.html#x185-2637560r560">mapcar</a></tt>. Conceptually,
these functions allow the mapped function to return a variable number of items to
be put into the output list. This is particularly useful for eﬀectively returning zero
or one item: <div class="lisp"><div class="tabbing">
(mapcan #&#x2019;(lambda (x) (and (numberp x) (list x)))
   <br>                                                                   &#x2019;(a 1 b c 3 4 d 5))<br>
   <span class="math"> ⇒</span> (1 3 4 5)<br>
<!--l. 3238--><p class="noindent" ></div>
<!--l. 3238--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6550007.8.4" id="x54-6550007.8.4"></a></span>
<!--l. 3238--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6560007.8.4" id="x54-6560007.8.4"></a></span>
</div>
<!--l. 3239--><p class="indent" >   In this case the function serves as a ﬁlter; this is a standard Lisp idiom using
<tt><a 
href="symbols.html#x185-2637559r559">mapcan</a></tt>. (The function <tt><a 
href="symbols.html#x185-2637739r739">remove-if-not</a></tt> might have been useful in this particular
context, however.) Remember that <tt><a 
href="symbols.html#x185-2637605r605">nconc</a></tt> is a destructive operation, and therefore
so are <tt><a 
href="symbols.html#x185-2637559r559">mapcan</a></tt> and <tt><a 
href="symbols.html#x185-2637561r561">mapcon</a></tt>; the lists returned by the <i>function</i> are altered in order
to concatenate them.
<!--l. 3247--><p class="indent" >   Sometimes a <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt> or a straightforward recursion is preferable to a mapping
operation; however, the mapping functions should be used wherever they
naturally apply because this increases the clarity of the code.
<!--l. 3251--><p class="indent" >   The functional argument to a mapping function must be acceptable to <tt><a 
href="symbols.html#x185-2637081r81">apply</a></tt>;
it cannot be a macro or the name of a special operator. Of course, there is nothing
wrong with using a function that has <tt>&#x0026;optional</tt> and <tt>&#x0026;rest</tt> parameters as the
functional argument.
<div class="newer">
<!--l. 3257--><p class="indent" >   X3J13 voted in June 1988 <a 
 id="dx54-656001"></a>to allow the <i>function</i> to be only of type
<tt>symbol</tt> or <tt><a 
href="symbols.html#x185-2637399r399">function</a></tt>; a lambda-expression is no longer acceptable as a
functional argument. One must use the <tt><a 
href="symbols.html#x185-2637399r399">function</a></tt> special operator or the
abbreviation <tt>#&#x2019;</tt> before a lambda-expression that appears as an explicit argument
form.
</div>
                                                                          

                                                                          
<div class="new">
<!--l. 3265--><p class="indent" >   X3J13 voted in January 1989 <a 
 id="dx54-656002"></a>to restrict user side eﬀects; see section <a 
href="clmse43.html#x55-6760007.9">7.9<!--tex4ht:ref: STRUCTURE-TRAVERSAL-SECTION --></a>.
</div>
</div>
<!--l. 3271--><p class="noindent" >
   <h4 class="subsectionHead"><span class="titlemark">7.8.5   </span> <a 
href="frontmatter.html#QQ2-54-665" id="x54-6570007.8.5">The “Program Feature”</a></h4>
<!--l. 3273--><p class="noindent" >Lisp implementations since Lisp 1.5 have had what was originally called “the
program feature,” as if it were impossible to write programs without it!
The <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt> construct allows one to write in an Algol-like or Fortran-like
statement-oriented style, using <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> statements that can refer to tags in the
body of the <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>. Modern Lisp programming style tends to use <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>
rather infrequently. The various iteration constructs, such as <tt><a 
href="symbols.html#x185-2637310r310">do</a></tt>, have
bodies with the characteristics of a <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>. (However, the ability to use
<tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> statements within iteration constructs is very seldom called upon in
practice.)
<!--l. 3284--><p class="indent" >   Three distinct operations are performed by <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>: it binds local variables, it
permits use of the <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt> statement, and it permits use of the <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> statement. In
Common Lisp, these three operations have been separated into three distinct
constructs: <tt><a 
href="symbols.html#x185-2637488r488">let</a></tt>, <tt><a 
href="symbols.html#x185-2637128r128">block</a></tt>, and <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt>. These three constructs may be used
independently as building blocks for other types of constructs.
<div class="defspec">
<div class="defmacheader">
<!--l. 3293--><p class="indent" >   <div class="tabbing">
 <i>[Special operator]</i> <b>tagbody</b> <a 
 id="dx54-657001"></a><a 
 id="x54-657002r109"></a> {tag | statement}*
   <br>
<!--l. 3294--><p class="noindent" ></div>
<!--l. 3294--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6580007.8.5" id="x54-6580007.8.5"></a></span>
</div>
<!--l. 3295--><p class="indent" >   The part of a <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> after the variable list is called the <i>body</i>. An item
in the body may be a symbol or an integer, in which case it is called a
<i>tag</i>, or an item in the body may be a list, in which case it is called a
<i>statement</i>.
                                                                          

                                                                          
<!--l. 3300--><p class="indent" >   Each element of the body is processed from left to right. A <i>tag</i> is ignored; a
<i>statement</i> is evaluated, and its results are discarded. If the end of the body is
reached, the <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> returns <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt>.
<!--l. 3305--><p class="indent" >   If <tt>(go <i>tag</i>)</tt> is evaluated, control jumps to the part of the body labelled with
the <i>tag</i>.
<!--l. 3308--><p class="indent" >   The scope of the tags established by a <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> is lexical, and the extent
is dynamic. Once a <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> construct has been exited, it is no longer
legal to <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> to a <i>tag</i> in its body. It is permissible for a <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> to jump to a
<tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> that is not the innermost <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> construct containing that <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt>;
the tags established by a <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> will only shadow other tags of like
name.
<!--l. 3316--><p class="indent" >   The lexical scoping of the <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> targets named by tags is fully general and has
consequences that may be surprising to users and implementors of other Lisp
systems. For example, the <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> in the following example actually does work in
Common Lisp as one might expect: <div class="lisp"><div class="tabbing">
(tagbody
   <br>         (catch &#x2019;stuﬀ<br>            (mapcar #&#x2019;(lambda (x) (if (numberp x)<br>
                                (hairyfun x)<br>
                                (go lose)))<br>                 items))<br>
   (return)<br>                                                           lose<br>
   (error &#x0022;I lost big!&#x0022;))<br>
<!--l. 3331--><p class="noindent" ></div>
<!--l. 3331--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6590007.8.5" id="x54-6590007.8.5"></a></span>
<!--l. 3331--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6600007.8.5" id="x54-6600007.8.5"></a></span>
</div>
<!--l. 3332--><p class="indent" >   Depending on the situation, a <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> in Common Lisp does not necessarily
correspond to a simple machine “jump” instruction. A <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> can break up
catchers if necessary to get to the target. It is possible for a “closure” created
by <tt><a 
href="symbols.html#x185-2637399r399">function</a></tt> for a lambda-expression to refer to a <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> target as long as
the tag is lexically apparent. See chapter <a 
href="scope.html#x25-1220003">3<!--tex4ht:ref: SCOPE --></a> for an elaborate example of
this.
                                                                          

                                                                          
<div class="new">
<!--l. 3341--><p class="indent" >   There are some holes in this speciﬁcation (and that of <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt>) that leave
some room for interpretation. For example, there is no explicit prohibition
against the same tag appearing more than once in the same <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> body.
Every implementation I know of will complain in the compiler, if not
in the interpreter, if there is a <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> to such a duplicated tag; but some
implementors take the position that duplicate tags are permitted provided
there is no <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> to such a tag. (“If a tree falls in the forest, and there is no
one there to hear it, then no one needs to yell ‘Timber!&#x2019; ”) Also, some
implementations allow objects other than symbols, integers, and lists in the
body and typically ignore them. Consequently, some programmers use
redundant tags such as <tt>–-</tt> for formatting purposes, and strings as comments:
<div class="lisp"><div class="tabbing">
(defun dining-philosopher (j)
   <br>              (tagbody —<br>               think   (unless (hungry) (go think))<br>
           —<br>                          &#x0022;Can&#x2019;t eat without chopsticks.&#x0022;<br>
           (snatch (chopstick j))<br>
           (snatch (chopstick (mod (+ j 1) 5)))<br>                      —<br>
   eat     (when (hungry)<br>                       (mapc #&#x2019;gobble-down<br>
                   &#x2019;(twice-cooked-pork kung-pao-chi-ding<br>
                     wu-dip-har orange-ﬂavor-beef<br>
                     two-side-yellow-noodles twinkies))<br>
             (go eat))<br>                                               —<br>
           &#x0022;Can&#x2019;t think with my neighbors&#x2019; stomachs rumbling.&#x0022;<br>
           (relinquish (chopstick j))<br>
           (relinquish (chopstick (mod (+ j 1) 5)))<br>
           —<br>                                    (if (happy) (go think)<br>
               (become insurance-salesman))))<br>
<!--l. 3377--><p class="noindent" ></div>
<!--l. 3377--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6610007.8.5" id="x54-6610007.8.5"></a></span>
<!--l. 3377--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6620007.8.5" id="x54-6620007.8.5"></a></span>
                                                                          

                                                                          
</div>
<!--l. 3378--><p class="indent" >   In certain implementations of Common Lisp they get away with it.
Others abhor what they view as an abuse of unintended ambiguity in
the language speciﬁcation. For maximum portability, I advise users to
steer clear of these issues. Similarly, it is best to avoid using <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> as a tag,
even though it is a symbol, because a few implementations treat <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> as
a list to be executed. To be extra careful, avoid calling from within a
<tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> a macro whose expansion might not be a non-<tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> list; wrap such
a call in <tt>(progn ...)</tt>, or rewrite the macro to return <tt>(progn ...)</tt> if
possible.
</div>
</div>
<div class="defmac">
<div class="defmacheader">
<!--l. 3392--><p class="indent" >   <div class="tabbing">
 <i>[Macro]</i> <b>prog</b> <a 
 id="dx54-662001"></a><a 
 id="x54-662002r110"></a> ({var | (var [init])}*) {declaration}* {tag | statement}*
   <br>
<!--l. 3392--><p class="noindent" ></div>
<!--l. 3392--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6630007.8.5" id="x54-6630007.8.5"></a></span>
</div>
<div class="defmacheader">
<!--l. 3392--><p class="indent" >   <div class="tabbing">
 <i>[Macro]</i> <b>prog*</b> <a 
 id="dx54-663001"></a><a 
 id="x54-663002r111"></a> ({var | (var [init])}*) {declaration}* {tag | statement}*
   <br>
<!--l. 3394--><p class="noindent" ></div>
<!--l. 3394--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6640007.8.5" id="x54-6640007.8.5"></a></span>
</div>
<!--l. 3395--><p class="indent" >   The <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt> construct is a synthesis of <tt><a 
href="symbols.html#x185-2637488r488">let</a></tt>, <tt><a 
href="symbols.html#x185-2637128r128">block</a></tt>, and <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt>, allowing bound
variables and the use of <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt> and <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> within a single construct. A typical <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>
construct looks like this: <div class="lisp"><div class="tabbing">
                                                                          

                                                                          
(prog (<i>var1</i> <i>var2</i> (<i>var3</i> <i>init3</i>) <i>var4</i> (<i>var5</i> <i>init5</i>))
   <br>                                                                         {<i><i>declaration</i></i>}* <br>
      <i>statement1</i><br>                                                    <i>tag1</i><br>
      <i>statement2</i><br>                                            <i>statement3</i><br>
      <i>statement4</i><br>                                                    <i>tag2</i><br>
      <i>statement5</i><br>                                                     ...<br>
      )<br>
<!--l. 3410--><p class="noindent" ></div>
<!--l. 3410--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6650007.8.5" id="x54-6650007.8.5"></a></span>
<!--l. 3410--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6660007.8.5" id="x54-6660007.8.5"></a></span>
</div>
<!--l. 3411--><p class="indent" >   The list after the keyword <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt> is a set of speciﬁcations for binding <i>var1</i>,
<i>var2</i>, etc., which are temporary variables bound locally to the <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>. This list is
processed exactly as the list in a <tt><a 
href="symbols.html#x185-2637488r488">let</a></tt> statement: ﬁrst all the <i>init</i> forms are
evaluated from left to right (where <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> is used for any omitted <i>init</i> form), and
then the variables are all bound in parallel to the respective results. Any
<i>declaration</i> appearing in the <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt> is used as if appearing at the top of the <tt><a 
href="symbols.html#x185-2637488r488">let</a></tt>
body.
<!--l. 3422--><p class="indent" >   The body of the <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt> is executed as if it were a <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> construct; the <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt>
statement may be used to transfer control to a <i>tag</i>.
<!--l. 3426--><p class="indent" >   A <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt> implicitly establishes a <tt><a 
href="symbols.html#x185-2637128r128">block</a></tt> named <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt> around the entire <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>
construct, so that <tt><a 
href="symbols.html#x185-2637751r751">return</a></tt> may be used at any time to exit from the <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>
construct.
<!--l. 3430--><p class="indent" >   Here is a ﬁne example of what can be done with <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>: <div class="lisp"><div class="tabbing">
(defun king-of-confusion (w)
   <br>                           &#x0022;Take a cons of two lists and make a list of conses.<br>
   Think of this function as being like a zipper.&#x0022;<br>
  (prog (x y z)     ;Initialize <tt>x</tt>, <tt>y</tt>, <tt>z</tt> to <tt><a 
href="symbols.html#x185-2637609r609">nil</a></tt><br>
        (setq y (car w) z (cdr w))<br>                                   loop<br>
        (cond ((null y) (return x))<br>                   ((null z) (go err)))<br>
                                                                          

                                                                          
   rejoin<br>                          (setq x (cons (cons (car y) (car z)) x))<br>
        (setq y (cdr y) z (cdr z))<br>                              (go loop)<br>
   err<br>                           (cerror &#x0022;Will self-pair extraneous items&#x0022;<br>
                &#x0022;Mismatch - gleep!  S&#x0022; y)<br>                   (setq z y)<br>
        (go rejoin)))<br>
<!--l. 3449--><p class="noindent" ></div>
<!--l. 3449--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6670007.8.5" id="x54-6670007.8.5"></a></span>
<!--l. 3449--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6680007.8.5" id="x54-6680007.8.5"></a></span>
</div>
<!--l. 3450--><p class="indent" >   which is accomplished somewhat more perspicuously by <div class="lisp"><div class="tabbing">
(defun prince-of-clarity (w)
   <br>                           &#x0022;Take a cons of two lists and make a list of conses.<br>
   Think of this function as being like a zipper.&#x0022;<br>
  (do ((y (car w) (cdr y))<br>                              (z (cdr w) (cdr z))<br>
       (x &#x2019;() (cons (cons (car y) (car z)) x)))<br>                 ((null y) x)<br>
    (when (null z)<br>               (cerror &#x0022;Will self-pair extraneous items&#x0022;<br>
              &#x0022;Mismatch - gleep!  S&#x0022; y)<br>                   (setq z y))))<br>
<!--l. 3463--><p class="noindent" ></div>
<!--l. 3463--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6690007.8.5" id="x54-6690007.8.5"></a></span>
<!--l. 3463--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6700007.8.5" id="x54-6700007.8.5"></a></span>
</div>
<!--l. 3465--><p class="indent" >   The <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt> construct may be explained in terms of the simpler constructs
<tt><a 
href="symbols.html#x185-2637128r128">block</a></tt>, <tt><a 
href="symbols.html#x185-2637488r488">let</a></tt>, and <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt> as follows: <div class="lisp"><div class="tabbing">
(prog <i>variable-list</i> {<i><i>declaration</i></i>}*  . <i>body</i>)
   <br>        <span class="math"> ≡</span> (block nil (let <i>variable-list</i> {<i><i>declaration</i></i>}*  (tagbody . <i>body</i>)))<br>
<!--l. 3471--><p class="noindent" ></div>
                                                                          

                                                                          
<!--l. 3471--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6710007.8.5" id="x54-6710007.8.5"></a></span>
<!--l. 3471--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6720007.8.5" id="x54-6720007.8.5"></a></span>
</div>
<!--l. 3473--><p class="indent" >   The <tt><a 
href="symbols.html#x185-2637697r697">prog*</a></tt> special operator is almost the same as <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt>. The only
diﬀerence is that the binding and initialization of the temporary variables is
done <i>sequentially</i>, so that the <i>init</i> form for each one can use the values of
previous ones. Therefore <tt><a 
href="symbols.html#x185-2637697r697">prog*</a></tt> is to <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt> as <tt><a 
href="symbols.html#x185-2637489r489">let*</a></tt> is to <tt><a 
href="symbols.html#x185-2637488r488">let</a></tt>. For example,
<div class="lisp"><div class="tabbing">
(prog* ((y z) (x (car y)))
   <br>                                                                             (return x))<br>
<!--l. 3482--><p class="noindent" ></div>
<!--l. 3482--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6730007.8.5" id="x54-6730007.8.5"></a></span>
<!--l. 3482--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6740007.8.5" id="x54-6740007.8.5"></a></span>
</div>
<!--l. 3483--><p class="indent" >   returns the <i>car</i> of the value of <tt>z</tt>.
<div class="new">
<!--l. 3486--><p class="indent" >   I haven&#x2019;t seen <tt><a 
href="symbols.html#x185-2637696r696">prog</a></tt> used very much in the last several years. Apparently
splitting it into functional constituents (<tt><a 
href="symbols.html#x185-2637488r488">let</a></tt>, <tt><a 
href="symbols.html#x185-2637128r128">block</a></tt>, <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt>) has been a success.
Common Lisp programmers now tend to use whichever speciﬁc construct is
appropriate.
</div>
</div>
<div class="defspec">
<div class="defmacheader">
<!--l. 3494--><p class="indent" >   <div class="tabbing">
 <i>[Special operator]</i> <b>go</b> <a 
 id="dx54-674001"></a><a 
 id="x54-674002r112"></a> tag
   <br>
                                                                          

                                                                          
<!--l. 3495--><p class="noindent" ></div>
<!--l. 3495--><p class="noindent" ><span class="paragraphHead"><a 
href="#x54-6750007.8.5" id="x54-6750007.8.5"></a></span>
</div>
<!--l. 3496--><p class="indent" >   The <tt>(go <i>tag</i>)</tt> special operator is used to do a “go to” within a <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt>
construct. The <i>tag</i> must be a symbol or an integer; the <i>tag</i> is not evaluated. <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt>
transfers control to the point in the body labelled by a tag <tt><a 
href="symbols.html#x185-2637338r338">eql</a></tt> to the one given. If
there is no such tag in the body, the bodies of lexically containing <tt><a 
href="symbols.html#x185-2637872r872">tagbody</a></tt>
constructs (if any) are examined as well. It is an error if there is no matching tag
lexically visible to the point of the <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt>.
<!--l. 3506--><p class="indent" >   The <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> form does not ever return a value.
<!--l. 3508--><p class="indent" >   As a matter of style, it is recommended that the user think twice before using
a <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt>. Most purposes of <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> can be accomplished with one of the iteration
primitives, nested conditional forms, or <tt><a 
href="symbols.html#x185-2637752r752">return-from</a></tt>. If the use of <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> seems to be
unavoidable, perhaps the control structure implemented by <tt><a 
href="symbols.html#x185-2637423r423">go</a></tt> should be packaged
as a macro deﬁnition.
</div>
                                                                          

                                                                          
<!--l. 3516--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse43.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse41.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse41.html#tailclmse41.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse42.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="contrl.html#clmse42.html" >Up</a><tt>&#x003E;</tt></div><a 
 id="tailclmse42.html"></a>   </div> </div> 
</body></html> 
