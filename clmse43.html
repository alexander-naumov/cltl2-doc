<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Structure Traversal and Side Eﬀects</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,next,charset=utf-8,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-08 00:30:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 5626--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse44.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse42.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse42.html#tailclmse42.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse43.html">Tail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch7.html#clmse43.html" >Up</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">7.9   </span> <a 
 id="x55-1420007.9"></a>Structure Traversal and Side Eﬀects</h3>
<!--l. 5629--><p class="noindent" >X3J13 voted in January 1989 <a 
 id="dx55-142001"></a>to restrict side eﬀects during the course of a built-in
operation that can execute user-supplied code while traversing a data
structure.
<!--l. 5634--><p class="indent" >   Consider the following example: <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(let ((x &#x2019;(apples peaches pumpkin pie)))
</td></tr></table>
<!--l. 5636--><p class="indent" >                                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (dolist (z x)</td></tr></table>
<!--l. 5637--><p class="indent" >                                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (when (eq z &#x2019;peaches)</td></tr></table>
<!--l. 5638--><p class="indent" >                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (setf (cddr x) &#x2019;(mango kumquat)))</td></tr></table>
<!--l. 5639--><p class="indent" >                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (format t &#x0022; S &#x0022; (car z))))</td></tr></table>
<!--l. 5641--><p class="indent" >
</div>
</div>
<!--l. 5642--><p class="noindent" >Depending on the details of the implementation of <a 
href="clmse42.html#x54-134002r111">dolist</a>, this bit of code could easily
print <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">apples peaches mango kumquat
</td></tr></table>
<!--l. 5646--><p class="indent" >
</div>
</div>
<!--l. 5647--><p class="noindent" >(which is perhaps what was intended), but it might as easily print <div class=lisp> <div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">apples peaches pumpkin pie
</td></tr></table>
<!--l. 5650--><p class="indent" >
                                                                          

                                                                          
</div>
</div>
<!--l. 5651--><p class="noindent" >Here is a plausible implementation of <a 
href="clmse42.html#x54-134002r111">dolist</a> that produces the ﬁrst result: <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform &#x0026;optional (resultform ”nil))
</td></tr></table>
<!--l. 5654--><p class="indent" >                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  &#x0026;body body)</td></tr></table>
<!--l. 5655--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((tailvar (gensym &#x0022;DOLIST&#x0022;)))</td></tr></table>
<!--l. 5656--><p class="indent" >                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(do ((,tailvar ,listform (cdr ,tailvar)))</td></tr></table>
<!--l. 5657--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((null ,tailvar) ,resultform)</td></tr></table>
<!--l. 5658--><p class="indent" >                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (let ((,var (car ,tailvar))) ,@body))</td></tr></table>
<!--l. 5660--><p class="indent" >
</div>
</div>
<!--l. 5661--><p class="noindent" >But here is a plausible implementation of <a 
href="clmse42.html#x54-134002r111">dolist</a> that produces the second result: <div class=lisp>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro dolist ((var listform &#x0026;optional (resultform ”nil))
</td></tr></table>
<!--l. 5664--><p class="indent" >                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  &#x0026;body body)</td></tr></table>
<!--l. 5665--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((tailvar (gensym &#x0022;DOLIST&#x0022;)))</td></tr></table>
<!--l. 5666--><p class="indent" >                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(do ((,tailvar ,listform))</td></tr></table>
<!--l. 5667--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">         ((null ,tailvar) ,resultform)</td></tr></table>
<!--l. 5668--><p class="indent" >                               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">       (let ((,var (pop ,tailvar))) ,@body))</td></tr></table>
<!--l. 5670--><p class="indent" >
</div>
</div>
<!--l. 5672--><p class="indent" >   The X3J13 recognizes and legitimizes varying implementation practices: in
general it is an error for code executed during a “structure-traversing” operation
to destructively modify the structure in a way that might aﬀect the ongoing
traversal operation. The committee identiﬁed in particular the following special
cases.
<!--l. 5678--><p class="indent" >   For list traversal operations, the <i>cdr</i> chain may not be destructively
modiﬁed.
                                                                          

                                                                          
<!--l. 5681--><p class="indent" >   For array traversal operations, the array may not be adjusted (see
<a 
href="clmse99.html#x121-243002r592">adjust-array</a>) and its ﬁll pointer, if any, may not be modiﬁed.
<!--l. 5684--><p class="indent" >   For hash table operations (such as <a 
href="clmse92.html#x113-234022r552">with-hash-table-iterator</a> and <a 
href="clmse92.html#x113-234015r549">maphash</a>), new
entries may not be added or deleted, <i>except</i> that the very entry being processed
by user code may be changed or deleted.
<!--l. 5689--><p class="indent" >   For package symbol operations (for example, <a 
href="clmse63.html#x79-192006r201">with-package-iterator</a> and
<a 
href="clmse63.html#x79-189005r198">do-symbols</a>), new symbols may not be interned in, nor symbols uninterned from,
the packages being traversed or any packages they use, <i>except</i> that the very
symbol being processed by user code may be uninterned.
<!--l. 5695--><p class="indent" >   X3J13 noted that this vote is intended to clarify restrictions on the use of
structure traversal operations that are not themselves inherently destructive; for
example, it applies to <a 
href="clmse82.html#x101-219005r407">map</a> and <a 
href="clmse42.html#x54-134002r111">dolist</a>. Destructive operators such as <a 
href="clmse83.html#x102-220014r419">delete</a>
require even more complicated restrictions and are addressed by a separate
proposal.
<!--l. 5701--><p class="indent" >   The X3J13 vote did not specify a complete list of the operations to
which these restrictions apply. Table <a 
href="#x55-1420021">7.1<!--tex4ht:ref: TRAVERSAL-OPERATIONS-TABLE --></a> shows what I believe to be a
complete list of operations that traverse structures and take user code as a
body (in the case of macros) or as a functional argument (in the case of
functions).
<!--l. 5707--><p class="indent" >   In addition, note that user code should not modify list structure that might be
undergoing interpretation by the evaluator, whether explicitly invoked via <a 
href="clmse110.html#x135-261002r620">eval</a> or
implicitly invoked, for example as in the case of a hook function (a <a 
href="clmse104.html#x128-250002r619">defstruct</a> print
function, the value of *evalhook* or *applyhook*, etc.) that happens to be a
closure of interpreted code. Similarly, <a 
href="clmse104.html#x128-250002r619">defstruct</a> print functions and other hooks
should not perform side eﬀects on data structures being printed or being
processed by <a 
href="clmse117.html#x144-287003r730">format</a>, or on a string given to <a 
href="clmse113.html#x139-265018r648">make-string-input-stream</a>. You get
the idea; be sensible.
<!--l. 5718--><p class="indent" >   Note that an operation such as <a 
href="clmse42.html#x54-137003r113">mapcar</a> or <a 
href="clmse42.html#x54-134002r111">dolist</a> traverses not only <i>cdr</i>
pointers (in order to chase down the list) but also <i>car</i> pointers (in order to obtain
the elements themselves). The restriction against modiﬁcation appears to apply to
all these pointers.
</div>
   <div class="table">
                                                                          

                                                                          
<!--l. 5724--><p class="indent" >   <a 
 id="x55-1420021"></a><hr class="float"><div class="float" 
>
                                                                          

                                                                          
<div class=new>
<br /> <div class="caption" 
><span class="id">Table 7.1: </span><span  
class="content">Structure Traversal Operations Subject to Side Eﬀect Restrictions</span></div><!--tex4ht:label?: x55-1420021 -->
<div class="tabular"><table width="100%"><tr><td align="left" >adjoin                   </td><td align="left" >maphash           </td><td align="left" >reduce                       </td>
</tr><tr><td align="left" >assoc                    </td><td align="left" >mapl                </td><td align="left" >remove                      </td>
</tr><tr><td align="left" >assoc-if                  </td><td align="left" >maplist             </td><td align="left" >remove-duplicates        </td>
</tr><tr><td align="left" >assoc-if-not            </td><td align="left" >member            </td><td align="left" >remove-if                   </td></tr><tr><td align="left" >count  </td><td align="left" >member-if </td><td align="left" >remove-if-not</td>
</tr><tr><td align="left" >count-if                 </td><td align="left" >member-if-not    </td><td align="left" >search                       </td></tr><tr><td align="left" >count-if-not  </td><td align="left" >merge </td><td align="left" >set-diﬀerence</td>
</tr><tr><td align="left" >delete                    </td><td align="left" >mismatch          </td><td align="left" >set-exclusive-or           </td></tr><tr><td align="left" >delete-duplicates  </td><td align="left" >nintersection </td><td align="left" >some</td>
</tr><tr><td align="left" >delete-if                 </td><td align="left" >notany              </td><td align="left" >sort                          </td>
</tr><tr><td align="left" >delete-if-not           </td><td align="left" >notevery            </td><td align="left" >stable-sort                 </td>
</tr><tr><td align="left" >do-all-symbols        </td><td align="left" >nset-diﬀerence    </td><td align="left" >sublis                        </td>
</tr><tr><td align="left" >do-external-symbols </td><td align="left" >nset-exclusive-or </td><td align="left" >subsetp                     </td>
</tr><tr><td align="left" >do-symbols             </td><td align="left" >nsublis              </td><td align="left" >subst                        </td>
</tr><tr><td align="left" >dolist                    </td><td align="left" >nsubst              </td><td align="left" >subst-if                      </td>
</tr><tr><td align="left" >eval                      </td><td align="left" >nsubst-if            </td><td align="left" >subst-if-not                </td>
</tr><tr><td align="left" >every                    </td><td align="left" >nsubst-if-not      </td><td align="left" >substitute                  </td>
</tr><tr><td align="left" >ﬁnd                      </td><td align="left" >nsubstitute        </td><td align="left" >substitute-if               </td>
</tr><tr><td align="left" >ﬁnd-if                   </td><td align="left" >nsubstitute-if     </td><td align="left" >substitute-if-not          </td>
</tr><tr><td align="left" >ﬁnd-if-not              </td><td align="left" >nsubstitute-if-not</td><td align="left" >tree-equal                  </td>
</tr><tr><td align="left" >intersection            </td><td align="left" >nunion              </td><td align="left" >union                        </td>
</tr><tr><td align="left" >certain loop clauses  </td><td align="left" >position            </td><td align="left" >with-hash-table-iterator</td>
</tr><tr><td align="left" >map                      </td><td align="left" >position-if          </td><td align="left" >with-input-from-string  </td>
</tr><tr><td align="left" >mapc                    </td><td align="left" >position-if-not    </td><td align="left" >with-output-to-string   </td>
</tr><tr><td align="left" >mapcan                 </td><td align="left" >rassoc               </td><td align="left" >with-package-iterator   </td>
</tr><tr><td align="left" >mapcar                 </td><td align="left" >rassoc-if            </td>
</tr><tr><td align="left" >mapcon                 </td><td align="left" >rassoc-if-not       </td></tr></table></div>
</div>
                                                                          

                                                                          
   </div><hr class="endfloat" />
   </div>
                                                                          

                                                                          
   <!--l. 5767--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmse44.html" >Next</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse42.html" >Prev</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse42.html#tailclmse42.html" >PrevTail</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse43.html" >Front</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch7.html#clmse43.html" >Up</a><tt>&#x003E;</tt></p></div>
<!--l. 5767--><p class="indent" >   <a 
 id="tailclmse43.html"></a>  
</body></html> 
