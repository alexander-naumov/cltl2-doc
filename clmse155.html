<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Primitives</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-03-19 15:57:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
</head><body 
>
   <!--l. 1553--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmap2.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse154.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse154.html#tailclmse154.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse155.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmap1.html#clmse155.html" >Вверх</a><tt>&#x003E;</tt></p></div>
   <h3 class="sectionHead"><span class="titlemark">A.4   </span> <a 
href="clm.html#QQ2-190-529" id="x190-489000A.4">Primitives</a></h3>
<!--l. 1555--><p class="noindent" >A large number of series functions are provided, because there are a large number
of useful operations that can be performed on series. However, this functionality
can be boiled down to a small number of primitive constructs.
<!--l. 1560--><p class="indent" >   <a 
href="clmse153.html#x188-480012r1038">collecting-fn</a> embodies the fundamental idea of series computations that
utilize internal state. It can be used as the basis for deﬁning any on-line
transducer.
<!--l. 1564--><p class="indent" >   <a 
href="clmse153.html#x188-480004r1034">until</a> embodies the fundamental idea of producing a series that is shorter than
the shortest input series. In particular, it embodies the idea of computing a
bounded series from non-series inputs. Together with <a 
href="clmse153.html#x188-480012r1038">collecting-fn</a>, <a 
href="clmse153.html#x188-480004r1034">until</a> can be
used to deﬁne <a 
href="clmse153.html#x188-476026r1028">scan-fn</a>, which can be used as the basis for deﬁning all the other
scanners.
<!--l. 1570--><p class="indent" >   <a 
href="clmse153.html#x188-482004r1051">collect-last</a> embodies the fundamental idea of producing a non-series value
from a series. Together with <a 
href="clmse153.html#x188-480012r1038">collecting-fn</a>, it can be used to deﬁne <a 
href="clmse153.html#x188-482038r1068">collect-fn</a>, which
(with the occasional assistance of <a 
href="clmse153.html#x188-480004r1034">until</a>) can be used as the basis for deﬁning all
the other collectors.
<!--l. 1576--><p class="indent" >   <a 
href="#x190-489002r1075">producing</a> embodies the fundamental idea of preorder computation. It can be
used as the basis for deﬁning all the other series functions, including the oﬀ-line
transducers.
<!--l. 1580--><p class="indent" >   In addition to the above, four primitives support various specialized aspects of
series functions. Alterability is supported by the function <a 
href="clmse153.html#x188-483004r1070">to-alter</a> and the
declaration <a 
href="#x190-491002r1077">propagate-alterability</a>. The propagation of type information is
supported by the type speciﬁer <a 
href="clmse154.html#x189-488002r1074">series-element-type</a>. The best implementation of
certain series functions requires the form <a 
href="#x190-491004r1078">encapsulated</a>.
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> producing </b><a 
 id="dx190-489001"></a><a 
 id="x190-489002r1075"></a> output-list input-list  {declaration}*  { form}*
</td></tr></table>
                                                                          

                                                                          
<!--l. 1590--><p class="indent" >
</div>
<!--l. 1590--><p class="noindent" ><span class="paragraphHead"><a 
href="#x190-490000A.4" id="x190-490000A.4"></a></span>
   <a 
href="#x190-489002r1075">producing</a> computes and returns a group of series and non-series outputs given
a group of series and non-series inputs. The key feature of <a 
href="#x190-489002r1075">producing</a> is
that some or all of the series inputs and outputs can be processed in an
oﬀ-line way. To support this, the processing in the body (consisting of the
<i>forms</i>) is performed from the perspective of generators and gatherers (see
appendix <a 
href="clmap2.html#x191-493000B">B<!--tex4ht:ref: GENERATORS --></a>). Each series input is converted to a generator before being
used in the body. Each series output is associated with a gatherer in the
body.
<!--l. 1601--><p class="indent" >   The <i>output-list</i> has the same syntax as the binding list of a <a 
href="clmse39.html#x51-100002r74">let</a>. The names of
the variables must be distinct from each other and from the names of the variables
in the input-list. If there are <i>n</i> variables in the <i>output-list</i>, <a 
href="#x190-489002r1075">producing</a> computes <i>n</i>
outputs. There must be at least one output variable. The variables act as the
names for the outputs and can be used in either of two ways. First, if an output
variable has a value associated with it in the <i>output-list</i>, then the variable is
treated as holding a non-series value. The variable is initialized to the
indicated value and can be used in any way desired in the body. The
eventual output value is whatever value is in the variable when the execution
of the body terminates. Second, if an output variable does not have a
value associated with it in the <i>output-list</i>, the variable is given as its
value a gatherer that collects elements. The only valid way to use the
variable in the body is in a call on <a 
href="clmse158.html#x194-497004r1082">next-out</a>. The output returned is a series
containing these elements. If the body never terminates, this series is
unbounded.
<!--l. 1618--><p class="indent" >   The <i>input-list</i> also has the same syntax as the binding list of a <a 
href="clmse39.html#x51-100002r74">let</a>. The names
of the variables must be distinct from each other and the names of the variables in
the <i>output-list</i>. The values can be series or non-series. If the value is not explicitly
speciﬁed, it defaults to <a 
href="clmse31.html#x42-74002r18">nil</a>. The variables act logically both as inputs and state
variables and can be used in one of two ways. First, if an input variable is
associated with a non-series value, then it is given this value before the
evaluation of the body begins and can be used in any way desired in the
body. Second, if an input variable is associated with a series, then the
variable is given a generator corresponding to this series as its initial
                                                                          

                                                                          
value. The only valid way to use the variable in the body is in a call on
<a 
href="clmse157.html#x193-495004r1080">next-in</a>.
<!--l. 1631--><p class="indent" >   There can be declarations at the start of the body. However, the only declarations
allowed are ignore declarations, type declarations, and <a 
href="#x190-491002r1077">propagate-alterability</a>
declarations (see below). In particular, it is an error for any of the input or output
variables to be special.
<!--l. 1637--><p class="indent" >   In conception, the body can contain arbitrary Lisp expressions. After the
appropriate generators and gatherers have been set up, the body is executed until
it terminates. If the body never terminates, the series outputs (if any)
are unbounded in length and the non-series outputs (if any) are never
produced.
<!--l. 1643--><p class="indent" >   Although easy to understand, this view of what can happen in the body
presents severe diﬃculties when optimizing (and even when evaluating)
series expressions that contain calls on <a 
href="#x190-489002r1075">producing</a>. As a result, several
limitations are imposed on the form of the body to simplify the processing
required.
<!--l. 1649--><p class="indent" >   The ﬁrst limitation is that, exclusive of any declarations, the body must have
the form (loop (tagbody ...)). The following example shows how <a 
href="#x190-489002r1075">producing</a> could
be used to implement a scanner creating an unbounded series of integers.
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(producing (nums) ((num 0))
</td></tr></table>
<!--l. 1654--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (declare (integer num) (type (series integer) nums))</td></tr></table>
<!--l. 1655--><p class="indent" >                                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (loop</td></tr></table>
<!--l. 1656--><p class="indent" >                                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (tagbody</td></tr></table>
<!--l. 1657--><p class="indent" >                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (setq num (1+ num))</td></tr></table>
<!--l. 1658--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (next-out nums num))))</td></tr></table>
<!--l. 1659--><p class="indent" >                                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  <span class="math"> ⇒</span> #Z(1 2 3 4 ...)</td></tr></table>
<!--l. 1661--><p class="indent" >
</div>
</div>
<!--l. 1663--><p class="indent" >   The second limitation is that the form <a 
href="#x190-490002r1076">terminate-producing</a> must be used to
terminate the execution of the body. Any other method of terminating the body
(with <a 
href="clmse137.html#x168-343002r840">return</a>, for example) is an error. The following example shows how
<a 
href="#x190-489002r1075">producing</a> could be used to implement the operation of summing a series. The
                                                                          

                                                                          
function <a 
href="#x190-490002r1076">terminate-producing</a> is used to stop the computation when numbers runs
out of elements. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(producing ((sum 0)) ((numbers #Z(1 2 3)) num)
</td></tr></table>
<!--l. 1671--><p class="indent" >                                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (loop</td></tr></table>
<!--l. 1672--><p class="indent" >                                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (tagbody</td></tr></table>
<!--l. 1673--><p class="indent" >                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (setq num (next-in numbers (terminate-producing)))</td></tr></table>
<!--l. 1674--><p class="indent" >                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (setq sum (+ sum num)))))</td></tr></table>
<!--l. 1675--><p class="indent" >                                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  <span class="math"> ⇒</span> 6</td></tr></table>
<!--l. 1677--><p class="indent" >
</div>
</div>
<!--l. 1679--><p class="indent" >   The third limitation is that calls on <a 
href="clmse158.html#x194-497004r1082">next-out</a> associated with output variables
must appear at top level in the <a 
href="clmse42.html#x54-126002r101">tagbody</a> in the body. They cannot be nested in
other forms. In addition, an output variable can be the destination of at most one
call on <a 
href="clmse158.html#x194-497004r1082">next-out</a> and if it is the destination of a <a 
href="clmse158.html#x194-497004r1082">next-out</a>, it cannot be used in any
other way.
<!--l. 1686--><p class="indent" >   If the call on <a 
href="clmse158.html#x194-497004r1082">next-out</a> for a given output appears in the ﬁnal part of the
<a 
href="clmse42.html#x54-126002r101">tagbody</a> in the body, after everything other than other calls on <a 
href="clmse158.html#x194-497004r1082">next-out</a>, then the
output is an on-line output—a new value is written on every cycle of the body.
Otherwise the output is oﬀ-line.
<!--l. 1692--><p class="indent" >   The following example shows how <a 
href="#x190-489002r1075">producing</a> could be used to split a series
into two parts. Items are read in one at a time and tested. Depending on the test,
they are written to one of two outputs. Note the use of labels and branches to
keep the calls on <a 
href="clmse158.html#x194-497004r1082">next-out</a> at top level. Both outputs are oﬀ-line. The ﬁrst example
above shows an on-line output. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(producing (items-1 items-2) ((items #Z(1 -2 3 -4)) item)
</td></tr></table>
<!--l. 1699--><p class="indent" >                                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (loop</td></tr></table>
<!--l. 1700--><p class="indent" >           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (tagbody (setq item (next-in items (terminate-producing)))</td></tr></table>
<!--l. 1701--><p class="indent" >                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (if (not (plusp item)) (go D))</td></tr></table>
<!--l. 1702--><p class="indent" >                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (next-out items-1 item)</td></tr></table>
<!--l. 1703--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (go F)</td></tr></table>
<!--l. 1704--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      D      (next-out items-2 item)</td></tr></table>
                                                                          

                                                                          
<!--l. 1705--><p class="indent" >                                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      F      )))</td></tr></table>
<!--l. 1706--><p class="indent" >                                              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  <span class="math"> ⇒</span> #Z(1 3) and #Z(-2 -4)</td></tr></table>
<!--l. 1708--><p class="indent" >
</div>
</div>
<!--l. 1710--><p class="indent" >   The fourth limitation is that the calls on <a 
href="clmse157.html#x193-495004r1080">next-in</a> associated with an input
variable v must appear at top level in the <a 
href="clmse42.html#x54-126002r101">tagbody</a> in the body, nested in
assignments of the form (setq <i>var</i> (next-in v ...)). They cannot be nested in
other forms. In addition, an input variable can be the source for at most one call
on <a 
href="clmse157.html#x193-495004r1080">next-in</a> and if it is the source for a <a 
href="clmse157.html#x193-495004r1080">next-in</a>, it cannot be used in any other
way.
<!--l. 1718--><p class="indent" >   If the call on <a 
href="clmse157.html#x193-495004r1080">next-in</a> for a given input has as its sole termination action
(terminate-producing) and appears in the initial part of the <a 
href="clmse42.html#x54-126002r101">tagbody</a> in the body,
before anything other than similar calls on <a 
href="clmse157.html#x193-495004r1080">next-in</a>, then the input is an on-line
input—a new value is read on every cycle of the body. Otherwise the input is
oﬀ-line.
<!--l. 1725--><p class="indent" >   The example below shows how <a 
href="#x190-489002r1075">producing</a> could be used to concatenate two
series. To start with, elements are read from the ﬁrst input series. When this runs
out, a ﬂag is set and reading begins from the second input. Both inputs are
oﬀ-line. (Compare this to the example above, which shows an on-line input.)
<div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(producing (items) ((item-1 #Z(1 2))
</td></tr></table>
<!--l. 1732--><p class="indent" >                                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                    (item-2 #Z(3 4))</td></tr></table>
<!--l. 1733--><p class="indent" >                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                    (in-2 nil)</td></tr></table>
<!--l. 1734--><p class="indent" >                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                    item)</td></tr></table>
<!--l. 1735--><p class="indent" >                                                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (loop</td></tr></table>
<!--l. 1736--><p class="indent" >                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (tagbody (if in-2 (go D))</td></tr></table>
<!--l. 1737--><p class="indent" >            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (setq item (next-in item-1 (setq in-2 t) (go D)))</td></tr></table>
<!--l. 1738--><p class="indent" >                                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">             (go F)</td></tr></table>
<!--l. 1739--><p class="indent" >         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      D      (setq item (next-in item-2 (terminate-producing)))</td></tr></table>
<!--l. 1740--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      F      (next-out items item))))</td></tr></table>
<!--l. 1741--><p class="indent" >                                                         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  <span class="math"> ⇒</span> #Z(1 2 3 4)</td></tr></table>
<!--l. 1743--><p class="indent" >
</div>
                                                                          

                                                                          
</div>
</div>
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> terminate-producing </b><a 
 id="dx190-490001"></a><a 
 id="x190-490002r1076"></a> <span class="math"> !</span>
</td></tr></table>
<!--l. 1748--><p class="indent" >
</div>
<!--l. 1748--><p class="noindent" ><span class="paragraphHead"><a 
href="#x190-491000A.4" id="x190-491000A.4"></a></span>
   This form (which takes no arguments) is used to terminate execution of (the
expansion of) the <a 
href="#x190-489002r1075">producing</a> macro.
<!--l. 1752--><p class="indent" >   As with the form <a 
href="clmse42.html#x54-128002r104">go</a>, <a 
href="#x190-490002r1076">terminate-producing</a> does not return any values; rather,
control immediately leaves the current context.
<!--l. 1756--><p class="indent" >   The form <a 
href="#x190-490002r1076">terminate-producing</a> is allowed to appear only in a <a 
href="#x190-489002r1075">producing</a> body
and causes the termination of the enclosing call on <a 
href="#x190-489002r1075">producing</a>.
</div>
<div class=defun>
<!--l. 1761--><p class="noindent" ><i>[Declaration speciﬁer]</i><a 
 id="dx190-491001"></a><a 
 id="x190-491002r1077"></a><b> propagate-alterability</b>
<!--l. 1763--><p class="noindent" >The declaration speciﬁer (propagate-alterability <i>input</i> <i>output</i>) indicates that
attempts to alter an element of <i>output</i> should be satisﬁed by altering the
corresponding element of <i>input</i>. (The corresponding element of <i>input</i> is
the one most recently read at the moment when the output element is
written.)
<!--l. 1771--><p class="indent" >   This declaration may appear only in a call on <a 
href="#x190-489002r1075">producing</a>. The <i>input</i> and
<i>output</i> arguments must be an input and an output, respectively, of the <a 
href="#x190-489002r1075">producing</a>
macro. The example below shows how the propagation of alterability could be
supported in a simpliﬁed version of <a 
href="clmse153.html#x188-480004r1034">until</a>. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defun simple-until (bools items)
</td></tr></table>
<!--l. 1777--><p class="indent" >                                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (declare (optimizable-series-function))</td></tr></table>
<!--l. 1778--><p class="indent" >                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (producing (z) ((x bools) (y items) bool item)</td></tr></table>
                                                                          

                                                                          
<!--l. 1779--><p class="indent" >                                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (declare (propagate-alterability y z))</td></tr></table>
<!--l. 1780--><p class="indent" >                                                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (loop</td></tr></table>
<!--l. 1781--><p class="indent" >                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">      (tagbody</td></tr></table>
<!--l. 1782--><p class="indent" >                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (setq bool (next-in x (terminate-producing)))</td></tr></table>
<!--l. 1783--><p class="indent" >                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (setq item (next-in y (terminate-producing)))</td></tr></table>
<!--l. 1784--><p class="indent" >                                  <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (if bool (terminate-producing))</td></tr></table>
<!--l. 1785--><p class="indent" >                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">        (next-out z item)))))</td></tr></table>
<!--l. 1787--><p class="indent" >
</div>
</div>
</div>
<div class=defmac>
<div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"> <i>[Макрос]</i><b> encapsulated </b><a 
 id="dx190-491003"></a><a 
 id="x190-491004r1078"></a> encapsulating-fn scanner-or-collector
</td></tr></table>
<!--l. 1792--><p class="indent" >
</div>
<!--l. 1792--><p class="noindent" ><span class="paragraphHead"><a 
href="#x190-492000A.4" id="x190-492000A.4"></a></span>
   Some of the features provided by Common Lisp are supported solely by
encapsulating forms. For example, there is no way to specify a cleanup
expression that will always be run, even when an abort occurs, without using
<a 
href="clmse44.html#x56-140004r115">unwind-protect</a>. <a 
href="#x190-491004r1078">encapsulated</a> makes it possible to take advantage of forms such as
<a 
href="clmse44.html#x56-140004r115">unwind-protect</a> when deﬁning a series function.
<!--l. 1798--><p class="indent" >   <a 
href="#x190-491004r1078">encapsulated</a> speciﬁes a function that places an encapsulating form around the
computation performed by its second argument. The ﬁrst argument must be a
quoted function that takes a Lisp expression and wraps the appropriate
encapsulating form around it, returning the resulting code. The second input must
be a literal call on <a 
href="clmse153.html#x188-476026r1028">scan-fn</a>, <a 
href="clmse153.html#x188-476028r1029">scan-fn-inclusive</a>, or <a 
href="clmse153.html#x188-482038r1068">collect-fn</a>. The second argument
can count on being evaluated in the scope of the encapsulating form. The values
returned by the second argument are returned as the values of <a 
href="#x190-491004r1078">encapsulated</a>. The
following shows how <a 
href="#x190-491004r1078">encapsulated</a> could be used to deﬁne a simpliﬁed version of
<a 
href="clmse153.html#x188-482036r1067">collect-ﬁle</a>. <div class=lisp><div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defun collect-ﬁle-wrap (ﬁle name body)
</td></tr></table>
<!--l. 1808--><p class="indent" >                   <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ‘(with-open-ﬁle (,ﬁle ,name :direction :output) ,body))</td></tr></table>
<!--l. 1809--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 1810--><p class="indent" >                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmacro simple-collect-ﬁle (name items)</td></tr></table>
<!--l. 1811--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (let ((ﬁle (gensym)))</td></tr></table>
<!--l. 1812--><p class="indent" >                                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(encapsulated #&#x2019;(lambda (body)</td></tr></table>
<!--l. 1813--><p class="indent" >           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                       (collect-ﬁle-wrap &#x2019;,ﬁle &#x2019;,name body))</td></tr></table>
<!--l. 1814--><p class="indent" >                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                   (collect-fn t #&#x2019;(lambda () t)</td></tr></table>
<!--l. 1815--><p class="indent" >               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                               #&#x2019;(lambda (state item)</td></tr></table>
<!--l. 1816--><p class="indent" >                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                                   (print item ,ﬁle)</td></tr></table>
<!--l. 1817--><p class="indent" >                           <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                                   state)</td></tr></table>
<!--l. 1818--><p class="indent" >                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                               ,items))))</td></tr></table>
<!--l. 1820--><p class="indent" >
</div>
</div>
</div>
<!--l. 1822--><p class="indent" >
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
                                                                          

                                                                          
   <!--l. 7--><div class="crosslinks"><p class="noindent"><tt>&#x003C;</tt><a 
href="clmap2.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse154.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse154.html#tailclmse154.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse155.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmap1.html#clmse155.html" >Вверх</a><tt>&#x003E;</tt></p></div>
<!--l. 7--><p class="indent" >   <a 
 id="tailclmse155.html"></a>  
</body></html> 
