<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//RU"  
  "http://www.w3.org/TR/html4/loose.dtd">  
<html > 
<head><title>Loading Files</title> 
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"> 
<meta name="generator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<meta name="originator" content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)"> 
<!-- 3,index=2,next,fn-in,charset=utf-8,sections+,minitoc<,html --> 
<meta name="src" content="clm.tex"> 
<meta name="date" content="2012-04-12 20:56:00"> 
<link rel="stylesheet" type="text/css" href="clm.css"> 
<link rel="stylesheet" type="text/css" href="cltl2ed.css"></head><body 
>
<!--l. 2550--><p class="noindent" > <div id="main_container"> <div id="content"> <div id="toplinks"><tt>&#x003C;</tt><a 
href="clmse116.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse114.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse114.html#tailclmse114.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="#tailclmse115.html">В-конец</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch23.html#clmse115.html" >Наверх</a><tt>&#x003E;</tt></div><h3 class="sectionHead"><span class="titlemark">23.4   </span> <a 
href="clm.html#QQ2-143-300" id="x143-27900023.4">Loading
Files</a></h3>
<!--l. 2552--><p class="noindent" >To <i>load</i> a ﬁle is to read through the ﬁle, evaluating each form in it. Programs
are typically stored in ﬁles containing calls to constructs such as <tt><a 
href="clmse29.html#x39-66002r13">defun</a></tt>,
<tt><a 
href="clmse44.html#x57-143004r118">defmacro</a></tt>, and <tt><a 
href="clmse29.html#x39-68002r14">defvar</a></tt>, which deﬁne the functions and variables of the
program.
<!--l. 2558--><p class="indent" >   Loading a compiled (“fasload”) ﬁle is similar, except that the ﬁle does not
contain text but rather pre-digested expressions created by the compiler that can
be loaded more quickly.
<div class=defun>
<!--l. 2562--><p class="noindent" ><i>[Function]</i><a 
 id="dx143-279001"></a><a 
 id="x143-279002r708"></a><b> load</b>  <i>ﬁlename</i> &#x0026;key  <i>:verbose</i> <i>:print</i> <i>:if-does-not-exist</i>
<!--l. 2564--><p class="noindent" >This function loads the ﬁle named by <i>ﬁlename</i> into the Lisp environment. It is
assumed that a text (character ﬁle) can be automatically distinguished from an
object (binary) ﬁle by some appropriate implementation-dependent means,
possibly by the ﬁle type. The defaults for <i>ﬁlename</i> are taken from the variable
<tt>*default-pathname-defaults*</tt>. If the <i>ﬁlename</i> (after the merging in
of the defaults) does not explicitly specify a type, and both text and
object types of the ﬁle are available in the ﬁle system, <tt><a 
href="#x143-279002r708">load</a></tt> should try
to select the more appropriate ﬁle by some implementation-dependent
means.
<!--l. 2577--><p class="indent" >   If the ﬁrst argument is a stream rather than a pathname, then <tt><a 
href="#x143-279002r708">load</a></tt>
determines what kind of stream it is and loads directly from the stream.
<!--l. 2581--><p class="indent" >   The <tt>:verbose</tt> argument (which defaults to the value of <tt>*load-verbose*</tt>), if
true, permits <tt><a 
href="#x143-279002r708">load</a></tt> to print a message in the form of a comment (that is, with a
leading semicolon) to <tt><a 
href="clmse105.html#x131-239004r579">*standard-output*</a></tt> indicating what ﬁle is being loaded and
other useful information.
<div class=obsolete>
<!--l. 2588--><p class="indent" >   The <tt>:print</tt> argument (default <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt>), if true, causes the value of each
expression loaded to be printed to <tt><a 
href="clmse105.html#x131-239004r579">*standard-output*</a></tt>. If a binary ﬁle is being
loaded, then what is printed may not reﬂect precisely the contents of the source
ﬁle, but nevertheless some information will be printed.
</div> <div class=newer> X3J13 voted in March 1989 <a 
 id="dx143-279003"></a>to add the variable <tt>*load-print*</tt>; its value is used
as the default for the <tt>:print</tt> argument to <tt><a 
href="#x143-279002r708">load</a></tt>.
                                                                          

                                                                          
</div>
<div class=newer>
<!--l. 2601--><p class="indent" >   The function <tt><a 
href="#x143-279002r708">load</a></tt> rebinds <tt><a 
href="clmse59.html#x75-167002r141">*package*</a></tt> to its current value. If some form in the
ﬁle changes the value of <tt><a 
href="clmse59.html#x75-167002r141">*package*</a></tt> during loading, the old value will be restored
when the loading is completed. (This was speciﬁed in the ﬁrst edition under
the description of <tt><a 
href="clmse59.html#x75-167002r141">*package*</a></tt>; for convenience I now mention it here as
well.)
</div>
<div class=new>
<!--l. 2609--><p class="indent" >   X3J13 voted in March 1988 <a 
 id="dx143-279004"></a>to specify exactly which streams may be used as
pathnames. See section <a 
href="clmse112.html#x140-27500023.1.6">23.1.6<!--tex4ht:ref: PATHNAME-FUNCTIONS --></a>.
</div>
<div class=newer>
<!--l. 2616--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx143-279005"></a>to clarify that supplying a wild pathname as the
<i>ﬁlename</i> argument to <tt><a 
href="#x143-279002r708">load</a></tt> has implementation-dependent consequences; <tt><a 
href="#x143-279002r708">load</a></tt>
might signal an error, for example, or might load all ﬁles that match the
pathname.
</div>
<div class=newer>
<!--l. 2624--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx143-279006"></a>to require <tt><a 
href="#x143-279002r708">load</a></tt> to accept logical pathnames (see
section <a 
href="clmse112.html#x140-26900023.1.5">23.1.5<!--tex4ht:ref: LOGICAL-PATHNAMES-SECTION --></a>).
</div>
<!--l. 2628--><p class="indent" >   If a ﬁle is successfully loaded, <tt><a 
href="#x143-279002r708">load</a></tt> always returns a non-<tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt> value. If
<tt>:if-does-not-exist</tt> is speciﬁed and is <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt>, <tt><a 
href="#x143-279002r708">load</a></tt> just returns <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt> rather than
signaling an error if the ﬁle does not exist.
<div class=newer>
<!--l. 2634--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx143-279007"></a>to require that <tt><a 
href="#x143-279002r708">load</a></tt> bind <tt>*readtable*</tt> to its
current value at the time <tt><a 
href="#x143-279002r708">load</a></tt> is called; the dynamic extent of the binding should
encompass all of the ﬁle-loading activity. This allows a portable program to
include forms such as <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(in-package &#x0022;FOO&#x0022;)
</td></tr></table>
<!--l. 2640--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 2641--><p class="indent" >                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(eval-when (:execute :load-toplevel :compile-toplevel)</td></tr></table>
<!--l. 2642--><p class="indent" >                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (setq *readtable* foo:my-readtable))</td></tr></table>
<!--l. 2644--><p class="indent" >
                                                                          

                                                                          
</div>
</div>
<!--l. 2645--><p class="noindent" >without performing a net global side eﬀect on the loading environment. Such
statements allow the remainder of such a ﬁle to be read either as interpreted code
or by <tt><a 
href="clmse117.html#x146-282006r717">compile-file</a></tt> in a syntax determined by an alternative readtable.
</div>
<div class=newer>
<!--l. 2652--><p class="indent" >   X3J13 voted in June 1989 <a 
 id="dx143-279008"></a>to require that <tt><a 
href="#x143-279002r708">load</a></tt> bind two new variables
<tt>*load-pathname*</tt> and <tt>*load-truename*</tt>; the dynamic extent of the bindings
should encompass all of the ﬁle-loading activity.
</div>
</div>
<div class=defun>
<!--l. 2659--><p class="noindent" ><i>[Variable]</i><a 
 id="dx143-279009"></a><a 
 id="x143-279010r709"></a><b> *load-verbose*</b>
<!--l. 2661--><p class="noindent" >This variable provides the default for the <tt>:verbose</tt> argument to <tt><a 
href="#x143-279002r708">load</a></tt>. Its initial
value is implementation-dependent.
</div>
<div class=newer>
<div class=defun>
<!--l. 2668--><p class="noindent" ><i>[Variable]</i><a 
 id="dx143-279011"></a><a 
 id="x143-279012r710"></a><b> *load-print*</b>
<!--l. 2670--><p class="noindent" >X3J13 voted in March 1989 <a 
 id="dx143-279013"></a>to add <tt>*load-print*</tt>. This variable provides the
default for the <tt>:print</tt> argument to <tt><a 
href="#x143-279002r708">load</a></tt>. Its initial value is <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt>.
</div>
</div>
<div class=newer>
<div class=defun>
<!--l. 2679--><p class="noindent" ><i>[Variable]</i><a 
 id="dx143-279014"></a><a 
 id="x143-279015r711"></a><b> *load-pathname*</b>
<!--l. 2681--><p class="noindent" >X3J13 voted in June 1989 <a 
 id="dx143-279016"></a>to introduce <tt>*load-pathname*</tt>; it is initially <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt> but
<tt><a 
href="#x143-279002r708">load</a></tt> binds it to a pathname that represents the ﬁle name given as the ﬁrst
argument to <tt><a 
href="#x143-279002r708">load</a></tt> merged with the defaults (see <tt>merge-pathname</tt>).
</div>
<div class=defun>
<!--l. 2688--><p class="noindent" ><i>[Variable]</i><a 
 id="dx143-279017"></a><a 
 id="x143-279018r712"></a><b> *load-truename*</b>
<!--l. 2690--><p class="noindent" >X3J13 voted in June 1989 <a 
 id="dx143-279019"></a>to introduce <tt>*load-truename*</tt>; it is initially
<tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt> but <tt><a 
href="#x143-279002r708">load</a></tt> binds it to the “true name” of the ﬁle being loaded. See
<tt><a 
href="clmse112.html#x140-275010r680">truename</a></tt>.
</div>
</div>
                                                                          

                                                                          
<div class=newer>
<!--l. 2698--><p class="indent" >   X3J13 voted in March 1989 <a 
 id="dx143-279020"></a>to introduce a facility based on the Object System
whereby a user can specify how <tt><a 
href="clmse117.html#x146-282006r717">compile-file</a></tt> and <tt><a 
href="#x143-279002r708">load</a></tt> must cooperate to
reconstruct compile-time constant objects at load time. The protocol is simply
this: <tt><a 
href="clmse117.html#x146-282006r717">compile-file</a></tt> calls the generic function <tt><a 
href="#x143-279022r713">make-load-form</a></tt> on any object that
is referenced as a constant or as a self-evaluating form, if the object&#x2019;s metaclass is
<tt>standard-class</tt>, <tt>structure-class</tt>, any user-deﬁned metaclass (not a subclass of
<tt>built-in-class</tt>), or any of a possibly empty implementation-deﬁned list of other
metaclasses; <tt><a 
href="clmse117.html#x146-282006r717">compile-file</a></tt> will call <tt><a 
href="#x143-279022r713">make-load-form</a></tt> only once for any given
object (as determined by <tt><a 
href="clmse32.html#x43-77002r44">eq</a></tt>) within a single ﬁle. The user-programmability stems
from the possibility of user-deﬁned methods for <tt><a 
href="#x143-279022r713">make-load-form</a></tt>. The helper
function <tt><a 
href="#x143-279024r714">make-load-form-saving-slots</a></tt> makes it easy to write commonly used
versions of such methods.
<div class=defun>
<!--l. 2715--><p class="noindent" ><i>[Generic function]</i><a 
 id="dx143-279021"></a><a 
 id="x143-279022r713"></a><b> make-load-form</b>  <i>object</i>
<!--l. 2717--><p class="noindent" >The argument is an object that is referenced as a constant or as a self-evaluating
form in a ﬁle being compiled by <tt><a 
href="clmse117.html#x146-282006r717">compile-file</a></tt>. The objective is to enable <tt><a 
href="#x143-279002r708">load</a></tt> to
construct an equivalent object.
<!--l. 2723--><p class="indent" >   The ﬁrst value, called the <i>creation form</i>, is a form that, when evaluated at
load time, should return an object that is equivalent to the argument.
The exact meaning of “equivalent” depends on the type of object and
is up to the programmer who deﬁnes a method for <tt><a 
href="#x143-279022r713">make-load-form</a></tt>.
This allows the user to program the notion of “similar as a constant” (see
section <a 
href="clmse117.html#x146-28200024.1">24.1<!--tex4ht:ref: COMPILER-SECTION --></a>).
<!--l. 2730--><p class="indent" >   The second value, called the <i>initialization form</i>, is a form that, when evaluated
at load time, should perform further initialization of the object. The value
returned by the initialization form is ignored. If the <tt><a 
href="#x143-279022r713">make-load-form</a></tt> method
returns only one value, the initialization form is <tt><a 
href="clmse30.html#x41-73002r18">nil</a></tt>, which has no eﬀect. If the
object used as the argument to <tt><a 
href="#x143-279022r713">make-load-form</a></tt> appears as a constant in the
initialization form, at load time it will be replaced by the equivalent object
constructed by the creation form; this is how the further initialization gains access
to the object.
<!--l. 2740--><p class="indent" >   Two values are returned so that circular structures may be handled. The order
of evaluation rules discussed below for creation and initialization forms eliminates
the possibility of partially initialized objects in the absence of circular structures
and reduces the possibility to a minimum in the presence of circular structures.
This allows nodes in non-circular structures to be built out of fully initialized
subparts.
                                                                          

                                                                          
<!--l. 2748--><p class="indent" >   Both the creation form and the initialization form can contain references to
objects of user-deﬁned types (deﬁned precisely below). However, there must not
be any circular dependencies in creation forms. An example of a circular
dependency: the creation form for the object <i>X</i> contains a reference to the
object <i>Y </i>, and the creation form for the object <i>Y </i> contains a reference to
the object <i>X</i>. A simpler example: the creation form for the object <i>X</i>
contains a reference to <i>X</i> itself. Initialization forms are not subject to any
restriction against circular dependencies, which is the entire reason for
having initialization forms. See the example of circular data structures
below.
<!--l. 2760--><p class="indent" >   The creation form for an object is always evaluated before the initialization
form for that object. When either the creation form or the initialization form
refers to other objects of user-deﬁned types that have not been referenced earlier
in the <tt><a 
href="clmse117.html#x146-282006r717">compile-file</a></tt>, the compiler collects all of the creation and initialization
forms. Each initialization form is evaluated as soon as possible after its creation
form, as determined by data ﬂow. If the initialization form for an object does
not refer to any other objects of user-deﬁned types that have not been
referenced earlier in the <tt><a 
href="clmse117.html#x146-282006r717">compile-file</a></tt>, the initialization form is evaluated
immediately after the creation form. If a creation or initialization form <i>F</i>
references other objects of user-deﬁned types that have not been referenced
earlier in the <tt><a 
href="clmse117.html#x146-282006r717">compile-file</a></tt>, the creation forms for those other objects are
evaluated before <i>F</i> and the initialization forms for those other objects are also
evaluated before <i>F</i> whenever they do not depend on the object created or
initialized by <i>F</i>. Where the above rules do not uniquely determine an order of
evaluation, it is unspeciﬁed which of the possible orders of evaluation is
chosen.
<!--l. 2779--><p class="indent" >   While these creation and initialization forms are being evaluated, the objects
are possibly in an uninitialized state, analogous to the state of an object between
the time it has been created by <tt>allocate-instance</tt> and it has been
processed fully by <tt><a 
href="clmse140.html#x172-407004r867">initialize-instance</a></tt>. Programmers writing methods for
<tt><a 
href="#x143-279022r713">make-load-form</a></tt> must take care in manipulating objects not to depend on slots
that have not yet been initialized.
<!--l. 2786--><p class="indent" >   It is unspeciﬁed whether <tt><a 
href="#x143-279002r708">load</a></tt> calls <tt><a 
href="clmse103.html#x128-236002r562">eval</a></tt> on the forms or does some other
operation that has an equivalent eﬀect. For example, the forms might be
translated into diﬀerent but equivalent forms and then evaluated; they might be
compiled and the resulting functions called by <tt><a 
href="#x143-279002r708">load</a></tt> (after they themselves have
been loaded); or they might be interpreted by a special-purpose interpreter
diﬀerent from <tt><a 
href="clmse103.html#x128-236002r562">eval</a></tt>. All that is required is that the eﬀect be equivalent to
                                                                          

                                                                          
evaluating the forms.
<!--l. 2795--><p class="indent" >   It is valid for user programs to call <tt><a 
href="#x143-279022r713">make-load-form</a></tt> in circumstances other
than compilation, providing the argument&#x2019;s metaclass is not <tt>built-in-class</tt> or a
subclass of <tt>built-in-class</tt>.
<!--l. 2799--><p class="indent" >   Applying <tt><a 
href="#x143-279022r713">make-load-form</a></tt> to an object whose metaclass is <tt>standard-class</tt> or
<tt>structure-class</tt> for which no user-deﬁned method is applicable signals an error.
It is valid to implement this either by deﬁning default methods for the classes
<tt>standard-object</tt> and <tt>structure-object</tt> that signal an error or by having no
applicable method for those classes.
<!--l. 2805--><p class="indent" >   See <tt>load-time-eval</tt>.
<!--l. 2807--><p class="indent" >   In the following example, an equivalent instance of <tt>my-class</tt> is reconstructed
by using the values of two of its slots. The value of the third slot is derived from
those two values. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defclass my-class ()   ((a :initarg :a :reader my-a)
</td></tr></table>
<!--l. 2812--><p class="indent" >                                            <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">   (b :initarg :b :reader my-b)</td></tr></table>
<!--l. 2813--><p class="indent" >                                                    <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">   (c :accessor my-c)))</td></tr></table>
<!--l. 2814--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 2815--><p class="indent" >              <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmethod shared-initialize ((self my-class) slots &#x0026;rest inits)</td></tr></table>
<!--l. 2816--><p class="indent" >                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (declare (ignore slots inits))</td></tr></table>
<!--l. 2817--><p class="indent" >                                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (unless (slot-boundp self &#x2019;c)</td></tr></table>
<!--l. 2818--><p class="indent" >                                                      <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    (setf (my-c self)</td></tr></table>
<!--l. 2819--><p class="indent" >                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">          (some-computation (my-a self) (my-b self)))))</td></tr></table>
<!--l. 2820--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 2821--><p class="indent" >                               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmethod make-load-form ((self my-class))</td></tr></table>
<!--l. 2822--><p class="indent" >                             <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ‘(make-instance &#x2019;,(class-name (class-of self))</td></tr></table>
<!--l. 2823--><p class="indent" >                     <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                  :a &#x2019;,(my-a self) :b &#x2019;,(my-b self)))</td></tr></table>
<!--l. 2825--><p class="indent" >
</div>
</div>
<!--l. 2826--><p class="noindent" >This code will fail if either of the ﬁrst two slots of some instance of <tt>my-class</tt> contains
the instance itself. Another way to write the last form in the preceding example is
<div class=lisp><div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmethod make-load-form ((self my-class))
</td></tr></table>
<!--l. 2830--><p class="indent" >                                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (make-load-form-saving-slots self &#x2019;(a b)))</td></tr></table>
<!--l. 2832--><p class="indent" >
</div>
</div>
<!--l. 2833--><p class="noindent" >This has the advantages of conciseness and handling circularities correctly.
<!--l. 2835--><p class="indent" >   In the next example, instances of class <tt>my-frob</tt> are “interned” in some way. An
equivalent instance is reconstructed by using the value of the <tt>name</tt> slot as a key
for searching for existing objects. In this case the programmer has chosen to
create a new object if no existing object is found; an alternative possibility would
be to signal an error in that case. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defclass my-frob ()
</td></tr></table>
<!--l. 2842--><p class="indent" >                               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ((name :initarg :name :reader my-name)))</td></tr></table>
<!--l. 2843--><p class="indent" >                                                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing"></td></tr></table>
<!--l. 2844--><p class="indent" >                               <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmethod make-load-form ((self my-frob))</td></tr></table>
<!--l. 2845--><p class="indent" >                <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  ‘(ﬁnd-my-frob &#x2019;,(my-name self) :if-does-not-exist :create))</td></tr></table>
<!--l. 2847--><p class="indent" >
</div>
</div>
<!--l. 2849--><p class="indent" >   In the following example, the data structure to be dumped is circular, because
each node of a tree has a list of its children and each child has a reference back to
its parent. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defclass tree-with-parent () ((parent :accessor tree-parent)
</td></tr></table>
<!--l. 2853--><p class="indent" >         <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                               (children :initarg :children)))</td></tr></table>
<!--l. 2855--><p class="indent" >
</div>
</div>
<div class=lisp>
<div class=tabbing>
                                                                          

                                                                          
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmethod make-load-form ((x tree-with-parent))
</td></tr></table>
<!--l. 2858--><p class="indent" >                                                                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (values</td></tr></table>
<!--l. 2859--><p class="indent" >                                          <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(make-instance &#x2019;,(class-of x)</td></tr></table>
<!--l. 2860--><p class="indent" >                 <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">                    :children &#x2019;,(slot-value x &#x2019;children))</td></tr></table>
<!--l. 2861--><p class="indent" >                       <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">    ‘(setf (tree-parent &#x2019;,x) &#x2019;,(slot-value x &#x2019;parent))))</td></tr></table>
<!--l. 2863--><p class="indent" >
</div>
</div>
<!--l. 2864--><p class="noindent" >Suppose <tt><a 
href="#x143-279022r713">make-load-form</a></tt> is called on one object in such a structure. The creation
form creates an equivalent object and ﬁlls in the <tt>children</tt> slot, which forces
creation of equivalent objects for all of its children, grandchildren, etc. At this
point none of the parent slots have been ﬁlled in. The initialization form ﬁlls in
the <tt>parent</tt> slot, which forces creation of an equivalent object for the parent
if it was not already created. Thus the entire tree is recreated at load
time. At compile time, <tt><a 
href="#x143-279022r713">make-load-form</a></tt> is called once for each object
in the tree. All the creation forms are evaluated, in unspeciﬁed order,
and then all the initialization forms are evaluated, also in unspeciﬁed
order.
<!--l. 2876--><p class="indent" >   In this ﬁnal example, the data structure to be dumped has no special
properties and an equivalent structure can be reconstructed simply by
reconstructing the slots&#x2019; contents. <div class=lisp><div class=tabbing>
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defstruct my-struct a b c)
</td></tr></table>
<!--l. 2880--><p class="indent" >
<table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">(defmethod make-load-form ((s my-struct))
</td></tr></table>
<!--l. 2881--><p class="indent" >                                        <table  
cellpadding="0" border="0" cellspacing="0" 
class="tabbing"><tr  
style="vertical-align:baseline;" class="tabbing"><td  
class="tabbing">  (make-load-form-saving-slots s))</td></tr></table>
<!--l. 2883--><p class="indent" >
</div>
</div>
<!--l. 2884--><p class="noindent" >This is easy to code using <tt><a 
href="#x143-279024r714">make-load-form-saving-slots</a></tt>.
</div>
<div class=defun>
                                                                          

                                                                          
<!--l. 2887--><p class="noindent" ><i>[Function]</i><a 
 id="dx143-279023"></a><a 
 id="x143-279024r714"></a><b> make-load-form-saving-slots</b>  <i>object</i> &#x0026;optional  <i>slots</i>
<!--l. 2889--><p class="noindent" >This returns two values suitable for return from a <tt><a 
href="#x143-279022r713">make-load-form</a></tt> method. The
ﬁrst argument is the object. The optional second argument is a list of the names
of slots to preserve; it defaults to all of the local slots.
<tt>
<!--l. 2895--><p class="indent" >   <a 
href="#x143-279024r714">make-load-form-saving-slots</a></tt> returns forms that construct an equivalent
object using <tt><a 
href="clmse140.html#x172-407012r871">make-instance</a></tt> and <tt><a 
href="clmse35.html#x47-89002r64">setf</a></tt> of <tt><a 
href="clmse140.html#x172-407067r898">slot-value</a></tt> for slots with values, or
<tt><a 
href="clmse140.html#x172-407057r893">slot-makunbound</a></tt> for slots without values, or other functions of equivalent
eﬀect.
<!--l. 2901--><p class="indent" >   Because <tt><a 
href="#x143-279024r714">make-load-form-saving-slots</a></tt> returns two values, it can deal with
circular structures; it works for any object of metaclass <tt>standard-class</tt> or
<tt>structure-class</tt>. Whether the result is useful depends on whether the object&#x2019;s
type and slot contents fully capture an application&#x2019;s idea of the object&#x2019;s
state.
</div>
</div>
                                                                          

                                                                          
<!--l. 2911--><p class="indent" >   <div id="bottomlinks"><tt>&#x003C;</tt><a 
href="clmse116.html" >Далее</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse114.html" >Назад</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse114.html#tailclmse114.html" >Назад-и-вниз</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmse115.html" >В-начало</a><tt>&#x003E;</tt><tt>&#x003C;</tt><a 
href="clmch23.html#clmse115.html" >Наверх</a><tt>&#x003E;</tt></div><a 
 id="tailclmse115.html"></a>  </div> </div> 
</body></html> 
